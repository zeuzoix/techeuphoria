:link-beagleboneblack-srm-pdf: link:docs/BBB_SRM.pdf
:uri-beagleboneblack-srm: https://github.com/CircuitCo/BeagleBone-Black/blob/master/BBB_SRM.pdf?raw=true
:link-am3359-datasheet-pdf: link:docs/am3359.pdf
:uri-am3359-datasheet: http://www.ti.com/lit/ds/symlink/am3359.pdf
:link-am3358-technical-reference-manual-pdf: link:docs/spruh73i.pdf
:uri-am3358-technical-reference-manual: http://www.ti.com/product/am3359
:link-fe-linux-kernel-labs-tar-xz: link:free_electrons_linux_kernel/linux-kernel-labs.tar.xz

== LAB 2 : Setting Up The Beaglebone Black Board

[NOTE]
.This is a hands on session taken from the Free Electrons labs with the following objectives
====
. Getting familiar with the BeagleBone Black board
. Knowing what technical documentation is available
. Installing the lab data from Free Electrons
. Access the board through the serial line. 
. Configure the U-boot bootloader to download files onto the board using trivial
file transfer protocol (tftp)
====

=== Getting Comfortable With The Board

At this point we have to get familiar with our board. It is good to go through
the features of the board given in section 4.0 of the
{link-beagleboneblack-srm-pdf}[BeagleBone Black System Reference Manual^].

==== Connectors, LEDs and Switches

====
[[beagleboneblacktux-CONN_REVA5A]]
.Beagle Bone Black Connectors, LEDs and Switches
image::CONN_REVA5A.jpg[width="640", height="480", align="center", link={awestruct-imagesdir}/CONN_REVA5A.jpg]
====

5V DC Power Connector:: The main DC input which accepts 5V power. Suitable for
more power hungry applications.
Power Down Button Switch:: Signals to the processor to initiate the power down
sequence. It is used to power down the board.
Boot Button Switch:: Force the a boot from the microSD card by removing and
reapplying power to the board.
Reset Button Switch:: Reset the processor.
USB Client Connector:: Mini USB port at the bottom of the board. It can be
used to power the board and setup a network connection.
10/100 Ethernet Connector:: The LAN interface.
Debug Serial Header Connector:: The header interface for the serial port.
MicroSD Slot Connector:: Slot at the bottom of the board to insert a micro SD
card.
MicroHDMI Slot Connector:: Slot at the bottom of the board to insert a micro
HDMI cable to interface to a display.
USB Host Connector:: This can be used to connect a USB device like keyboard,
mouse, BT dongle, WiFi dongle, etc..

==== System Key Components

====
[[beagleboneblacktux-COMP_A5A]]
.BeagleBone Black system key components
image::COMP_A5A.jpg[width="640", height="480", align="center", link={awestruct-imagesdir}/COMP_A5A.jpg]
====

Sitara Processor:: ARM architecture OMAP System On Chip(SOC) from
Texas Instruments. This is XAM3359AZCZ100 for revision A5A to A6A and
XAM3359AZCZ100 for revision B and above. Only the A4 revision boards had the
AM3352 processor.
512MB DDR3 RAM:: Micron 512MB DDR3L or Kingston 512MB DDR3 Dual Data Rate RAM.
TPS65217C PMIC:: It is the power management IC which supplies the power rails
to the different components on board.
SMSC Ethernet PHY:: The physical interface to the ethernet network.
Micron eMMC:: This was 2GB till revision B and changed to 4GB in revision C.
HDMI Framer:: Provides the HDMI control for and HDMI or DVI-D display with
adaptor.

=== Downloading The Technical Documentation

Design is not possible without documentation, so we download the documents
which will help us in the lab sessions. The following are needed:


Tht System Reference Manual describes the details about the design of the
board and is available on this site {link-beagleboneblack-srm-pdf}[here^] +
The latest document should be available at: {uri-beagleboneblack-srm}[{uri-beagleboneblack-srm}^].
 

The datasheet of the TI AM335x SoCs is useful to see the PIN assignments
later when we want to configure the _pinmux_ settings and is available on this
site {link-am3359-datasheet-pdf}[here^] +
The original link is at the TI website at: {uri-am3359-datasheet}[{uri-am3359-datasheet}^]

The last document is the Technical Reference Manual(TRM) of the TI AM335x SoCs.
At over 4000 pages it describes the internal IP design of the chip. It is available
{link-am3358-technical-reference-manual-pdf}[here^]. +
The same document can be retrieved from the TI website at :
{uri-am3358-technical-reference-manual}[{uri-am3358-technical-reference-manual}^]
  
=== Installing The Free Electrons Lab Data

We will be using the lab data available from Free Electrons to setup our
BeagleBone Black. First make sure the lab data is downloaded. The lab data which
was available at the time of writing this journal is
{link-fe-linux-kernel-labs-tar-xz}[here^].

We'll have to uncompress the file with *sudo* permissions and change the
permissions of the resulting folder. The prime reason being that the package
contains system device node files for the NFS root filesystem:

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo tar xvJf linux-kernel-labs.tar.xz 	<1>
[sudo] password for conrad: 
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
linux-kernel-labs/
linux-kernel-labs/src/
linux-kernel-labs/src/patches/
.
.
.
linux-kernel-labs/modules/nfsroot/sbin/route
linux-kernel-labs/modules/nfsroot/sbin/runlevel
linux-kernel-labs/git/
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ 
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo chown -R conrad:conrad linux-kernel-labs	<2>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ ls -l
total 7756
drwxrwxr-x 6 conrad conrad    4096 Mar 22 17:38 linux-kernel-labs	<3>
-rw-rw-r-- 1 conrad conrad 7931316 Mar 22 18:57 linux-kernel-labs.tar.xz
-rw-rw-r-- 1 conrad conrad      87 Mar 22 18:55 Readme.txt
----
<1> Command to untar and decompress the package
<2> Command to change the owner and group to the user name in this case _conrad_
<3> Listing of the directory shows the owner and group has been set appropriately

The xz extension of the package indicates that it requires XZ compression utility
which if not available on your system can be upgraded as follows:

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo apt-get install xz-utils
----

=== Making A Bootable MicroSD Card

Now we deviate slightly from the Free Electrons lab slides and first
prepare our board as per the instructions provided in the
_linux-kernel-labs/bootloader/beaglebone-black/README.txt_ file. The
bootable micro-SD card will automatically format the on board eMMC
device.

Take the microSD card and insert it into a microSD adapter like the
one shown in the image below:

====
[[beagleboneblacktux-microsd-adaptor-sd]]
.Micro SD card adapter
image::sdcard-microsd-adaptor-sd.jpg[width="640", height="480", align="center", link={awestruct-imagesdir}/sdcard-microsd-adaptor-sd.jpg]
====
 
This memory card reader/adapter should be inserted into the SD card
slot available. If your system has a micro SD card slot then please
use that directly. On checking the kernel logs with _dmesg_ we should
be able to identify the card detected in the system. If a micro SD
card slot is available then the system should register it as a 
_/dev/mmcblk0_ whereas in this case with a memory card reader we see
it as _/dev/sdb_. The following shows the kernel logs:

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ dmesg
.
.
.
[127595.272118] usb 1-2: new high-speed USB device number 6 using ehci-pci
[127595.405640] usb 1-2: New USB device found, idVendor=058f, idProduct=6366
[127595.405650] usb 1-2: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[127595.405658] usb 1-2: Product: Mass Storage Device
[127595.405665] usb 1-2: Manufacturer: Generic
[127595.405671] usb 1-2: SerialNumber: 058F63666433
[127595.406226] usb-storage 1-2:1.0: USB Mass Storage device detected
[127595.407830] scsi9 : usb-storage 1-2:1.0
[127596.532963] scsi 9:0:0:0: Direct-Access     Multiple Card  Reader     1.00 PQ: 0 ANSI: 0
[127596.533754] sd 9:0:0:0: Attached scsi generic sg1 type 0
[127598.192274] sd 9:0:0:0: [sdb] 7744512 512-byte logical blocks: (3.96 GB/3.69 GiB) <1>
[127598.193263] sd 9:0:0:0: [sdb] Write Protect is off
[127598.193269] sd 9:0:0:0: [sdb] Mode Sense: 03 00 00 00
[127598.194256] sd 9:0:0:0: [sdb] No Caching mode page found
[127598.194259] sd 9:0:0:0: [sdb] Assuming drive cache: write through
[127598.199023] sd 9:0:0:0: [sdb] No Caching mode page found
[127598.199028] sd 9:0:0:0: [sdb] Assuming drive cache: write through
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ ls -l /dev/sdb 	<2>
brw-rw---- 1 root disk 8, 16 Mar 22 21:09 /dev/sdb
----
<1> We see the device attached as sdb
<2> The device node has been created successfully as /dev/sdb

We will have to first partition the micro SD card using the _sfdisk_ utility
which is part of the _util-linux_ APT package.
This tool helps us to list the partitions of a device, check the sizes of the
partitions, check the partitions on a device and re-partition a device. We must
*be extra careful* when we use such a tool as it could also cause damage to our
workstation system if we select the wrong device file unintentionally.

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ sudo sfdisk --in-order --Linux --unit M /dev/sdb << EOF		<1>
> 1,48,0xE,*
> ,,,-
> EOF
Checking that no-one is using this disk right now ...
BLKRRPART: Device or resource busy						<2>

This disk is currently in use - repartitioning is probably a bad idea.
Umount all file systems, and swapoff all swap partitions on this disk.
Use the --no-reread flag to suppress this check.
Use the --force flag to overrule all checks.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ mount		<3>
/dev/sda1 on / type ext4 (rw,errors=remount-ro)
proc on /proc type proc (rw,noexec,nosuid,nodev)
sysfs on /sys type sysfs (rw,noexec,nosuid,nodev)
none on /sys/fs/cgroup type tmpfs (rw)
none on /sys/fs/fuse/connections type fusectl (rw)
none on /sys/kernel/debug type debugfs (rw)
none on /sys/kernel/security type securityfs (rw)
udev on /dev type devtmpfs (rw,mode=0755)
devpts on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)
tmpfs on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)
none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)
none on /run/shm type tmpfs (rw,nosuid,nodev)
none on /run/user type tmpfs (rw,noexec,nosuid,nodev,size=104857600,mode=0755)
none on /sys/fs/pstore type pstore (rw)
rpc_pipefs on /run/rpc_pipefs type rpc_pipefs (rw)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,noexec,nosuid,nodev)
systemd on /sys/fs/cgroup/systemd type cgroup (rw,noexec,nosuid,nodev,none,name=systemd)
nfsd on /proc/fs/nfsd type nfsd (rw)
gvfsd-fuse on /run/user/1000/gvfs type fuse.gvfsd-fuse (rw,nosuid,nodev,user=conrad)
/dev/sdb1 on /media/conrad/boot type vfat (rw,nosuid,nodev,uid=1000,gid=1000,shortname=mixed,dmask=0077,utf8=1,showexec,flush,uhelper=udisks2) <4>
----
<1> The command to re-partition the _/devsdb_ device with _sfdisk_. The options
_--in-order_ indicates that the partitions are in order in the input. _--Linux_
tells sfdisk to ignore all warnings irrelevant for Linux.
<2> The device is apparently busy.
<3> We do a _mount_ to check if it is mounted
<4> We see that a partition is mounted in our Workstation at /media/conrad/boot

If the micro-SD card is already partitioned and formated it may be auto mounted
by our work station. We will have to un-mount all the partitions before we can
proceed.

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ sudo umount /media/conrad/boot 	<1>
[sudo] password for conrad: 
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ mount		<2>
/dev/sda1 on / type ext4 (rw,errors=remount-ro)
proc on /proc type proc (rw,noexec,nosuid,nodev)
sysfs on /sys type sysfs (rw,noexec,nosuid,nodev)
none on /sys/fs/cgroup type tmpfs (rw)
none on /sys/fs/fuse/connections type fusectl (rw)
none on /sys/kernel/debug type debugfs (rw)
none on /sys/kernel/security type securityfs (rw)
udev on /dev type devtmpfs (rw,mode=0755)
devpts on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)
tmpfs on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)
none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)
none on /run/shm type tmpfs (rw,nosuid,nodev)
none on /run/user type tmpfs (rw,noexec,nosuid,nodev,size=104857600,mode=0755)
none on /sys/fs/pstore type pstore (rw)
rpc_pipefs on /run/rpc_pipefs type rpc_pipefs (rw)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,noexec,nosuid,nodev)
systemd on /sys/fs/cgroup/systemd type cgroup (rw,noexec,nosuid,nodev,none,name=systemd)
nfsd on /proc/fs/nfsd type nfsd (rw)
gvfsd-fuse on /run/user/1000/gvfs type fuse.gvfsd-fuse (rw,nosuid,nodev,user=conrad)
----
<1> We have to unmount the _/dev/sdb1_ from the mount point i.e. _/media/conrad/boot_
<2> We check to see if anything else is mounted again

Again we attempt to repartition the micro SD card 

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ sudo sfdisk --in-order --Linux --unit M /dev/sdb << EOF	
1,48,0xE,*
,,,-
EOF											<1>
Checking that no-one is using this disk right now ...					<2>
OK

Disk /dev/sdb: 1023 cylinders, 122 heads, 62 sectors/track
Old situation:										<3>
Units = mebibytes of 1048576 bytes, blocks of 1024 bytes, counting from 0

   Device Boot Start   End    MiB    #blocks   Id  System
/dev/sdb1   *     1     48     48      49152    e  W95 FAT16 (LBA)
/dev/sdb2        49   3780   3732    3821568   83  Linux
/dev/sdb3         0      -      0          0    0  Empty
/dev/sdb4         0      -      0          0    0  Empty
New situation:										<4>
Units = mebibytes of 1048576 bytes, blocks of 1024 bytes, counting from 0

   Device Boot Start   End    MiB    #blocks   Id  System
/dev/sdb1   *     1     48     48      49152    e  W95 FAT16 (LBA)
/dev/sdb2        49   3780   3732    3821568   83  Linux
/dev/sdb3         0      -      0          0    0  Empty
/dev/sdb4         0      -      0          0    0  Empty
Successfully wrote the new partition table

Re-reading the partition table ...
BLKRRPART: Device or resource busy
The command to re-read the partition table failed.
Run partprobe(8), kpartx(8) or reboot your system now,
before using mkfs
If you created or changed a DOS partition, /dev/foo7, say, then use dd(1)
to zero the first 512 bytes:  dd if=/dev/zero of=/dev/foo7 bs=512 count=1
(See fdisk(8).)
----
<1> The _sfdisk_ utility is invoked supplying the information about the partitions
<2> _sfdisk_ checking to see that no one is using the disk
<3> The old partition map is displayed first. *This will vary based on the history
of the micro-SD card*
<4> The new partition map is displayed. The first partition is a W95 FAT16 one
which is 48 MB. This is the first line of input to sfdisk. The remaining has
been converted to a Linux partition.

We will have to format the first partition of the disk using the _mkfs.vfat_
partition.

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ sudo mkfs.vfat -F 16 /dev/sdb1 -n boot	<1>
[sudo] password for conrad: 
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
mkfs.fat 3.0.26 (2014-03-07)
mkfs.fat: warning - lowercase labels might not work properly with DOS or Windows
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ echo $?			<2>
0
----
<1> _mkfs.vfat_ is run on the partition _/dev/sdb1_. The label of the partition
is set to _boot_ with the -n option and the -F option specifies the type of
file allocation tables used (12, 16 or 32 bit).
<2> Checks the return value of the command

We now remove and re-insert the microSD card into the system to see if it gets
detected and automatically mounted. It does and we see that Ubuntu
opens up the directory located in _/media/conrad/boot_.

====
[[beagleboneblacktux-media-boot-automounted]]
.The first partition _/dev/sdb1_ has been automounted successfully at _/media/conrad/boot_
image::beagleboneblacktux-media-boot-automounted.png[width="640", height="480", align="center", link={awestruct-imagesdir}/beagleboneblacktux-media-boot-automounted.png]
====

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ mount	<1>
/dev/sda1 on / type ext4 (rw,errors=remount-ro)
proc on /proc type proc (rw,noexec,nosuid,nodev)
sysfs on /sys type sysfs (rw,noexec,nosuid,nodev)
none on /sys/fs/cgroup type tmpfs (rw)
none on /sys/fs/fuse/connections type fusectl (rw)
none on /sys/kernel/debug type debugfs (rw)
none on /sys/kernel/security type securityfs (rw)
udev on /dev type devtmpfs (rw,mode=0755)
devpts on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)
tmpfs on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)
none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)
none on /run/shm type tmpfs (rw,nosuid,nodev)
none on /run/user type tmpfs (rw,noexec,nosuid,nodev,size=104857600,mode=0755)
none on /sys/fs/pstore type pstore (rw)
rpc_pipefs on /run/rpc_pipefs type rpc_pipefs (rw)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,noexec,nosuid,nodev)
systemd on /sys/fs/cgroup/systemd type cgroup (rw,noexec,nosuid,nodev,none,name=systemd)
nfsd on /proc/fs/nfsd type nfsd (rw)
gvfsd-fuse on /run/user/1000/gvfs type fuse.gvfsd-fuse (rw,nosuid,nodev,user=conrad)
/dev/sdb1 on /media/conrad/boot type vfat (rw,nosuid,nodev,uid=1000,gid=1000,shortname=mixed,dmask=0077,utf8=1,showexec,flush,uhelper=udisks2)	<2>
----
<1> We use _mount_ to check explicitly what's there in the system
<2> Our partition has been mounted at _/media/conrad/boot_

We will finally have to copy the files from the lab data folder to this partition
and un mount the device.

[source,bash]
----
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/bootloader/beaglebone-black$ cp am335x-boneblack.dtb MLO MBR u-boot.img MLO.final u-boot.img.final uEnv.txt uImage /media/conrad/boot/		<1>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/bootloader/beaglebone-black$ umount /media/conrad/boot	<2>
----
<1> Copying the necessary files from the Free Electrons lab data folder which we unpacked earlier
<2> Unmounting the mounted partition

We can now safely eject or remove the microSD card from the work station.




