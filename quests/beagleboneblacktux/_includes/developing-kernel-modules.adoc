ifndef::awestruct[]
:imagesdir: ../images
endif::[]
== Developing Kernel Modules

We will first take a look at a sample source code of a Linux kernel module.

[source, C]
----
#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>
<1>

static int __init sample_module_init(void)	<2>
{
	pr_alert("Wassup!\n");
	return 0;
}

static void __exit sample_module_exit(void)	<4>
{
	pr_alert("Cya Later!\n");
}
	
module_init(sample_module_init);		<3>
module_exit(sample_module_exit);		<5>
	
MODULE_LICENSE("GPL");				
MODULE_DESCRIPTION("Sample Module");
MODULE_AUTHOR("Newbie");
<6>
----
<1> Only headers specific to the Linux kernel, no access to the standard C
library
<2> Defining an initialization function, returns an int to indicate the
status of the initialization when _insmod_ is used to load the module.
<3> The macro _module_init_ is used to register the initialization
function for the module.
<4> Defining a  cleanup function for the module.
<5> The macro _module_exit_ is used to register the cleanup function for
the module.
<6> Metadata for the module defining the license type, description and
the author.


The source code is in C but it has some special symbols which are not
used in user space application programming: +

__init:: This indicates that the module initializaiton function
_sample_module_init_ can be removed after initialization. The function is called
only once when the module starts up and thereafter is not used. This optimizes
the memory usage of the kernel.

__exit:: This indicates that the function is discarded if the module is
compiled statically into the kernel or if module unloading is disabled. Its
primary use is for loadable kernel modules.

It should be noted that the name of the initialization and cleanup
functions can be anything however the module name is often used to form
the functions (<modulename>_init()/<modulename_exit()).

=== Symbols Exported To Modules

A kernel module can use functions and variables defined in other parts of the Linux
kernel source code so long as they are exported. There are two macros
that are used to export the symbol names that can be used by other modules: +

EXPORT_SYMBOL(symbolname):: Exports a function or variable to all modules
EXPORT_SYMBOL_GPL(symbolname):: Exports a function or variable to only GPL
modules

====
[[symbols-exported-to-modules]]
.Symbols exported to modules
image::symbols-exported-to-modules.png[width="640", height="480", align="center", link={awestruct-imagesdir}/symbols-exported-to-modules.png]
====

////
[ditaa, symbols-exported-to-modules]
----
                                                /---------------------------------------\        											
                                                |              GPL Module 1             |
                                                |                                       |
                                                |    /----------------------------\     |
                                                |    |                            |     |
                                                |    |       void func4(){...}    |     |
                                                |    |  EXPORT_SYMBOL_GPL(func4); |     |
                                                |    |                            |     |
  /---------------------------------------\     |    \----------------------------/     |
  |                Kernel                 |     |                                       |
  |                                       |     |    /----------\      /----------\     |
  |    /----------------------------\     |     |    |          |      |          |     |
  |    |                            |     |     |    | func1(); |      |    NOK   |     |
  |    |       void func1(){...}    |     |     |    | func2(); |      |    OK    |     |
  |    |                            |     |     |    | func3(); |      |    OK    |     |
  |    |       void func2(){...}    |     |     |    | func4(); |      |    OK    |     |
  |    |   EXPORT_SYMBOL(func2);    |     |     |    |          |      |          |     |
  |    |                            |     |     |    \----------/      \----------/     |
  |    |       void func3(){...}    |     |     |                                       |
  |    |  EXPORT_SYMBOL_GPL(func3); |     |     \---------------------------------------/
  |    |                            |     |
  |    \----------------------------/     |     /---------------------------------------\        											
  |                                       |     |              GPL Module 2             |
  |    /----------\      /----------\     |     |                                       |
  |    |          |      |          |     |     |    /----------\      /----------\     |
  |    | func1(); |      |    OK    |     |     |    |          |      |          |     |
  |    | func2(); |      |    OK    |     |     |    | func1(); |      |    NOK   |     |
  |    | func3(); |      |    OK    |     |     |    | func2(); |      |    OK    |     |
  |    | func4(); |      |    NOK   |     |     |    | func3(); |      |    OK    |     |
  |    |          |      |          |     |     |    | func4(); |      |    OK    |     |
  |    \----------/      \----------/     |     |    |          |      |          |     |
  |                                       |     |    \----------/      \----------/     |
  \---------------------------------------/     |                                       |
                                                \---------------------------------------/

                                                /---------------------------------------\        											
                                                |              Non-GPL Module           |
                                                |                                       |
                                                |    /----------\      /----------\     |
                                                |    |          |      |          |     |
                                                |    | func1(); |      |    NOK   |     |
                                                |    | func2(); |      |    OK    |     |
                                                |    | func3(); |      |    NOK   |     |
                                                |    | func4(); |      |    NOK   |     |
                                                |    |          |      |          |     |
                                                |    \----------/      \----------/     |
                                                |                                       |
                                                \---------------------------------------/


----
////

The diagram illustrates the difference between exporting a symbol with
_EXPORT_SYMBOL_ versus _EXPORT_SYMBOL_GPL_. Symbols exported by
_EXPORT_SYMBOL_GPL_(func3, func4) can be used by only GPL modules whereas
symbols exported by _EXPORT_SYMBOL_ can be used by both GPL and Non-GPL
modules. A module gets it's license from the _MODULE_LICENSE_ macro added
in it's source code along with the other metadata.

[source, C]
----
#include <linux/init.h>
#include <linux/module.h>
#include <linux/kernel.h>

static int __init sample_module_init(void)
.
.
.
MODULE_LICENSE("GPL");				<1>
MODULE_DESCRIPTION("Sample Module");
MODULE_AUTHOR("Newbie");
----
<1> Module license is GPL

The kernel can only use symbols defined in its source code. It cannot
use symbols exported by _modules_ even if they are GPL licensed modules.
Symbols exported with _EXPORT_SYMBOL_GPL_ can be used only by GPL licensed
modules. Symbols exported with _EXPORT_SYMBOL_ can be used by GPL and Non-GPL
licensed modules

=== About Module Licenses

The _MODULE_LICENSE_ is used to define the license of the module. It is used
to restrict the functions that a module can use if it is not a GPL licensed
module. GPL licensed modules have access to all exported symbols whereas
Non-GPL licensed modules can only access symbols exported with _EXPORT_SYMBOL_.

Another use for module licenses is to identify issues comming from proprietary
modules. Typically kernel developers do not fix issues coming from proprietary
modules or drivers which cause kernel crashes and OOPSes.

[source, C]
----
#ifndef __LICENSE_H
#define __LICENSE_H

static inline int license_is_gpl_compatible(const char *license)
{
        return (strcmp(license, "GPL") == 0
                || strcmp(license, "GPL v2") == 0
                || strcmp(license, "GPL and additional rights") == 0
                || strcmp(license, "Dual BSD/GPL") == 0
                || strcmp(license, "Dual MIT/GPL") == 0
                || strcmp(license, "Dual MPL/GPL") == 0);
}

#endif
----

GPL compatible licenses are defined in the _include/linux/license.h_ file as
shown above. These include GPL, GPL v2, GPL and additional rights, Dual BSD/GPL,
Dual MIT/GPL or Dual MPL/GPL. All other licenses are considered as proprietary.

