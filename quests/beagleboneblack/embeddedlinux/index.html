<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title>A Technical Odyssey</title>
<link href="http://zeuzoix.github.io/techeuphoria/stylesheets/app.css" rel="stylesheet">
<link href="/techeuphoria/feed.xml" rel="alternate" type="application/atom+xml">
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/vendor/custom.modernizr.js"></script>
<link href="http://zeuzoix.github.io/techeuphoria/humans.txt" rel="author" type="text/plain">
</head>
<body class="antialiased">
<div class="fixed-width">
<nav class="top-bar">
<ul class="title-area">
<li class="name">
<h1>
<a href="/techeuphoria/">
TechEuphoria
</a>
</h1>
</li>
<li class="toggle-topbar menu-icon">
<a href="#"><span></span></a>
</li>
</ul>
<section class="top-bar-section">
<ul class="left">
<li class="divider">
<li>
<a href="/techeuphoria/quests/index.html">/quests</a>
</li>
</li>
<li class="divider"></li>
</ul>
</section>
</nav>
</div>
<div class="row">
<div class="large-12 columns">
<h1></h1>
</div>
</div>
<div class="row" id="content">
<div class="large-12 columns">
<div id="preamble">
<div class="sectionbody">
<div id="toc" class="toc">
<div id="toctitle" class="title">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel1">
<li><a href="#about-the-linux-kernel">1. About The Linux Kernel</a></li>
<li><a href="#about-beagleboard">2. About BeagleBoard</a></li>
<li><a href="#about-free-electrons">3. About Free Electrons</a></li>
</ul>
</li>
<li><a href="#training-and-workbench-setup">Training and Workbench Setup</a>
<ul class="sectlevel1">
<li><a href="#hardware">4. Hardware</a>
<ul class="sectlevel2">
<li><a href="#beaglebone-black">4.1. BeagleBone Black</a></li>
</ul>
</li>
<li><a href="#software">5. Software</a>
<ul class="sectlevel2">
<li><a href="#ubuntu">5.1. Ubuntu</a></li>
<li><a href="#git">5.2. GIT</a></li>
<li><a href="#free-electrons-linux-kernel-data">5.3. Free Electrons Linux Kernel Data</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#the-kernel-source-code">The Kernel Source Code</a>
<ul class="sectlevel1">
<li><a href="#offical-and-unofficial-kernel-sources">6. Offical and Unofficial Kernel Sources</a>
<ul class="sectlevel2">
<li><a href="#cloning-the-linux-tree-with-git">6.1. Cloning the Linux Tree With GIT</a></li>
<li><a href="#using-stable-releases">6.2. Using Stable Releases</a></li>
</ul>
</li>
<li><a href="#why-are-the-sources-so-big">7. Why Are The Sources So Big?</a>
<ul class="sectlevel2">
<li><a href="#size-comparison-of-different-kernel-source-directories">7.1. Size Comparison of Different Kernel Source Directories</a></li>
</ul>
</li>
<li><a href="#programming-religion">8. Programming Religion</a></li>
<li><a href="#no-c-library">9. No C Library</a></li>
<li><a href="#portability">10. Portability</a></li>
<li><a href="#linux-internal-api">11. Linux Internal API</a></li>
<li><a href="#is-it-free">12. Is It Free?</a></li>
<li><a href="#advantages-of-gpl-drivers">13. Advantages Of GPL Drivers</a></li>
<li><a href="#advantages-of-in-tree-kernel-drivers">14. Advantages Of In-Tree Kernel Drivers</a></li>
<li><a href="#user-space-device-drivers">15. User Space Device Drivers</a>
<ul class="sectlevel2">
<li><a href="#examples-of-user-space-device-drivers">15.1. Examples Of User Space Device Drivers</a></li>
<li><a href="#the-good-and-the-bad-of-user-space-device-drivers">15.2. The Good And The Bad Of User Space Device Drivers</a></li>
</ul>
</li>
<li><a href="#what-s-in-the-sources">16. What&#8217;s In The Sources?</a></li>
<li><a href="#browsing-the-sources">17. Browsing The Sources</a>
<ul class="sectlevel2">
<li><a href="#cscope">17.1. Cscope</a></li>
<li><a href="#lxr">17.2. LXR</a></li>
</ul>
</li>
<li><a href="#lab-1-getting-accustomed-to-browsing-the-sources">18. LAB 1 : Getting Accustomed To Browsing The Sources</a>
<ul class="sectlevel2">
<li><a href="#creating-a-branch-to-a-particular-stable-kernel-version">18.1. Creating A Branch To A Particular Stable Kernel Version</a></li>
<li><a href="#searching-tools">18.2. Searching Tools</a>
<ul class="sectlevel3">
<li><a href="#using-find">18.2.1. Using Find</a></li>
<li><a href="#using-git-grep">18.2.2. Using Git-Grep</a></li>
<li><a href="#using-linux-cross-reference">18.2.3. Using Linux Cross Reference</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#configuring-the-kernel">19. Configuring The Kernel</a>
<ul class="sectlevel2">
<li><a href="#kernel-configuration">19.1. Kernel Configuration</a>
<ul class="sectlevel3">
<li><a href="#kernel-configuration-in-the-system">19.1.1. Kernel Configuration In The System</a></li>
</ul>
</li>
<li><a href="#configuring-features-as-modules">19.2. Configuring Features As Modules</a></li>
<li><a href="#kernel-option-types">19.3. Kernel Option Types</a></li>
<li><a href="#kernel-option-dependencies">19.4. Kernel Option Dependencies</a></li>
<li><a href="#graphical-configuration-interface-em-xconfig-em">19.5. Graphical Configuration Interface <em>xconfig</em></a></li>
<li><a href="#graphical-configuration-interface-em-gconfig-em">19.6. Graphical Configuration Interface <em>gconfig</em></a></li>
<li><a href="#text-configuration-interface-em-menuconfig-em">19.7. Text Configuration Interface <em>menuconfig</em></a></li>
<li><a href="#text-configuration-interface-em-nconfig-em">19.8. Text Configuration Interface <em>nconfig</em></a></li>
<li><a href="#make-oldconfig">19.9. make oldconfig</a></li>
<li><a href="#reverting-to-a-previous-configuration">19.10. Reverting To A Previous Configuration</a></li>
</ul>
</li>
<li><a href="#compiling-the-kernel">20. Compiling The Kernel</a></li>
<li><a href="#kernel-installation">21. Kernel Installation</a>
<ul class="sectlevel2">
<li><a href="#kernel-module-installation">21.1. Kernel Module Installation</a></li>
<li><a href="#cleaning-up">21.2. Cleaning Up</a></li>
</ul>
</li>
<li><a href="#cross-compiling-the-kernel">22. Cross-Compiling The Kernel</a>
<ul class="sectlevel2">
<li><a href="#predefined-configuration-files">22.1. Predefined Configuration Files</a></li>
<li><a href="#saving-our-default-configuration">22.2. Saving Our Default Configuration</a></li>
<li><a href="#device-tree">22.3. Device Tree</a></li>
<li><a href="#steps-to-build-and-install-a-kernel">22.4. Steps To Build and Install A Kernel</a></li>
<li><a href="#using-u-boot">22.5. Using U-Boot</a></li>
<li><a href="#kernel-command-line">22.6. Kernel Command Line</a></li>
</ul>
</li>
<li><a href="#lab-2-setting-up-the-beaglebone-black-board">23. LAB 2 : Setting Up The Beaglebone Black Board</a>
<ul class="sectlevel2">
<li><a href="#getting-comfortable-with-the-board">23.1. Getting Comfortable With The Board</a>
<ul class="sectlevel3">
<li><a href="#connectors-leds-and-switches">23.1.1. Connectors, LEDs and Switches</a></li>
<li><a href="#system-key-components">23.1.2. System Key Components</a></li>
</ul>
</li>
<li><a href="#downloading-the-technical-documentation">23.2. Downloading The Technical Documentation</a></li>
<li><a href="#installing-the-free-electrons-lab-data">23.3. Installing The Free Electrons Lab Data</a></li>
<li><a href="#making-a-bootable-microsd-card">23.4. Making A Bootable MicroSD Card</a>
<ul class="sectlevel3">
<li><a href="#source-for-binaries">23.4.1. Source For Binaries</a></li>
</ul>
</li>
<li><a href="#reflashing-the-emmc-with-the-micro-sd-card">23.5. Reflashing The eMMC With The micro-SD Card</a>
<ul class="sectlevel3">
<li><a href="#insert-the-micro-sd-card">23.5.1. Insert The micro-SD Card</a></li>
<li><a href="#pressing-the-boot-switch">23.5.2. Pressing The Boot Switch</a></li>
<li><a href="#applying-power">23.5.3. Applying Power</a></li>
<li><a href="#troubleshooting">23.5.4. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#setting-up-serial-communication-with-the-board">23.6. Setting Up Serial Communication With The Board</a>
<ul class="sectlevel3">
<li><a href="#rhydolabz-ftdi-usb-to-serial-breakout-board">23.6.1. Rhydolabz FTDI USB To Serial Breakout Board</a></li>
<li><a href="#connecting-the-breakout-board">23.6.2. Connecting The Breakout Board</a></li>
<li><a href="#accessing-the-serial-port-with-em-picocom-em">23.6.3. Accessing The Serial Port With <em>Picocom</em></a></li>
<li><a href="#setting-default-environment-variables-for-u-boot">23.6.4. Setting Default Environment Variables For U-Boot</a></li>
</ul>
</li>
<li><a href="#setting-up-ethernet-communication-with-the-board">23.7. Setting Up Ethernet Communication With The Board</a></li>
</ul>
</li>
<li><a href="#lab-3-cross-compiling-the-kernel-and-booting-it-from-the-workstation">24. LAB 3 : Cross Compiling The Kernel And Booting It From The Workstation</a>
<ul class="sectlevel2">
<li><a href="#enabling-networking-to-speed-up-embedded-development">24.1. Enabling Networking To Speed Up Embedded Development</a></li>
<li><a href="#installing-the-prerequisites">24.2. Installing The Prerequisites</a></li>
<li><a href="#configuring-the-kernel-2">24.3. Configuring The Kernel</a></li>
<li><a href="#cross-compiling-the-kernel-2">24.4. Cross-compiling The Kernel</a>
<ul class="sectlevel3">
<li><a href="#clean-the-sources">24.4.1. Clean The Sources</a></li>
<li><a href="#build-zimage">24.4.2. Build zImage</a></li>
<li><a href="#build-uimage">24.4.3. Build uImage</a></li>
<li><a href="#generate-the-device-tree-binaries">24.4.4. Generate The Device Tree Binaries</a></li>
<li><a href="#copy-to-tftp-server-home-directory">24.4.5. Copy To TFTP Server Home Directory</a></li>
</ul>
</li>
<li><a href="#setting-up-the-nfs-server">24.5. Setting Up The NFS Server</a></li>
<li><a href="#boot-the-system">24.6. Boot The System</a>
<ul class="sectlevel3">
<li><a href="#setting-the-em-bootargs-em">24.6.1. Setting The <em>bootargs</em></a></li>
<li><a href="#explanation-of-the-bootargs">24.6.2. Explanation Of The Bootargs</a></li>
<li><a href="#download-the-kernel-image-and-device-tree-binary">24.6.3. Download The Kernel Image And Device Tree Binary</a></li>
<li><a href="#boot-the-kernel">24.6.4. Boot The Kernel</a></li>
<li><a href="#automating-the-boot-system">24.6.5. Automating The Boot System</a></li>
<li><a href="#halting-the-sytem-and-disconnecting-picocom">24.6.6. Halting The Sytem And Disconnecting Picocom</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#linux-kernel-modules">Linux Kernel Modules</a>
<ul class="sectlevel1">
<li><a href="#when-do-we-use-kernel-modules">25. When Do We Use Kernel Modules</a></li>
<li><a href="#determining-kernel-module-dependencies">26. Determining Kernel Module Dependencies</a></li>
<li><a href="#inserting-kernel-modules">27. Inserting Kernel Modules</a></li>
<li><a href="#removing-kernel-modules">28. Removing Kernel Modules</a></li>
<li><a href="#passing-parameters-to-modules">29. Passing Parameters To Modules</a></li>
<li><a href="#developing-kernel-modules">30. Developing Kernel Modules</a>
<ul class="sectlevel2">
<li><a href="#symbols-exported-to-modules">30.1. Symbols Exported To Modules</a></li>
<li><a href="#about-module-licenses">30.2. About Module Licenses</a></li>
<li><a href="#compiling-modules-out-of-tree">30.3. Compiling Modules Out Of Tree</a></li>
<li><a href="#compiling-modules-inside-of-the-kernel-tree">30.4. Compiling Modules Inside Of The  Kernel Tree</a></li>
<li><a href="#adding-parameters-to-kernel-modules">30.5. Adding Parameters To Kernel Modules</a></li>
</ul>
</li>
<li><a href="#lab-4-writing-kernel-modules">31. LAB 4 : Writing Kernel Modules</a>
<ul class="sectlevel2">
<li><a href="#starting-with-a-template-file">31.1. Starting With A Template File</a></li>
<li><a href="#adding-code-to-the-template">31.2. Adding Code To The Template</a>
<ul class="sectlevel3">
<li><a href="#searching-for-a-version-function-macro">31.2.1. Searching For A Version Function/MACRO</a></li>
<li><a href="#implementing-the-version-function-macro-into-the-module">31.2.2. Implementing The Version Function/MACRO Into The Module</a></li>
<li><a href="#testing-the-kernel-module">31.2.3. Testing The Kernel Module</a></li>
</ul>
</li>
<li><a href="#adding-a-parameter-to-the-module">31.3. Adding A Parameter To The Module</a></li>
<li><a href="#following-linux-coding-standards">31.4. Following Linux Coding Standards</a></li>
<li><a href="#adding-em-hello_version-em-to-the-kernel-sources">31.5. Adding <em>hello_version</em> To The Kernel Sources</a></li>
<li><a href="#create-a-kernel-patch">31.6. Create A Kernel Patch</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#linux-device-and-driver-model">Linux Device And Driver Model</a>
<ul class="sectlevel1">
<li><a href="#the-purpose-behind-having-a-device-model">32. The Purpose Behind Having A Device Model</a></li>
<li><a href="#interfaces-to-a-kernel-driver">33. Interfaces To A Kernel Driver</a></li>
<li><a href="#device-model-data-structures">34. Device Model Data Structures</a></li>
<li><a href="#bus-drivers">35. Bus Drivers</a>
<ul class="sectlevel2">
<li><a href="#usb-bus-as-an-example-of-a-bus-driver">35.1. USB Bus As An Example Of A Bus Driver</a></li>
<li><a href="#example-of-a-usb-device-driver">35.2. Example Of A USB Device Driver</a>
<ul class="sectlevel3">
<li><a href="#device-identification">35.2.1. Device Identification</a></li>
<li><a href="#driver-instantiation">35.2.2. Driver Instantiation</a></li>
<li><a href="#driver-registration-and-unregistration">35.2.3. Driver Registration And Unregistration</a></li>
<li><a href="#device-detection">35.2.4. Device Detection</a></li>
<li><a href="#probing-the-driver">35.2.5. Probing The Driver</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#platform-drivers">36. Platform Drivers</a>
<ul class="sectlevel2">
<li><a href="#serial-i-mx-as-an-example-of-a-platform-driver">36.1. Serial i.MX As An Example Of A Platform Driver</a></li>
<li><a href="#declaring-platform-devices-in-source-code">36.2. Declaring Platform Devices In Source Code</a></li>
<li><a href="#accessing-resources">36.3. Accessing Resources</a></li>
<li><a href="#accessing-platform-data">36.4. Accessing Platform Data</a></li>
<li><a href="#device-tree-2">36.5. Device Tree</a></li>
<li><a href="#an-example-of-device-tree">36.6. An Example Of Device Tree</a></li>
<li><a href="#device-tree-bindings">36.7. Device Tree Bindings</a></li>
</ul>
</li>
<li><a href="#sysfs">37. sysfs</a></li>
<li><a href="#the-i2c-subsystem">38. The I2C Subsystem</a>
<ul class="sectlevel2">
<li><a href="#registering-an-i2c-driver">38.1. Registering An I2C Driver</a></li>
<li><a href="#registering-an-i2c-device-non-dt-approach">38.2. Registering An I2C Device, non-DT Approach</a></li>
<li><a href="#registering-an-i2c-device-dt-approach">38.3. Registering An I2C Device, DT Approach</a></li>
<li><a href="#i2c-device-driver-un-registration">38.4. I2C Device Driver (Un)Registration</a></li>
</ul>
</li>
<li><a href="#lab-5-linux-device-model-for-an-i2c-device">39. LAB 5 : Linux Device Model For An I2C Device</a>
<ul class="sectlevel2">
<li><a href="#creating-a-new-branch">39.1. Creating A New Branch</a></li>
<li><a href="#about-the-nunchuck">39.2. About The Nunchuck</a></li>
<li><a href="#update-the-board-device-tree">39.3. Update The Board Device Tree</a>
<ul class="sectlevel3">
<li><a href="#declaring-a-second-i2c-bus">39.3.1. Declaring A Second I2C Bus</a></li>
<li><a href="#declaring-the-nunchuck-device">39.3.2. Declaring The Nunchuck Device</a></li>
</ul>
</li>
<li><a href="#implement-a-basic-i2c-driver-for-the-nunchuck">39.4. Implement A Basic I2C Driver For The Nunchuck</a>
<ul class="sectlevel3">
<li><a href="#compiling-the-em-nunchuck-em-driver">39.4.1. Compiling The <em>nunchuck</em> Driver</a></li>
<li><a href="#testing-the-em-nunchuck-em-driver">39.4.2. Testing The <em>nunchuck</em> Driver</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#communicating-with-the-i2c-device">40. Communicating With The I2C Device</a>
<ul class="sectlevel2">
<li><a href="#raw-api">40.1. Raw API</a></li>
<li><a href="#message-transfer-api">40.2. Message Transfer API</a></li>
<li><a href="#smbus-calls">40.3. SMBus Calls</a>
<ul class="sectlevel3">
<li><a href="#list-of-smbus-api">40.3.1. List Of SMBus API</a></li>
</ul>
</li>
<li><a href="#i2c-functionality">40.4. I2C Functionality</a></li>
</ul>
</li>
<li><a href="#pin-muxing">41. Pin Muxing</a>
<ul class="sectlevel2">
<li><a href="#device-tree-binding-for-consumer-devices">41.1. Device Tree Binding For Consumer Devices</a>
<ul class="sectlevel3">
<li><a href="#pinctrl-client-devices">41.1.1. Pinctrl Client Devices</a></li>
<li><a href="#pin-controller-devices">41.1.2. Pin Controller Devices</a></li>
</ul>
</li>
<li><a href="#example-on-omap-am33xx">41.2. Example On OMAP / AM33xx</a></li>
</ul>
</li>
<li><a href="#lab-6-communicating-with-the-nunchuck">42. LAB 6 : Communicating With The Nunchuck</a>
<ul class="sectlevel2">
<li><a href="#connecting-the-nunchuck">42.1. Connecting The Nunchuck</a></li>
<li><a href="#configuring-pin-muxing-configuration-for-i2c1">42.2. Configuring Pin Muxing Configuration For I2C1</a></li>
<li><a href="#add-em-pinctrl-em-properties-to-the-device-tree">42.3. Add <em>pinctrl</em> Properties To The Device Tree</a></li>
<li><a href="#i2c-bus-tests">42.4. I2C Bus Tests</a></li>
<li><a href="#nunchuck-device-initialization">42.5. Nunchuck Device Initialization</a></li>
<li><a href="#read-nunchuck-registers">42.6. Read Nunchuck Registers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#kernel-frameworks">Kernel Frameworks</a>
<ul class="sectlevel1">
<li><a href="#user-space-inteface-to-devices">43. User Space Inteface To Devices</a>
<ul class="sectlevel2">
<li><a href="#major-minor-numbers">43.1. Major &amp; Minor Numbers</a></li>
<li><a href="#devices-are-files">43.2. Devices Are Files</a></li>
<li><a href="#creating-device-files">43.3. Creating Device Files</a></li>
</ul>
</li>
<li><a href="#character-drivers">44. Character Drivers</a>
<ul class="sectlevel2">
<li><a href="#file-operations">44.1. File Operations</a></li>
</ul>
</li>
<li><a href="#exchanging-data-with-user-space">45. Exchanging Data With User Space</a>
<ul class="sectlevel2">
<li><a href="#zero-copy-access-to-user-space">45.1. Zero Copy Access To User Space</a></li>
</ul>
</li>
<li><a href="#input-subsystem-a-framework-example">46. Input Subsystem, A Framework Example</a>
<ul class="sectlevel2">
<li><a href="#input-subsystem-overview">46.1. Input Subsystem Overview</a>
<ul class="sectlevel3">
<li><a href="#input-subsystem-api-for-allocation-and-deallocation">46.1.1. Input Subsystem API For Allocation And Deallocation</a></li>
<li><a href="#input-subsystem-api-for-registration-and-deregistration">46.1.2. Input Subsystem API For Registration And Deregistration</a></li>
<li><a href="#input-subsystem-api-for-injecting-events">46.1.3. Input Subsystem API For Injecting Events</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">This document is under active development!</div>
<div class="paragraph">
<p>If you find errors or omissions in this document, please don&#8217;t hesitate to <a href="mailto:conrad.s.j.gomes@gmail.com">send me a mail</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This journal assumes you are comfortable with a linux environment as most of the
published work here uses an Ubuntu distribution as the work station.</p>
</div>
</div>
</div>
<h1 id="introduction" class="sect0"><a class="anchor" href="#introduction"></a>Introduction</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This journal was started in order to document my exploration of embedded linux
using a popular low-cost platform i.e. the BeagleBone Black. The end objective
is to become well versed with embedded linux development on an ARM based embedded
device.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="about-the-linux-kernel"><a class="anchor" href="#about-the-linux-kernel"></a>1. About The Linux Kernel</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
I&#8217;m doing a (free) operating system (just a hobby, won&#8217;t be big and
professional like gnu) for 386(486) AT clones. This has been brewing
since April and is starting to get ready. I&#8217;d like any feedback on things
people like/dislike in minix, as my OS resembles it somewhat (same physical
layout of the file-system (due to practical reasons) among other things).
</blockquote>
<div class="attribution">
&#8212; Linus Torvald: 25th August 1991
</div>
</div>
<div class="paragraph">
<p>The Linux kernel started off as a hobby project and by a Finnish
national Linus Torvalds. It is today the OS powering the largest number of
computers on the planet. It is used in phones, tablets, laptops, netbooks,
routers, desktops, servers, supercomputers, embedded devices, consumer
electronics, etc.</p>
</div>
<div class="paragraph">
<p>The development of the Linux kernel is carried out by an army of dynamic
open source developers, the majority of which comprise of hobbyists.
Significant contribution to the kernel is now coming from companies using
the kernel. The development is still spearheaded by Linus who is employed
by the <a href="http://www.linuxfoundation.org/" target="_blank">Linux Foundation</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="about-beagleboard"><a class="anchor" href="#about-beagleboard"></a>2. About BeagleBoard</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://beagleboard.org/" target="_blank">BeagleBoard.org Foundation</a> is a non-profit corporation which
promotes open source software and open hardware. It was started by enthusiasts
from TI with the aim of providing a powerful platform to design embedded solutions.
The BeagleBone Black is their fourth board till date which offers a lot of
possibilities in a small credit card size form factor.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="about-free-electrons"><a class="anchor" href="#about-free-electrons"></a>3. About Free Electrons</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="http://free-electrons.com/" target="_blank">Free Electrons</a> is an engineering company consisting of
embedded linux experts who support companies using Embedded Linux. They
additionally conduct training workshops for companies on different topics
such as Linux kernel and device driver development, Android system development,
Yocto Project and OpenEmbedded development, etc. This journal uses the Free
Electrons training material which they publish online to explore Embedded Linux
with the BeagleBone Black board from TI.</p>
</div>
</div>
</div>
<h1 id="training-and-workbench-setup" class="sect0"><a class="anchor" href="#training-and-workbench-setup"></a>Training and Workbench Setup</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This section covers the setup software and hardware used in this journal.
The sources of the training material and references are mentioned as well
as details about how to procure the hardware.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="hardware"><a class="anchor" href="#hardware"></a>4. Hardware</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="beaglebone-black"><a class="anchor" href="#beaglebone-black"></a>4.1. BeagleBone Black</h3>
<div class="paragraph">
<p>The BeagleBone Black is the newest member in the BeagleBoard family. The board
is designed to be a low sized small form factor board. The size of the board
is comparable to the size of a credit card and it offers expansion headers to
add headers called as capes similar to the <a href="http://www.raspberrypi.org/" target="_blank">Raspberry Pi</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-BeagleBoneBlackREV_A5A" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/BeagleBoneBlackREV_A5A.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/BeagleBoneBlackREV_A5A.jpg" alt="BeagleBoneBlackREV A5A" width="640" height="480"></a>
</div>
<div class="title">Beagle Bone Black Revision A5A Board</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The table below highlights the key onboard components of the board along with
the connectors available on the board. The diagram of the table below is taken
from the <a href="../docs/BBB_SRM.pdf" target="_blank">BeagleBone Black System Reference Manual</a>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-BeagleBoneBlackFeatures" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/BeagleBoneBlackFeatures.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/BeagleBoneBlackFeatures.jpg" alt="BeagleBoneBlackFeatures" width="640" height="480"></a>
</div>
<div class="title">Beagle Bone Black Feature Table</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="software"><a class="anchor" href="#software"></a>5. Software</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="ubuntu"><a class="anchor" href="#ubuntu"></a>5.1. Ubuntu</h3>
<div class="paragraph">
<p>To work with an embedded system you need a work station on which you can
perform the various tasks that are required in the development life cycle.
These tasks include:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Editing your build scripts and source code</p>
</li>
<li>
<p>Cross-compiling your source code for the embedded target</p>
</li>
<li>
<p>Transferring or accessing the cross-compiled application and libraries
to or from the embedded target</p>
</li>
<li>
<p>Collecting debug information from the target</p>
</li>
<li>
<p>Communicating with the target remotely using its interfaces like
serial, USB, network, etc..</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In this document we use the popular Debian based Linux operating system,
<a href="http://www.ubuntu.com/">Ubuntu</a> as our work station for all the tasks listed above.
Ubuntu can be easily downloaded and installed on any PC or laptop.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Do not use a virtual machine runnning Ubuntu as your workstation</div>
<div class="paragraph">
<p>This document uses Ubuntu 14.04 running on a HP laptop. Use of a similar
environment through a virtual machine runnning on <a href="http://www.vmware.com" target="_blank">VMWare</a> or
<a href="https://www.virtualbox.org/" target="_blank">Oracle VirtualBox</a> is
not recommended.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="git"><a class="anchor" href="#git"></a>5.2. GIT</h3>
<div class="paragraph">
<p>The source code management tool used by the Linux kernel community is
<a href="http://git-scm.com/" target="_blank">GIT</a>. To use GIT we need to install the packages required
on our work station using the Advanced Packaging Tool(APT) using a
command line terminal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ sudo apt-get install git gitk git-email</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the packages are successfully installed we will need to configure GIT with
some basic information about our name and email address</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ git config --global user.name Conrad Gomes
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ git config --global user.email conrad.s.j.gomes@gmail.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further infomation about GIT can be obtained at:<br>
<a href="http://git-scm.com/" target="_blank">http://git-scm.com/</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="free-electrons-linux-kernel-data"><a class="anchor" href="#free-electrons-linux-kernel-data"></a>5.3. Free Electrons Linux Kernel Data</h3>
<div class="paragraph">
<p>Since we are going through the training material provided by Free Electrons
we&#8217;ll need to download their slides and lab data from their website link:<br>
<a href="http://free-electrons.com/training/kernel/" target="_blank">http://free-electrons.com/training/kernel/</a></p>
</div>
<div class="paragraph">
<p>As Free Electrons continues to improve on their training material, this journal
will be based on the version available at the time of its writing:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="../free_electrons_linux_kernel/linux-kernel-slides.pdf" target="_blank">Slides</a></p>
</li>
<li>
<p><a href="../free_electrons_linux_kernel/linux-kernel-labs.pdf" target="_blank">Labs</a></p>
</li>
<li>
<p><a href="../free_electrons_linux_kernel/linux-kernel-labs.tar.xz" target="_blank">Lab Data</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
<h1 id="the-kernel-source-code" class="sect0"><a class="anchor" href="#the-kernel-source-code"></a>The Kernel Source Code</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This section covers details about the Linux Kernel source code. We will go through
the source code, its structure and characteristics.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="offical-and-unofficial-kernel-sources"><a class="anchor" href="#offical-and-unofficial-kernel-sources"></a>6. Offical and Unofficial Kernel Sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The official source of the Linux Kernel is available at:<br>
<a href="https://www.kernel.org/" target="_blank">https://www.kernel.org/</a></p>
</div>
<div class="paragraph">
<p>The sources present in this website do not represent the entire spectrum of
features and development that is taking place. Since the kernel is logically
divided into sub-systems, each sub-system is maintained by a designated
individual who has been involved with the sub-system and is trusted by Linus.
So when the merge window opens these individuals who are termed as "maintainers"
send pull requests to Linus to take in the patches from their repositories for
merging with the mainline kernel tree. In some cases if the subsystem is large
it may be divided into smaller subsystems which are managed by individuals
designated as "sub-maintainers".</p>
</div>
<div class="paragraph">
<p>The official development repository for some sub-systems are given below:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>MTD<br>
<strong>Website:</strong> <a href="http://www.linux-mtd.infradead.org/index.html" target="_blank">http://www.linux-mtd.infradead.org/index.html</a><br>
<strong>GIT:</strong> git://git.infradead.org/linux-mtd.git</p>
</li>
<li>
<p>MIPS<br>
<strong>Website:</strong> <a href="http://www.linux-mips.org/wiki/Main_Page" target="_blank">http://www.linux-mips.org/wiki/Main_Page</a><br>
<strong>GIT:</strong> git://git.linux-mips.org/pub/scm/ralf/linux.git</p>
</li>
<li>
<p>USB<br>
<strong>Website:</strong> <a href="http://www.linux-usb.org/" target="_blank">http://www.linux-usb.org/</a><br>
<strong>GIT:</strong> git://git.kernel.org/pub/scm/linux/kernel/git/gregkh/patches.git</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="cloning-the-linux-tree-with-git"><a class="anchor" href="#cloning-the-linux-tree-with-git"></a>6.1. Cloning the Linux Tree With GIT</h3>
<div class="paragraph">
<p>Now that GIT is present in the workstation we can get the main development tree
of the Linux kernel as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ git clone git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>And if you&#8217;re in a corporarte environment or if your firewall blocks out the
network port for <em>git</em> you can use <em>http</em> instead as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ git clone http://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>The whole process should take a while so you can go for a small coffee break
and come back. Comparitively using <em>git</em> is recommended as it is faster than
<em>http</em></p>
</div>
<div class="paragraph">
<p>If you happen to have a copy of the Linux GIT repository all you have to do
is pull in the latest changes</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ cd ~/git/linux
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git checkout master
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git pull</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once you have the Linux GIT repository you can pull the latest changes by
by running <em>git pull</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="using-stable-releases"><a class="anchor" href="#using-stable-releases"></a>6.2. Using Stable Releases</h3>
<div class="paragraph">
<p>Typically when we are developing a project we reuse multiple projects to build
our application on top of. Similarly since we will be learing about Embedded
Linux we cannot use the tip of the tree as it is the latest but not the stablest
version of the kernel.</p>
</div>
<div class="paragraph">
<p>With GIT we don&#8217;t have to clone the whole repository all over again. Instead we
can add a reference to a remote tree to our existing clone and fetch all the
commits which are unique in that repository. As the <strong><em>stable</em></strong> release is
derived from the <strong><em>mainline</em></strong> tree we can add a remote to our repository as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git remote -v <i class="conum" data-value="1"></i><b>(1)</b>
origin        git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git (fetch)
origin        git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git (push)
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git remote add stable git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git remote -v
origin        git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git (fetch)
origin        git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git (push)
stable        git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git (fetch) <i class="conum" data-value="3"></i><b>(3)</b>
stable        git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git (push)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>git remote -v</em> lists the remotes. By default the git repository from which the repository was cloned will be the main remote</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>git remote add</em> adds a new remote with the name stable</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>git remote -v</em> lists the new added remote</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The last part is fetching the unique commits in the <strong><em>stable</em></strong> remote. This
command should take a while.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git fetch stable</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="why-are-the-sources-so-big"><a class="anchor" href="#why-are-the-sources-so-big"></a>7. Why Are The Sources So Big?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the reasons why cloning the kernel sources takes so long is that the
Linux Kernel source code is BIG. This is because the Kernel source code
contains many subsystems, frameworks, drivers, network protocols and supports
many different processor architectures.</p>
</div>
<div class="sect2">
<h3 id="size-comparison-of-different-kernel-source-directories"><a class="anchor" href="#size-comparison-of-different-kernel-source-directories"></a>7.1. Size Comparison of Different Kernel Source Directories</h3>
<div class="paragraph">
<p>If we check the disk usage per directory in the Linux Kernel source code we
get the distribution below. We&#8217;ll go through the type of source code in each
of those directories in a later section.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ du -s ./*/ | sort -nr
3084600        ./drivers/
723496        ./net/
589520        ./fs/
275636        ./arch/
260960        ./sound/
84020        ./kernel/
52264        ./security/
38628        ./include/
36340        ./crypto/
28968        ./Documentation/
27616        ./lib/
25984        ./mm/
17768        ./block/
8920        ./firmware/
8440        ./tools/
4356        ./scripts/
3760        ./ipc/
3720        ./init/
2596        ./virt/
248        ./samples/
92        ./usr/</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="programming-religion"><a class="anchor" href="#programming-religion"></a>8. Programming Religion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Linux Kernel is written primarily in C with a little assembly code too. The
source code is written in a version of C supported by Gnu Compiler Collection
or GCC. Therefore the Linux Kernel source can not be compiled with all C
compilers.</p>
</div>
<div class="paragraph">
<p>The assembly code comprises of small sections of code and is basically the
GCC&#8217;s "AT&amp;T-style" syntax of target architecture which will run the kernel.</p>
</div>
<div class="paragraph">
<p>Even though the Linux Kernel has certain frameworks designed with Object
Oriented Principles in mind it is not written in C. For further
understanding on why C is still not used please see the following link:
<a href="http://www.tux.org/lkml/#s15-3" target="_blank">http://www.tux.org/lkml/#s15-3</a></p>
</div>
<div class="paragraph">
<p>And on a lighter note &#8230;&#8203;</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>In fact, in Linux we did try C++ once already, back in 1992.</p>
</div>
<div class="paragraph">
<p>It sucks. Trust me - writing kernel code in C++ is a BLOODY STUPID IDEA.</p>
</div>
<div class="paragraph">
<p>The fact is, C++ compilers are not trustworthy. They were even worse in
1992, but some fundamental facts haven&#8217;t changed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the whole C++ exception handling thing is fundamentally broken. It&#8217;s
<em>especially</em> broken for kernels.</p>
</li>
<li>
<p>any compiler or language that likes to hide things like memory
allocations behind your back just isn&#8217;t a good choice for a kernel.</p>
</li>
<li>
<p>you can write object-oriented code (useful for filesystems etc) in C,
<em>without</em> the crap that is C++.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In general, I&#8217;d say that anybody who designs his kernel modules for C is
either
 (a) looking for problems
 (b) a C bigot that can&#8217;t see what he is writing is really just C anyway
 (c) was given an assignment in CS class to do so.</p>
</div>
<div class="paragraph">
<p>Feel free to make up (d).</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Linus Torvalds<br>
<cite>19 Jan 2004</cite>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="no-c-library"><a class="anchor" href="#no-c-library"></a>9. No C Library</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Linux Kernel is a single program which has its own routines to perform
common functions. It does not use any user space library like stdlib, rather
it has equivalent functions that enable it to achieve the same results.</p>
</div>
<div class="paragraph">
<p>In place of the standard C functions like printf(), memset(), malloc() there
are functions like printk(), memset(),kmalloc() in the source code.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="portability"><a class="anchor" href="#portability"></a>10. Portability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the Linux Kernel key features is portability and hardware support.
It supports a wide variety of architectures and to achieve this the source
code should be portable across architectures. The architecture specific code is
all located in the <em>arch/</em> directory. The remaining code in all the other
directories has to be portable across all architectures.</p>
</div>
<div class="paragraph">
<p>To achieve portability there are hardware abstraction API for specific
features:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Endianess</p>
<div class="ulist">
<ul>
<li>
<p>cpu_to_be32()</p>
</li>
<li>
<p>cpu_to_le32()</p>
</li>
<li>
<p>be32_to_cpu()</p>
</li>
<li>
<p>le32_to_cpu()</p>
</li>
</ul>
</div>
</li>
<li>
<p>I/O Memory Access</p>
</li>
<li>
<p>Memory barriers</p>
</li>
<li>
<p>DMA API to flush and invalidate caches</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Since the Linux Kernel is designed to run on any processor the use of floating
point expressions is not allowed. As an example consider the most popular embedded
architecture i.e. ARM, it does not have a floating point unit.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="linux-internal-api"><a class="anchor" href="#linux-internal-api"></a>11. Linux Internal API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the main reasons for having drivers in-tree i.e. present along with the
sources of the Linux Kernel is that the internal Linux API may be changed at
any point in time and if a change is proposed and implemented the developer
responsible for the API change will also have to take the ownership of changing
all the modules and drivers which use the changed API. In the case of an
out-of-tree driver the work will be owned by the driver owner and any time a
change occurs the driver will not compile with the latest kernel source code.</p>
</div>
<div class="paragraph">
<p>Having said that the Linux Kernel external API i.e. kernel to userspace API like
system calls, /proc, /sys does not change and is considered to protect the user
space applications who depend on it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="is-it-free"><a class="anchor" href="#is-it-free"></a>12. Is It Free?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Linux Kernel is licensed under GNU General Public License version 2. This
license defines the Linux Kernel as Free Software as defined by the
<a href="http://www.fsf.org/" target="_blank">Free Software Foundation</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If you redistribute the software you have to do so under the same license
irrespective of whether it is modified or unmodified.</p>
</li>
<li>
<p>If you make modifications to the Linux Kernel you have to release it under
the same license.</p>
</li>
<li>
<p>You only have to do so when your device with the kernel start getting
distributed</p>
</li>
<li>
<p>You only have to license it to your customers and not necessarily the whole
world.</p>
</li>
<li>
<p>It is illegal to distribute a binary kernel with statically compiled
proprietary drivers.</p>
</li>
<li>
<p>Proprietary drivers are frowned upon by the Linux Kernel community as it goes
against the philosophy of the GPL license.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advantages-of-gpl-drivers"><a class="anchor" href="#advantages-of-gpl-drivers"></a>13. Advantages Of GPL Drivers</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>It is possible to reuse software from other GPL drivers to write a new GPL
driver</p>
</li>
<li>
<p>A GPL driver has more contributors, testers, reviewers and maintainers
thereby making it more robust.</p>
</li>
<li>
<p>Once the driver is accepted it is easily shipped and distributed by
others who are using the Linux Kernel.</p>
</li>
<li>
<p>A pre-compiled driver will always have to catch up with the latest kernel
devlopments leaving users of the driver at a loss as they can&#8217;t upgrade
their kernel with ease in order to use the latest source with new features</p>
</li>
<li>
<p>Making a driver GPL compliant avoids any potential legal hastles</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="advantages-of-in-tree-kernel-drivers"><a class="anchor" href="#advantages-of-in-tree-kernel-drivers"></a>14. Advantages Of In-Tree Kernel Drivers</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Acceptance of a driver into the mainline kernel is a step that must be
done by developers who have developed a GPL compatible driver.</p>
</li>
<li>
<p>This allows the developer to release the ownership of maintaining the
kernel driver to the community. This reduces the cost of maintainence.</p>
</li>
<li>
<p>The source of the kernel driver is easily accessible by anyone, as the
kernel code is widely published.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-space-device-drivers"><a class="anchor" href="#user-space-device-drivers"></a>15. User Space Device Drivers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is possible to develop a user space device driver. There are several
scenarios in which a user space device driver is developed:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The device driver does not depend on any of the frameworks exposed by
the Linux Kernel.</p>
</li>
<li>
<p>The device driver is used by only one application and is not required
by any other application.</p>
</li>
<li>
<p>The kernel provides a simple interface with which the user space device
driver can control and read the hardware for which it is developed.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="examples-of-user-space-device-drivers"><a class="anchor" href="#examples-of-user-space-device-drivers"></a>15.1. Examples Of User Space Device Drivers</h3>
<div class="paragraph">
<p>Certain busses have interfaces exposed by the kernel which can be used to
develop a user space device driver if the hardware is connected to that
bus:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>USB with libusb, <a href="http://www.libusb.org/" target="_blank">http://www.libusb.org/</a></p>
</li>
<li>
<p>SPI wiht spidev, <a href="https://www.kernel.org/doc/Documentation/spi/spidev" target="_blank">Documentation/spi/spidev</a></p>
</li>
<li>
<p>I2C with i2cdev, <a href="https://www.kernel.org/doc/Documentation/i2c/dev-interface" target="_blank">Documentation/i2c/dev-interface</a></p>
</li>
<li>
<p>Memory-mapped devices with UIO, including interrupt handling, <a href="http://free-electrons.com/kerneldoc/latest/DocBook/uio-howto/" target="_blank">http://free-electrons.com/kerneldoc/latest/DocBook/uio-howto/</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>On certain SOCs the vendor also provides a user space device driver along with
a kernel driver which has access to other processors in the SOC which are
running a firmware for highly specialized applications.</p>
</div>
</div>
<div class="sect2">
<h3 id="the-good-and-the-bad-of-user-space-device-drivers"><a class="anchor" href="#the-good-and-the-bad-of-user-space-device-drivers"></a>15.2. The Good And The Bad Of User Space Device Drivers</h3>
<div class="paragraph">
<p>The Good</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The driver can be written in any programming language or script.</p>
</li>
<li>
<p>The driver can be kept proprietary.</p>
</li>
<li>
<p>The driver runs in user space as an application or daemon.</p>
</li>
<li>
<p>The driver cannot bring down the kernel.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The Bad</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Handling interrupts from the hardware is non-trivial resulting in some sort
of polling mechanism.</p>
</li>
<li>
<p>The interrupt latency is larger when compared to a kernel device driver.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-s-in-the-sources"><a class="anchor" href="#what-s-in-the-sources"></a>16. What&#8217;s In The Sources?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll briefly go through each of the sources in the Linux Source Code and try
to get an understanding of the overall structure of the source tree. Each
directory is a placeholder for certain code, scripts and files which serve
to make up the Linux Kernel project.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">arch/&lt;ARCH&gt;</dt>
<dd>
<p>Architecture specific code. All code that has anything to do with the
processor the kernel is running on is present in this directory</p>
<div class="ulist">
<ul>
<li>
<p>arch/&lt;ARCH&gt;/mach-&lt;machine&gt;, machine/board specific code</p>
</li>
<li>
<p>arch/&lt;ARCH&gt;/include/asm, architecture-specific headers</p>
</li>
<li>
<p>arch/&lt;ARCH&gt;boot/dts, Device Tree source files for certain architecture</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">block/</dt>
<dd>
<p>Code relate to block device drivers for hard disk drives and others</p>
</dd>
<dt class="hdlist1">COPYING</dt>
<dd>
<p>License of the Linux Kernel.</p>
</dd>
<dt class="hdlist1">CREDITS</dt>
<dd>
<p>Who Did what?</p>
</dd>
<dt class="hdlist1">crypto/</dt>
<dd>
<p>Cryptographic libraries</p>
</dd>
<dt class="hdlist1">Documentation/</dt>
<dd>
<p>Documentation for all things about the Linux Kernel</p>
</dd>
<dt class="hdlist1">drivers/</dt>
<dd>
<p>Device drivers except for sound which has its own directory below</p>
</dd>
<dt class="hdlist1">firmware/</dt>
<dd>
<p>Legacy: firmware images extracted from old drivers</p>
</dd>
<dt class="hdlist1">fs/</dt>
<dd>
<p>Source code for various filesystems (ext2/ubifs/etc..)</p>
</dd>
<dt class="hdlist1">include/</dt>
<dd>
<p>Kernel headers</p>
</dd>
<dt class="hdlist1">include/linux/</dt>
<dd>
<p>Linux Kernel core headers</p>
</dd>
<dt class="hdlist1">include/uapi/</dt>
<dd>
<p>User space API headers</p>
</dd>
<dt class="hdlist1">init/</dt>
<dd>
<p>Code related to the kernel initaliazation. Includes the main.c</p>
</dd>
<dt class="hdlist1">ipc/</dt>
<dd>
<p>Code responsible for allowing inter process communication</p>
</dd>
<dt class="hdlist1">Kbuild</dt>
<dd>
<p>Part of the build system</p>
</dd>
<dt class="hdlist1">Kconfig</dt>
<dd>
<p>Top level description file for configuration parameters</p>
</dd>
<dt class="hdlist1">kernel/</dt>
<dd>
<p>The core of the Linux Kernel</p>
</dd>
<dt class="hdlist1">lib/</dt>
<dd>
<p>Useful library routines (crc32&#8230;&#8203;)</p>
</dd>
<dt class="hdlist1">MAINTAINERS</dt>
<dd>
<p>Maintainers of different subsystems of the kernel</p>
</dd>
<dt class="hdlist1">Makefile</dt>
<dd>
<p>Top level makefile</p>
</dd>
<dt class="hdlist1">mm/</dt>
<dd>
<p>Memory management code</p>
</dd>
<dt class="hdlist1">net/</dt>
<dd>
<p>Network support code</p>
</dd>
<dt class="hdlist1">README</dt>
<dd>
<p>Overview and building instructions. Read once atleast.</p>
</dd>
<dt class="hdlist1">REPORTING-BUGS</dt>
<dd>
<p>Procedure to report bugs with the Linux Kernel</p>
</dd>
<dt class="hdlist1">samples/</dt>
<dd>
<p>Sample code of usage of frameworks and kernel code</p>
</dd>
<dt class="hdlist1">scripts/</dt>
<dd>
<p>Useful scripts for internal or external use</p>
</dd>
<dt class="hdlist1">security/</dt>
<dd>
<p>Support for security features like SELinux</p>
</dd>
<dt class="hdlist1">sound/</dt>
<dd>
<p>Sound support code and drivers</p>
</dd>
<dt class="hdlist1">tools/</dt>
<dd>
<p>Code for various user space tools</p>
</dd>
<dt class="hdlist1">usr/</dt>
<dd>
<p>Code to generate an initramfs cpio archive file</p>
</dd>
<dt class="hdlist1">virt/</dt>
<dd>
<p>Virtualization support (KVM)</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="browsing-the-sources"><a class="anchor" href="#browsing-the-sources"></a>17. Browsing The Sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the most common tasks required by any developer is the ability to browse
a project and search for:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A specific symbol such as a function name or variable name</p>
</li>
<li>
<p>The calling function of a function</p>
</li>
<li>
<p>The function definition using a function call point</p>
</li>
<li>
<p>An include file in the project from its declaration in source code</p>
</li>
<li>
<p>A pattern of text</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="cscope"><a class="anchor" href="#cscope"></a>17.1. Cscope</h3>
<div class="paragraph">
<p>One such tool is Cscope which allows us to browse the Linux source code with ease
from editors like vim, emacs and also independently using only cscope.</p>
</div>
</div>
<div class="sect2">
<h3 id="lxr"><a class="anchor" href="#lxr"></a>17.2. LXR</h3>
<div class="paragraph">
<p>This is a generic indexing tool and code browser which is available as a web
service. It supports both C and C++ and it makes it easy to search for
declarations, definitions  and symbols. A good examples of LXR with the Linux
Kernel in action is through the <a href="http://lxr.free-electrons.com" target="_blank">Free Electrons LXR Site</a>
and further information abouit LXR can be obtained from its
<a href="http://sourceforge.net/projects/lxr" target="_blank">sourceforge page</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lab-1-getting-accustomed-to-browsing-the-sources"><a class="anchor" href="#lab-1-getting-accustomed-to-browsing-the-sources"></a>18. LAB 1 : Getting Accustomed To Browsing The Sources</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">This is a hands on session taken from the Free Electrons labs with the following objectives</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Create a branch based on a remote tree to explore a particular stable kernel
version (from the stable kernel tree).</p>
</li>
<li>
<p>Explore the sources in search for files, function headers or other kinds of
information. . .</p>
</li>
<li>
<p>Browse the kernel sources with tools like cscope and LXR.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="creating-a-branch-to-a-particular-stable-kernel-version"><a class="anchor" href="#creating-a-branch-to-a-particular-stable-kernel-version"></a>18.1. Creating A Branch To A Particular Stable Kernel Version</h3>
<div class="paragraph">
<p>In order to get the list of branches on our stable remote tree we have to
enter the Linux Kernel source tree and use the <em>git branch</em> command as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ cd ~/git/linux
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git branch -a
* master        <i class="conum" data-value="1"></i><b>(1)</b>
  remotes/origin/HEAD -&gt; origin/master
  remotes/origin/master
  remotes/stable/linux-2.6.11.y                <i class="conum" data-value="2"></i><b>(2)</b>
  remotes/stable/linux-2.6.12.y
.
.
  remotes/stable/linux-3.9.y
  remotes/stable/master</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our source code is currently pointing to the master branch</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Remote stable branch remotes/stable/linux-2.6.11.y</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will be working with the 3.13 stable branch and so we will use the remote
branch <strong><em>remotes/stable/linux-3.13.y</em></strong> from the list of branches displayed.</p>
</div>
<div class="paragraph">
<p>Before we do anything let us check the version of our <strong><em>master</em></strong> branch using
the top level Makefile in the source code. Using <em>vim</em> or your favourite editor
or head examine the first few lines of the Makefile</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ head Makefile
VERSION = 3
PATCHLEVEL = 18
SUBLEVEL = 0
EXTRAVERSION = -rc4
NAME = Diseased Newt
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can see the version of our <em>master</em> branch is at 3.18.0 -rc4 and the name
of the release is "Diseased Newt". Now let us create a local branch starting
from the stable remote branch of 3.13.y. The following command uses
<em>git checkout</em> to checkout the stable remote branch <em>stable/linux-3.13.y</em> as
a local branch with the name <em>3.13.y</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git checkout -b 3.13.y stable/linux-3.13.y        <i class="conum" data-value="1"></i><b>(1)</b>
Checking out files: 100% (27044/27044), done.
Branch 3.13.y set up to track remote branch linux-3.13.y from stable.
Switched to a new branch '3.13.y'        <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git branch -a        <i class="conum" data-value="3"></i><b>(3)</b>
* 3.13.y        <i class="conum" data-value="4"></i><b>(4)</b>
  master
  remotes/origin/HEAD -&gt; origin/master
  remotes/origin/master
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to checkout the stable remote branch as a local branch</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The switch to the new branch takes place successfully</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We list all the branches again</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The git repository now points to the <em>3.13.y</em> local branch</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Once again let us examine the first few lines of the top level Makefile. We can
now see the version is at 3.13.11 and the name of the release is
"One Giant Leap for Frogkind". So we have successfully managed to create a
branch pointing to a stable release of the Linux Kernel source code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ head Makefile
VERSION = 3
PATCHLEVEL = 13
SUBLEVEL = 11
EXTRAVERSION =
NAME = One Giant Leap for Frogkind
.
.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="searching-tools"><a class="anchor" href="#searching-tools"></a>18.2. Searching Tools</h3>
<div class="paragraph">
<p>There are several tools that can be used to browse the kernel code and search.
We will demonstrate the commands used with examples taken from the labs.</p>
</div>
<div class="sect3">
<h4 id="using-find"><a class="anchor" href="#using-find"></a>18.2.1. Using Find</h4>
<div class="paragraph">
<p>The <em>find</em> utility can be used to search for a specific file name. The only
catch being the name or pattern of the file needs to be known. For instance
say you want to locate the logo of Linux in the source code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ find . -name &quot;*.gif&quot; -o -name &quot;*.jpg&quot; -o -name &quot;*.png&quot; -type f
./Documentation/logo.gif</code></pre>
</div>
</div>
<div class="paragraph">
<p>We use popular file formats to locate pictures in the source code and
coincidentally there is one file in the <em>Documentation</em> directory with the
name <em>logo.gif</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-git-grep"><a class="anchor" href="#using-git-grep"></a>18.2.2. Using Git-Grep</h4>
<div class="paragraph">
<p>The <em>git-grep</em> command can be used to search within a git project. For instance
if we want to search for the name of the maintainer of MVNETA network driver we
would use it as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git grep MVNETA                <i class="conum" data-value="1"></i><b>(1)</b>
MAINTAINERS:MARVELL MVNETA ETHERNET DRIVER                         <i class="conum" data-value="2"></i><b>(2)</b>
arch/arm/configs/mvebu_defconfig:CONFIG_MVNETA=y
drivers/net/ethernet/marvell/Kconfig:     This driver is used by the MV643XX_ETH and MVNETA drivers.
drivers/net/ethernet/marvell/Kconfig:config MVNETA
.
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We search for MVNETA with <em>git grep</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We get the maintainers as MARVELL for MVNETA ETHERNET DRIVER</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To get line numbers for the references of the regex being searched we have
to set the environment for git. This can be done locally (--local) specific
to the git project or globally(--global) for all git projects on the workstation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git config --local grep.lineNumber true                <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enabling line numbers in the search in my local linux git clone</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to search in a specific branch of the project with
<em>git-grep</em>. For instance let us try to find the <em>platform_device_register</em>
function in all header files in the linux project in the branch
<em>remotes/stable/linux-3.7.y</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git grep -e platform_device_register remotes/stable/linux-3.7.y -- '*.h'         <i class="conum" data-value="1"></i><b>(1)</b>
remotes/stable/linux-3.7.y:arch/arm/mach-ux500/devices-common.h:99:     return platform_device_register_full(&amp;pdevinfo);
remotes/stable/linux-3.7.y:arch/arm/mach-ux500/devices-common.h:123:    return platform_device_register_full(&amp;pdevinfo);
remotes/stable/linux-3.7.y:arch/arm/mach-ux500/devices-common.h:140:    platform_device_register_full(&amp;pdevinfo);
remotes/stable/linux-3.7.y:arch/arm/mach-ux500/devices-db8500.h:26:     return platform_device_register_resndata(parent, &quot;nmk-ske-keypad&quot;, -1,
remotes/stable/linux-3.7.y:arch/arm/plat-mxc/include/mach/devices-common.h:31:  return platform_device_register_full(&amp;pdevinfo);
remotes/stable/linux-3.7.y:include/linux/platform_device.h:43:extern int platform_device_register(struct platform_device *);                <i class="conum" data-value="2"></i><b>(2)</b>
remotes/stable/linux-3.7.y:include/linux/platform_device.h:69:extern struct platform_device *platform_device_register_full(
remotes/stable/linux-3.7.y:include/linux/platform_device.h:73: * platform_device_register_resndata - add a platform-level device with
remotes/stable/linux-3.7.y:include/linux/platform_device.h:86:static inline struct platform_device *platform_device_register_resndata(
remotes/stable/linux-3.7.y:include/linux/platform_device.h:102: return platform_device_register_full(&amp;pdevinfo);
remotes/stable/linux-3.7.y:include/linux/platform_device.h:106: * platform_device_register_simple - add a platform-level device and its resources
remotes/stable/linux-3.7.y:include/linux/platform_device.h:127:static inline struct platform_device *platform_device_register_simple(
remotes/stable/linux-3.7.y:include/linux/platform_device.h:131: return platform_device_register_resndata(NULL, name, id,
remotes/stable/linux-3.7.y:include/linux/platform_device.h:136: * platform_device_register_data - add a platform-level device with platform-specific data
remotes/stable/linux-3.7.y:include/linux/platform_device.h:151:static inline struct platform_device *platform_device_register_data(
remotes/stable/linux-3.7.y:include/linux/platform_device.h:155: return platform_device_register_resndata(parent, name, id,</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Expression searches for <em>platform_device_register</em> declaration in <em>remotes/stable/linux-3.7.y</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The function is declared on line 43 in <em>include/linux/platform_device.h</em> in the branch <em>linux-3.7.y</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we compare it to one of the older stable branches of <em>remotes/stable/linux-2.6.11.y</em>
we get fewer header files with reference to the function name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/git/linux$ git grep -e platform_device_register remotes/stable/linux-2.6.11.y -- '*.h'        <i class="conum" data-value="1"></i><b>(1)</b>
remotes/stable/linux-2.6.11.y:include/asm-ppc/ppc_sys.h:54:/* Update all memory resources by paddr, call before platform_device_register */
remotes/stable/linux-2.6.11.y:include/asm-ppc/ppc_sys.h:58:/* Get platform_data pointer out of platform device, call before platform_device_register */
remotes/stable/linux-2.6.11.y:include/linux/device.h:380:extern int platform_device_register(struct platform_device *);                        <i class="conum" data-value="2"></i><b>(2)</b>
remotes/stable/linux-2.6.11.y:include/linux/device.h:392:extern struct platform_device *platform_device_register_simple(char *, unsigned int, struct resource *, unsigned int);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Expression searches for <em>platform_device_register</em> declaration in <em>remotes/stable/linux-2.6.11.y</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The function is declared on line 380 in <em>include/linux/platform_device.h</em> in the branch <em>linux-2.6.11.y</em></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="using-linux-cross-reference"><a class="anchor" href="#using-linux-cross-reference"></a>18.2.3. Using Linux Cross Reference</h4>
<div class="paragraph">
<p>We can make use of an automated tool like Linux Cross Reference or
LXR as well:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Identifier search: <a href="http://lxr.free-electrons.com/ident" target="_blank">http://lxr.free-electrons.com/ident</a></p>
</li>
<li>
<p>Free text search: <a href="http://lxr.free-electrons.com/search">http://lxr.free-electrons.com/search</a></p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-the-kernel"><a class="anchor" href="#configuring-the-kernel"></a>19. Configuring The Kernel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The kernel source code contains code to support many filesystems, device
drivers, network protocols, architectures, etc. The source code can be
configured to chose which features are required based on the type of
applications that will be run in user space.</p>
</div>
<div class="paragraph">
<p>Additionally the kernel configuration will also support test code that
may be run to validate device drivers in the system. For example the
MTD system has several kernel modules which can be loaded to validate
the implementation of the mtd device driver code for the flash storage
in the system.</p>
</div>
<div class="paragraph">
<p>To support this type of configuration there are a series of Makefiles
present in the kernel source code. However to start the configuraton
and build we would only be required to work with the top level
<em>Makefile</em>.</p>
</div>
<div class="paragraph">
<p>There are various targets defined in the top level Makefile which can
control the configuration, build and installation of the Linux kernel.</p>
</div>
<div class="paragraph">
<p>To get a sense of the number of targets available we can run <em>make help</em>
to see all the targets.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make help | head
Cleaning targets:
  clean                  - Remove most generated files but keep the config and
                    enough build support to build external modules
  mrproper          - Remove all generated files + config + various backup files
  distclean          - mrproper + remove editor backup and patch files

Configuration targets:
  config          - Update current config utilising a line-oriented program
  nconfig         - Update current config utilising a ncurses menu based program
  menuconfig          - Update current config utilising a menu based program
.
.
.</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="kernel-configuration"><a class="anchor" href="#kernel-configuration"></a>19.1. Kernel Configuration</h3>
<div class="paragraph">
<p>The process of configuring the Linux Kernel includes modifying the
configuration file located at the root of the source code. This file
is named <em>.config</em>. The dot at the beginning of the file name indicates
that it is a hidden file.</p>
</div>
<div class="paragraph">
<p>The syntax of this file is in the form of simple key value pairs as shown
in the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ head .config        <i class="conum" data-value="1"></i><b>(1)</b>
#
# Automatically generated file; DO NOT EDIT.
# Linux/x86 3.12.0-rc7 Kernel Configuration
#
# CONFIG_64BIT is not set                <i class="conum" data-value="2"></i><b>(2)</b>
CONFIG_X86_32=y
CONFIG_X86=y
CONFIG_INSTRUCTION_DECODER=y
CONFIG_OUTPUT_FORMAT=&quot;elf32-i386&quot;
CONFIG_ARCH_DEFCONFIG=&quot;arch/x86/configs/i386_defconfig&quot;
.
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to display the first lines of the <em>.config</em> file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>#</em> is used to comment out key values in the configuration file</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An important point to note is that because options have dependencies it is
not advisable to edit the <em>.config</em> file by hand. Preferably use the available
configuration interfaces.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Graphical Interfaces</dt>
<dd>
<p><em>make xconfig</em> OR <em>make gconfig</em></p>
</dd>
<dt class="hdlist1">Text/Shell Interfaces</dt>
<dd>
<p><em>make menuconfig</em> OR <em>make nconfig</em></p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It doesn&#8217;t make any difference which is used and we can shift between either
of the interfaces as they all edit the same <em>.config</em> file.</p>
</div>
<div class="sect3">
<h4 id="kernel-configuration-in-the-system"><a class="anchor" href="#kernel-configuration-in-the-system"></a>19.1.1. Kernel Configuration In The System</h4>
<div class="paragraph">
<p>The configuration of a GNU/Linux distribution is usually present along with the
kernel image in the <em>/boot/</em> directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ uname -r                <i class="conum" data-value="1"></i><b>(1)</b>
3.13.0-45-generic                                                        <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ ls -l /boot/config-3.13.0-45-generic         <i class="conum" data-value="3"></i><b>(3)</b>
-rw-r--r-- 1 root root 169818 Jan 14 01:53 /boot/config-3.13.0-45-generic                        <i class="conum" data-value="4"></i><b>(4)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>uname -r</em> is the command to get the kernel running on the system</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The kernel running is <em>3.13.0-45-generic</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Listing the configuration file of this kernel in <em>/boot/</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The configuration file is <em>config-3.13.0-45-generic</em></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-features-as-modules"><a class="anchor" href="#configuring-features-as-modules"></a>19.2. Configuring Features As Modules</h3>
<div class="paragraph">
<p>Upon configuring the kernel source and completion of the build we get
a single image which represents the kernel and all the features it is
configured for. However it is possible to configure some of the features
such as device drivers, filesystems, driver tests, etc. as separate
entities called <strong>kernel modules</strong>.</p>
</div>
<div class="paragraph">
<p>By configuring certain features as modules we are able to keep the size
of the kernel to a minimum. Kernel modules can be loaded from user space
to support certain applications on execution or on insertion of certain
devices into the system buses like USB, PCI, etc..</p>
</div>
<div class="paragraph">
<p>Therefore in the configuration of certain features it is possible to select
if the feature needs to be compiled as a kernel module. All kernel modules
will have to be stored in a file system and will have to be loaded into the
running kernel by some user space application or script.</p>
</div>
<div class="paragraph">
<p>An important point to note in choosing if a feature should be compiled as
a module is the latency with which the feature needs to be activated from
boot of the system. As the kernel module is stored in a filesystem, it will
not be loadable until the filesystem is mounted in the kernel.</p>
</div>
</div>
<div class="sect2">
<h3 id="kernel-option-types"><a class="anchor" href="#kernel-option-types"></a>19.3. Kernel Option Types</h3>
<div class="paragraph">
<p>When selecting different features and configuring the kernel we come across
different types based on the information required to complete the
configuration.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">bool</dt>
<dd>
<p><em>true</em> or <em>false</em> to indicate presence or absence of the feature
respectively.</p>
</dd>
<dt class="hdlist1">tristate</dt>
<dd>
<p><em>true</em> or <em>false</em> similar to bool option types and also a third
state i.e. <em>module</em> to indicate it is a kernel module.</p>
</dd>
<dt class="hdlist1">int</dt>
<dd>
<p>If an integer value is required in the configuration of the feature.</p>
</dd>
<dt class="hdlist1">hex</dt>
<dd>
<p>If a hexadecimal value is required in the configuration of the feature.</p>
</dd>
<dt class="hdlist1">string</dt>
<dd>
<p>If a string value is requried in the configuration of the feature.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="kernel-option-dependencies"><a class="anchor" href="#kernel-option-dependencies"></a>19.4. Kernel Option Dependencies</h3>
<div class="paragraph">
<p>There will be dependencies between different kernel objects. To describe
the dependency there are two types:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">depends on dependencies</dt>
<dd>
<p>The option that is dependent on another remains
invisible until the later is enabled.</p>
</dd>
<dt class="hdlist1">select dependencies</dt>
<dd>
<p>The option on selection automatically selects the
object on which it depends on in the configuration.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="graphical-configuration-interface-em-xconfig-em"><a class="anchor" href="#graphical-configuration-interface-em-xconfig-em"></a>19.5. Graphical Configuration Interface <em>xconfig</em></h3>
<div class="paragraph">
<p>The xconfig configuration utitlity which uses Qt is invoked when running
<em>make xconfig</em> in the root directory. If we try to invoke it we get the
following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ cd ~/Git/linux
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make xconfig
  CHECK   qt                                                                <i class="conum" data-value="1"></i><b>(1)</b>
* Unable to find the QT4 tool qmake. Trying to use QT3
*
* Unable to find any QT installation. Please make sure that
* the QT4 or QT3 development package is correctly installed and
* either qmake can be found or install pkg-config or set
* the QTDIR environment variable to the correct location.                <i class="conum" data-value="2"></i><b>(2)</b>
*
make[1]: *** No rule to make target `scripts/kconfig/.tmp_qtcheck', needed by `scripts/kconfig/qconf.o'.  Stop.
make: *** [xconfig] Error 2
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The target rule checks for qt</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A nice description of what is probably wrong with our Ubuntu distribution</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Ok we need to install Qt in our system. The dependencies are <em>libqt4-dev</em>
and <em>g++</em>. For older kernel sources the dependencies are <em>libqt3-mt-dev</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ sudo apt-get install libqt4-dev g++        <i class="conum" data-value="1"></i><b>(1)</b>
Reading package lists... Done
Building dependency tree
Reading state information... Done
.
.
.
Setting up libqtwebkit-dev (2.3.2-0ubuntu7) ...
Processing triggers for libc-bin (2.19-0ubuntu6.5) ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Installing the prerequisites</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again we try running <em>make xconfig</em> and see the graphical interface as shown
in the screen capture below:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-make-xconfig-screenshot" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/make-xconfig-screenshot.png"><img src="http://zeuzoix.github.io/techeuphoria/images/make-xconfig-screenshot.png" alt="make xconfig screenshot" width="640" height="480"></a>
</div>
<div class="title">Screenshot of xconfig interface</div>
</div>
</div>
</div>
<div class="paragraph">
<p>It is possible to search for a particular feature using the search interface.
This can be invoked with a <strong>CTRL + F</strong> keyboard combination.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-make-xconfig-search" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/make-xconfig-search-imx.png"><img src="http://zeuzoix.github.io/techeuphoria/images/make-xconfig-search-imx.png" alt="make xconfig search imx" width="640" height="480"></a>
</div>
<div class="title">Screenshot of xconfig search</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="graphical-configuration-interface-em-gconfig-em"><a class="anchor" href="#graphical-configuration-interface-em-gconfig-em"></a>19.6. Graphical Configuration Interface <em>gconfig</em></h3>
<div class="paragraph">
<p>Another graphical interface is the <em>gconfig</em> target.This GTK based configuration
gives the following error when we invoke it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make gconfig                <i class="conum" data-value="1"></i><b>(1)</b>
*
* Unable to find the GTK+ installation. Please make sure that
* the GTK+ 2.0 development package is correctly installed...
* You need gtk+-2.0, glib-2.0 and libglade-2.0.                                        <i class="conum" data-value="2"></i><b>(2)</b>
*
make[1]: *** No rule to make target `scripts/kconfig/.tmp_gtkcheck', needed by `scripts/kconfig/gconf.o'.  Stop.
make: *** [gconfig] Error 2</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We invoke the target gconfig of the root directory makefile</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A helpful message indicates a missing GTK+ installation in our Ubun</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this case we have to install the debian package <em>libglade2-dev</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ sudo apt-get install libglade2-dev
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
Reading package lists... Done
Building dependency tree
Reading state information... Done
.
.
.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="text-configuration-interface-em-menuconfig-em"><a class="anchor" href="#text-configuration-interface-em-menuconfig-em"></a>19.7. Text Configuration Interface <em>menuconfig</em></h3>
<div class="paragraph">
<p>This configuration interface requires no graphical interface and only
requires the <em>libncurses-dev</em> debian package to be installed. This interface
is popular with other projects such as Linux Target Image Builder (LTIB),
Busybox, OpenWrt, etc.. It works well enough for us to ignore the graphical
interfaces. It is brought up using a <em>make menuconfig</em> command in the root
directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make menuconfig</code></pre>
</div>
</div>
<div class="paragraph">
<p>We get the following screen shot one the interface is invoked from the shell.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-make-menuconfig-screenshot" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/make-menuconfig-screenshot.png"><img src="http://zeuzoix.github.io/techeuphoria/images/make-menuconfig-screenshot.png" alt="make menuconfig screenshot" width="640" height="480"></a>
</div>
<div class="title">Screenshot of menuconfig interface</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Searching with the <em>menuconfig</em> interface is done by hitting the '/' key similar
to <em>vim</em>. Once the search page is displayed we can enter a key word for the
search.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-make-menuconfig-search-imx" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/make-menuconfig-search-imx.png"><img src="http://zeuzoix.github.io/techeuphoria/images/make-menuconfig-search-imx.png" alt="make menuconfig search imx" width="640" height="480"></a>
</div>
<div class="title">Screenshot of menuconfig search</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The results of the search are displayed as follows:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-make-menuconfig-search-results" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/make-menuconfig-search-imx-results.png"><img src="http://zeuzoix.github.io/techeuphoria/images/make-menuconfig-search-imx-results.png" alt="make menuconfig search imx results" width="640" height="480"></a>
</div>
<div class="title">Screenshot of menuconfig search results</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="text-configuration-interface-em-nconfig-em"><a class="anchor" href="#text-configuration-interface-em-nconfig-em"></a>19.8. Text Configuration Interface <em>nconfig</em></h3>
<div class="paragraph">
<p>Another similar test based configuration interface is <em>nconfig</em> with the same
dependency on <em>libncurses_dev</em> debian package. Again to invoke the interface
we will have to use <em>make nconfig</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make nconfig</code></pre>
</div>
</div>
<div class="paragraph">
<p>We get the following screen shot once the interface is invoked from the shell.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-make-nconfig-screenshot" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/make-nconfig-screenshot.png"><img src="http://zeuzoix.github.io/techeuphoria/images/make-nconfig-screenshot.png" alt="make nconfig screenshot" width="640" height="480"></a>
</div>
<div class="title">Screenshot of nconfig interface</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="make-oldconfig"><a class="anchor" href="#make-oldconfig"></a>19.9. make oldconfig</h3>
<div class="paragraph">
<p>If we are upgrading to a newer release and use the <em>.config</em> file from an older
release of the Linux kernel then we need to run <em>make oldconfig</em>. This will
inform us of the configuration settings that are irrelevant in the newer release
and if there are newer features or parameters then it will prompt us asking for
appropriate values for these settings.</p>
</div>
<div class="paragraph">
<p>Another scenario in which <em>make oldconfig</em> may come in use is if we modify the
<em>.config</em> file by hand.</p>
</div>
</div>
<div class="sect2">
<h3 id="reverting-to-a-previous-configuration"><a class="anchor" href="#reverting-to-a-previous-configuration"></a>19.10. Reverting To A Previous Configuration</h3>
<div class="paragraph">
<p>If we mess up our configuration and build a kernel that is unusable then we can
revert to the older configuration that the kernel was built. This is done by
copyting the <em>.config.old</em> file which gets created if we use any of the
configuration interfaces available. All the interfaces save a copy of the
existing configuration file <em>.config</em> as a back up in <em>.config.old</em></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="compiling-the-kernel"><a class="anchor" href="#compiling-the-kernel"></a>20. Compiling The Kernel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After configuring the kernel with one of the configuration interfaces we can
proceed to build the kernel by issuing a <em>make</em> command in the root directory.
If blessed with multiple CPU cores then the build can be speed up using a
<em>make -j 4</em> command which instructs make to run 4 jobs in parallel.</p>
</div>
<div class="paragraph">
<p>After the build the following will be generated:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">vmlinux</dt>
<dd>
<p>Raw and uncompressed image which can be used for debugging purposes.
This image cannot be booted.</p>
</dd>
<dt class="hdlist1">arch/&lt;ARCH&gt;/boot/*Image</dt>
<dd>
<p>The final kernel image which can be booted e.g.
bzImage for x86 and zImage for ARM. There may also be compressed images
generated.</p>
</dd>
<dt class="hdlist1">arch/&lt;ARCH&gt;/boot/dts/*.dtb</dt>
<dd>
<p>Compiled Device Tree files for certain
architectures. This will be loaded by the bootloader before the kernel image.</p>
</dd>
<dt class="hdlist1">kernel modules(*.ko)</dt>
<dd>
<p>This will be generated in the directory corresponding
to the driver/feature for which module type of configuration option was
selected.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="kernel-installation"><a class="anchor" href="#kernel-installation"></a>21. Kernel Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A kernel compiled for the host machine on which it is built can be installed
in the system by issuing a <em>make install</em> after the build is successful. To
install the kernel image we would required root permissions.</p>
</div>
<div class="paragraph">
<p>The installation includes the following:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">/boot/vmlinuz-&lt;version&gt;</dt>
<dd>
<p>The compressed kernel image. This is copied from
the <em>arch/&lt;ARCH&gt;/boot</em> directory.</p>
</dd>
<dt class="hdlist1">/boot/System.map-&lt;version&gt;</dt>
<dd>
<p>This file stores the kernel symbols along with
their addresses and will be handy in the event of a Kernel panic</p>
</dd>
<dt class="hdlist1">/boot/config-&lt;version&gt;</dt>
<dd>
<p>This is the configuration file <em>.config</em> saved
along with the compiled kernel</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The installation may also reconfigured the bootloader to take the new
kernel settings so that on the next boot the new kernel will be visible.</p>
</div>
<div class="sect2">
<h3 id="kernel-module-installation"><a class="anchor" href="#kernel-module-installation"></a>21.1. Kernel Module Installation</h3>
<div class="paragraph">
<p>Along with the kernel the compiled modules will also have to be installed
in the system. To achieve this there is a target <em>modules_install</em> which
can be executed after executing the <em>install</em> target of the root makefile.</p>
</div>
<div class="paragraph">
<p>The kernel modules and related files are installed in the
<em>/lib/modules/&lt;version&gt;/</em> directory. If we explore this directory we will
see the following:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">kernel/</dt>
<dd>
<p>This directory contains a directory structure similar to the
kernel source code. The kernel modules will be saved in the same directory
structure as the source from which they were built.</p>
</dd>
<dt class="hdlist1">modules.alias</dt>
<dd>
<p>Aliases for the modules for loading utilities. An example
of the contents of this file is given below:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ head /lib/modules/3.13.0-45-generic/modules.alias
# Aliases extracted from modules themselves.
alias char-major-10-134 apm
alias aes-asm aes_i586
alias aes aes_i586
alias twofish-asm twofish_i586
alias twofish twofish_i586
alias salsa20-asm salsa20_i586
alias salsa20 salsa20_i586
alias serpent serpent_sse2_i586
alias aes aesni_intel</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">modules.dep</dt>
<dd>
<p>Highlights the dependencies between modules. This will be used by
<em>modprobe</em> to choose which kernel modules have to be loaded before loading a
particular module. In the example below mce_inject.ko has no dependency and can
be loaded without any issue. But twofish-i586.ko depends on twofish_common.ko
which must be loaded first.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ head /lib/modules/3.13.0-45-generic/modules.dep
kernel/arch/x86/kernel/cpu/mcheck/mce-inject.ko:
kernel/arch/x86/kernel/msr.ko:
kernel/arch/x86/kernel/cpuid.ko:
kernel/arch/x86/kernel/apm.ko:
kernel/arch/x86/crypto/glue_helper.ko:
kernel/arch/x86/crypto/aes-i586.ko:
kernel/arch/x86/crypto/twofish-i586.ko: kernel/crypto/twofish_common.ko
kernel/arch/x86/crypto/salsa20-i586.ko:
kernel/arch/x86/crypto/serpent-sse2-i586.ko: kernel/crypto/xts.ko kernel/crypto/serpent_generic.ko kernel/crypto/lrw.ko kernel/crypto/gf128mul.ko kernel/arch/x86/crypto/glue_helper.ko kernel/crypto/ablk_helper.ko kernel/crypto/cryptd.ko
kernel/arch/x86/crypto/aesni-intel.ko: kernel/arch/x86/crypto/aes-i586.ko kernel/crypto/xts.ko kernel/crypto/lrw.ko kernel/crypto/gf128mul.ko kernel/crypto/ablk_helper.ko kernel/crypto/cryptd.ko</code></pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">modules.symbols</dt>
<dd>
<p>Describes the kernel module to which a symbol belongs. It can
be useful during debugging of a Kernel panic. For example we can see that
cfg80211_report_obss_beacon belongs to the cfg80211 kernel module.</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ head /lib/modules/3.13.0-45-generic/modules.symbols
# Aliases for symbols, used by symbol_request().
alias symbol:cfg80211_report_obss_beacon cfg80211
alias symbol:drm_dp_link_train_channel_eq_delay drm_kms_helper
alias symbol:VBoxHost_RTThreadPreemptDisable vboxdrv
alias symbol:__twofish_setkey twofish_common
alias symbol:get_wd_exp_mode_sd bpctl_mod
alias symbol:hsi_register_controller hsi
alias symbol:mlx4_db_free mlx4_core
alias symbol:sdhci_remove_host sdhci
alias symbol:videobuf_dma_init_kernel videobuf_dma_sg</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cleaning-up"><a class="anchor" href="#cleaning-up"></a>21.2. Cleaning Up</h3>
<div class="paragraph">
<p>There are several targets that are used to clean up files that have been
generated by the configuration and compilation of the Linux kernel source
code.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">make clean</dt>
<dd>
<p>This will remove all the generated object code files to allow
us to rebuilt the kernel.</p>
</dd>
<dt class="hdlist1">make mrproper</dt>
<dd>
<p>Remove all the generated files including the configuration
file <em>.config</em>. It may be used if we are rebuilding the kernel source
code for a different architecture.</p>
</dd>
<dt class="hdlist1">make distclean</dt>
<dd>
<p>This target is used to remove editor backup files. It is
mainly used when generating patches.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cross-compiling-the-kernel"><a class="anchor" href="#cross-compiling-the-kernel"></a>22. Cross-Compiling The Kernel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When we work with embedded targets such as the Beagle Bone Black board
we have to compile the kernel for the architecture of that board i.e.
ARM. A kernel compiled on our x86 workstation will not execute on the
Beagle Bone Black because it is compiled for an x86 architecture.</p>
</div>
<div class="paragraph">
<p>The process of compiling the kernel on our work station for another
architecture is referred to as cross-compilation. The kernel can be
compiled on the Beagle Bone Black if it has a toolchain installed on
it. However as the processing power of embedded targets is much lower
than that of PCs and servers it becomes more efficient to employ
a cross-compilation toolchain for embedded development.</p>
</div>
<div class="paragraph">
<p>A cross-compiler can be recognized by its prefix which indicates
the system for which it will compile the source code. For example
<em>mips-linux-gcc</em> indicates that the cross-compiler will generate
a binary that can be executed on a MIPS based architecture whereas
a <em>arm-linux-gnueabi-gcc</em> indicates that the cross-compiler will
generate a binary that can be executed on an ARM based architecture.</p>
</div>
<div class="paragraph">
<p>To specify the architecture for which the kernel source code is
to be compiled we have to pass a variable <strong><em>ARCH</em></strong> to the top level
makefile. This should map to any of the subdirectories in the
<em>arch/</em> directory of the kernel source code e.g. <em>arm</em>.</p>
</div>
<div class="paragraph">
<p>To specify the cross compilation toolchain we have to pass the
<strong><em>CROSS_COMPILE</em></strong> variable which represents the prefix of the
toolchain e.g. <em>mips-linux-</em> or <em>arm-linux-gnueabi-</em>.</p>
</div>
<div class="sect2">
<h3 id="predefined-configuration-files"><a class="anchor" href="#predefined-configuration-files"></a>22.1. Predefined Configuration Files</h3>
<div class="paragraph">
<p>Many times when working with embedded boards we don&#8217;t set the configuration
of a particular board from scratch. It is easier if there is a predefined
configuration with which we can start from and there is in most cases. We
get a list of predefined configurations from <em>make help</em> which allows us to
set the <em>.config</em> to a particular configuration for a specific board.</p>
</div>
<div class="paragraph">
<p>For instance if we run <em>make viper_defconfig</em> it will overwrite the <em>.config</em>
file with the file from <em>arch/arm/configs/viper_defconfig</em>. To get a list of
default configurations we can either use <em>make help</em> or the find utility as
shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ find . -name *_defconfig |head
./arch/arc/configs/tb10x_defconfig
./arch/arc/configs/fpga_defconfig
./arch/arc/configs/fpga_noramfs_defconfig
./arch/arc/configs/nsimosci_defconfig
./arch/mn10300/configs/asb2364_defconfig
.
.
.
./arch/ia64/configs/sim_defconfig
./arch/ia64/configs/tiger_defconfig
./arch/xtensa/configs/iss_defconfig
./arch/xtensa/configs/s6105_defconfig
./arch/xtensa/configs/common_defconfig</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once we&#8217;ve loaded a default configuration which is basically a minimal
configuration it&#8217;s time to tailor the configuration to our specifications.
This will include running one of the configuration interfaces like
<em>make menuconfig</em>. We see the settings of the default configuration in the
interface.</p>
</div>
</div>
<div class="sect2">
<h3 id="saving-our-default-configuration"><a class="anchor" href="#saving-our-default-configuration"></a>22.2. Saving Our Default Configuration</h3>
<div class="paragraph">
<p>We also have the ability to save our configuration once it is tailored, as
a default configuration. This can be done by running the command
<em>make savedefconfig</em>. Running this target causes make to save the <em>.config</em>
file with a name <em>defconfig</em>. We can move the new <em>defconfig</em> file to
the architecture <em>configs</em> directory with an appropriate name.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>mv defconfig arch/&lt;ARCH&gt;/configs/my_favourite_config</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Overall the choice of starting from a default minimal configuration lies with
the developer. We can also start from scratch but be mindful about selection of
the CPU selection and the correct device drivers.</p>
</div>
</div>
<div class="sect2">
<h3 id="device-tree"><a class="anchor" href="#device-tree"></a>22.3. Device Tree</h3>
<div class="paragraph">
<p>Most embedded platforms have non-discoverable hardware which exists as part
of the SOC. This hardware has to be described to the kernel in the form of
code or a special hardware description language called <em>Device Tree</em>.</p>
</div>
<div class="paragraph">
<p>The <em>Device Tree</em> language is used only recently in certain architectures
such as ARM, PowerPC, ARC, etc.. The Device Tree source file is compiled
into a binary called Device Tree Blob by a compiler and passed to the kernel
through the bootloader. Each board will have its own unique hardware and
therefore will have a unique device tree source file.</p>
</div>
<div class="paragraph">
<p>The <em>Device Tree</em> files will be located in the
 <em>/arch/&lt;ARCH&gt;/boot/dts/</em> folder. The bootloader has to have the capability
to load the <em>Device Tree Blob</em> and the kernel image before starting
execution of the kernel.</p>
</div>
</div>
<div class="sect2">
<h3 id="steps-to-build-and-install-a-kernel"><a class="anchor" href="#steps-to-build-and-install-a-kernel"></a>22.4. Steps To Build and Install A Kernel</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure the kernel source code using <em>make menuconfig</em></p>
</li>
<li>
<p>Build the kernel using <em>make</em> with &lt;ARCH&gt; and &lt;CROSS_COMPILE&gt; set if building
for and embedded platform.</p>
</li>
<li>
<p>Copy the built image from <em>arch/&lt;ARCH&gt;/boot/</em>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The image name will depend on the architecture e.g. bzImage, zImage, etc..</p>
</li>
</ol>
</div>
</li>
<li>
<p>Install the kernel image. For an embedded platform do <strong>NOT</strong> run <em>make install</em>.
It is better to simply copy the built kernel image.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The installation can be customized by editing the <em>arch/&lt;ARCH&gt;/boot/install.sh</em>
script.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Install the modules. For an embedded platform do <strong>NOT</strong> run <em>make modules_install</em>
without the <em>INSTALL_MOD_PATH=&lt;dir&gt;/</em> variable. This ensures we don&#8217;t mess around
with the system kernel modules.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="using-u-boot"><a class="anchor" href="#using-u-boot"></a>22.5. Using U-Boot</h3>
<div class="paragraph">
<p>A popular bootloader with embedded platforms is U-Boot. U-Boot works with a
format of kernel image called <em>uImage</em>. This is generated from the <em>zImage</em> using
a <em>make uImage</em> target execution for ARM. Newer versions of U-Boot also support
booting of the ARM based kernel image zImage directly.</p>
</div>
<div class="paragraph">
<p>Some ARM platforms require the LOADADDR to be passed along with the <em>make uImage</em>
target execution. The address associated with this variable represents the
physical memory where the image is executed in.</p>
</div>
<div class="paragraph">
<p>U-Boot also has the ability to load the <em>Device Tree Blob</em> in memory and pass
it to the kernel. The boot process follows the steps</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Load the kernel zImage or uImage at address X</p>
</li>
<li>
<p>Load the &lt;board&gt;.dtb file at Y</p>
</li>
<li>
<p>Boot the kernel with bootz X -Y or bootm X - Y. The - indicates no initramfs.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="kernel-command-line"><a class="anchor" href="#kernel-command-line"></a>22.6. Kernel Command Line</h3>
<div class="paragraph">
<p>The kernel takes in a list of arguments which can affect its behavior at run
time. These argument can be hardcoded during the configuration of the kernel
source code by setting the CONFIG_CMDLINE option.</p>
</div>
<div class="paragraph">
<p>The command line argument can also be passed to the kernel at boot up using
an environment variable like <em>bootargs</em> in the case of U-Boot.</p>
</div>
<div class="paragraph">
<p>There are several kernel arguments documented in
<em>Documentation/kernel-parameters.txt</em>. We typically set:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>root =  for the root filesystem</p>
</li>
<li>
<p>console = for the destination of the kernel messages</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lab-2-setting-up-the-beaglebone-black-board"><a class="anchor" href="#lab-2-setting-up-the-beaglebone-black-board"></a>23. LAB 2 : Setting Up The Beaglebone Black Board</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">This is a hands on session taken from the Free Electrons labs with the following objectives</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Getting familiar with the BeagleBone Black board</p>
</li>
<li>
<p>Knowing what technical documentation is available</p>
</li>
<li>
<p>Installing the lab data from Free Electrons</p>
</li>
<li>
<p>Access the board through the serial line.</p>
</li>
<li>
<p>Configure the U-boot bootloader to download files onto the board using trivial
file transfer protocol (tftp)</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="getting-comfortable-with-the-board"><a class="anchor" href="#getting-comfortable-with-the-board"></a>23.1. Getting Comfortable With The Board</h3>
<div class="paragraph">
<p>At this point we have to get familiar with our board. It is good to go through
the features of the board given in section 4.0 of the
<a href="../docs/BBB_SRM.pdf" target="_blank">BeagleBone Black System Reference Manual</a>.</p>
</div>
<div class="sect3">
<h4 id="connectors-leds-and-switches"><a class="anchor" href="#connectors-leds-and-switches"></a>23.1.1. Connectors, LEDs and Switches</h4>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-CONN_REVA5A" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/CONN_REVA5A.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/CONN_REVA5A.jpg" alt="CONN REVA5A" width="640" height="480"></a>
</div>
<div class="title">Beagle Bone Black Connectors, LEDs and Switches</div>
</div>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">5V DC Power Connector</dt>
<dd>
<p>The main DC input which accepts 5V power. Suitable for
more power hungry applications.</p>
</dd>
<dt class="hdlist1">Power Down Button Switch</dt>
<dd>
<p>Signals to the processor to initiate the power down
sequence. It is used to power down the board.</p>
</dd>
<dt class="hdlist1">Boot Button Switch</dt>
<dd>
<p>Force the a boot from the micro-SD card by removing and
reapplying power to the board.</p>
</dd>
<dt class="hdlist1">Reset Button Switch</dt>
<dd>
<p>Reset the processor.</p>
</dd>
<dt class="hdlist1">USB Client Connector</dt>
<dd>
<p>Mini USB port at the bottom of the board. It can be
used to power the board and setup a network connection.</p>
</dd>
<dt class="hdlist1">10/100 Ethernet Connector</dt>
<dd>
<p>The LAN interface.</p>
</dd>
<dt class="hdlist1">Debug Serial Header Connector</dt>
<dd>
<p>The header interface for the serial port.</p>
</dd>
<dt class="hdlist1">MicroSD Slot Connector</dt>
<dd>
<p>Slot at the bottom of the board to insert a micro-SD
card.</p>
</dd>
<dt class="hdlist1">MicroHDMI Slot Connector</dt>
<dd>
<p>Slot at the bottom of the board to insert a
micro-HDMI cable to interface to a display.</p>
</dd>
<dt class="hdlist1">USB Host Connector</dt>
<dd>
<p>This can be used to connect a USB device like keyboard,
mouse, BT dongle, WiFi dongle, etc..</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="system-key-components"><a class="anchor" href="#system-key-components"></a>23.1.2. System Key Components</h4>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-COMP_A5A" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/COMP_A5A.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/COMP_A5A.jpg" alt="COMP A5A" width="640" height="480"></a>
</div>
<div class="title">BeagleBone Black system key components</div>
</div>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Sitara Processor</dt>
<dd>
<p>ARM architecture OMAP System On Chip(SOC) from
Texas Instruments. This is XAM3359AZCZ100 for revision A5A to A6A and
XAM3359AZCZ100 for revision B and above. Only the A4 revision boards had the
AM3352 processor.</p>
</dd>
<dt class="hdlist1">512MB DDR3 RAM</dt>
<dd>
<p>Micron 512MB DDR3L or Kingston 512MB DDR3 Dual Data Rate RAM.</p>
</dd>
<dt class="hdlist1">TPS65217C PMIC</dt>
<dd>
<p>It is the power management IC which supplies the power rails
to the different components on board.</p>
</dd>
<dt class="hdlist1">SMSC Ethernet PHY</dt>
<dd>
<p>The physical interface to the ethernet network.</p>
</dd>
<dt class="hdlist1">Micron eMMC</dt>
<dd>
<p>This was 2GB till revision B and changed to 4GB in revision C.</p>
</dd>
<dt class="hdlist1">HDMI Framer</dt>
<dd>
<p>Provides the HDMI control for and HDMI or DVI-D display with
adaptor.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="downloading-the-technical-documentation"><a class="anchor" href="#downloading-the-technical-documentation"></a>23.2. Downloading The Technical Documentation</h3>
<div class="paragraph">
<p>Design is not possible without documentation, so we download the documents
which will help us in the lab sessions. The following are needed:</p>
</div>
<div class="paragraph">
<p>Tht System Reference Manual describes the details about the design of the
board and is available on this site <a href="../docs/BBB_SRM.pdf" target="_blank">here</a><br>
The latest document should be available at: <a href="https://github.com/CircuitCo/BeagleBone-Black/blob/master/BBB_SRM.pdf?raw=true" target="_blank">https://github.com/CircuitCo/BeagleBone-Black/blob/master/BBB_SRM.pdf?raw=true</a>.</p>
</div>
<div class="paragraph">
<p>The datasheet of the TI AM335x SoCs is useful to see the PIN assignments
later when we want to configure the <em>pinmux</em> settings and is available on this
site <a href="../docs/am3359.pdf" target="_blank">here</a><br>
The original link is at the TI website at: <a href="http://www.ti.com/lit/ds/symlink/am3359.pdf" target="_blank">http://www.ti.com/lit/ds/symlink/am3359.pdf</a></p>
</div>
<div class="paragraph">
<p>The last document is the Technical Reference Manual(TRM) of the TI AM335x SoCs.
At over 4000 pages it describes the internal IP design of the chip. It is available
<a href="../docs/spruh73i.pdf" target="_blank">here</a>.<br>
The same document can be retrieved from the TI website at :
<a href="http://www.ti.com/product/am3359" target="_blank">http://www.ti.com/product/am3359</a></p>
</div>
</div>
<div class="sect2">
<h3 id="installing-the-free-electrons-lab-data"><a class="anchor" href="#installing-the-free-electrons-lab-data"></a>23.3. Installing The Free Electrons Lab Data</h3>
<div class="paragraph">
<p>We will be using the lab data available from Free Electrons to setup our
BeagleBone Black. First make sure the lab data is downloaded. The lab data which
was available at the time of writing this journal is
<a href="../free_electrons_linux_kernel/linux-kernel-labs.tar.xz" target="_blank">here</a>.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll have to uncompress the file with <strong>sudo</strong> permissions and change the
permissions of the resulting folder. The prime reason being that the package
contains system device node files for the NFS root filesystem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo tar xvJf linux-kernel-labs.tar.xz         <i class="conum" data-value="1"></i><b>(1)</b>
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
linux-kernel-labs/
linux-kernel-labs/src/
linux-kernel-labs/src/patches/
.
.
.
linux-kernel-labs/modules/nfsroot/sbin/route
linux-kernel-labs/modules/nfsroot/sbin/runlevel
linux-kernel-labs/git/
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo chown -R conrad:conrad linux-kernel-labs        <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ ls -l
total 7756
drwxrwxr-x 6 conrad conrad    4096 Mar 22 17:38 linux-kernel-labs        <i class="conum" data-value="3"></i><b>(3)</b>
-rw-rw-r-- 1 conrad conrad 7931316 Mar 22 18:57 linux-kernel-labs.tar.xz
-rw-rw-r-- 1 conrad conrad      87 Mar 22 18:55 Readme.txt</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to untar and decompress the package</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Command to change the owner and group to the user name in this case <em>conrad</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Listing of the directory shows the owner and group has been set appropriately</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The xz extension of the package indicates that it requires XZ compression utility
which if not available on your system can be upgraded as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo apt-get install xz-utils</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="making-a-bootable-microsd-card"><a class="anchor" href="#making-a-bootable-microsd-card"></a>23.4. Making A Bootable MicroSD Card</h3>
<div class="paragraph">
<p>Now we deviate slightly from the Free Electrons lab slides and first
prepare our board as per the instructions provided in the
<em>linux-kernel-labs/bootloader/beaglebone-black/README.txt</em> file. The
bootable micro-SD card will automatically format the on board eMMC
device.</p>
</div>
<div class="paragraph">
<p>Take the micro-SD card and insert it into a micro-SD adapter/reader
like the one shown in the image below:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-microsd-adaptor-sd" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/sdcard-microsd-adaptor-sd.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-microsd-adaptor-sd.jpg" alt="sdcard microsd adaptor sd" width="640" height="480"></a>
</div>
<div class="title">Micro SD card adapter</div>
</div>
</div>
</div>
<div class="paragraph">
<p>This memory card reader/adapter should be inserted into the SD card
slot available. If your system has a micro-SD card slot then please
use that directly. On checking the kernel logs with <em>dmesg</em> we should
be able to identify the card detected in the system. If a micro-SD
card slot is available then the system should register it as a
<em>/dev/mmcblk0</em> whereas in this case with a memory card reader we see
it as <em>/dev/sdb</em>. The following shows the kernel logs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ dmesg
.
.
.
[127595.272118] usb 1-2: new high-speed USB device number 6 using ehci-pci
[127595.405640] usb 1-2: New USB device found, idVendor=058f, idProduct=6366
[127595.405650] usb 1-2: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[127595.405658] usb 1-2: Product: Mass Storage Device
[127595.405665] usb 1-2: Manufacturer: Generic
[127595.405671] usb 1-2: SerialNumber: 058F63666433
[127595.406226] usb-storage 1-2:1.0: USB Mass Storage device detected
[127595.407830] scsi9 : usb-storage 1-2:1.0
[127596.532963] scsi 9:0:0:0: Direct-Access     Multiple Card  Reader     1.00 PQ: 0 ANSI: 0
[127596.533754] sd 9:0:0:0: Attached scsi generic sg1 type 0
[127598.192274] sd 9:0:0:0: [sdb] 7744512 512-byte logical blocks: (3.96 GB/3.69 GiB) <i class="conum" data-value="1"></i><b>(1)</b>
[127598.193263] sd 9:0:0:0: [sdb] Write Protect is off
[127598.193269] sd 9:0:0:0: [sdb] Mode Sense: 03 00 00 00
[127598.194256] sd 9:0:0:0: [sdb] No Caching mode page found
[127598.194259] sd 9:0:0:0: [sdb] Assuming drive cache: write through
[127598.199023] sd 9:0:0:0: [sdb] No Caching mode page found
[127598.199028] sd 9:0:0:0: [sdb] Assuming drive cache: write through
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ ls -l /dev/sdb         <i class="conum" data-value="2"></i><b>(2)</b>
brw-rw---- 1 root disk 8, 16 Mar 22 21:09 /dev/sdb</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We see the device attached as sdb</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The device node has been created successfully as /dev/sdb</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will have to first partition the micro-SD card using the <em>sfdisk</em> utility
which is part of the <em>util-linux</em> APT package.
This tool helps us to list the partitions of a device, check the sizes of the
partitions, check the partitions on a device and re-partition a device. We must
<strong>be extra careful</strong> when we use such a tool as it could also cause damage to our
workstation system if we select the wrong device file unintentionally.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ sudo sfdisk --in-order --Linux --unit M /dev/sdb &lt;&lt; EOF                <i class="conum" data-value="1"></i><b>(1)</b>
&gt; 1,48,0xE,*
&gt; ,,,-
&gt; EOF
Checking that no-one is using this disk right now ...
BLKRRPART: Device or resource busy                                                <i class="conum" data-value="2"></i><b>(2)</b>

This disk is currently in use - repartitioning is probably a bad idea.
Umount all file systems, and swapoff all swap partitions on this disk.
Use the --no-reread flag to suppress this check.
Use the --force flag to overrule all checks.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ mount                <i class="conum" data-value="3"></i><b>(3)</b>
/dev/sda1 on / type ext4 (rw,errors=remount-ro)
proc on /proc type proc (rw,noexec,nosuid,nodev)
sysfs on /sys type sysfs (rw,noexec,nosuid,nodev)
none on /sys/fs/cgroup type tmpfs (rw)
none on /sys/fs/fuse/connections type fusectl (rw)
none on /sys/kernel/debug type debugfs (rw)
none on /sys/kernel/security type securityfs (rw)
udev on /dev type devtmpfs (rw,mode=0755)
devpts on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)
tmpfs on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)
none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)
none on /run/shm type tmpfs (rw,nosuid,nodev)
none on /run/user type tmpfs (rw,noexec,nosuid,nodev,size=104857600,mode=0755)
none on /sys/fs/pstore type pstore (rw)
rpc_pipefs on /run/rpc_pipefs type rpc_pipefs (rw)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,noexec,nosuid,nodev)
systemd on /sys/fs/cgroup/systemd type cgroup (rw,noexec,nosuid,nodev,none,name=systemd)
nfsd on /proc/fs/nfsd type nfsd (rw)
gvfsd-fuse on /run/user/1000/gvfs type fuse.gvfsd-fuse (rw,nosuid,nodev,user=conrad)
/dev/sdb1 on /media/conrad/boot type vfat (rw,nosuid,nodev,uid=1000,gid=1000,shortname=mixed,dmask=0077,utf8=1,showexec,flush,uhelper=udisks2) <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The command to re-partition the <em>/devsdb</em> device with <em>sfdisk</em>. The options
<em>--in-order</em> indicates that the partitions are in order in the input. <em>--Linux</em>
tells sfdisk to ignore all warnings irrelevant for Linux.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The device is apparently busy.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We do a <em>mount</em> to check if it is mounted</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We see that a partition is mounted in our Workstation at /media/conrad/boot</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the micro-SD card is already partitioned and formated it may be auto mounted
by our work station. We will have to un-mount all the partitions before we can
proceed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ sudo umount /media/conrad/boot         <i class="conum" data-value="1"></i><b>(1)</b>
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ mount                <i class="conum" data-value="2"></i><b>(2)</b>
/dev/sda1 on / type ext4 (rw,errors=remount-ro)
proc on /proc type proc (rw,noexec,nosuid,nodev)
sysfs on /sys type sysfs (rw,noexec,nosuid,nodev)
none on /sys/fs/cgroup type tmpfs (rw)
none on /sys/fs/fuse/connections type fusectl (rw)
none on /sys/kernel/debug type debugfs (rw)
none on /sys/kernel/security type securityfs (rw)
udev on /dev type devtmpfs (rw,mode=0755)
devpts on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)
tmpfs on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)
none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)
none on /run/shm type tmpfs (rw,nosuid,nodev)
none on /run/user type tmpfs (rw,noexec,nosuid,nodev,size=104857600,mode=0755)
none on /sys/fs/pstore type pstore (rw)
rpc_pipefs on /run/rpc_pipefs type rpc_pipefs (rw)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,noexec,nosuid,nodev)
systemd on /sys/fs/cgroup/systemd type cgroup (rw,noexec,nosuid,nodev,none,name=systemd)
nfsd on /proc/fs/nfsd type nfsd (rw)
gvfsd-fuse on /run/user/1000/gvfs type fuse.gvfsd-fuse (rw,nosuid,nodev,user=conrad)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We have to unmount the <em>/dev/sdb1</em> from the mount point i.e. <em>/media/conrad/boot</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We check to see if anything else is mounted again</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again we attempt to repartition the micro-SD card</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ sudo sfdisk --in-order --Linux --unit M /dev/sdb &lt;&lt; EOF
1,48,0xE,*
,,,-
EOF                                                                                        <i class="conum" data-value="1"></i><b>(1)</b>
Checking that no-one is using this disk right now ...                                        <i class="conum" data-value="2"></i><b>(2)</b>
OK

Disk /dev/sdb: 1023 cylinders, 122 heads, 62 sectors/track
Old situation:                                                                                <i class="conum" data-value="3"></i><b>(3)</b>
Units = mebibytes of 1048576 bytes, blocks of 1024 bytes, counting from 0

   Device Boot Start   End    MiB    #blocks   Id  System
/dev/sdb1   *     1     48     48      49152    e  W95 FAT16 (LBA)
/dev/sdb2        49   3780   3732    3821568   83  Linux
/dev/sdb3         0      -      0          0    0  Empty
/dev/sdb4         0      -      0          0    0  Empty
New situation:                                                                                <i class="conum" data-value="4"></i><b>(4)</b>
Units = mebibytes of 1048576 bytes, blocks of 1024 bytes, counting from 0

   Device Boot Start   End    MiB    #blocks   Id  System
/dev/sdb1   *     1     48     48      49152    e  W95 FAT16 (LBA)
/dev/sdb2        49   3780   3732    3821568   83  Linux
/dev/sdb3         0      -      0          0    0  Empty
/dev/sdb4         0      -      0          0    0  Empty
Successfully wrote the new partition table

Re-reading the partition table ...
BLKRRPART: Device or resource busy
The command to re-read the partition table failed.
Run partprobe(8), kpartx(8) or reboot your system now,
before using mkfs
If you created or changed a DOS partition, /dev/foo7, say, then use dd(1)
to zero the first 512 bytes:  dd if=/dev/zero of=/dev/foo7 bs=512 count=1
(See fdisk(8).)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <em>sfdisk</em> utility is invoked supplying the information about the partitions</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>sfdisk</em> checking to see that no one is using the disk</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The old partition map is displayed first. <strong>This will vary based on the history
of the micro-SD card</strong></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The new partition map is displayed. The first partition is a W95 FAT16 one
which is 48 MB. This is the first line of input to sfdisk. The remaining has
been converted to a Linux partition.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will have to format the first partition of the disk using the <em>mkfs.vfat</em>
partition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ sudo mkfs.vfat -F 16 /dev/sdb1 -n boot        <i class="conum" data-value="1"></i><b>(1)</b>
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
mkfs.fat 3.0.26 (2014-03-07)
mkfs.fat: warning - lowercase labels might not work properly with DOS or Windows
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ echo $?                        <i class="conum" data-value="2"></i><b>(2)</b>
0</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>mkfs.vfat</em> is run on the partition <em>/dev/sdb1</em>. The label of the partition
is set to <em>boot</em> with the -n option and the -F option specifies the type of
file allocation tables used (12, 16 or 32 bit).</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Checks the return value of the command</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We now remove and re-insert the micro-SD card into the system to see if it gets
detected and automatically mounted. It does and we see that Ubuntu
opens up the directory located in <em>/media/conrad/boot</em>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-media-boot-automounted" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-media-boot-automounted.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-media-boot-automounted.png" alt="beagleboneblacktux media boot automounted" width="640" height="480"></a>
</div>
<div class="title">The first partition <em>/dev/sdb1</em> has been automounted successfully at <em>/media/conrad/boot</em></div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria$ mount        <i class="conum" data-value="1"></i><b>(1)</b>
/dev/sda1 on / type ext4 (rw,errors=remount-ro)
proc on /proc type proc (rw,noexec,nosuid,nodev)
sysfs on /sys type sysfs (rw,noexec,nosuid,nodev)
none on /sys/fs/cgroup type tmpfs (rw)
none on /sys/fs/fuse/connections type fusectl (rw)
none on /sys/kernel/debug type debugfs (rw)
none on /sys/kernel/security type securityfs (rw)
udev on /dev type devtmpfs (rw,mode=0755)
devpts on /dev/pts type devpts (rw,noexec,nosuid,gid=5,mode=0620)
tmpfs on /run type tmpfs (rw,noexec,nosuid,size=10%,mode=0755)
none on /run/lock type tmpfs (rw,noexec,nosuid,nodev,size=5242880)
none on /run/shm type tmpfs (rw,nosuid,nodev)
none on /run/user type tmpfs (rw,noexec,nosuid,nodev,size=104857600,mode=0755)
none on /sys/fs/pstore type pstore (rw)
rpc_pipefs on /run/rpc_pipefs type rpc_pipefs (rw)
binfmt_misc on /proc/sys/fs/binfmt_misc type binfmt_misc (rw,noexec,nosuid,nodev)
systemd on /sys/fs/cgroup/systemd type cgroup (rw,noexec,nosuid,nodev,none,name=systemd)
nfsd on /proc/fs/nfsd type nfsd (rw)
gvfsd-fuse on /run/user/1000/gvfs type fuse.gvfsd-fuse (rw,nosuid,nodev,user=conrad)
/dev/sdb1 on /media/conrad/boot type vfat (rw,nosuid,nodev,uid=1000,gid=1000,shortname=mixed,dmask=0077,utf8=1,showexec,flush,uhelper=udisks2)        <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use <em>mount</em> to check explicitly what&#8217;s there in the system</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our partition has been mounted at <em>/media/conrad/boot</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will finally have to copy the files from the lab data folder to this partition
and un mount the device.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/bootloader/beaglebone-black$ cp am335x-boneblack.dtb MLO MBR u-boot.img MLO.final u-boot.img.final uEnv.txt uImage /media/conrad/boot/                <i class="conum" data-value="1"></i><b>(1)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/bootloader/beaglebone-black$ umount /media/conrad/boot        <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Copying the necessary files from the Free Electrons lab data folder which we unpacked earlier</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Unmounting the mounted partition</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-bootable-microSD-contents" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-bootable-microSD-contents.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-bootable-microSD-contents.png" alt="beagleboneblacktux bootable microSD contents" width="640" height="480"></a>
</div>
<div class="title">The contents of the bootable micro-SD card</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We can now safely eject or remove the micro-SD card from the work station.</p>
</div>
<div class="sect3">
<h4 id="source-for-binaries"><a class="anchor" href="#source-for-binaries"></a>23.4.1. Source For Binaries</h4>
<div class="paragraph">
<p>The binaries that are copied can be built from source however we&#8217;re not
going to do that for now. Instructions to build them are given in the
<em>linux-kernel-labs/bootloader/beaglebone-black/README.txt</em> of the lab data
downloaded.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="reflashing-the-emmc-with-the-micro-sd-card"><a class="anchor" href="#reflashing-the-emmc-with-the-micro-sd-card"></a>23.5. Reflashing The eMMC With The micro-SD Card</h3>
<div class="paragraph">
<p>The bootable micro-SD card will now be used to reflash the eMMC device to get
it ready for the lab session. The process is short but the steps maybe a bit
confusing so follow the pictures to nail it down correctly.</p>
</div>
<div class="sect3">
<h4 id="insert-the-micro-sd-card"><a class="anchor" href="#insert-the-micro-sd-card"></a>23.5.1. Insert The micro-SD Card</h4>
<div class="paragraph">
<p>This step is self-explanatory. The bootable micro-SD card has to be inserted
into the micro-SD card slot on the BeagleBone Black board. The micro-SD card
has 8 contacts with a golden hue which are at the bottom of the card. The
picture below shows the top of the micro-SD card which is placed in the slot.
All that is left is to press it into the slot until a click is felt.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-microsd-in-slot" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-microsd-in-slot.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-microsd-in-slot.jpg" alt="beagleboneblacktux microsd in slot" width="640" height="480"></a>
</div>
<div class="title">The micro-SD card is placed in the slot waiting to be fully inserted</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pressing-the-boot-switch"><a class="anchor" href="#pressing-the-boot-switch"></a>23.5.2. Pressing The Boot Switch</h4>
<div class="paragraph">
<p>After inserting the micro-SD card we have to press the boot switch which is
located near the micro-SD card slot as shown in the picture below. Also note
that the micro-SD card has been inserted properly into its slot.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-boot-switch" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-boot-switch.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-boot-switch.jpg" alt="beagleboneblacktux boot switch" width="640" height="480"></a>
</div>
<div class="title">The boot switch located near the micro-SD card slot</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-boot-switch-pressed" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-boot-switch-pressed.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-boot-switch-pressed.jpg" alt="beagleboneblacktux boot switch pressed" width="640" height="480"></a>
</div>
<div class="title">The boot switch has to be pressed before applying power</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="applying-power"><a class="anchor" href="#applying-power"></a>23.5.3. Applying Power</h4>
<div class="paragraph">
<p>The last step is to apply power i.e. either through the USB connector or
power connector. Make sure your power supply is built for 5V 1A output
before inserting it into the power supply connector. You can depress the
boot switch after 1 second after applying power. On applying power the
leds will start blinking. The entire reflashing process takes about 20 to
30 seconds. At the end of the process all 4 leds will be on as shown:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-all-leds-on-successful-reflash" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-all-leds-on-successful-reflash.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-all-leds-on-successful-reflash.jpg" alt="beagleboneblacktux all leds on successful reflash" width="640" height="480"></a>
</div>
<div class="title">The reflash operation was successful as all 4 leds are on after 20s</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>23.5.4. Troubleshooting</h4>
<div class="paragraph">
<p>In case there is an issue with the process and the 4 leds do not light up
after a minute then try again. If it still fails then go through the steps
given in the lab data folder i.e.
<em>linux-kernel-labs/bootloader/beaglebone-black/README.txt</em>. The
procedure given here has been taken from that document. There&#8217;s a section
on "Fixing issues (if any)" which might help.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-serial-communication-with-the-board"><a class="anchor" href="#setting-up-serial-communication-with-the-board"></a>23.6. Setting Up Serial Communication With The Board</h3>
<div class="paragraph">
<p>The debug serial header connector has been descibed in the
<a href="#getting-comfortable-with-the-board">Getting Comfortable With The Board</a> section and should be easy to locate
 with the labelled image in that section. It is a 1x6 header. Serial
capability is provided by UART0 of the processor. It would be good to read
the section on the debug serial header given in the
<a href="../docs/spruh73i.pdf" target="_blank">Technical Reference Manual</a>.</p>
</div>
<div class="paragraph">
<p>The only two signals available are TX and RX on the connector and the levels
on these signals is 3.3V. A FTDI USB to serial cable is recommended as this
serves to provide a serial port to PCs/Laptops making use of the available
USB port. The FTDI chip translates the USB data to serial and vice versa. There
are several provided in the elinux.org website link at:<br>
<a href="http://elinux.org/Beagleboard:BeagleBone_Black_Serial" target="_blank">http://elinux.org/Beagleboard:BeagleBone_Black_Serial</a>.</p>
</div>
<div class="sect3">
<h4 id="rhydolabz-ftdi-usb-to-serial-breakout-board"><a class="anchor" href="#rhydolabz-ftdi-usb-to-serial-breakout-board"></a>23.6.1. Rhydolabz FTDI USB To Serial Breakout Board</h4>
<div class="paragraph">
<p>In this journal a breakout board was purchased from
<a href="http://www.rhydolabz.com/index.php" target="_blank">Rhydolabz</a>. There are several boards available but
one without a 1x6 connector was chosen. All the signals of the FTDI can be
exposed by soldering a bergstrip pin-out for advanced users but for our use
case GND, RX and TX are provided with an easy to access 4 pin connector. The
board is also capable of outputing both 5V and 3.3V. This is controlled by
soldering the 3.3V leads at the back of the breakout board. The board can be
picked up from:<br>
<a href="http://www.rhydolabz.com/index.php?main_page=product_info&amp;cPath=80&amp;products_id=1090" target="_blank">http://www.rhydolabz.com/index.php?main_page=product_info&amp;cPath=80&amp;products_id=1090</a></p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-rhydolabz-ftdi-usb-serial-breakout-board" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/rhydolabz-ftdi-usb-to-serial-interface-module.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/rhydolabz-ftdi-usb-to-serial-interface-module.jpg" alt="rhydolabz ftdi usb to serial interface module" width="640" height="480"></a>
</div>
<div class="title">Rhydolabz breakout board with mini USB cable</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="connecting-the-breakout-board"><a class="anchor" href="#connecting-the-breakout-board"></a>23.6.2. Connecting The Breakout Board</h4>
<div class="paragraph">
<p>The FTDI breakout board comes with a Grove 4 pin Female jumper to 4 pin
conversion cable. Each of the cables can be connected to female connectors
to be slotted into the serial debug header pins. We need only the GND, RXD
and TXD signals from the board. Before connecting the board signals make
sure the 3.3V leads are shorted at the bottom of the board. The board from
Rhydolabz comes with the 5V lead shorted and must be converted for the Beagle
Bone Black.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Connect the GND cable of the FTDI breakout board to pin 1 of the serial header.</p>
</li>
<li>
<p>Next connect RXD of the FTDI breakout board to pin 5 which is the TX of the serial debug header.</p>
</li>
<li>
<p>Finally connect TXD of the board to pin 4 which is the RX of the serial debug header.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>It is always good to understand the specifications of the connectors whenever
interfacing electronic circuits. In this case we know that the BeagleBone Black
takes 3.3V from the System Reference Manual. If a different cable is to be used
check and see if its connector is compatible with the header. The figure below
shows the setup where GND is the orange cable on the right, next RXD is the
brown cable followed by the TXD which is the red cable.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-rhydolabz-ftdi-serial-debug-connection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-rhydolabz-ftdi-serial-debug-connection.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-rhydolabz-ftdi-serial-debug-connection.jpg" alt="beagleboneblacktux rhydolabz ftdi serial debug connection" width="640" height="480"></a>
</div>
<div class="title">Rhydolabz breakout board serial connection to BeagleBone Black 1x6 header</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once the connections are in place between the BeagleBone Black serial debug
header and the FTDI cable or breakout board then connect the USB cable to the
breakout board. The picture shows that the board lights up.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-rhydolabz-ftdi-mini-usb-connection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-rhydolabz-ftdi-mini-usb-connection.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-rhydolabz-ftdi-mini-usb-connection.jpg" alt="beagleboneblacktux rhydolabz ftdi mini usb connection" width="640" height="480"></a>
</div>
<div class="title">Rhydolabz breakout board mini USB connection</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The linux kernel running on the workstation should register the new USB
device connected. We can probe the kernel logs to see if there is any activity
using dmesg.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs$ dmesg
.
.
.
[60269.932101] usb 6-1: new full-speed USB device number 2 using uhci_hcd
[60270.125794] usb 6-1: New USB device found, idVendor=0403, idProduct=6001
[60270.125804] usb 6-1: New USB device strings: Mfr=1, Product=2, SerialNumber=3
[60270.125812] usb 6-1: Product: FT232R USB UART
[60270.125819] usb 6-1: Manufacturer: FTDI
[60270.125825] usb 6-1: SerialNumber: A602I2CN
[60270.212583] usbcore: registered new interface driver usbserial
[60270.212599] usbcore: registered new interface driver usbserial_generic
[60270.212611] usbserial: USB Serial support registered for generic
[60270.230288] usbcore: registered new interface driver ftdi_sio
[60270.230305] usbserial: USB Serial support registered for FTDI USB Serial Device
[60270.230972] ftdi_sio 6-1:1.0: FTDI USB Serial Device converter detected
[60270.231033] usb 6-1: Detected FT232RL
[60270.231036] usb 6-1: Number of endpoints 2
[60270.231039] usb 6-1: Endpoint 1 MaxPacketSize 64
[60270.231041] usb 6-1: Endpoint 2 MaxPacketSize 64
[60270.231043] usb 6-1: Setting MaxPacketSize 64
[60270.233850] usb 6-1: FTDI USB Serial Device converter now attached to ttyUSB0        <i class="conum" data-value="1"></i><b>(1)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs$ ls -l /dev/ttyUSB0
crw-rw---- 1 root dialout 188, 0 Mar 25 22:28 /dev/ttyUSB0        <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The device has been recognized as a tty device and is named ttyUSB0</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>A device node <em>/dev/ttyUSB0</em> is created in the root filesystem</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="accessing-the-serial-port-with-em-picocom-em"><a class="anchor" href="#accessing-the-serial-port-with-em-picocom-em"></a>23.6.3. Accessing The Serial Port With <em>Picocom</em></h4>
<div class="paragraph">
<p>We can now access the serial port with a terminal application like picocom.
This can be installed as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs$ sudo apt-get install picocom        <i class="conum" data-value="1"></i><b>(1)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs$ sudo adduser $USER dialout        <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Installing <em>picocom</em> with <em>apt-get</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Adding $USER to the dialout group to use <em>picocom</em> without sudo. $USER is set to the username i.e conrad in the above case.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can now start <em>picocom</em> and connect it to the <em>/dev/ttyUSB0</em> device which
was created earlier. The baud rate is specified with the -b option. The
default serial port settings for the board are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Baud 115,200</p>
</li>
<li>
<p>Bits 8</p>
</li>
<li>
<p>Parity N</p>
</li>
<li>
<p>Stop Bits 1</p>
</li>
<li>
<p>Handshake None</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After starting the <em>picocom</em> application we should be able to see the serial
port is opened and the settings should be the default settings. If they are
not then try to get the settings by providing options to picocom. Once we get
the desired settings we can apply power to the connected BeagleBone Black. At
this point we will boot up the board for the first time and should see the
serial logs of the bootloader U-Boot. The boot process can be interrupted by
hitting any key on the keyboard and allowing us to configure the U-Boot
environment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/techeuphoria/quests/beagleboneblacktux/free_electrons_linux_kernel$ picocom -b 115200 /dev/ttyUSB0 <i class="conum" data-value="1"></i><b>(1)</b>
picocom v1.7

port is        : /dev/ttyUSB0
flowcontrol    : none
baudrate is    : 115200
parity is      : none
databits are   : 8
escape is      : C-a
local echo is  : no
noinit is      : no
noreset is     : no
nolock is      : no
send_cmd is    : sz -vv
receive_cmd is : rz -vv
imap is        :
omap is        :
emap is        : crcrlf,delbs,

Terminal ready        <i class="conum" data-value="2"></i><b>(2)</b>
 
U-Boot SPL 2013.10 (Nov 28 2013 - 06:36:11)        <i class="conum" data-value="3"></i><b>(3)</b>
reading args
spl: error reading image args, err - -1
reading u-boot.img
reading u-boot.img


U-Boot 2013.10 (Nov 28 2013 - 06:36:11)

I2C:   ready
DRAM:  512 MiB
WARNING: Caches not enabled
MMC:   OMAP SD/MMC: 0, OMAP SD/MMC: 1
Using default environment

Net:   &lt;ethaddr&gt; not set. Validating first E-fuse MAC
cpsw, usb_ether
Hit any key to stop autoboot:  0         <i class="conum" data-value="4"></i><b>(4)</b>
U-Boot#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We run the <em>picocom</em> application setting the baud rate to 115200 and
choosing the device as <em>/dev/ttyUSB0</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>picocom</em> shows that the terminal is ready after printing the serial
port settings</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>On application of power to the BeagleBone Black this is the first
print from U-Boot</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We can interrupt U-boot before it tries to boot the kernel by hitting
any key</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="setting-default-environment-variables-for-u-boot"><a class="anchor" href="#setting-default-environment-variables-for-u-boot"></a>23.6.4. Setting Default Environment Variables For U-Boot</h4>
<div class="paragraph">
<p>We need to make sure the version of the U-Boot running is 2013.10. We use the
command <em>version</em> to get the information.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot#     version        <i class="conum" data-value="1"></i><b>(1)</b>

U-Boot 2013.10 (Nov 28 2013 - 06:36:11)                <i class="conum" data-value="2"></i><b>(2)</b>
arm-linux-gnueabi-gcc (Ubuntu/Linaro 4.7.3-1ubuntu1) 4.7.3
GNU ld (GNU Binutils for Ubuntu) 2.23.52.20130913</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>version</em> checks the version of U-Boot in the system</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our version has to be 2013.10 to save the U-Boot environment to the eMMC storage</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally we reset the settings of the U-Boot environment to its default values using
the command <em>env default -f -a</em> as shown below. Finally <em>saveenv</em> is used to save
the environment settings whenever we want to retain it across reboots.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# env default -f -a                <i class="conum" data-value="1"></i><b>(1)</b>
## Resetting to default environment
U-Boot# saveenv                         <i class="conum" data-value="2"></i><b>(2)</b>
Saving Environment to MMC...                <i class="conum" data-value="3"></i><b>(3)</b>
Writing to redundant MMC(1)... done
U-Boot#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Resetting the environment variables to a default value</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Saving the environment values</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The environment values are saved to the eMMC device</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-ethernet-communication-with-the-board"><a class="anchor" href="#setting-up-ethernet-communication-with-the-board"></a>23.7. Setting Up Ethernet Communication With The Board</h3>
<div class="paragraph">
<p>We will now need to setup the board in such a way so as to allow us to download
files to its system memory using U-Boot. To do this we will use Trivial File
Transfer Protocol (TFTP) through an ethernet cable. Our board will be the TFTP
client and we will configure our Ubuntu work station to act as a TFTP server.
TFTP can be installed as shown below using APT.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo apt-get install tftpd-hpa</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we will connect an ethernet cable between our workstation and the BeagleBone
Black ethernet connector. If the workstation does not have any more connections
then we will have to use a USB ethernet adapter. In this case we have an unused
connection so we will connect the cable as shown.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-ethernet-connection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-ethernet-connection.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-ethernet-connection.jpg" alt="beagleboneblacktux ethernet connection" width="640" height="480"></a>
</div>
<div class="title">BeagleBone Black connected to ethernet cable</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We next have to configure the network interface on the workstation side. Click
on the network manager tasklet on the desktop and select <em>Edit Connections</em>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-ethernet-screenshot-edit-connections" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-ethernet-screenshot-edit-connections.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-ethernet-screenshot-edit-connections.png" alt="beagleboneblacktux ethernet screenshot edit connections" width="640" height="480"></a>
</div>
<div class="title">Screen shot of <em>Edit Connections</em> selected in the network manager tasklet</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Click on the Add button on the left and then <em>Create..</em> an ethernet connection.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-ethernet-screenshot-add-new-connection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-ethernet-screenshot-add-new-connection.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-ethernet-screenshot-add-new-connection.png" alt="beagleboneblacktux ethernet screenshot add new connection" width="640" height="480"></a>
</div>
<div class="title">Screen shot of adding a new ethernet conneciton</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Edit the new ethernet connection by changing its name to <em>BBB</em>. Change the
IPV4 settings by selecting the method as manual. And finally add the static
address as 192.168.0.1 and netmask as 255.255.255.0. There&#8217;s no need to add
a gateway but if the cursor is in the textbox enter 0.0.0.0. Save the
settings and the interface is set up on the workstation.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-ethernet-screenshot-edit-new-connection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-ethernet-screenshot-edit-new-connection.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-ethernet-screenshot-edit-new-connection.png" alt="beagleboneblacktux ethernet screenshot edit new connection" width="640" height="480"></a>
</div>
<div class="title">Screen shot of editing IPV4 settings of the new ethernet connection</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now that we have our workstation ethernet interface configured we can setup
networking on U-Boot&#8217;s side. We can print the environment to check what the
variables are set to by running <em>printenv</em> which will give out the values
of all the variables in the U-Boot environment. In our case with the default
environment values we see that the IP address and TFTP server IP is not set.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot#
U-Boot# printenv        <i class="conum" data-value="1"></i><b>(1)</b>
arch=arm
baudrate=115200
board=am335x
board_name=A335BNLT
board_rev=00A6
.
.
.
stderr=serial
stdin=serial
stdout=serial
usbnet_devaddr=90:59:af:49:c8:ef
vendor=ti
ver=U-Boot 2013.10 (Nov 28 2013 - 06:36:11)

Environment size: 3471/131067 bytes
U-Boot# printenv ipaddr                <i class="conum" data-value="2"></i><b>(2)</b>
## Error: &quot;ipaddr&quot; not defined
U-Boot# printenv serverip        <i class="conum" data-value="3"></i><b>(3)</b>
## Error: &quot;serverip&quot; not defined</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Print all the environment variables</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Print value of the IP address</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Print value of TFTP server IP</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We will set the server IP to the static IP we assigned to our ethernet
interface on our workstation and IP address to a different value as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# setenv ipaddr 192.168.0.100        <i class="conum" data-value="1"></i><b>(1)</b>
U-Boot# printenv ipaddr
ipaddr=192.168.0.100
U-Boot# setenv serverip 192.168.0.1        <i class="conum" data-value="2"></i><b>(2)</b>
U-Boot# printenv serverip
serverip=192.168.0.1
U-Boot# saveenv                                <i class="conum" data-value="3"></i><b>(3)</b>
Saving Environment to MMC...
Writing to MMC(1)... done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Setting the IP address to 192.168.0.100</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setting the server IP to the workstation ethernet interface IP</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Saving the environment variables</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next step is to test the connection by creating a file called testfile.txt
in <em>/var/lib/tftpboot/</em>. We will attempt to download the file through the
<em>tftp</em> command in U-Boot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# tftp 0x81000000 testfile.txt        <i class="conum" data-value="1"></i><b>(1)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename 'testfile.txt'.
Load address: 0x81000000
Loading: T T T T T T T T
Abort                <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The tftp command takes a memory address in our BBB system and the file name
as parameters.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We abort the command with CTRL-C after a while as nothing seems to be happening.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This may happen if the tftp service has not been started properly. So we can restart
the service using the following command on the workstation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo service tftpd-hpa restart
tftpd-hpa stop/waiting
tftpd-hpa start/running, process 12562</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now when we try the <em>tftp</em> command again in the U-Boot command prompt we are
able to successfully download the file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# tftp 0x81000000 testfile.txt
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename 'testfile.txt'.
Load address: 0x81000000
Loading: #
         6.8 KiB/s
done
Bytes transferred = 23 (17 hex)                <i class="conum" data-value="1"></i><b>(1)</b>
U-Boot# md 0x81000000                        <i class="conum" data-value="2"></i><b>(2)</b>
81000000: 67616542 6f42656c 4220656e 6b63616c    BeagleBone Black
81000010: 61776120 fa0a2179 3477dfe5 36c5771d     away!....w4.w.6
81000020: ddfddd53 acb6fdf7 bff3df47 8df4e90d    S.......G.......
81000030: 51bbd157 4bbfd90f 5f723ff2 ae63b73f    W..Q...K.?r_?.c.
81000040: e777dbbd ff1f5774 d43f27c9 bcefd75d    ..w.tW...'?.]...
81000050: fdb7eff5 fd7ff7bd 6c7e5ebc df50576c    .........^~llWP.
81000060: f6fdad24 e24de9dd fdaf3f3f 97cfffbe    $.....M.??......
81000070: fec7fc3d fbed8ff7 bfdd7bbe 57df759c    =........{...u.W
81000080: 7fbbd68d 3cb2b137 a71377cf 1754bdff    ....7..&lt;.w....T.
81000090: ef4cf775 bbee4a85 fe75553d f137bfec    u.L..J..=Uu...7.
810000a0: f9997e33 f5f77735 df4cbffb dd7d4d49    3~..5w....L.IM}.
810000b0: f077f636 b5e5d555 5c7fb5f7 d7f69374    6.w.U......\t...
810000c0: f27f9d5f f1d4fd65 74a5db11 b5b6734d    _...e......tMs..
810000d0: 77d75f6f 3ef5757e d327f1d7 91255fd7    o_.w~u.&gt;..'.._%.
810000e0: f5c47f7f fe5d77fe 445ebfdd ed78dbbf    .....w]...^D..x.
810000f0: 7fb36aff 4fffe7bf d7bd7f5f 9fdffe6d    .j.....O_...m...
U-Boot#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The file was successfully transferred this time.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We read the contents of the load address at 0x81000000 and see
"BeagleBone Black away!" as expected.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have successfully setup U-Boot to download the kernel.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lab-3-cross-compiling-the-kernel-and-booting-it-from-the-workstation"><a class="anchor" href="#lab-3-cross-compiling-the-kernel-and-booting-it-from-the-workstation"></a>24. LAB 3 : Cross Compiling The Kernel And Booting It From The Workstation</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">This is a hands on session taken from the Free Electrons labs with the following objectives</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cross-compile the Linux kernel for the ARM platform</p>
</li>
<li>
<p>Boot the cross-compiled kernel with a NFS root filesystem, using the workstation as a NFS
server</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="enabling-networking-to-speed-up-embedded-development"><a class="anchor" href="#enabling-networking-to-speed-up-embedded-development"></a>24.1. Enabling Networking To Speed Up Embedded Development</h3>
<div class="paragraph">
<p>In the previous lab we enabled network connectivity between the board and
workstation by configuring the U-Boot environment appropriately. This
enables us to build our binaries on the workstation and test it on the
board without having to flash the board which saves time as well
as prolongs the life of the eMMC device or micro-SD card. We will also
enable a NFS type of root filesystem which will allow us to test
cross-compiled modules on board.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="lab-setup-implementation" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/lab-setup-implementation.png"><img src="http://zeuzoix.github.io/techeuphoria/images/lab-setup-implementation.png" alt="lab setup implementation" width="640" height="480"></a>
</div>
<div class="title">Lab setup implementation</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="installing-the-prerequisites"><a class="anchor" href="#installing-the-prerequisites"></a>24.2. Installing The Prerequisites</h3>
<div class="paragraph">
<p>We will need to install a couple of packages before we can proceed with the lab.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/src$ sudo apt-get install libqt4-dev g++ u-boot-tools        <i class="conum" data-value="1"></i><b>(1)</b>
.
.
.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/src$ sudo apt-get install gcc-arm-linux-gnueabi        <i class="conum" data-value="2"></i><b>(2)</b>
.
.
.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/src$ dpkg -L gcc-arm-linux-gnueabi                        <i class="conum" data-value="3"></i><b>(3)</b>
/.
/usr
/usr/bin
/usr/share
/usr/share/doc
/usr/share/man
/usr/share/man/man1
/usr/bin/arm-linux-gnueabi-gcc
/usr/bin/arm-linux-gnueabi-gcov
/usr/share/doc/gcc-arm-linux-gnueabi
/usr/share/man/man1/arm-linux-gnueabi-gcov.1.gz
/usr/share/man/man1/arm-linux-gnueabi-gcc.1.gz</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>libtqy4-dev, g++ are required for <em>make xconfig</em>. u-boot-tools are required
for mkuimage</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>gcc-arm-linux-gnueabi is the cross compiler toolchain from Linaro</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Path and name of the cross-compiler can be determined by examining the
cross-compiler installed.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="configuring-the-kernel-2"><a class="anchor" href="#configuring-the-kernel-2"></a>24.3. Configuring The Kernel</h3>
<div class="paragraph">
<p>We start with configuring the kernel source code with a default configuration.
Since our board has a processor(AM335x) which belongs to the OMAP2 family we
will use a default configuration file for that board i.e. omap2plus_defconfig.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ find arch/arm/configs/ -iname '*omap*'
arch/arm/configs/omap2plus_defconfig        <i class="conum" data-value="1"></i><b>(1)</b>
arch/arm/configs/omap1_defconfig
arch/arm/configs/da8xx_omapl_defconfig
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- omap2plus_defconfig        <i class="conum" data-value="2"></i><b>(2)</b>
#
# configuration written to .config
#
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The default configuration for omap2 boards</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setting the default configuration to omap2dplus_defconfig</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now configure the kernel to use a NFS root filesystem. This can be done with
any of the configuration targets i.e. menuconfig, nconfig, gconfig or xconfig.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig
scripts/kconfig/mconf Kconfig
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>To identify the configuration option for NFS root filesystem search for
<em>CONFIG_ROOT_NFS</em> once the menuconfig screen appears.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-search-config-root-nfs-screenshot" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-search-config-root-nfs-screenshot.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-search-config-root-nfs-screenshot.png" alt="beagleboneblacktux search config root nfs screenshot" width="640" height="480"></a>
</div>
<div class="title">Searching for CONFIG_ROOT_NFS</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We see that CONFIG_ROOT_NFS can be reached through <strong>"File systems"</strong> and
<strong>"Network File Systems"</strong></p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-found-config-root-nfs-screenshot" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-found-config-root-nfs-screenshot.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-found-config-root-nfs-screenshot.png" alt="beagleboneblacktux found config root nfs screenshot" width="640" height="480"></a>
</div>
<div class="title">CONFIG_ROOT_NFS is under File systems and Network File Systems</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-config-root-nfs-filesystems-select" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-config-root-nfs-filesystems-select.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-config-root-nfs-filesystems-select.png" alt="beagleboneblacktux config root nfs filesystems select" width="640" height="480"></a>
</div>
<div class="title">We select File systems</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-config-root-nfs-network-file-systems-select" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-config-root-nfs-network-file-systems-select.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-config-root-nfs-network-file-systems-select.png" alt="beagleboneblacktux config root nfs network file systems select" width="640" height="480"></a>
</div>
<div class="title">We select Network File Systems</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-config-root-nfs-root-file-system-on-nfs-select" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-config-root-nfs-root-file-system-on-nfs-select.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-config-root-nfs-root-file-system-on-nfs-select.png" alt="beagleboneblacktux config root nfs root file system on nfs select" width="640" height="480"></a>
</div>
<div class="title">We select Root file system on NFS</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cross-compiling-the-kernel-2"><a class="anchor" href="#cross-compiling-the-kernel-2"></a>24.4. Cross-compiling The Kernel</h3>
<div class="paragraph">
<p>Now it is time to cross-compile the kernel after we have configured it
correctly. We will first do a clean on the source code to make sure we&#8217;re
compiling fresh</p>
</div>
<div class="sect3">
<h4 id="clean-the-sources"><a class="anchor" href="#clean-the-sources"></a>24.4.1. Clean The Sources</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- clean
  CLEAN   .
  CLEAN   arch/arm/kernel
  CLEAN   drivers/eisa
  CLEAN   drivers/gpu/drm/radeon
  CLEAN   drivers/net/wan
  CLEAN   drivers/scsi/aic7xxx
  CLEAN   drivers/scsi
  CLEAN   drivers/tty/vt
  CLEAN   drivers/video/logo
  CLEAN   firmware
  CLEAN   kernel/debug/kdb
  CLEAN   kernel
  CLEAN   lib/raid6
  CLEAN   lib
  CLEAN   security/apparmor
  CLEAN   security/selinux
  CLEAN   usr
  CLEAN   arch/arm/boot/compressed
  CLEAN   arch/arm/boot/dts
  CLEAN   arch/arm/boot
  CLEAN   .tmp_versions</code></pre>
</div>
</div>
<div class="paragraph">
<p>We compile the source code by invoking make with no target and by passing
ARCH as <em>arm</em> and CROSS_COMPILE as <em>arm-linux-gnueabi-</em>. The compilation
process may take a while.</p>
</div>
</div>
<div class="sect3">
<h4 id="build-zimage"><a class="anchor" href="#build-zimage"></a>24.4.2. Build zImage</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-                <i class="conum" data-value="1"></i><b>(1)</b>
  CHK     include/config/kernel.release
  CHK     include/generated/uapi/linux/version.h
  CHK     include/generated/utsrelease.h
  HOSTCC  scripts/basic/fixdep
make[1]: `include/generated/mach-types.h' is up to date.
  CC      kernel/bounds.s
.
.
.
  CC      sound/soc/omap/snd-soc-omap3pandora.mod.o
  LD [M]  sound/soc/omap/snd-soc-omap3pandora.ko
  CC      sound/soc/snd-soc-core.mod.o
  LD [M]  sound/soc/snd-soc-core.ko
  CC      sound/soundcore.mod.o
  LD [M]  sound/soundcore.ko
  CC      sound/usb/snd-usb-audio.mod.o
  LD [M]  sound/usb/snd-usb-audio.ko
  CC      sound/usb/snd-usbmidi-lib.mod.o
  LD [M]  sound/usb/snd-usbmidi-lib.ko
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ ls -l arch/arm/boot/
total 12828
drwxrwxr-x 2 conrad conrad    4096 Nov 12 23:07 bootp
drwxrwxr-x 2 conrad conrad    4096 Mar 30 21:28 compressed
drwxrwxr-x 4 conrad conrad   36864 Mar 30 21:28 dts
-rwxrwxr-x 1 conrad conrad 8843712 Mar 30 21:28 Image
-rw-rw-r-- 1 conrad conrad    1648 Oct 19  2013 install.sh
-rw-rw-r-- 1 conrad conrad    3148 Oct 19  2013 Makefile
-rwxrwxr-x 1 conrad conrad 4229384 Mar 30 21:28 zImage                                        <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ file arch/arm/boot/zImage
arch/arm/boot/zImage: Linux kernel ARM boot executable zImage (little-endian)                <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The cross-compilation command in the kernel source directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The zImage generated after cross-compilation</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We check the type of file of zImage using the <em>file</em> command</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="build-uimage"><a class="anchor" href="#build-uimage"></a>24.4.3. Build uImage</h4>
<div class="paragraph">
<p>In order to boot the kernel image with U-Boot we need to convert it into
a special format called <em>uImage</em>. The kernel Makefile has a target that can do
this and which uses <em>mkimage</em> tool found in the u-boot-tools package. The file
will contain the zImage kernel and information about load address of the
kernel. The load address will vary based on the platform for the BeagleBone
Black board it is 0x80008000.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make LOADADDR=0x80008000 uImage                <i class="conum" data-value="1"></i><b>(1)</b>
  CHK     include/config/kernel.release
  CHK     include/generated/uapi/linux/version.h
  CHK     include/generated/utsrelease.h
make[1]: `include/generated/mach-types.h' is up to date.
  CALL    scripts/checksyscalls.sh
  CHK     include/generated/compile.h
  CHK     kernel/config_data.h
  Kernel: arch/arm/boot/Image is ready
  Kernel: arch/arm/boot/zImage is ready
  UIMAGE  arch/arm/boot/uImage
Image Name:   Linux-3.13.11
Created:      Tue Mar 31 21:50:14 2015
Image Type:   ARM Linux Kernel Image (uncompressed)
Data Size:    4229384 Bytes = 4130.26 kB = 4.03 MB
Load Address: 80008000
Entry Point:  80008000
  Image arch/arm/boot/uImage is ready                                <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Invoking the uImage target with LOADADDR set to 0x80008000</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The image is located at <em>arch/arm/boot/uImage</em></td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="generate-the-device-tree-binaries"><a class="anchor" href="#generate-the-device-tree-binaries"></a>24.4.4. Generate The Device Tree Binaries</h4>
<div class="paragraph">
<p>We also need to generate the Device Tree Binaries (DTBs)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make dtbs</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="copy-to-tftp-server-home-directory"><a class="anchor" href="#copy-to-tftp-server-home-directory"></a>24.4.5. Copy To TFTP Server Home Directory</h4>
<div class="paragraph">
<p>Finally we can copy the <em>uImage</em> and the <em>am335x-boneblack.dtb</em> files to the
TFTP server home directory i.e. <em>/var/lib/tftpboot</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ cp arch/arm/boot/dts/am335x-boneblack.dtb /var/lib/tftpboot/.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ cp arch/arm/boot/uImage /var/lib/tftpboot/.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-the-nfs-server"><a class="anchor" href="#setting-up-the-nfs-server"></a>24.5. Setting Up The NFS Server</h3>
<div class="paragraph">
<p>We will now need to setup our workstation as a NFS server. This will require
installation of the <em>nfs-kernel-server</em> package.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo apt-get install nfs-kernel-server</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once installed we need to edit the <em>/etc/exports</em> file to configure the server
to allow a NFS client to connect to it and mount a directory. In this case
we want to configure the NFS server in such a way so as to allow our
BeagleBone Black platform to mount the root filesystem which is there in our
workstation lab data directory.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ cat /etc/exports                 <i class="conum" data-value="1"></i><b>(1)</b>
# /etc/exports: the access control list for filesystems which may be exported
#                to NFS clients.  See exports(5).
#
# Example for NFSv2 and NFSv3:
# /srv/homes       hostname1(rw,sync,no_subtree_check) hostname2(ro,sync,no_subtree_check)
#
# Example for NFSv4:
# /srv/nfs4        gss/krb5i(rw,sync,fsid=0,crossmnt,no_subtree_check)
# /srv/nfs4/homes  gss/krb5i(rw,sync,no_subtree_check)
#
/home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot 192.168.0.100(rw,no_root_squash,no_subtree_check)        <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>After editing the file we cat its contents</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The directory of nfsroot is exported to IP 192.168.0.100 which is our BBB IP</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally before we boot make sure to restart the NFS server as shown below. If
there are any errors then the server will refuse to start and error logs will
appear. The <em>/etc/exports</em> file must be revisited and the syntax of the line
must be inspected and corrected. Fix the errors and ensure the NFS server
restarts before proceeding.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo service nfs-kernel-server restart
 * Stopping NFS kernel daemon                                 [ OK ]
 * Unexporting directories for NFS kernel daemon...     [ OK ]
 * Exporting directories for NFS kernel daemon...       [ OK ]
 * Starting NFS kernel daemon                           [ OK ]
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="boot-the-system"><a class="anchor" href="#boot-the-system"></a>24.6. Boot The System</h3>
<div class="paragraph">
<p>We will now proceed to boot the system. Make sure the BeagleBone Black is
connected to the USB to serial connector correctly as was described in
Lab2. Also make sure your etherned cable is connected between the board
and your workstation. On powering up the board interrupt the boot sequence
so that we have access to the U-Boot console.</p>
</div>
<div class="sect3">
<h4 id="setting-the-em-bootargs-em"><a class="anchor" href="#setting-the-em-bootargs-em"></a>24.6.1. Setting The <em>bootargs</em></h4>
<div class="paragraph">
<p>We will now change the <em>bootargs</em> environment variable to instruct it to
boot the root filesystem from a NFS server and also we will pass the
consoled that it is to use. These are standard kernel parameters which
can change the way the kernel boots the system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot 2013.10 (Nov 28 2013 - 06:36:11)

I2C:   ready
DRAM:  512 MiB
WARNING: Caches not enabled
MMC:   OMAP SD/MMC: 0, OMAP SD/MMC: 1
Net:   cpsw, usb_ether
Hit any key to stop autoboot:  0
U-Boot#
U-Boot# setenv bootargs root=/dev/nfs rw ip=192.168.0.100 console=ttyO0 nfsroot=192.168.0.1:/home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot        <i class="conum" data-value="1"></i><b>(1)</b>
U-Boot# printenv bootargs
bootargs=root=/dev/nfs rw ip=192.168.0.100 console=ttyO0 nfsroot=192.168.0.1:/home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot
U-Boot#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use setenv to fix the <em>bootargs</em>.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="explanation-of-the-bootargs"><a class="anchor" href="#explanation-of-the-bootargs"></a>24.6.2. Explanation Of The Bootargs</h4>
<div class="dlist">
<dl>
<dt class="hdlist1">root=/dev/nfs</dt>
<dd>
<p>We set the root filesystem device as /dev/nfs to indicate that
NFS is to be used.
rw::The root filesystem should be mounted with read and write capabilities</p>
</dd>
<dt class="hdlist1">ip=192.168.0.100</dt>
<dd>
<p>The IP of the BeagleBone Black board should be 192.168.0.100
before mounting the NFS root filesystem</p>
</dd>
<dt class="hdlist1">console=ttyO0</dt>
<dd>
<p>The console to be used is serial port 0. The character before
the 0 is 'O' as in "OMAP".</p>
</dd>
<dt class="hdlist1">nfsroot=192.168.0.1:/home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot</dt>
<dd>
<p>The
NFS root filesystem server IP and path of the directory. This is similar to
the workstation settings. The IP is the workstation ethernet static IP and
the path is the same as that in the <em>/etc/exports</em>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="download-the-kernel-image-and-device-tree-binary"><a class="anchor" href="#download-the-kernel-image-and-device-tree-binary"></a>24.6.3. Download The Kernel Image And Device Tree Binary</h4>
<div class="paragraph">
<p>The first step is to download the <em>uImage</em> via <em>tftp</em>. Before downloading it
is good to restart the TFTP server on the workstation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ sudo service tftpd-hpa restart
tftpd-hpa stop/waiting
tftpd-hpa start/running, process 4204
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next on the U-Boot console we can download the uImage as we learnt in the previous lab.
We download it to address 0x81000000.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# tftp 0x81000000 uImage                                <i class="conum" data-value="1"></i><b>(1)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename 'uImage'.
Load address: 0x81000000
Loading: #################################################################
         #################################################################
         #################################################################
         #################################################################
         #############################
         1.3 MiB/s
done
Bytes transferred = 4229448 (408948 hex)                <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to download <em>uImage</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>4229448 bytes successfully transferred.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next we download the device tree binary for the BeagleBone Black board to
address 0x82000000</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# tftp 0x82000000 am335x-boneblack.dtb                 <i class="conum" data-value="1"></i><b>(1)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename 'am335x-boneblack.dtb'.
Load address: 0x82000000
Loading: ##
         485.4 KiB/s
done
Bytes transferred = 17911 (45f7 hex)                        <i class="conum" data-value="2"></i><b>(2)</b>
U-Boot#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to download <em>am335x-boneblack.dtb</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>17911 bytes successfully transferred.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="boot-the-kernel"><a class="anchor" href="#boot-the-kernel"></a>24.6.4. Boot The Kernel</h4>
<div class="paragraph">
<p>Finally we can boot the kernel from the U-Boot prompt passing the address
of the <em>uImage</em> and the address of the device tree binary. The complete log
file is available <a href="../logs/lab3-kernel-boot.txt" target="_blank">here</a>. The credentials for the
login prompt are username as <em>root</em> and no password.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"><i class="conum" data-value="1"></i><b>(1)</b>
U-Boot# bootm 0x81000000 - 0x82000000
## Booting kernel from Legacy Image at 81000000 ...
   Image Name:   Linux-3.13.11
   Image Type:   ARM Linux Kernel Image (uncompressed)
   Data Size:    4229384 Bytes = 4 MiB
   Load Address: 80008000
   Entry Point:  80008000
   Verifying Checksum ... OK
## Flattened Device Tree blob at 82000000
   Booting using the fdt blob at 0x82000000
   Loading Kernel Image ... OK
   Using Device Tree in place at 82000000, end 820075f6

Starting kernel ...
.
.
<i class="conum" data-value="2"></i><b>(2)</b>
[    5.028652] libphy: 4a101000.mdio:00 - Link is Up - 100/Full
[    5.068073] IP-Config: Guessing netmask 255.255.255.0
[    5.073695] IP-Config: Complete:
[    5.077074]      device=eth0, hwaddr=90:59:af:49:c8:ef, ipaddr=192.168.0.100, mask=255.255.255.0, gw=255.255.255.255
[    5.088130]      host=192.168.0.100, domain=, nis-domain=(none)
[    5.094313]      bootserver=255.255.255.255, rootserver=192.168.0.1, rootpath=
[    5.120355] VFS: Mounted root (nfs filesystem) on device 0:13.
[    5.142936] devtmpfs: mounted
[    5.146640] Freeing unused kernel memory: 384K (c0771000 - c07d1000)
Starting logging: OK
Initializing random number generator... [    5.795678] random: dd urandom read with 56 bits of entropy available
done.
Starting network...
ip: RTNETLINK answers: File exists
Starting dropbear sshd: OK

Welcome to Buildroot
buildroot login: root
#
#
#
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Successfully starting the kernel</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The NFS root filesystem has been successfully mounted giving us access to a root terminal.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If at all the kernel fails to mount the NFS root filesystem take a look
at the <em>/var/log/syslog</em> file.</p>
</div>
</div>
<div class="sect3">
<h4 id="automating-the-boot-system"><a class="anchor" href="#automating-the-boot-system"></a>24.6.5. Automating The Boot System</h4>
<div class="paragraph">
<p>It is cumbersome to repeat the sequence of U-Boot commands at the console
everytime we want to boot our system. We can automate the boot process by
changing the <em>bootcmd</em> environment variable of U-Boot. Before doing so we
can save the older value of <em>bootcmd</em> in another variable of our choice.
Reset the board by pressing the "Reset" switch. Interrupt the U-Boot
autoprompt sequence to gain access to the U-Boot terminal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# printenv bootcmd        <i class="conum" data-value="1"></i><b>(1)</b>
bootcmd=run findfdt; run mmcboot;setenv mmcdev 1; setenv bootpart 1:2; run mmcboot;run nandboot;
U-Boot#
U-Boot# setenv bootcmd_orig 'run findfdt; run mmcboot;setenv mmcdev 1; setenv bootpart 1:2; run mmcboot;run nandboot;'        <i class="conum" data-value="2"></i><b>(2)</b>
U-Boot# printenv bootcmd_orig
bootcmd_orig=run findfdt; run mmcboot;setenv mmcdev 1; setenv bootpart 1:2; run mmcboot;run nandboot;
U-Boot#
U-Boot# setenv bootcmd 'tftp 0x81000000 uImage; tftp 0x82000000 am335x-boneblack.dtb; bootm 0x81000000 - 0x82000000'        <i class="conum" data-value="3"></i><b>(3)</b>
U-Boot# printenv bootcmd
bootcmd=tftp 0x81000000 uImage; tftp 0x82000000 am335x-boneblack.dtb; bootm 0x81000000 - 0x82000000
U-Boot# saveenv                        <i class="conum" data-value="4"></i><b>(4)</b>
Saving Environment to MMC...
Writing to MMC(1)... done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Checking the value of <em>bootcmd</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Note the use of single quotes for the value of the command</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Setting the new value of <em>bootcmd</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Saving the environment changes</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>bootcmd</em> can be changed based on requirements. It can also be changed to
boot the <em>uImage</em> from the eMMC flash if it is stored there. As a last step
power cycle the board to check if the system boots up as was done previously.
If there is an issue in the boot sequence then review the <em>bootcmd</em> carefully.</p>
</div>
</div>
<div class="sect3">
<h4 id="halting-the-sytem-and-disconnecting-picocom"><a class="anchor" href="#halting-the-sytem-and-disconnecting-picocom"></a>24.6.6. Halting The Sytem And Disconnecting Picocom</h4>
<div class="paragraph">
<p>We have to remember that the BeagleBone Black is a development board which
may not be as robust as other products. To be on the safer side it is good
to shutdown the system correctly. To shutdown the system we can issue the
<em>halt</em> command in the terminal.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">buildroot login: root
#
#
# halt                                        <i class="conum" data-value="1"></i><b>(1)</b>
The system is going down NOW!
Sent SIGTERM to all processes
Sent SIGKILL to all processes
Requesting system halt
[  202.908940] reboot: System halted        <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>On issuing <em>halt</em> wait for the system to shutdown</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The last log received</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally <em>picocom</em> can be disengaged carefully by keying the
"espace character" which by default is "C-a" and then by hitting
"x".</p>
</div>
</div>
</div>
</div>
</div>
<h1 id="linux-kernel-modules" class="sect0"><a class="anchor" href="#linux-kernel-modules"></a>Linux Kernel Modules</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This section covers details about Linux Kernel modules. Some features of the
kernel can be loaded as modules after it boots up. We will understand what a
module is and when it is used. We will also write, compile and test our very
own kernel module.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="when-do-we-use-kernel-modules"><a class="anchor" href="#when-do-we-use-kernel-modules"></a>25. When Do We Use Kernel Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the <a href="#configuring-features-as-modules">Configuring Features As Modules</a>
section we learnt about Kernel modules and how we can configure certain
features of the kernel source code to be compiled as separate binaries
that can be loaded into the kernel after it boots up. These modules can
also exist independent of the kernel source code in another source path
and can be compiled with the headers of the kernel so long as the API
used in the module are compatible with the kernel source code.</p>
</div>
<div class="paragraph">
<p>We use kernel modules when:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>We are interested in developing a feature of the kernel independently.
This allows us to make changes to the module source code, load and test it
without having to reboot the kernel. If the source code were a part of the
kernel source code we would have to reboot the kernel everytime we wanted
to test the code.</p>
</li>
<li>
<p>We want to minimize the size of the kernel image. In most cases if the
system is a general purpose system then the drivers and features required
by certain applications do not have to be present in the kernel from boot.
They can be loaded on demand. In embedded systems the kernel is sometimes
stored on a limited storage device like NAND flash on a partition. The
size of the partition of the kernel will depend on the size of the kernel
used for the applications of that system.</p>
</li>
<li>
<p>We want to minimize the boot time to improve system responsiveness after
a reboot. If features that are not required immediately after boot are part
of the kernel then their initialization will be add to the boot time. We
can delay their initialization using kernel modules.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="determining-kernel-module-dependencies"><a class="anchor" href="#determining-kernel-module-dependencies"></a>26. Determining Kernel Module Dependencies</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kernel modules cannot be loaded if the modules they depend on have not been
loaded into the kernel. To check the module dependencies of a particular
module, read the module information using <em>modinfo</em>. Apart from other useful
information about the Kernel module <em>modinfo</em> will also give a list of
dependencies in the <em>depends</em> field. We will check the module dependency
for one of the kernel modules in our workstation as an example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ modinfo mac80211        <i class="conum" data-value="1"></i><b>(1)</b>
filename:       /lib/modules/3.13.0-45-generic/kernel/net/mac80211/mac80211.ko
license:        GPL
description:    IEEE 802.11 subsystem
srcversion:     385697223F8285F67C93A06
depends:        cfg80211        <i class="conum" data-value="2"></i><b>(2)</b>
intree:         Y
vermagic:       3.13.0-45-generic SMP mod_unload modversions 686
signer:         Magrathea: Glacier signing key
sig_key:        36:89:BF:48:AF:50:2C:BA:FE:71:E5:C2:5D:6C:55:34:0B:7F:13:FF
sig_hashalgo:   sha512
parm:           max_nullfunc_tries:Maximum nullfunc tx tries before disconnecting (reason 4). (int)
parm:           max_probe_tries:Maximum probe tries before disconnecting (reason 4). (int)
parm:           beacon_loss_count:Number of beacon intervals before we decide beacon was lost. (int)
parm:           probe_wait_ms:Maximum time(ms) to wait for probe response before disconnecting (reason 4). (int)
parm:           ieee80211_default_rc_algo:Default rate control algorithm for mac80211 to use (charp)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use <em>modinfo</em> to check the information about <em>mac80211</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We see the dependency is module <em>cfg80211</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The utility <em>modinfo</em> can be also given the full path file name of a kernel
module if it is not loaded into the system</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ modinfo /lib/modules/3.13.0-45-generic/kernel/net/mac80211/mac80211.ko        <i class="conum" data-value="1"></i><b>(1)</b>
filename:       /lib/modules/3.13.0-45-generic/kernel/net/mac80211/mac80211.ko
license:        GPL
description:    IEEE 802.11 subsystem
srcversion:     385697223F8285F67C93A06
depends:        cfg80211
intree:         Y
vermagic:       3.13.0-45-generic SMP mod_unload modversions 686
signer:         Magrathea: Glacier signing key
sig_key:        36:89:BF:48:AF:50:2C:BA:FE:71:E5:C2:5D:6C:55:34:0B:7F:13:FF
sig_hashalgo:   sha512
parm:           max_nullfunc_tries:Maximum nullfunc tx tries before disconnecting (reason 4). (int)
parm:           max_probe_tries:Maximum probe tries before disconnecting (reason 4). (int)
parm:           beacon_loss_count:Number of beacon intervals before we decide beacon was lost. (int)
parm:           probe_wait_ms:Maximum time(ms) to wait for probe response before disconnecting (reason 4). (int)
parm:           ieee80211_default_rc_algo:Default rate control algorithm for mac80211 to use (charp)
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We give the full path file name of the kernel module</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The kernel module dependencies are described in the
<em>/lib/modules/&lt;kernel-version&gt;/modules.dep</em> file which is generated when
running the <em>make modules_install</em> command.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="inserting-kernel-modules"><a class="anchor" href="#inserting-kernel-modules"></a>27. Inserting Kernel Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To insert a module into the kernel we have to use the <em>insmod</em> command.
As a kernel module has the ability to affect the running kernel it requires
administrative privileges in order to insert the module. The full path
of the kernel module must be given e.g. <em>sudo insmod &lt;module_path&gt;.ko</em></p>
</div>
<div class="paragraph">
<p>It may so happen that the kernel module may refuse to load and <em>insmod</em>
will exit without giving sufficient details. In such a case we can inspect
the kernel logs using <em>dmesg</em> to understand what is failing.</p>
</div>
<div class="paragraph">
<p>Another method of inserting the module is to use <em>modprobe</em>. With this
method all dependent modules are also loaded into the kernel before
loading the module required. To do this <em>modprobe</em> determines the dependency
tree of the module and loads them in order. The dependent modules are
searched in the <em>/lib/modules/&lt;version&gt;/</em>. Based on the module name
the corresponding object file name is searched.</p>
</div>
<div class="paragraph">
<p>To list the modules which are inserted into the kernel we can use the
<em>lsmod</em> utility. Another way is to <em>cat</em> the contents of <em>/proc/modules</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="removing-kernel-modules"><a class="anchor" href="#removing-kernel-modules"></a>28. Removing Kernel Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can remove a module which has been inserted and is live as part of the kernel
if no other process or kernel module is using it. To do this we have to use the
<em>rmmod</em> utility with administrator privileges e.g. <em>sudo rmmod &lt;module name&gt;</em>.</p>
</div>
<div class="paragraph">
<p>Another way of removing the kernel module is with <em>modprobe</em> e.g.
<em>modprobe -r &lt;module name&gt;</em>. This will attempt to remove the module and all the
dependent modules which are no longer needed after removing the module.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="passing-parameters-to-modules"><a class="anchor" href="#passing-parameters-to-modules"></a>29. Passing Parameters To Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A kernel module can take parameters before loading it so as to change
its behavior during execution. The parameters of a kernel module can
be determined with the <em>modinfo</em> utility.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training$ modinfo mac80211        <i class="conum" data-value="1"></i><b>(1)</b>
filename:       /lib/modules/3.13.0-45-generic/kernel/net/mac80211/mac80211.ko
license:        GPL
description:    IEEE 802.11 subsystem
srcversion:     385697223F8285F67C93A06
depends:        cfg80211
intree:         Y
vermagic:       3.13.0-45-generic SMP mod_unload modversions 686
signer:         Magrathea: Glacier signing key
sig_key:        36:89:BF:48:AF:50:2C:BA:FE:71:E5:C2:5D:6C:55:34:0B:7F:13:FF
sig_hashalgo:   sha512
parm:           max_nullfunc_tries:Maximum nullfunc tx tries before disconnecting (reason 4). (int)        <i class="conum" data-value="2"></i><b>(2)</b>
parm:           max_probe_tries:Maximum probe tries before disconnecting (reason 4). (int)                <i class="conum" data-value="3"></i><b>(3)</b>
parm:           beacon_loss_count:Number of beacon intervals before we decide beacon was lost. (int)        <i class="conum" data-value="4"></i><b>(4)</b>
parm:           probe_wait_ms:Maximum time(ms) to wait for probe response before disconnecting (reason 4). (int)        <i class="conum" data-value="5"></i><b>(5)</b>
parm:           ieee80211_default_rc_algo:Default rate control algorithm for mac80211 to use (charp)        <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We use <em>modinfo</em> to check the information about <em>mac80211</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Parameter max_nullfunc_tries indicated with the <em>parm</em> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Parameter max_probe_tries indicated with the <em>parm</em> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Parameter beacon_loss_count indicated with the <em>parm</em> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Parameter probe_wait_ms indicated with the <em>parm</em> field.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Parameter ieee80211_default_rc_algo indicated with the <em>parm</em> field.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are several ways of passing parameters to the kernel module:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Through insmod:<br>
<em>sudo insmod ./snd-intel8x0m index=-2</em></p>
</li>
<li>
<p>Through modprobe by setting parameters in <em>/etc/modprobe.conf</em> or any file
in <em>/etc/modprobe.d/</em> as follows:<br>
<em>options snd-intel8x0m index=-2</em></p>
</li>
<li>
<p>Through the kernel command line, when the driver is built as part of the
kernel:<br>
<em>snd-intel8x0m index=-2</em></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><em>snd-intel8x0m</em> is the kernel module name</p>
</li>
<li>
<p><em>index</em> is the parameter</p>
</li>
<li>
<p><em>-2</em> is the value</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>To check the current values of modules already loaded in the kernel check the
<em>/sys/module/&lt;name&gt;/parameters</em> directory. Each file in it represents a parameter
and its content is the value of that parameter for the running module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ ls /sys/module/snd/parameters/
cards_limit  debug  major  slots                                                <i class="conum" data-value="1"></i><b>(1)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ cat /sys/module/snd/parameters/cards_limit
1                                                                                <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ cat /sys/module/snd/parameters/debug
1                                                                                <i class="conum" data-value="3"></i><b>(3)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ cat /sys/module/snd/parameters/major
116                                                                                <i class="conum" data-value="4"></i><b>(4)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$ cat /sys/module/snd/parameters/slots
(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null),(null)                                                <i class="conum" data-value="5"></i><b>(5)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Listing the parameters <em>cards_limit, debug, major, slots</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Checking the values passed to the parameter <em>card_limit</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Checking the values passed to the parameter <em>debug</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Checking the values passed to the parameter <em>major</em></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Checking the values passed to the parameter <em>slots</em></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="developing-kernel-modules"><a class="anchor" href="#developing-kernel-modules"></a>30. Developing Kernel Modules</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will first take a look at a sample source code of a Linux kernel module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/kernel.h&gt;</span>
<i class="conum" data-value="1"></i><b>(1)</b>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init sample_module_init(<span style="color:#088;font-weight:bold">void</span>)        <i class="conum" data-value="2"></i><b>(2)</b>
{
        pr_alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Wassup!</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit sample_module_exit(<span style="color:#088;font-weight:bold">void</span>)        <i class="conum" data-value="4"></i><b>(4)</b>
{
        pr_alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cya Later!</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
}

module_init(sample_module_init);                <i class="conum" data-value="3"></i><b>(3)</b>
module_exit(sample_module_exit);                <i class="conum" data-value="5"></i><b>(5)</b>

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);
MODULE_DESCRIPTION(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Sample Module</span><span style="color:#710">&quot;</span></span>);
MODULE_AUTHOR(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Newbie</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Only headers specific to the Linux kernel, no access to the standard C
library</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defining an initialization function, returns an int to indicate the
status of the initialization when <em>insmod</em> is used to load the module.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The macro <em>module_init</em> is used to register the initialization
function for the module.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Defining a  cleanup function for the module.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The macro <em>module_exit</em> is used to register the cleanup function for
the module.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Metadata for the module defining the license type, description and
the author.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The source code is in C but it has some special symbols which are not
used in user space application programming:<br></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">__init</dt>
<dd>
<p>This indicates that the module initializaiton function
<em>sample_module_init</em> can be removed after initialization. The function is called
only once when the module starts up and thereafter is not used. This optimizes
the memory usage of the kernel.</p>
</dd>
<dt class="hdlist1">__exit</dt>
<dd>
<p>This indicates that the function is discarded if the module is
compiled statically into the kernel or if module unloading is disabled. Its
primary use is for loadable kernel modules.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>It should be noted that the name of the initialization and cleanup
functions can be anything however the module name is often used to form
the functions (&lt;modulename&gt;_init()/&lt;modulename_exit()).</p>
</div>
<div class="sect2">
<h3 id="symbols-exported-to-modules"><a class="anchor" href="#symbols-exported-to-modules"></a>30.1. Symbols Exported To Modules</h3>
<div class="paragraph">
<p>A kernel module can use functions and variables defined in other parts of the Linux
kernel source code so long as they are exported. There are two macros
that are used to export the symbol names that can be used by other modules:<br></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">EXPORT_SYMBOL(symbolname)</dt>
<dd>
<p>Exports a function or variable to all modules</p>
</dd>
<dt class="hdlist1">EXPORT_SYMBOL_GPL(symbolname)</dt>
<dd>
<p>Exports a function or variable to only GPL
modules</p>
</dd>
</dl>
</div>
<div class="exampleblock">
<div class="content">
<div id="symbols-exported-to-modules" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/symbols-exported-to-modules.png"><img src="http://zeuzoix.github.io/techeuphoria/images/symbols-exported-to-modules.png" alt="symbols exported to modules" width="640" height="480"></a>
</div>
<div class="title">Symbols exported to modules</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The diagram illustrates the difference between exporting a symbol with
<em>EXPORT_SYMBOL</em> versus <em>EXPORT_SYMBOL_GPL</em>. Symbols exported by
<em>EXPORT_SYMBOL_GPL</em>(func3, func4) can be used by only GPL modules whereas
symbols exported by <em>EXPORT_SYMBOL</em> can be used by both GPL and Non-GPL
modules. A module gets it&#8217;s license from the <em>MODULE_LICENSE</em> macro added
in it&#8217;s source code along with the other metadata.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/kernel.h&gt;</span>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init sample_module_init(<span style="color:#088;font-weight:bold">void</span>)
.
.
.
MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);                                <i class="conum" data-value="1"></i><b>(1)</b>
MODULE_DESCRIPTION(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Sample Module</span><span style="color:#710">&quot;</span></span>);
MODULE_AUTHOR(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Newbie</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Module license is GPL</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The kernel can only use symbols defined in its source code. It cannot
use symbols exported by <em>modules</em> even if they are GPL licensed modules.
Symbols exported with <em>EXPORT_SYMBOL_GPL</em> can be used only by GPL licensed
modules. Symbols exported with <em>EXPORT_SYMBOL</em> can be used by GPL and Non-GPL
licensed modules</p>
</div>
</div>
<div class="sect2">
<h3 id="about-module-licenses"><a class="anchor" href="#about-module-licenses"></a>30.2. About Module Licenses</h3>
<div class="paragraph">
<p>The <em>MODULE_LICENSE</em> macro is used to define the license of the module. It is
used to restrict the functions that a module can use if it is not a GPL licensed
module. GPL licensed modules have access to all exported symbols whereas
Non-GPL licensed modules can only access symbols exported with <em>EXPORT_SYMBOL</em>.</p>
</div>
<div class="paragraph">
<p>Another use for module licenses is to identify issues comming from proprietary
modules. Typically kernel developers do not fix issues coming from proprietary
modules or drivers which cause kernel crashes and OOPSes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C"><span style="color:#579">#ifndef</span> __LICENSE_H
<span style="color:#579">#define</span> __LICENSE_H

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">inline</span> <span style="color:#0a8;font-weight:bold">int</span> license_is_gpl_compatible(<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *license)
{
        <span style="color:#080;font-weight:bold">return</span> (strcmp(license, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>) == <span style="color:#00D">0</span>
                || strcmp(license, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL v2</span><span style="color:#710">&quot;</span></span>) == <span style="color:#00D">0</span>
                || strcmp(license, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL and additional rights</span><span style="color:#710">&quot;</span></span>) == <span style="color:#00D">0</span>
                || strcmp(license, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Dual BSD/GPL</span><span style="color:#710">&quot;</span></span>) == <span style="color:#00D">0</span>
                || strcmp(license, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Dual MIT/GPL</span><span style="color:#710">&quot;</span></span>) == <span style="color:#00D">0</span>
                || strcmp(license, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Dual MPL/GPL</span><span style="color:#710">&quot;</span></span>) == <span style="color:#00D">0</span>);
}

<span style="color:#579">#endif</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>GPL compatible licenses are defined in the <em>include/linux/license.h</em> file as
shown above. These include GPL, GPL v2, GPL and additional rights, Dual BSD/GPL,
Dual MIT/GPL or Dual MPL/GPL. All other licenses are considered as proprietary.</p>
</div>
</div>
<div class="sect2">
<h3 id="compiling-modules-out-of-tree"><a class="anchor" href="#compiling-modules-out-of-tree"></a>30.3. Compiling Modules Out Of Tree</h3>
<div class="paragraph">
<p>The source code is maintained separately outside the kernel source code.
It is easier to modify the source code, however adapting the module source
code to changes in the kernel API means that the maintainer has the onus
of keeping it upto date with the changing kernel. One disadvantage is that
the module cannot be built statically with the kernel. The following snippet
shows the Makefile that can be used to build an out of tree kernel
module/driver.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="makefile">ifneq ($(KERNELRELEASE),)
obj-m := wassup.o
else
KDIR := /path/to/kernel/sources

all:
        $(MAKE) -C $(KDIR) M=$$PWD        <i class="conum" data-value="1"></i><b>(1)</b>
endif</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Rule for the target <em>all</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When compiled out of tree the Makefile does not have <em>KERNELRELEASE</em> defined
and therefore KDIR is set to the path to either:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Full kernel directory</p>
</li>
<li>
<p>Kernel Headers Directory</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The kernel Makefile gets invoked as <em>KDIR</em> is set and the rule for the target
<em>all</em> will change to the <em>KDIR</em> first and call the corresponding Makefile in that
path. Additionally <em>$PWD</em> is passed as an argument value in <em>M</em> to the kernel
Makefile. The double $$ is required to pass $PWD as the value to <em>M</em>.</p>
</div>
<div class="paragraph">
<p>The kernel Makefile knows that it has to compile a module and because there
is a value for <em>M</em> it can locate where the module Makefile is present. This
time the kernel Makefile calls the module Makefile and the value of
<em>KERNELRELEASE</em> is defined. The kernel uses the definition of <em>obj-m</em> to
identify the module to be compiled which in our case is <em>wassup.o</em>. In this
way the module Makefile given above is invoked twice, the first time  from the
module directory and second time by the kernel Makefile.</p>
</div>
<div class="paragraph">
<p>The kernel directory pointed to by <em>KDIR</em> in the module makefile must be
configured as there will be differences between different configurations of
the kernel. The module compiled against a specific version will only load in
that version and configuration of the kernel. If there is a mismatch then
<em>insmod/modprobe</em> will crib with an output <em>"Invalid module format"</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="compiling-modules-inside-of-the-kernel-tree"><a class="anchor" href="#compiling-modules-inside-of-the-kernel-tree"></a>30.4. Compiling Modules Inside Of The  Kernel Tree</h3>
<div class="paragraph">
<p>The source code is integrated inside the kernel source code. It can be
integrated with the configuration and compilation process of the kernel.
The module can be built statically with the kernel source code.</p>
</div>
<div class="paragraph">
<p>To add a new driver or module to the kernel source tree we have to place
the source file in the appropriate source directory. For example we&#8217;ll
take a look at the <em>USB serial navman</em> driver. The source code for the
driver/module should be present in a single file. If the driver is
really big then it should have its own directory. The source file
for the <em>navman</em> driver is in <em>drivers/usb/serial/navman.c</em></p>
</div>
<div class="paragraph">
<p>To configure the kernel to include a module or driver we need to add
information in the <em>drivers/usb/serial/Kconfig</em> file in the same directory.
The snippet below shows that the navman driver has a kernel option type of
<em>tristate</em> which means it can be enabled, disabled or configured as a module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
config USB_SERIAL_NAVMAN
        tristate &quot;USB Navman GPS device&quot;
        help
          To compile this driver as a module, choose M here: the
          module will be called navman.
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we take a look at the <em>drivers/usb/serial/Makefile</em> which has
a line based on the <em>drivers/usb/serial/Kconfig</em> setting. The name
of the configuration field <em>CONFIG_USB_SERIAL_NAVMAN</em> is derived
from the KConfig settings. The value of <em>CONFIG_USB_SERIAL_NAVMAN</em>
will be based on the configuration applied upon invoking
<em>make menuconfig</em>. After configuring the kernel and enabling th
module/driver we can build it by running <em>make</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="makefile">.
.
obj-$(CONFIG_USB_SERIAL_MOS7840)                += mos7840.o
obj-$(CONFIG_USB_SERIAL_NAVMAN)                 += navman.o
obj-$(CONFIG_USB_SERIAL_OMNINET)                += omninet.o
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further information about the Kernel build process and incorporating
newer files to the source can be obtained at:<br>
<em>Documentation/kbuild</em></p>
</div>
</div>
<div class="sect2">
<h3 id="adding-parameters-to-kernel-modules"><a class="anchor" href="#adding-parameters-to-kernel-modules"></a>30.5. Adding Parameters To Kernel Modules</h3>
<div class="paragraph">
<p>Kernel modules can have parameters which can change the runtime
behavior of the kernel based on the input arguments. There are
two methods which can be used to declare module parameters.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">module_param(name, type, perm)</dt>
<dd>
<p>This method declares a single parameter</p>
</dd>
<dt class="hdlist1">module_param_array(name, type, nump, perm)</dt>
<dd>
<p>This method is used to declare
an array as a parameter.<br></p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>name</strong> : the variable to alter, and exposed parameter name. It becomes the module parameter, or (prefixed by KBUILD_MODNAME and a ".") the kernel commandline parameter.</p>
</li>
<li>
<p><strong>type</strong> : the type of the parameter.  Standard types are:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>byte, short, ushort, int, uint, long, ulong</p>
</li>
<li>
<p>charp, a character pointer</p>
</li>
<li>
<p>bool, a bool, values 0/1, y/n, Y/N.</p>
</li>
<li>
<p>invbool, the above, only sense-reversed (N = true).</p>
</li>
</ol>
</div>
</li>
<li>
<p><strong>perm</strong> : visibility in sysfs.is 0 if the the variable is not to appear in sysfs, or 0444 for world-readable, 0644 for root-writable, etc.  Note that if it is writable, you may need to use kparam_block_sysfs_write() around accesses (esp. charp, which can be kfreed when it changes)</p>
</li>
<li>
<p><strong>nump</strong> : optional pointer filled in with the number written.</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="C"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/kernel.h&gt;</span>

<span style="color:#777">/* Parameters that control who gets wassup'd and how many times */</span>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">char</span>* yourname = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Anonymous</span><span style="color:#710">&quot;</span></span>;
module_param(yourname, charp, <span style="color:#00D">0</span>);

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> ntimes = <span style="color:#00D">1</span>;
module_param(ntimes, <span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#00D">0</span>);

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init sample_module_init(<span style="color:#088;font-weight:bold">void</span>)
{
        <span style="color:#0a8;font-weight:bold">int</span> i = <span style="color:#00D">0</span>;

        <span style="color:#080;font-weight:bold">for</span>(i = <span style="color:#00D">0</span> ; i &lt; ntimes ; i++)
                pr_alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Wassup %s!</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, yourname);
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit sample_module_exit(<span style="color:#088;font-weight:bold">void</span>)
{
        <span style="color:#0a8;font-weight:bold">int</span> i = <span style="color:#00D">0</span>;

        <span style="color:#080;font-weight:bold">for</span>(i = <span style="color:#00D">0</span> ; i &lt; ntimes ; i++)
                pr_alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Cya Later %s!</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, yourname);
}

module_init(sample_module_init);
module_exit(sample_module_exit);

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);
MODULE_DESCRIPTION(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Sample Module With Parameters</span><span style="color:#710">&quot;</span></span>);
MODULE_AUTHOR(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Newbie</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lab-4-writing-kernel-modules"><a class="anchor" href="#lab-4-writing-kernel-modules"></a>31. LAB 4 : Writing Kernel Modules</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">This is a hands on session taken from the Free Electrons labs with the following objectives</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cross-compile and test standalone kernel modules, whose code is not part of the main Linux sources.</p>
</li>
<li>
<p>Write a kernel module with different capabilities</p>
</li>
<li>
<p>Access kernel internals from within the kernel module.</p>
</li>
<li>
<p>Set up the environment to compile it.</p>
</li>
<li>
<p>Create a kernel patch.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="starting-with-a-template-file"><a class="anchor" href="#starting-with-a-template-file"></a>31.1. Starting With A Template File</h3>
<div class="paragraph">
<p>Since we&#8217;ve enabled a NFS root filesystem we can compile our kernel module
on the development server and test it on out BeagleBone Black target.</p>
</div>
<div class="paragraph">
<p>We go to the <em>~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello</em>
directory. A template file <em>hello_version.c</em> is present which we can modify to
test the module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">hello_version.c  Makefile
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$ cat hello_version.c
#include &lt;linux/init.h&gt;
#include &lt;linux/module.h&gt;
#include &lt;linux/i2c.h&gt;

/* Add your code here */

MODULE_LICENSE(&quot;GPL&quot;);

conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-code-to-the-template"><a class="anchor" href="#adding-code-to-the-template"></a>31.2. Adding Code To The Template</h3>
<div class="paragraph">
<p>Our first objective is to print a message as follows:<br></p>
</div>
<div class="paragraph">
<p><em>*Hello Master. You are currently using Linux &lt;version&gt;*</em></p>
</div>
<div class="paragraph">
<p>To do this we need to find some function which will spit out the version
of the kernel running. Here&#8217;s where we have to search the kernel sources or
use any other means to locate a suitable function to get the kernel version.</p>
</div>
<div class="sect3">
<h4 id="searching-for-a-version-function-macro"><a class="anchor" href="#searching-for-a-version-function-macro"></a>31.2.1. Searching For A Version Function/MACRO</h4>
<div class="paragraph">
<p>First we try searching for files in the kernel sources which have <em>version</em>
in them.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ find . -name '*version*'
./arch/x86/boot/version.c
./arch/x86/math-emu/version.h
.
.
.
./init/version.o
./init/.version.o.cmd
./init/version.c        <i class="conum" data-value="1"></i><b>(1)</b>
./Documentation/isdn/README.diversion
./Documentation/misc-devices/mei/mei-amt-version.c
./fs/proc/version.o
./fs/proc/.version.o.cmd
./fs/proc/version.c
./fs/reiserfs/tail_conversion.c
./.tmp_versions
./.version
./sound/pci/asihpi/hpi_version.h
./tools/power/cpupower/utils/version-gen.sh
./tools/perf/config/feature-checks/test-libpython-version.c
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A possible candidate</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Opening the file <em>version.c</em> we see that it does print some sort of version information
using a MACRO <em>UTS_RELEASE</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;generated/compile.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/uts.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/utsname.h&gt;</span>                <i class="conum" data-value="1"></i><b>(1)</b>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;generated/utsrelease.h&gt;</span>        <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/version.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/proc_ns.h&gt;</span>

<span style="color:#579">#ifndef</span> CONFIG_KALLSYMS
<span style="color:#579">#define</span> version(a) Version_ <span style="color:#579">#</span><span style="color:#579"># a</span>
<span style="color:#579">#define</span> version_string(a) version(a)

<span style="color:#088;font-weight:bold">extern</span> <span style="color:#0a8;font-weight:bold">int</span> version_string(LINUX_VERSION_CODE);
<span style="color:#0a8;font-weight:bold">int</span> version_string(LINUX_VERSION_CODE);
<span style="color:#579">#endif</span>

<span style="color:#080;font-weight:bold">struct</span> uts_namespace init_uts_ns = {
        .kref = {
                .refcount       = ATOMIC_INIT(<span style="color:#00D">2</span>),
        },
        .name = {
                .sysname        = UTS_SYSNAME,
                .nodename       = UTS_NODENAME,
                .release        = UTS_RELEASE,
                .version        = UTS_VERSION,
                .machine        = UTS_MACHINE,
                .domainname     = UTS_DOMAINNAME,
        },
        .user_ns = &amp;init_user_ns,
        .proc_inum = PROC_UTS_INIT_INO,
};
EXPORT_SYMBOL_GPL(init_uts_ns);

<span style="color:#777">/* FIXED STRINGS! Don't touch! */</span>
<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> linux_banner[] =                                        <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Linux version </span><span style="color:#710">&quot;</span></span> UTS_RELEASE <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> (</span><span style="color:#710">&quot;</span></span> LINUX_COMPILE_BY <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">@</span><span style="color:#710">&quot;</span></span>
        LINUX_COMPILE_HOST <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">) (</span><span style="color:#710">&quot;</span></span> LINUX_COMPILER <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">) </span><span style="color:#710">&quot;</span></span> UTS_VERSION <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>;

<span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> linux_proc_banner[] =
        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s version %s</span><span style="color:#710">&quot;</span></span>
        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> (</span><span style="color:#710">&quot;</span></span> LINUX_COMPILE_BY <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">@</span><span style="color:#710">&quot;</span></span> LINUX_COMPILE_HOST <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">)</span><span style="color:#710">&quot;</span></span>
        <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20"> (</span><span style="color:#710">&quot;</span></span> LINUX_COMPILER <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">) %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Header file with definitions</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Header file with generated release name</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Macro used to pring version of compiled kernel</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We take a look at the header files and see that <em>&lt;generated/utsrelease.h&gt;</em>
defines the MACRO <em>UTS_RELEASE</em> which is the version of the kernel.</p>
</div>
<div class="paragraph">
<p>However if we take a careful look at <em>&lt;linux/utsname.h&gt;</em> we see there is
a function <em>utsname</em>. This function returns the current kernel information
in the form a structure <em>struct new_utsname</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#ifndef</span> _LINUX_UTSNAME_H
<span style="color:#579">#define</span> _LINUX_UTSNAME_H


<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/sched.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/kref.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/nsproxy.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/err.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;uapi/linux/utsname.h&gt;</span>                <i class="conum" data-value="1"></i><b>(1)</b>
.
.
.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">inline</span> <span style="color:#080;font-weight:bold">struct</span> new_utsname *utsname(<span style="color:#088;font-weight:bold">void</span>)
{
        <span style="color:#080;font-weight:bold">return</span> &amp;current-&gt;nsproxy-&gt;uts_ns-&gt;name;
}
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Header file with definition of <em>struct new_utsname</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The structure is in the header file <em>&lt;uapi/linux/utsname.h&gt;</em>.
Opening the file we see which member we need to print the current kernel
version.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#ifndef</span> _UAPI_LINUX_UTSNAME_H
<span style="color:#579">#define</span> _UAPI_LINUX_UTSNAME_H

<span style="color:#579">#define</span> __OLD_UTS_LEN <span style="color:#00D">8</span>

<span style="color:#080;font-weight:bold">struct</span> oldold_utsname {
        <span style="color:#0a8;font-weight:bold">char</span> sysname[<span style="color:#00D">9</span>];
        <span style="color:#0a8;font-weight:bold">char</span> nodename[<span style="color:#00D">9</span>];
        <span style="color:#0a8;font-weight:bold">char</span> release[<span style="color:#00D">9</span>];
        <span style="color:#0a8;font-weight:bold">char</span> version[<span style="color:#00D">9</span>];
        <span style="color:#0a8;font-weight:bold">char</span> machine[<span style="color:#00D">9</span>];
};

<span style="color:#579">#define</span> __NEW_UTS_LEN <span style="color:#00D">64</span>

<span style="color:#080;font-weight:bold">struct</span> old_utsname {
        <span style="color:#0a8;font-weight:bold">char</span> sysname[<span style="color:#00D">65</span>];
        <span style="color:#0a8;font-weight:bold">char</span> nodename[<span style="color:#00D">65</span>];
        <span style="color:#0a8;font-weight:bold">char</span> release[<span style="color:#00D">65</span>];
        <span style="color:#0a8;font-weight:bold">char</span> version[<span style="color:#00D">65</span>];
        <span style="color:#0a8;font-weight:bold">char</span> machine[<span style="color:#00D">65</span>];
};

<span style="color:#080;font-weight:bold">struct</span> new_utsname {
        <span style="color:#0a8;font-weight:bold">char</span> sysname[__NEW_UTS_LEN + <span style="color:#00D">1</span>];
        <span style="color:#0a8;font-weight:bold">char</span> nodename[__NEW_UTS_LEN + <span style="color:#00D">1</span>];
        <span style="color:#0a8;font-weight:bold">char</span> release[__NEW_UTS_LEN + <span style="color:#00D">1</span>];        <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#0a8;font-weight:bold">char</span> version[__NEW_UTS_LEN + <span style="color:#00D">1</span>];
        <span style="color:#0a8;font-weight:bold">char</span> machine[__NEW_UTS_LEN + <span style="color:#00D">1</span>];
        <span style="color:#0a8;font-weight:bold">char</span> domainname[__NEW_UTS_LEN + <span style="color:#00D">1</span>];
};


<span style="color:#579">#endif</span> <span style="color:#777">/* _UAPI_LINUX_UTSNAME_H */</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The character string with the kernel version.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="implementing-the-version-function-macro-into-the-module"><a class="anchor" href="#implementing-the-version-function-macro-into-the-module"></a>31.2.2. Implementing The Version Function/MACRO Into The Module</h4>
<div class="paragraph">
<p>We can now write our C code to print the kernel information. We add
the code in the initialization code of the kernel module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/kernel.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/utsname.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;generated/utsrelease.h&gt;</span>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init version_init(<span style="color:#088;font-weight:bold">void</span>)
{
        printk(KERN_INFO <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello Master you are currently using kernel version %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, utsname()-&gt;release); <i class="conum" data-value="1"></i><b>(1)</b>
        printk(KERN_INFO <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Your kernel module is compiled with version %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, UTS_RELEASE); <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit version_exit(<span style="color:#088;font-weight:bold">void</span>)
{
        printk(KERN_INFO <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Over and out!</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
}

module_init(version_init);
module_exit(version_exit);

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);
MODULE_AUTHOR(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">zeuzoix</span><span style="color:#710">&quot;</span></span>);
MODULE_DESCRIPTION(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Kernel Module Version Example Module</span><span style="color:#710">&quot;</span></span>);

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Printing the run time version</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Printing the compile time version</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To compile the kernel module we use the Makefile present in the same directory</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$ cat Makefile
ifneq ($(KERNELRELEASE),)
obj-m := hello_version.o
else
KDIR := $(HOME)/linux-kernel-labs/src/linux
all:
        $(MAKE) -C $(KDIR) M=$$PWD
endif</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can pass the KDIR variable to the make command to use our kernel source.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$ make KDIR=/home/conrad/Git/linux
make -C /home/conrad/Git/linux M=$PWD
make[1]: Entering directory `/home/conrad/Git/linux'
  CC [M]  /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello/hello_version.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello/hello_version.mod.o
  LD [M]  /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello/hello_version.ko
make[1]: Leaving directory `/home/conrad/Git/linux'
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="testing-the-kernel-module"><a class="anchor" href="#testing-the-kernel-module"></a>31.2.3. Testing The Kernel Module</h4>
<div class="paragraph">
<p>After compiling the kernel module we can immediately test it on the
target by going to the folder and inserting the compiled ko file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Welcome to Buildroot
buildroot login: root
# cd /root/hello/
# ls
Makefile             hello_version.c      hello_version.mod.o
Module.symvers       hello_version.ko     hello_version.o
built-in.o           hello_version.mod.c  modules.order
# insmod hello_version.ko                                 <i class="conum" data-value="1"></i><b>(1)</b>
[12261.297192] Hello Master you are currently using kernel version 3.13.11
[12261.304310] Your kernel module is compiled with version 3.13.11
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Insert the compiled kernel module</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Great, now that the module works we take a look at seeing which modules are inserted
in the running kernel. There are two ways to do it as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># lsmod                                <i class="conum" data-value="1"></i><b>(1)</b>
Module                  Size  Used by    Tainted: G
hello_version            824  0
#
# cat /proc/modules                <i class="conum" data-value="2"></i><b>(2)</b>
hello_version 824 0 - Live 0xbf000000 (O)
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using lsmod</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Reading <em>/proc/modules</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally if we need to unload the kernel moduel we can use <em>rmmod</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># rmmod hello_version                <i class="conum" data-value="1"></i><b>(1)</b>
[12557.539564] Over and out!
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>rmmod</em> removes the kernel module.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-a-parameter-to-the-module"><a class="anchor" href="#adding-a-parameter-to-the-module"></a>31.3. Adding A Parameter To The Module</h3>
<div class="paragraph">
<p>We&#8217;ll now try to add a parameter to the module. Let&#8217;s try to change
<em>Master</em> based on a parameter passed. In order to define a new parameter
we define a static gobal string and use <em>module_param</em> to indicate
that it is a module parameter.</p>
</div>
<div class="paragraph">
<p>Additionally we use <em>MODULE_PARM_DESC</em> to give description about the
new module parameter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/kernel.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/utsname.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;generated/utsrelease.h&gt;</span>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">char</span> *who = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Master</span><span style="color:#710">&quot;</span></span>;        <i class="conum" data-value="1"></i><b>(1)</b>
module_param(who, charp, <span style="color:#00D">0</span>);        <i class="conum" data-value="2"></i><b>(2)</b>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init version_init(<span style="color:#088;font-weight:bold">void</span>)
{
        printk(KERN_INFO <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello %s you are currently using kernel version %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, who, utsname()-&gt;release);        <i class="conum" data-value="3"></i><b>(3)</b>
        printk(KERN_INFO <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Your kernel module is compiled with version %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, UTS_RELEASE);
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit version_exit(<span style="color:#088;font-weight:bold">void</span>)
{
        printk(KERN_INFO <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Over and out!</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
}

module_init(version_init);
module_exit(version_exit);

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);
MODULE_AUTHOR(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">zeuzoix</span><span style="color:#710">&quot;</span></span>);
MODULE_DESCRIPTION(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Kernel Module Version Example Module</span><span style="color:#710">&quot;</span></span>);
MODULE_PARM_DESC(who, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Name of the user</span><span style="color:#710">&quot;</span></span>);        <i class="conum" data-value="4"></i><b>(4)</b>

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Definition static global string, <em>who</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Declaring <em>who</em> as a module parameter</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Using <em>who</em> in the statement</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Adding a module parameter description with <em>MODULE_PARM_DESC</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>On testing the module we must pass the value of <em>who</em> in the arguments with <em>insmod</em>.
If we don&#8217;t pass any value the default value of "Master" is used.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># insmod hello_version.ko         <i class="conum" data-value="1"></i><b>(1)</b>
[ 9790.064102] Hello Master you are currently using kernel version 3.13.11
[ 9790.071216] Your kernel module is compiled with version 3.13.11
# rmmod hello_version
[ 9796.676646] Over and out!
# insmod hello_version.ko who=&quot;Anonymous&quot;
[ 9814.183983] Hello Master you are currently using kernel version 3.13.11
[ 9814.191080] Your kernel module is compiled with version 3.13.11
#
# rmmod hello_version
[ 9822.334179] Over and out!
#
# insmod hello_version.ko who=&quot;Anonymous&quot;        <i class="conum" data-value="2"></i><b>(2)</b>
[ 9869.352553] Hello Anonymous you are currently using kernel version 3.13.11
[ 9869.359930] Your kernel module is compiled with version 3.13.11
# rmmod hello_version
[ 9874.813462] Over and out!</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Without arguments</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>With argument as Anonymous</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="following-linux-coding-standards"><a class="anchor" href="#following-linux-coding-standards"></a>31.4. Following Linux Coding Standards</h3>
<div class="paragraph">
<p>Coding style is a matter of personal taste but it is crucial for every
software project to adhere to a coding standard. This helps in maintaining
consistency in the style of code being generated for the project. It
makes the code easier to read and also easier to maintain.</p>
</div>
<div class="paragraph">
<p>The Linux kernel also has its own coding style and also provides a utility
to check for source code violations. The utility is <em>checkpatch.pl</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ scripts/checkpatch.pl -h
Usage: checkpatch.pl [OPTION]... [FILE]...
Version: 0.32

Options:
  -q, --quiet                quiet
  --no-tree                  run without a kernel tree
  --no-signoff               do not check for 'Signed-off-by' line
  --patch                    treat FILE as patchfile (default)
  --emacs                    emacs compile window format
  --terse                    one line per report
  -f, --file                 treat FILE as regular source file
  --subjective, --strict     enable more subjective tests
  --types TYPE(,TYPE2...)    show only these comma separated message types
  --ignore TYPE(,TYPE2...)   ignore various comma separated message types
  --max-line-length=n        set the maximum line length, if exceeded, warn
  --show-types               show the message &quot;types&quot; in the output
  --root=PATH                PATH to the kernel tree root
  --no-summary               suppress the per-file summary
  --mailback                 only produce a report in case of warnings/errors
  --summary-file             include the filename in summary
  --debug KEY=[0|1]          turn on/off debugging of KEY, where KEY is one of
                             'values', 'possible', 'type', and 'attr' (default
                             is all off)
  --test-only=WORD           report only warnings/errors containing WORD
                             literally
  --fix                      EXPERIMENTAL - may create horrible results
                             If correctable single-line errors exist, create
                             &quot;&lt;inputfile&gt;.EXPERIMENTAL-checkpatch-fixes&quot;
                             with potential errors corrected to the preferred
                             checkpatch style
  --ignore-perl-version      override checking of perl version.  expect
                             runtime errors.
  -h, --help, --version      display this help and exit

When FILE is - read standard input.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="paragraph">
<p>We run the <em>checkpatch.pl</em> utility on our <em>hello_version.c</em> kernel module.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$ ~/Git/linux/scripts/checkpatch.pl --file --no-tree hello_version.c
WARNING: line over 80 characters
#20: FILE: hello_version.c:20:
+        printk(KERN_INFO &quot;Hello %s you are currently using kernel version %s\n&quot;, who, utsname()-&gt;release);

ERROR: code indent should use tabs where possible        <i class="conum" data-value="1"></i><b>(1)</b>
#20: FILE: hello_version.c:20:
+        printk(KERN_INFO &quot;Hello %s you are currently using kernel version %s\n&quot;, who, utsname()-&gt;release);$

WARNING: please, no spaces at the start of a line
#20: FILE: hello_version.c:20:
+        printk(KERN_INFO &quot;Hello %s you are currently using kernel version %s\n&quot;, who, utsname()-&gt;release);$

WARNING: Prefer netdev_info(netdev, ... then dev_info(dev, ... then pr_info(...  to printk(KERN_INFO ...
#20: FILE: hello_version.c:20:
+        printk(KERN_INFO &quot;Hello %s you are currently using kernel version %s\n&quot;, who, utsname()-&gt;release);

WARNING: line over 80 characters                        <i class="conum" data-value="2"></i><b>(2)</b>
#21: FILE: hello_version.c:21:
+        printk(KERN_INFO &quot;Your kernel module is compiled with version %s\n&quot;, UTS_RELEASE);

ERROR: code indent should use tabs where possible
#21: FILE: hello_version.c:21:
+        printk(KERN_INFO &quot;Your kernel module is compiled with version %s\n&quot;, UTS_RELEASE);$

WARNING: please, no spaces at the start of a line        <i class="conum" data-value="3"></i><b>(3)</b>
#21: FILE: hello_version.c:21:
+        printk(KERN_INFO &quot;Your kernel module is compiled with version %s\n&quot;, UTS_RELEASE);$

WARNING: Prefer netdev_info(netdev, ... then dev_info(dev, ... then pr_info(...  to printk(KERN_INFO ...
#21: FILE: hello_version.c:21:
+        printk(KERN_INFO &quot;Your kernel module is compiled with version %s\n&quot;, UTS_RELEASE);

ERROR: code indent should use tabs where possible
#22: FILE: hello_version.c:22:
+        return 0;$

WARNING: please, no spaces at the start of a line
#22: FILE: hello_version.c:22:
+        return 0;$

ERROR: code indent should use tabs where possible
#34: FILE: hello_version.c:34:
+        printk(KERN_INFO &quot;Over and out!\n&quot;);$

WARNING: please, no spaces at the start of a line
#34: FILE: hello_version.c:34:
+        printk(KERN_INFO &quot;Over and out!\n&quot;);$

WARNING: Prefer netdev_info(netdev, ... then dev_info(dev, ... then pr_info(...  to printk(KERN_INFO ... <i class="conum" data-value="4"></i><b>(4)</b>
#34: FILE: hello_version.c:34:
+        printk(KERN_INFO &quot;Over and out!\n&quot;);

ERROR: code indent should use tabs where possible
#35: FILE: hello_version.c:35:
+        printk(KERN_INFO &quot;Time lapsed is %u s\n&quot;, do_div(n_secs,NSEC_PER_SEC));$

WARNING: please, no spaces at the start of a line
#35: FILE: hello_version.c:35:
+        printk(KERN_INFO &quot;Time lapsed is %u s\n&quot;, do_div(n_secs,NSEC_PER_SEC));$

WARNING: Prefer netdev_info(netdev, ... then dev_info(dev, ... then pr_info(...  to printk(KERN_INFO ...
#35: FILE: hello_version.c:35:
+        printk(KERN_INFO &quot;Time lapsed is %u s\n&quot;, do_div(n_secs,NSEC_PER_SEC));

ERROR: space required after that ',' (ctx:VxV)
#35: FILE: hello_version.c:35:
+        printk(KERN_INFO &quot;Time lapsed is %u s\n&quot;, do_div(n_secs,NSEC_PER_SEC));
                                                                ^

total: 6 errors, 11 warnings, 46 lines checked

NOTE: whitespace errors detected, you may wish to use scripts/cleanpatch or
      scripts/cleanfile

hello_version.c has style problems, please review.

If any of these errors are false positives, please report
them to the maintainer, see CHECKPATCH in MAINTAINERS.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Spaces used instead of tabs</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Line over 80 characters long</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Space detected at the start of the line</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>pr_info to be used instead of printk</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After correcting the warnings we get the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$ ~/Git/linux/scripts/checkpatch.pl --file --no-tree hello_version.c
total: 0 errors, 0 warnings, 48 lines checked        <i class="conum" data-value="1"></i><b>(1)</b>

hello_version.c has no obvious style problems and is ready for submission.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Source code has 0 errors and 0 warnings</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We&#8217;ve followed the guidelines as mentioned in <em>Documentation/CodingStyle</em>.
The source code after corrections looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/kernel.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/utsname.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;generated/utsrelease.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/time.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;asm/div64.h&gt;</span>


<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">char</span> *who = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Master</span><span style="color:#710">&quot;</span></span>;
module_param(who, charp, <span style="color:#00D">0</span>);

<span style="color:#777">/* Note starting time of kernel module */</span>
<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> timeval start;

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init version_init(<span style="color:#088;font-weight:bold">void</span>)
{

        do_gettimeofday(&amp;start);
        pr_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Hello %s you are currently using kernel version %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>,
                who, utsname()-&gt;release);
        pr_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Your kernel module is compiled with version %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>,
                UTS_RELEASE);
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit version_exit(<span style="color:#088;font-weight:bold">void</span>)
{
        <span style="color:#080;font-weight:bold">struct</span> timeval now;
        s64 n_secs;

        do_gettimeofday(&amp;now);

        n_secs = timeval_to_ns(&amp;now) - timeval_to_ns(&amp;start);

        pr_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Over and out!</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
        pr_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Time lapsed is %u s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, do_div(n_secs, NSEC_PER_SEC));
}

module_init(version_init);
module_exit(version_exit);

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);
MODULE_AUTHOR(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">zeuzoix</span><span style="color:#710">&quot;</span></span>);
MODULE_DESCRIPTION(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Kernel Module Version Example Module</span><span style="color:#710">&quot;</span></span>);
MODULE_PARM_DESC(who, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Name of the user</span><span style="color:#710">&quot;</span></span>);

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="adding-em-hello_version-em-to-the-kernel-sources"><a class="anchor" href="#adding-em-hello_version-em-to-the-kernel-sources"></a>31.5. Adding <em>hello_version</em> To The Kernel Sources</h3>
<div class="paragraph">
<p>Its time to add our tested kernel module to the kernel sources. We create
a special branch for our changes and then attempt to add the module sources
to the <em>drivers/misc</em> directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello$ cd ~/Git/linux
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git checkout 3.13.y
Already on '3.13.y'
Your branch is up-to-date with 'stable/linux-3.13.y'.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git branch
* 3.13.y
  fix_unioxx5
  master
  tutorialv2
  tutorialv3
  tutorialv4
  tutorialv5
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git checkout -b hello_version
Switched to a new branch 'hello_version'
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git branch
  3.13.y
  fix_unioxx5
* hello_version
  master
  tutorialv2
  tutorialv3
  tutorialv4
  tutorialv5
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ cp ~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/hello/hello_version.c ~/Git/linux/drivers/misc/.</code></pre>
</div>
</div>
<div class="paragraph">
<p>We modify the files <em>drivers/misc/Kconfig</em> and <em>drivers/misc/Makefile</em> to
include the <em>hello_version.c</em> file as part of the Linux kernel build. The changes
done to the files are as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git diff drivers/misc/Makefile        <i class="conum" data-value="1"></i><b>(1)</b>
diff --git a/drivers/misc/Makefile b/drivers/misc/Makefile
index f45473e..8fae713 100644
--- a/drivers/misc/Makefile
+++ b/drivers/misc/Makefile
@@ -53,3 +53,4 @@ obj-$(CONFIG_VMWARE_VMCI)     += vmw_vmci/
 obj-$(CONFIG_LATTICE_ECP3_CONFIG)      += lattice-ecp3-config.o
 obj-$(CONFIG_SRAM)             += sram.o
 obj-y                          += mic/
+obj-$(CONFIG_HELLO_VERSION)    += hello_version.o
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git diff drivers/misc/Kconfig        <i class="conum" data-value="2"></i><b>(2)</b>
diff --git a/drivers/misc/Kconfig b/drivers/misc/Kconfig
index a3e291d..1c055e4 100644
--- a/drivers/misc/Kconfig
+++ b/drivers/misc/Kconfig
@@ -515,6 +515,12 @@ config SRAM
          the genalloc API. It is supposed to be used for small on-chip SRAM
          areas found on many SoCs.

+config HELLO_VERSION
+       tristate &quot;Sample module to print version information&quot;
+       help
+         To compile this driver as a module, choose M here: the module will
+         be called kernel_version.
+
 source &quot;drivers/misc/c2port/Kconfig&quot;
 source &quot;drivers/misc/eeprom/Kconfig&quot;
 source &quot;drivers/misc/cb710/Kconfig&quot;</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Modifications done to the <em>Makefile</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Modifications done to the <em>Kconfig</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We then configure the kernel and enable the kernel_verion module in the configuration
before issuing the build.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="beagleboneblacktux-enable-kernel-version" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/beagleboneblacktux-enable-kernel-version.png"><img src="http://zeuzoix.github.io/techeuphoria/images/beagleboneblacktux-enable-kernel-version.png" alt="beagleboneblacktux enable kernel version" width="640" height="480"></a>
</div>
<div class="title">We select kernel version in the <em>menuconfig</em></div>
</div>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- omap2plus_defconfig
  HOSTCC  scripts/basic/fixdep
  HOSTCC  scripts/kconfig/conf.o
  HOSTCC  scripts/kconfig/zconf.tab.o
  HOSTLD  scripts/kconfig/conf
#
# configuration written to .config
#
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- menuconfig
  HOSTCC  scripts/kconfig/lxdialog/checklist.o
  HOSTCC  scripts/kconfig/lxdialog/inputbox.o
  HOSTCC  scripts/kconfig/lxdialog/menubox.o
  HOSTCC  scripts/kconfig/lxdialog/textbox.o
  HOSTCC  scripts/kconfig/lxdialog/util.o
  HOSTCC  scripts/kconfig/lxdialog/yesno.o
  HOSTCC  scripts/kconfig/mconf.o
  HOSTLD  scripts/kconfig/mconf
scripts/kconfig/mconf Kconfig
configuration written to .config

*** End of the configuration.
*** Execute 'make' to start the build or try 'make help'.

conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- clean
  CLEAN   .
  CLEAN   arch/arm/kernel
  CLEAN   drivers/tty/vt
  CLEAN   drivers/video/logo
  CLEAN   kernel
  CLEAN   lib
  CLEAN   usr
  CLEAN   arch/arm/boot/compressed
  CLEAN   arch/arm/boot/dts
  CLEAN   arch/arm/boot
  CLEAN   .tmp_versions
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
  CHK     include/config/kernel.release
  CHK     include/generated/uapi/linux/version.h
  CHK     include/generated/utsrelease.h
make[1]: `include/generated/mach-types.h' is up to date.
  CALL    scripts/checksyscalls.sh
  CHK     include/generated/compile.h
.
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the compilation goes through we can check in the changes in our branch.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git status                                <i class="conum" data-value="1"></i><b>(1)</b>
On branch hello_version
Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

        modified:   drivers/misc/Kconfig
        modified:   drivers/misc/Makefile

Untracked files:
  (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)

        defconfig
        drivers/Module.symvers
        drivers/misc/Module.symvers
        drivers/misc/hello_version.c
        drivers/staging/Module.symvers
        drivers/staging/comedi/Module.symvers
        drivers/staging/comedi/drivers/Module.symvers

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git add drivers/misc/hello_version.c        <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git add drivers/misc/Kconfig                <i class="conum" data-value="3"></i><b>(3)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git add drivers/misc/Makefile                <i class="conum" data-value="4"></i><b>(4)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git commit -s                                <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check the status of the branch first</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Add the hello_version.c file to staging</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add the Kconfig file to staging</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Add the Makefile  file to staging</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Commit the staged changes. The -s adds a Signed-off-by line to the commit message.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can verify the commit message using <em>git log</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git log
commit 56e2688434d7fd5ff8f3c35849e9d4b0ac0d2721
Author: Conrad Gomes &lt;conrad.s.j.gomes@gmail.com&gt;
Date:   Sat Dec 19 09:05:25 2015 +0530

    hello_version: Adding a miscellaneous module

    Adding a miscellaneous kernel module the source code.
    Changed the Kconfig and Makefile to include the module as part of
    the configuration.

    Signed-off-by: Conrad Gomes &lt;conrad.s.j.gomes@gmail.com&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="create-a-kernel-patch"><a class="anchor" href="#create-a-kernel-patch"></a>31.6. Create A Kernel Patch</h3>
<div class="paragraph">
<p>Finally to share the code we would need to submit a patch to the Linux community.
Creating a patch is easy with <em>git</em>. Since our changes are isolated on a separate
branch we can create the patch between the local branch and the source branch
which is <em>3.13.y</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git format-patch 3.13.y
0001-hello_version-Adding-a-miscellaneous-module.patch</code></pre>
</div>
</div>
<div class="paragraph">
<p>The patch name is taken from the commit message added during the commit.</p>
</div>
</div>
</div>
</div>
<h1 id="linux-device-and-driver-model" class="sect0"><a class="anchor" href="#linux-device-and-driver-model"></a>Linux Device And Driver Model</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>This section covers details about the Linux Kernel device and driver model.
We will understand why we need an architecture to describe a device and its
driver. We&#8217;ll see how the kernel recognises a device in the system and also
understand how it associates a driver to the device.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-purpose-behind-having-a-device-model"><a class="anchor" href="#the-purpose-behind-having-a-device-model"></a>32. The Purpose Behind Having A Device Model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Linux kernel runs on a wide variety of architectures and platforms.
There are platforms which may have the same type of device for which
the same driver may be used. To fascilitate this architecture a device
model is required so that the driver for a device can be independent
of the platform on which it is implemented.</p>
</div>
<div class="paragraph">
<p>There are several layers of abstraction in which the Linux kernel
separates the device description from the <em>device drivers</em>. Additionally
the <em>bus drivers</em> are separated from the <em>device drivers</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="interfaces-to-a-kernel-driver"><a class="anchor" href="#interfaces-to-a-kernel-driver"></a>33. Interfaces To A Kernel Driver</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In Linux the driver is designed to first interface between a <strong>framework</strong>
which groups the functionality of the device to the application in a
generic way. e.g. input devices like keyboards and the mouse are represented
as an input event framework.</p>
</li>
<li>
<p>Secondly the driver has to interface with a <strong>bus infrastructure</strong> in order
to access the device. The bus interface can be anything ranging from UART, USB
to SPI.</p>
</li>
</ol>
</div>
<div class="exampleblock">
<div class="content">
<div id="kernel-device-driver-model" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/kernel-device-driver-model.png"><img src="http://zeuzoix.github.io/techeuphoria/images/kernel-device-driver-model.png" alt="kernel device driver model" width="320" height="240"></a>
</div>
<div class="title">Kernel Device Driver Model</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="device-model-data-structures"><a class="anchor" href="#device-model-data-structures"></a>34. Device Model Data Structures</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The main data structures in the device driver model are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <em>struct bus_type</em> structure represents a bus system viz. USB, SPI, I2C, etc..</p>
</li>
<li>
<p>The <em>struct device_driver</em> structure represents one driver capable of handling devices on a certain bus.</p>
</li>
<li>
<p>The <em>struct device</em> represents a device connected to a bus.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Inheritance is used in the device driver model in order to create
specialized versions of <em>struct device driver</em> and <em>struct device</em> for specific
bus systems.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="bus-drivers"><a class="anchor" href="#bus-drivers"></a>35. Bus Drivers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Typically to interface the processor to any external device we would need
a bus. The bus defines an interface to communicate with other devices through
a protocol. The Linux kernel abstracts the bus as a bus driver thereby allowing
reuse of the same driver across many platforms.</p>
</div>
<div class="paragraph">
<p>There is one bus driver for each type of bus e.g. PCI, USB, SPI, I2C, etc..
So what are the functions of the bus driver?</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Regisitering the bus type i.e. <em>struct bus_type</em>.</p>
</li>
<li>
<p>Registering adapter drivers which can detect devices and communicate with them
on the bus.</p>
</li>
<li>
<p>Register device drivers which are to support devices connected on the bus.</p>
</li>
<li>
<p>Pair devices connected on the bus with registered device drivers.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="usb-bus-as-an-example-of-a-bus-driver"><a class="anchor" href="#usb-bus-as-an-example-of-a-bus-driver"></a>35.1. USB Bus As An Example Of A Bus Driver</h3>
<div class="exampleblock">
<div class="content">
<div id="usb-bus-driver-model" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/usb-bus-driver-model.png"><img src="http://zeuzoix.github.io/techeuphoria/images/usb-bus-driver-model.png" alt="usb bus driver model" width="640" height="480"></a>
</div>
<div class="title">USB Bus Driver Model</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The diagram illustrates the various kernel components that enable the USB architecture to
support multiple platforms, controllers and devices. It is essentially divided into three
parts:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Core Infrastructure</dt>
<dd>
<p>This is the main source code responsible for declaring the bus type and registering it.</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The code is defined in <em>drivers/usb/core</em></p>
</li>
<li>
<p><em>struct bus_type</em> is defined in <em>drivers/usb/core/driver.c</em> and registered in
<em>drivers/usb/core/usb.c</em></p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Adapter Drivers</dt>
<dd>
<p>This is the driver code which implement the host controllers the software which is able to communicate
with the device drivers. There are several versions of the host controller which are implemented
on different platforms</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The code is defined in <em>drivers/usb/host</em></p>
</li>
<li>
<p>OHCI, UHCI, EHCI, XHCI are different host controller interfaces implemented for different platforms.</p>
</li>
<li>
<p>UHCI (Universal Host Controller Interface) is an intel defined controller for USB 1.x.</p>
</li>
<li>
<p>OHCI (Open Host Controller Interface) is used on systems which do not have x86 USB1.1 controllers.</p>
</li>
<li>
<p>EHCI (Enhanced Host Controller Interface) was defined as a standard for USB 2.0</p>
</li>
<li>
<p>XHCI (Extensible Host Controller Interface) is the latest standard which supports all USB versions
upto USB 3.1</p>
</li>
</ol>
</div>
</dd>
<dt class="hdlist1">Device Drivers</dt>
<dd>
<p>The device drivers are spread across the kernel source code. Based on the device classification the
device driver will be present in its appropriate framework.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="example-of-a-usb-device-driver"><a class="anchor" href="#example-of-a-usb-device-driver"></a>35.2. Example Of A USB Device Driver</h3>
<div class="paragraph">
<p>We&#8217;ll take a look at a USB network card. As it is a network device we&#8217;ll be able to
find it in the network framework of the kernel source code. Since it interfaces with
the USB bus it will be a USB device driver. The driver is located at
<em>drivers/net/usb/rtl8150.c</em>.</p>
</div>
<div class="sect3">
<h4 id="device-identification"><a class="anchor" href="#device-identification"></a>35.2.1. Device Identification</h4>
<div class="paragraph">
<p>Typically each device driver may support multiple devices. So a driver should describe
the list of devices which it supports. This is defined by a device table.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#777">/* table of devices that work with this driver */</span>
<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> usb_device_id rtl8150_table[] = {
        {USB_DEVICE(VENDOR_ID_REALTEK, PRODUCT_ID_RTL8150)},
        {USB_DEVICE(VENDOR_ID_MELCO, PRODUCT_ID_LUAKTX)},
        {USB_DEVICE(VENDOR_ID_MICRONET, PRODUCT_ID_SP128AR)},
        {USB_DEVICE(VENDOR_ID_LONGSHINE, PRODUCT_ID_LCS8138TX)},
        {USB_DEVICE(VENDOR_ID_OQO, PRODUCT_ID_RTL8150)},
        {USB_DEVICE(VENDOR_ID_ZYXEL, PRODUCT_ID_PRESTIGE)},
        {}
};

MODULE_DEVICE_TABLE(usb, rtl8150_table);
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The device table serves two purposes. Once the driver is loaded the USB core knows
which devices it can work with so when a device is attached to the USB bus and the core
will match the driver to that device. Another use is to extract the map between device
identifier and driver so that a dynamic loading ability is present. The <em>depmod</em>
utility can extract the module device table information which can be used by <em>udev</em>
in userspace whenever the kernel sends a notification of a new device connected.</p>
</div>
<div class="paragraph">
<p>Information about the mapping is normally present in the path
<em>/lib/modules/$(uname -r)/modules.alias</em> or <em>/lib/modules/$(uname -r)/modules.usbmap</em>.</p>
</div>
</div>
<div class="sect3">
<h4 id="driver-instantiation"><a class="anchor" href="#driver-instantiation"></a>35.2.2. Driver Instantiation</h4>
<div class="paragraph">
<p>To instantiate a USB device driver the core provides an API with which an
appropriate structure can be registered. This is present at the end of the file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> usb_driver rtl8150_driver = {
        .name           = driver_name,
        .probe          = rtl8150_probe,
        .disconnect     = rtl8150_disconnect,
        .id_table       = rtl8150_table,
        .suspend        = rtl8150_suspend,
        .resume         = rtl8150_resume,
        .disable_hub_initiated_lpm = <span style="color:#00D">1</span>,
};

module_usb_driver(rtl8150_driver);
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>As mentioned before the kernel is filled with inheritance and in this case
the <em>struct usb_driver</em> inherits a <em>struct device_driver</em> in its definition.</p>
</div>
</div>
<div class="sect3">
<h4 id="driver-registration-and-unregistration"><a class="anchor" href="#driver-registration-and-unregistration"></a>35.2.3. Driver Registration And Unregistration</h4>
<div class="paragraph">
<p>Now comes the part where the driver registers itself with the USB core system.
This is done in the module initialisation and exit functions. This is abstracted
through the API <em>module_usb_driver</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
module_usb_driver(rtl8150_driver);
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>So if we see the definition of <em>module_usb_driver</em> in <em>include/linux/usb.h</em> it
turns out that it uses the generic driver registration function <em>module_driver</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
<span style="color:#777">/**
 * module_usb_driver() - Helper macro for registering a USB driver
 * @__usb_driver: usb_driver struct
 *
 * Helper macro for USB drivers which do not do anything special in module
 * init/exit. This eliminates a lot of boilerplate. Each module may only
 * use this macro once, and calling it replaces module_init() and module_exit()
 */</span>
<span style="color:#579">#define</span> module_usb_driver(__usb_driver) \
        module_driver(__usb_driver, usb_register, \
                       usb_deregister)
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The definition of <em>module_driver</em> is in <em>include/linux/device.h</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
<span style="color:#777">/**
 * module_driver() - Helper macro for drivers that don't do anything
 * special in module init/exit. This eliminates a lot of boilerplate.
 * Each module may only use this macro once, and calling it replaces
 * module_init() and module_exit().
 *
 * @__driver: driver name
 * @__register: register function for this driver type
 * @__unregister: unregister function for this driver type
 * @...: Additional arguments to be passed to __register and __unregister.
 *
 * Use this macro to construct bus specific macros for registering
 * drivers, and do not use it on its own.
 */</span>
<span style="color:#579">#define</span> module_driver(__driver, __register, __unregister, ...) \
<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init __driver<span style="color:#579">#</span><span style="color:#579">#_init</span>(<span style="color:#088;font-weight:bold">void</span>) \
{ \
        <span style="color:#080;font-weight:bold">return</span> __register(&amp;(__driver) , <span style="color:#579">#</span><span style="color:#579">#__VA_ARGS__</span>); \
} \
module_init(__driver<span style="color:#579">#</span><span style="color:#579">#_init</span>); \
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit __driver<span style="color:#579">#</span><span style="color:#579">#_exit</span>(<span style="color:#088;font-weight:bold">void</span>) \
{ \
        __unregister(&amp;(__driver) , <span style="color:#579">#</span><span style="color:#579">#__VA_ARGS__</span>); \
} \
module_exit(__driver<span style="color:#579">#</span><span style="color:#579">#_exit</span>);
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a similar fashion the adapter driver also registers itself
with the USB core using <em>usb_add_hcd()</em></p>
</div>
<div class="exampleblock">
<div class="content">
<div id="usb-core-registration" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/usb-core-registration.png"><img src="http://zeuzoix.github.io/techeuphoria/images/usb-core-registration.png" alt="usb core registration" width="640" height="480"></a>
</div>
<div class="title">USB Adapter and Device Driver Registration</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="device-detection"><a class="anchor" href="#device-detection"></a>35.2.4. Device Detection</h4>
<div class="paragraph">
<p>The USB adapter driver registers itself with the USB core using the
<em>usb_add_hcd()</em> function. The adapter driver is responsible to detect
a new device connected. It communicates the device id of the device
to the USB core. Thereafter the USB core matches the device id with
a list of known device id to driver mapping. If there is a match
the <em>probe</em> function of the driver is called.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="usb-device-driver-rtl8150" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/usb-device-driver-rtl8150.png"><img src="http://zeuzoix.github.io/techeuphoria/images/usb-device-driver-rtl8150.png" alt="usb device driver rtl8150" width="640" height="480"></a>
</div>
<div class="title">USB rtl8150 Device Driver Mapping</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="probing-the-driver"><a class="anchor" href="#probing-the-driver"></a>35.2.5. Probing The Driver</h4>
<div class="paragraph">
<p>On invoking the <em>probe</em> function of the driver a structure is passed which is
specific to the bus interface. On invocation the driver can:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Map I/O memory,</p>
</li>
<li>
<p>Register interrupts</p>
</li>
<li>
<p>Initialise private driver data structures</p>
</li>
<li>
<p>Register the driver with the appropriate framework.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> rtl8150_probe(<span style="color:#080;font-weight:bold">struct</span> usb_interface *intf,
                         <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> usb_device_id *id)
{
        <span style="color:#080;font-weight:bold">struct</span> usb_device *udev = interface_to_usbdev(intf);
        rtl8150_t *dev;
        <span style="color:#080;font-weight:bold">struct</span> net_device *netdev;

        netdev = alloc_etherdev(<span style="color:#080;font-weight:bold">sizeof</span>(rtl8150_t));                <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#080;font-weight:bold">if</span> (!netdev)
                <span style="color:#080;font-weight:bold">return</span> -ENOMEM;

        dev = netdev_priv(netdev);

        dev-&gt;intr_buff = kmalloc(INTBUFSIZE, GFP_KERNEL);
        <span style="color:#080;font-weight:bold">if</span> (!dev-&gt;intr_buff) {
                free_netdev(netdev);
                <span style="color:#080;font-weight:bold">return</span> -ENOMEM;
        }

        tasklet_init(&amp;dev-&gt;tl, rx_fixup, (<span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>)dev);        <i class="conum" data-value="2"></i><b>(2)</b>
        spin_lock_init(&amp;dev-&gt;rx_pool_lock);

        dev-&gt;udev = udev;
        dev-&gt;netdev = netdev;
        netdev-&gt;netdev_ops = &amp;rtl8150_netdev_ops;
        netdev-&gt;watchdog_timeo = RTL8150_TX_TIMEOUT;
        SET_ETHTOOL_OPS(netdev, &amp;ops);
        dev-&gt;intr_interval = <span style="color:#00D">100</span>;       <span style="color:#777">/* 100ms */</span>

        <span style="color:#080;font-weight:bold">if</span> (!alloc_all_urbs(dev)) {
                dev_err(&amp;intf-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">out of memory</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
                <span style="color:#080;font-weight:bold">goto</span> out;
        }
        <span style="color:#080;font-weight:bold">if</span> (!rtl8150_reset(dev)) {
                dev_err(&amp;intf-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">couldn't reset the device</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
                <span style="color:#080;font-weight:bold">goto</span> out1;
        }
        fill_skb_pool(dev);
        set_ethernet_addr(dev);

        usb_set_intfdata(intf, dev);
        SET_NETDEV_DEV(netdev, &amp;intf-&gt;dev);
        <span style="color:#080;font-weight:bold">if</span> (register_netdev(netdev) != <span style="color:#00D">0</span>) {                                        <i class="conum" data-value="3"></i><b>(3)</b>
                dev_err(&amp;intf-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">couldn't register the device</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
                <span style="color:#080;font-weight:bold">goto</span> out2;
        }

        dev_info(&amp;intf-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: rtl8150 is detected</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, netdev-&gt;name);

        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;

<span style="color:#970;font-weight:bold">out2:</span>
        usb_set_intfdata(intf, <span style="color:#069">NULL</span>);
        free_skb_pool(dev);
<span style="color:#970;font-weight:bold">out1:</span>
        free_all_urbs(dev);
<span style="color:#970;font-weight:bold">out:</span>
        kfree(dev-&gt;intr_buff);
        free_netdev(netdev);
        <span style="color:#080;font-weight:bold">return</span> -EIO;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Allocate etherdev structure</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Initialise tasklet</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Register with net framework</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="platform-drivers"><a class="anchor" href="#platform-drivers"></a>36. Platform Drivers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Not all buses have the ability to dynamically detect new devices. Some
buses such as SPI and I2C do not support enumeration or hotplugging.
And in the case of SOCs there are devices like the UART which are directly
part of the chip. These devices are described to the kernel through either
source code or a <em>Device Tree</em> file format.</p>
</div>
<div class="paragraph">
<p>To support such devices in the device driver model of the Linux kernel a
<em>platform bus</em> is created which handles <em>platform drivers</em> and <em>platform devices</em>.
The <em>platform bus</em> works like any other bus except that the devices are not
discovered but rather defined using either source code in the kernel or using
the <em>Device Tree</em> file mechanism.</p>
</div>
<div class="sect2">
<h3 id="serial-i-mx-as-an-example-of-a-platform-driver"><a class="anchor" href="#serial-i-mx-as-an-example-of-a-platform-driver"></a>36.1. Serial i.MX As An Example Of A Platform Driver</h3>
<div class="paragraph">
<p>Let&#8217;s take a look at the serial driver for the i.MX platform from Freescale.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ find . -name 'imx.c'
./drivers/tty/serial/imx.c
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="paragraph">
<p>The structure which defines the serial platform driver is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> platform_driver serial_imx_driver = {
        .probe          = serial_imx_probe,
        .remove         = serial_imx_remove,

        .suspend        = serial_imx_suspend,
        .resume         = serial_imx_resume,
        .id_table       = imx_uart_devtype,
        .driver         = {
                .name   = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">imx-uart</span><span style="color:#710">&quot;</span></span>,
                .owner  = THIS_MODULE,
                .of_match_table = imx_uart_dt_ids,
        },
};
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The registration and deregistration of this platform driver takes place in
the initialisation and exit functions of the driver.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init imx_serial_init(<span style="color:#088;font-weight:bold">void</span>)
{
        <span style="color:#0a8;font-weight:bold">int</span> ret;

        pr_info(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Serial: IMX driver</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);

        ret = uart_register_driver(&amp;imx_reg);
        <span style="color:#080;font-weight:bold">if</span> (ret)
                <span style="color:#080;font-weight:bold">return</span> ret;

        ret = platform_driver_register(&amp;serial_imx_driver); <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#080;font-weight:bold">if</span> (ret != <span style="color:#00D">0</span>)
                uart_unregister_driver(&amp;imx_reg);

        <span style="color:#080;font-weight:bold">return</span> ret;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit imx_serial_exit(<span style="color:#088;font-weight:bold">void</span>)
{
        platform_driver_unregister(&amp;serial_imx_driver);        <i class="conum" data-value="2"></i><b>(2)</b>
        uart_unregister_driver(&amp;imx_reg);
}

module_init(imx_serial_init);
module_exit(imx_serial_exit);
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Platform driver registration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Platform driver deregistration</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="declaring-platform-devices-in-source-code"><a class="anchor" href="#declaring-platform-devices-in-source-code"></a>36.2. Declaring Platform Devices In Source Code</h3>
<div class="paragraph">
<p>The platform device is declared in source code. To locate where the device is
declared we have to probe a bit into the source code. Typically the platform
device if declared in this manner will be present in the machine specific
section of the kernel. We first take a look at
<em>arch/arm/mach-imx/devices/platform-imx-uart.c</em>. The main function is
_</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#080;font-weight:bold">struct</span> platform_device *__init imx_add_imx_uart_3irq(
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imx_imx_uart_3irq_data *data,
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imxuart_platform_data *pdata)
{
        <span style="color:#080;font-weight:bold">struct</span> resource res[] = {
                {
                        .start = data-&gt;iobase,
                        .end = data-&gt;iobase + data-&gt;iosize - <span style="color:#00D">1</span>,
                        .flags = IORESOURCE_MEM,
                }, {
                        .start = data-&gt;irqrx,
                        .end = data-&gt;irqrx,
                        .flags = IORESOURCE_IRQ,
                }, {
                        .start = data-&gt;irqtx,
                        .end = data-&gt;irqtx,
                        .flags = IORESOURCE_IRQ,
                }, {
                        .start = data-&gt;irqrts,
                        .end = data-&gt;irqrx,
                        .flags = IORESOURCE_IRQ,
                },
        };

        <span style="color:#080;font-weight:bold">return</span> imx_add_platform_device(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">imx1-uart</span><span style="color:#710">&quot;</span></span>, data-&gt;id, res,        <i class="conum" data-value="1"></i><b>(1)</b>
                        ARRAY_SIZE(res), pdata, <span style="color:#080;font-weight:bold">sizeof</span>(*pdata));
}
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The device is created by this <em>imx_add_platform_device</em>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we search for the definition of <em>imx_add_platform_device</em> we can locate it
in <em>arch/arm/mach-imx/devices/devices-common.h</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">inline</span> <span style="color:#080;font-weight:bold">struct</span> platform_device *imx_add_platform_device_dmamask(
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *name, <span style="color:#0a8;font-weight:bold">int</span> id,
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> resource *res, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> num_resources,
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">void</span> *data, size_t size_data, u64 dmamask)        <i class="conum" data-value="3"></i><b>(3)</b>
{
        <span style="color:#080;font-weight:bold">struct</span> platform_device_info pdevinfo = {                <i class="conum" data-value="4"></i><b>(4)</b>
                .name = name,
                .id = id,
                .res = res,
                .num_res = num_resources,
                .data = data,
                .size_data = size_data,
                .dma_mask = dmamask,
        };
        <span style="color:#080;font-weight:bold">return</span> platform_device_register_full(&amp;pdevinfo);
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">inline</span> <span style="color:#080;font-weight:bold">struct</span> platform_device *imx_add_platform_device(
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *name, <span style="color:#0a8;font-weight:bold">int</span> id,
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> resource *res, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> num_resources,
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#088;font-weight:bold">void</span> *data, size_t size_data)         <i class="conum" data-value="1"></i><b>(1)</b>
{
        <span style="color:#080;font-weight:bold">return</span> imx_add_platform_device_dmamask(
                        name, id, res, num_resources, data, size_data, <span style="color:#00D">0</span>);        <i class="conum" data-value="2"></i><b>(2)</b>
}
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The definition of <em>imx_add_platform_device</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Another function is called which instantiates the device</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The definition of _imx_add_platform_device_dmamask</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The device structure values</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The device is instantiated in the <em>arch/arm/mach-imx/mach-mx1ads.c</em> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __init mx1ads_init(<span style="color:#088;font-weight:bold">void</span>)
{
        imx1_soc_init();

        mxc_gpio_setup_multiple_pins(mx1ads_pins,
                ARRAY_SIZE(mx1ads_pins), <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">mx1ads</span><span style="color:#710">&quot;</span></span>);

        <span style="color:#777">/* UART */</span>
        imx1_add_imx_uart0(&amp;uart0_pdata);        <i class="conum" data-value="1"></i><b>(1)</b>
        imx1_add_imx_uart1(&amp;uart1_pdata);        <i class="conum" data-value="2"></i><b>(2)</b>

        <span style="color:#777">/* Physmap flash */</span>
        platform_device_register_resndata(<span style="color:#069">NULL</span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">physmap-flash</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">0</span>,
                        &amp;flash_resource, <span style="color:#00D">1</span>,
                        &amp;mx1ads_flash_data, <span style="color:#080;font-weight:bold">sizeof</span>(mx1ads_flash_data));

        <span style="color:#777">/* I2C */</span>
        i2c_register_board_info(<span style="color:#00D">0</span>, mx1ads_i2c_devices,
                                ARRAY_SIZE(mx1ads_i2c_devices));

        imx1_add_imx_i2c(&amp;mx1ads_i2c_data);
}
.
.
MACHINE_START(MX1ADS, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Freescale MX1ADS</span><span style="color:#710">&quot;</span></span>)
        <span style="color:#777">/* Maintainer: Sascha Hauer, Pengutronix */</span>
        .atag_offset = <span style="color:#02b">0x100</span>,
        .map_io = mx1_map_io,
        .init_early = imx1_init_early,
        .init_irq = mx1_init_irq,
        .handle_irq = imx1_handle_irq,
        .init_time      = mx1ads_timer_init,
        .init_machine = mx1ads_init,
        .restart        = mxc_restart,
MACHINE_END
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>UART 0 is added</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>UART 1 is added</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The definition of <em>imx1_add_imx_uart0</em> is in <em>arch/arm/mach-imx/devices-imx1.h</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">extern</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imx_imx_uart_3irq_data imx1_imx_uart_data[];
<span style="color:#579">#define</span> imx1_add_imx_uart(id, pdata)    \
        imx_add_imx_uart_3irq(&amp;imx1_imx_uart_data[id], pdata)
<span style="color:#579">#define</span> imx1_add_imx_uart0(pdata)       imx1_add_imx_uart(<span style="color:#00D">0</span>, pdata)
<span style="color:#579">#define</span> imx1_add_imx_uart1(pdata)       imx1_add_imx_uart(<span style="color:#00D">1</span>, pdata)
.
.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="accessing-resources"><a class="anchor" href="#accessing-resources"></a>36.3. Accessing Resources</h3>
<div class="paragraph">
<p>Resources to a device can be IRQ lines, DMA channels, I/O registers' addresses
and so forth. All devices will require access to different resources. If we
look at the device instantiating function above we see the resources assigned in
<em>imx_add_imx_uart_3irq</em>. The resources are defined with the <em>struct resource</em>
structure definition. So in the function an array of resources is associated with
the device during instantiation. This again allows a driver to work with multiple
platform devices using different resources.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#080;font-weight:bold">struct</span> platform_device *__init imx_add_imx_uart_3irq(
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imx_imx_uart_3irq_data *data,
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imxuart_platform_data *pdata)
{
        <span style="color:#080;font-weight:bold">struct</span> resource res[] = {        <i class="conum" data-value="1"></i><b>(1)</b>
                {
                        .start = data-&gt;iobase,
                        .end = data-&gt;iobase + data-&gt;iosize - <span style="color:#00D">1</span>,
                        .flags = IORESOURCE_MEM,
                }, {
                        .start = data-&gt;irqrx,
                        .end = data-&gt;irqrx,
                        .flags = IORESOURCE_IRQ,
                }, {
                        .start = data-&gt;irqtx,
                        .end = data-&gt;irqtx,
                        .flags = IORESOURCE_IRQ,
                }, {
                        .start = data-&gt;irqrts,
                        .end = data-&gt;irqrx,
                        .flags = IORESOURCE_IRQ,
                },
        };

        <span style="color:#080;font-weight:bold">return</span> imx_add_platform_device(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">imx1-uart</span><span style="color:#710">&quot;</span></span>, data-&gt;id, res,        <i class="conum" data-value="2"></i><b>(2)</b>
                        ARRAY_SIZE(res), pdata, <span style="color:#080;font-weight:bold">sizeof</span>(*pdata));
}
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Array of resources defined</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Resources are associated with the device</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="accessing-platform-data"><a class="anchor" href="#accessing-platform-data"></a>36.4. Accessing Platform Data</h3>
<div class="paragraph">
<p>Many drivers will require platform specific data for each device. This is also passed
during platform instantiation. Basically since the <em>struct platform_data</em> inherits the
<em>struct device</em> the platform data can be passed through the <em>platform_data</em> field of
<em>struct device</em>. The field is defined as a <em>void *</em> data type so any data type can
be passed through it. Typically the platform driver will define the data structure to
pass information through <em>platform_data</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#080;font-weight:bold">struct</span> platform_device *__init imx_add_imx_uart_3irq(
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imx_imx_uart_3irq_data *data,
                <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imxuart_platform_data *pdata)        <i class="conum" data-value="1"></i><b>(1)</b>
{
        <span style="color:#080;font-weight:bold">struct</span> resource res[] = {        <i class="conum" data-value="1"></i><b>(1)</b>
                {
                        .start = data-&gt;iobase,
                        .end = data-&gt;iobase + data-&gt;iosize - <span style="color:#00D">1</span>,
                        .flags = IORESOURCE_MEM,
                }, {
                        .start = data-&gt;irqrx,
                        .end = data-&gt;irqrx,
                        .flags = IORESOURCE_IRQ,
                }, {
                        .start = data-&gt;irqtx,
                        .end = data-&gt;irqtx,
                        .flags = IORESOURCE_IRQ,
                }, {
                        .start = data-&gt;irqrts,
                        .end = data-&gt;irqrx,
                        .flags = IORESOURCE_IRQ,
                },
        };

        <span style="color:#080;font-weight:bold">return</span> imx_add_platform_device(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">imx1-uart</span><span style="color:#710">&quot;</span></span>, data-&gt;id, res,
                        ARRAY_SIZE(res), pdata, <span style="color:#080;font-weight:bold">sizeof</span>(*pdata));        <i class="conum" data-value="2"></i><b>(2)</b>
}
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Platform data is defined as struct imxuart_platform_data</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The platform data is passed to the device during instantiation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The definition of the <em>struct imxuart_platform_data</em> is located in
<em>include/linux/platform_data/serial-imx.h</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#080;font-weight:bold">struct</span> imxuart_platform_data {
        <span style="color:#0a8;font-weight:bold">int</span> (*init)(<span style="color:#080;font-weight:bold">struct</span> platform_device *pdev);
        <span style="color:#088;font-weight:bold">void</span> (*exit)(<span style="color:#080;font-weight:bold">struct</span> platform_device *pdev);
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> flags;
        <span style="color:#088;font-weight:bold">void</span> (*irda_enable)(<span style="color:#0a8;font-weight:bold">int</span> enable);
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> irda_inv_rx:<span style="color:#00D">1</span>;
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> irda_inv_tx:<span style="color:#00D">1</span>;
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">short</span> transceiver_delay;
};
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The board code in <em>arch/arm/mach-imx/mach-mx1ads.c</em> initiates
the structure as <em>&amp;uart0_pdata</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imxuart_platform_data uart0_pdata __initconst = {
        .flags = IMXUART_HAVE_RTSCTS,
};
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The platform driver can then access this data in its probe function where the
platform device is passed to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> serial_imx_probe_pdata(<span style="color:#080;font-weight:bold">struct</span> imx_port *sport,
                <span style="color:#080;font-weight:bold">struct</span> platform_device *pdev)
{
        <span style="color:#080;font-weight:bold">struct</span> imxuart_platform_data *pdata = dev_get_platdata(&amp;pdev-&gt;dev);
.
.
.
        <span style="color:#080;font-weight:bold">if</span> (pdata-&gt;flags &amp; IMXUART_HAVE_RTSCTS)        <i class="conum" data-value="3"></i><b>(3)</b>
                sport-&gt;have_rtscts = <span style="color:#00D">1</span>;
.
.

}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> serial_imx_probe(<span style="color:#080;font-weight:bold">struct</span> platform_device *pdev)        <i class="conum" data-value="1"></i><b>(1)</b>
{
        <span style="color:#080;font-weight:bold">struct</span> imx_port *sport;
        <span style="color:#080;font-weight:bold">struct</span> imxuart_platform_data *pdata;
.
.
.
        ret = serial_imx_probe_dt(sport, pdev);
        <span style="color:#080;font-weight:bold">if</span> (ret &gt; <span style="color:#00D">0</span>)
                serial_imx_probe_pdata(sport, pdev);        <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (ret &lt; <span style="color:#00D">0</span>)
                <span style="color:#080;font-weight:bold">return</span> ret;
.
.
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <em>serial_imx_probe</em> function calls the <em>serial_imx_probe_pdata</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <em>serial_imx_probe_pdata</em> calls accesses the platform data.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="device-tree-2"><a class="anchor" href="#device-tree-2"></a>36.5. Device Tree</h3>
<div class="paragraph">
<p>The older approach of writing code to instantiate devices is not easily
maintainable. An alternative approach is to use the <em>Device Tree</em> to
describe the platform devices.</p>
</div>
<div class="paragraph">
<p>A <em>Device Tree</em> is a tree of nodes that describes the network of devices
in a system. It can describe devices inside the processor as well as
devices on the board. Each node has different properties which can be
attached to the device such as addresses, interrupts, clocks, gpios, etc..</p>
</div>
<div class="paragraph">
<p>The device tree is compiled into a binary file which is recognised
by the kernel. During boot up the <em>device tree blob</em> is passed to the
kernel which describes the platform devices in the system. This allows
the same kernel image to work with different systems.</p>
</div>
</div>
<div class="sect2">
<h3 id="an-example-of-device-tree"><a class="anchor" href="#an-example-of-device-tree"></a>36.6. An Example Of Device Tree</h3>
<div class="paragraph">
<p>The device tree source files are stored in the architecture specific
path of the Linux kernel source code. For example for ARM devices
the files are located at <em>arch/arm/boot/dts/</em>. We can take a look at
<em>arch/arm/boot/dts/omap3.dtsi</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
                uart1: serial<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">4806</span>a000 {
                        compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,omap3-uart</span><span style="color:#710">&quot;</span></span>;
                        reg = &lt;<span style="color:#02b">0x4806a000</span> <span style="color:#02b">0x2000</span>&gt;;
                        interrupts = &lt;<span style="color:#00D">72</span>&gt;;
                        dmas = &lt;&amp;sdma <span style="color:#00D">49</span> &amp;sdma <span style="color:#00D">50</span>&gt;;
                        dma-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">tx</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">rx</span><span style="color:#710">&quot;</span></span>;
                        ti,hwmods = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">uart1</span><span style="color:#710">&quot;</span></span>;
                        clock-frequency = &lt;<span style="color:#00D">48000000</span>&gt;;
                };
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the node above <em>serial@4806a000</em> is the name of the node. The notation
<em>uart1</em> is the alias which can be refer to the node as <em>&amp;uart1</em> in other
sections of the device tree source. The remaining lines are properties
of the node which are used by the platform driver.</p>
</div>
<div class="paragraph">
<p>The file <em>arch/arm/boot/dts/omap3.dtsi</em> is a common file which can be included
by other hardware platforms. Thus device trees support inheritance whereby
common similarities between different platforms can be defined in a common
file.</p>
</div>
<div class="paragraph">
<p>The file which includes the common file overrides the properties as well as
defining its own properties. The <em>compatible</em> property associated with the
uart1 node defines the driver mapping for the device. The platform driver
will also have the same string in the <em>of_match_table</em> of the <em>struct device_driver</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ egrep -ri &quot;ti,omap3-uart&quot; drivers/tty/
Binary file drivers/tty/serial/built-in.o matches
Binary file drivers/tty/serial/omap-serial.o matches
drivers/tty/serial/omap-serial.c:        { .compatible = &quot;ti,omap3-uart&quot; },        <i class="conum" data-value="1"></i><b>(1)</b>
Binary file drivers/tty/built-in.o matches</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Location of the platform driver</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When we open the platform driver source code we see the mapping:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.

<span style="color:#579">#if</span> defined(CONFIG_OF)
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> of_device_id omap_serial_of_match[] = {
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,omap2-uart</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,omap3-uart</span><span style="color:#710">&quot;</span></span> },        <i class="conum" data-value="1"></i><b>(1)</b>
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,omap4-uart</span><span style="color:#710">&quot;</span></span> },
        {},
};
MODULE_DEVICE_TABLE(of, omap_serial_of_match);
<span style="color:#579">#endif</span>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> platform_driver serial_omap_driver = {
        .probe          = serial_omap_probe,
        .remove         = serial_omap_remove,
        .driver         = {
                .name   = DRIVER_NAME,
                .pm     = &amp;serial_omap_dev_pm_ops,
                .of_match_table = of_match_ptr(omap_serial_of_match),        <i class="conum" data-value="2"></i><b>(2)</b>
        },
};
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <em>compatible</em> property presetn in the <em>struct of_device_id</em> table <em>omap_serial_of_match</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <em>of_match_table</em> of the <em>struct device_driver</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>CONFIG_OF</em> macro stands for configuration of open firmware. This is associated
with the device tree implementation in the kernel. With the device tree method
the resources such as interrupt numbers, physical addresses, etc.. are picked up from
the properties of the device node.</p>
</div>
<div class="paragraph">
<p>The resources list is built up at boot time by
the kernel when it reads the <em>Device Tree Blob</em>. The driver will not have to make
any lookups to the DT but will get access to the node through the struct platform_device
structure. Any other properties are specific to the class of the device or the driver it belongs
to.</p>
</div>
</div>
<div class="sect2">
<h3 id="device-tree-bindings"><a class="anchor" href="#device-tree-bindings"></a>36.7. Device Tree Bindings</h3>
<div class="paragraph">
<p>The <em>compatible</em> string and the associated properties define the device tree binding.
These are documented in the <em>Documentation/devicetree/bindings/</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ ls -l Documentation/devicetree/bindings/
total 284
drwxrwxr-x  2 conrad conrad  4096 Nov 20  2013 arc
drwxrwxr-x 15 conrad conrad  4096 Nov 12  2014 arm
drwxrwxr-x  2 conrad conrad  4096 Nov 12  2014 ata
drwxrwxr-x  2 conrad conrad  4096 Nov 12  2014 bus
.
.
.
drwxrwxr-x  3 conrad conrad  4096 Nov 12  2014 video
drwxrwxr-x  2 conrad conrad  4096 Oct 19  2013 virtio
drwxrwxr-x  2 conrad conrad  4096 Oct 19  2013 w1
drwxrwxr-x  2 conrad conrad  4096 Nov 12  2014 watchdog
drwxrwxr-x  2 conrad conrad  4096 Oct 19  2013 x86
-rw-rw-r--  1 conrad conrad 10748 Oct 19  2013 xilinx.txt
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>Device Tree</em> is part of the ABI and a new kernel should work with an older Device Tree.
The design of the bindings is carefully reviewed on the <em>devicetree@vger.kernel.org</em>
mailing list. The device tree should only describe the properties of the hardware. Anything
related to the configuration of the device should be avoided for instance
whether DMA should be used or not.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sysfs"><a class="anchor" href="#sysfs"></a>37. sysfs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <em>sysfs</em> offers a mechanism to access the information related to
the bus, drivers, devices, etc to the userspace. This information
can be used to support features such as :
. dynamic loading of drivers
. dynamic loading of firmware
. automatic creation of device file</p>
</div>
<div class="paragraph">
<p>The <em>sysfs</em> is usually mounted in <em>/sys/</em>. It is organised into different sections
of information. For instance:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>/sys/block</em> contains information of different block devices</p>
</li>
<li>
<p><em>/sys/class</em> contains information about devices by class e.g. net, graphics, block, input, etc..</p>
</li>
<li>
<p><em>/sys/devices</em> contains the list of devices</p>
</li>
<li>
<p><em>/sys/bus</em> contains the list of buses</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>While writing a kernel module or driver we can export properties to userspace
through the <em>sysfs</em> interface.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the-i2c-subsystem"><a class="anchor" href="#the-i2c-subsystem"></a>38. The I2C Subsystem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The I2C bus is a low speed bus which is found on many SOCs today.
It is a simple bus with two wires, SDA for the data and SCL for the
clock. The SOC normally has the I2C controller and therefore is
the master on the bus controlling the slave devices.</p>
</div>
<div class="paragraph">
<p>Each slave has a unique address on the bus and each transaction
on the bus includes the address of the device with which communication
is required from the controller.</p>
</div>
<div class="paragraph">
<p>Only the master can initiate transactions on the bus with the addressed
slave device responding. In some systems it may be possible for one
bus to have two masters but there would be some level of arbitration
mechanism implemented in order to have only one master controlling
the bus at any time.</p>
</div>
<div class="paragraph">
<p>Since I2C is a very common protocol we find many devices have it
as an interface. I2C is found in a wide variety of chips which
can be used in the overall system design of the platform. Some
use cases are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Touchscreen controller</p>
</li>
<li>
<p>GPIO expander</p>
</li>
<li>
<p>Audio codec</p>
</li>
<li>
<p>Real Time clock</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The I2C subsystem is a platform bus system. It provides API to:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Implement I2C controller drivers</p>
</li>
<li>
<p>Implement I2C device drivers, in kernel space</p>
</li>
<li>
<p>Implement I2C device drivers, in user space</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The core of the I2C subsystem resides in <em>drivers/i2c</em>. The
I2C controller drivers are present in <em>drivers/i2c/busses/</em>.
And the device drivers are present in <em>drivers</em> based on the
classification of the device e.g. <em>drivers/gpio</em> for gpio expanders.</p>
</div>
<div class="sect2">
<h3 id="registering-an-i2c-driver"><a class="anchor" href="#registering-an-i2c-driver"></a>38.1. Registering An I2C Driver</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The I2C subsystem defines a <em>struct i2c_driver</em> which inherits the
<em>struct device_driver</em>. This is instantiated and registered by each
I2C device driver.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Similarly this structure will have a <em>probe()</em> and a <em>remove()</em>
function.</p>
</li>
<li>
<p>It also contains an <em>id_table</em> which enumerates the list of devices
that can be used with the driver. This table is normally used for
non-DT based drivers.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The <em>i2c_add_driver()</em> and <em>i2c_del_driver()</em> functions are used
to add the device driver and remove it from the I2C subsystem.</p>
</li>
<li>
<p>If the driver doesn&#8217;t require anything else to be done in the
initialisation and exit sequence then the <em>module_i2c_driver</em>
macro can be used.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can take a look at an I2C device driver in <em>drivers/gpio/gpio-pcf857x.c</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> i2c_device_id pcf857x_id[] = {        <i class="conum" data-value="1"></i><b>(1)</b>
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pcf8574</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pcf8574a</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pca8574</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pca9670</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pca9672</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pca9674</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pcf8575</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">16</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pca8575</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">16</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pca9671</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">16</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pca9673</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">16</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pca9675</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">16</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">max7328</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">max7329</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">tca9554</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">8</span> },
        { }
};
MODULE_DEVICE_TABLE(i2c, pcf857x_id);        <i class="conum" data-value="2"></i><b>(2)</b>

<span style="color:#579">#ifdef</span> CONFIG_OF
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> of_device_id pcf857x_of_table[] = {
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pcf8574</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pcf8574a</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pca8574</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pca9670</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pca9672</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pca9674</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pcf8575</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pca8575</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pca9671</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pca9673</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nxp,pca9675</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">maxim,max7328</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">maxim,max7329</span><span style="color:#710">&quot;</span></span> },
        { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,tca9554</span><span style="color:#710">&quot;</span></span> },
        { }
};
MODULE_DEVICE_TABLE(of, pcf857x_of_table);
<span style="color:#579">#endif</span>
.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> i2c_driver pcf857x_driver = {        <i class="conum" data-value="3"></i><b>(3)</b>
        .driver = {
                .name   = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pcf857x</span><span style="color:#710">&quot;</span></span>,
                .owner  = THIS_MODULE,
                .of_match_table = of_match_ptr(pcf857x_of_table),
        },
        .probe  = pcf857x_probe,
        .remove = pcf857x_remove,
        .id_table = pcf857x_id,
};

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init pcf857x_init(<span style="color:#088;font-weight:bold">void</span>)
{
        <span style="color:#080;font-weight:bold">return</span> i2c_add_driver(&amp;pcf857x_driver);        <i class="conum" data-value="4"></i><b>(4)</b>
}
<span style="color:#777">/* register after i2c postcore initcall and before
 * subsys initcalls that may rely on these GPIOs
 */</span>
subsys_initcall(pcf857x_init);

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit pcf857x_exit(<span style="color:#088;font-weight:bold">void</span>)
{
        i2c_del_driver(&amp;pcf857x_driver);        <i class="conum" data-value="5"></i><b>(5)</b>
}
module_exit(pcf857x_exit);

.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>pcf857x_id</em> is the device id table</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The device id table is registered with the I2C subsystem</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>pcf857x_driver</em> is the <em>struct i2c_driver</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><em>i2c_add_driver</em> registers the device driver</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><em>i2c_del_driver</em> deletes the device driver</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="registering-an-i2c-device-non-dt-approach"><a class="anchor" href="#registering-an-i2c-device-non-dt-approach"></a>38.2. Registering An I2C Device, non-DT Approach</h3>
<div class="paragraph">
<p>On non-DT platforms the <em>struct i2c_board_info</em> structure describes
how the I2C device is connected on the board. The <em>I2C_BOARD_INFO</em>
macro takes the device name and slave address of the device on the
bus. If we take a look at
the <em>arch/arm/mach-imx/mach-mx1ads.c</em> file we can see its usage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> pcf857x_platform_data pcf857x_data[] = {
        {
                .gpio_base = <span style="color:#00D">4</span> * <span style="color:#00D">32</span>,
        }, {
                .gpio_base = <span style="color:#00D">4</span> * <span style="color:#00D">32</span> + <span style="color:#00D">16</span>,
        }
};

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> imxi2c_platform_data mx1ads_i2c_data __initconst = {
        .bitrate = <span style="color:#00D">100000</span>,
};

<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> i2c_board_info mx1ads_i2c_devices[] = {        <i class="conum" data-value="1"></i><b>(1)</b>
        {
                I2C_BOARD_INFO(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pcf8575</span><span style="color:#710">&quot;</span></span>, <span style="color:#02b">0x22</span>),        <i class="conum" data-value="2"></i><b>(2)</b>
                .platform_data = &amp;pcf857x_data[<span style="color:#00D">0</span>],
        }, {
                I2C_BOARD_INFO(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pcf8575</span><span style="color:#710">&quot;</span></span>, <span style="color:#02b">0x24</span>),
                .platform_data = &amp;pcf857x_data[<span style="color:#00D">1</span>],
        },
};

<span style="color:#777">/*
 * Board init
 */</span>
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __init mx1ads_init(<span style="color:#088;font-weight:bold">void</span>)
{
.
.
.
        <span style="color:#777">/* I2C */</span>
        i2c_register_board_info(<span style="color:#00D">0</span>, mx1ads_i2c_devices,                        <i class="conum" data-value="3"></i><b>(3)</b>
                                ARRAY_SIZE(mx1ads_i2c_devices));

        imx1_add_imx_i2c(&amp;mx1ads_i2c_data);
}
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The array of devices is defined as <em>mx1ads_i2c_devices</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <em>I2C_BOARD_INFO</em> macro defines an I2C device</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <em>i2c_register_board_info</em> API registers the devices</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="registering-an-i2c-device-dt-approach"><a class="anchor" href="#registering-an-i2c-device-dt-approach"></a>38.3. Registering An I2C Device, DT Approach</h3>
<div class="paragraph">
<p>In the Device Tree approach the I2C controller is specified in the
<em>.dtsi</em> file that describes the processor. The controller is
normally defined with <em>status = "disabled"</em>.</p>
</div>
<div class="paragraph">
<p>At the board/platform level, in the <em>.dts</em> file:
. the I2C controller device is enabled i.e. <em>status = "ok"</em>
. the I2C bus controller frequency is defined i.e. <em>clock-frequency = &lt;100000&gt;"
. the I2C devices on the bus are described as children nodes and the
_reg</em> property gives their address.</p>
</div>
<div class="paragraph">
<p>As an example take a look at the <em>arch/arm/boot/dts/tegra30.dtsi</em> file.
Here we see the I2C controller defined and disabled.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
        i2c<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">7000</span>d000 { <i class="conum" data-value="1"></i><b>(1)</b>
                compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nvidia,tegra30-i2c</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nvidia,tegra20-i2c</span><span style="color:#710">&quot;</span></span>;
                reg = &lt;<span style="color:#02b">0x7000d000</span> <span style="color:#02b">0x100</span>&gt;;
                interrupts = &lt;GIC_SPI <span style="color:#00D">53</span> IRQ_TYPE_LEVEL_HIGH&gt;;
                <span style="color:#579">#address</span>-cells = &lt;<span style="color:#00D">1</span>&gt;;
                <span style="color:#579">#size</span>-cells = &lt;<span style="color:#00D">0</span>&gt;;
                clocks = &lt;&amp;tegra_car TEGRA30_CLK_I2C5&gt;,
                         &lt;&amp;tegra_car TEGRA30_CLK_PLL_P_OUT3&gt;;
                clock-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">div-clk</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">fast-clk</span><span style="color:#710">&quot;</span></span>;
                status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">disabled</span><span style="color:#710">&quot;</span></span>;        <i class="conum" data-value="2"></i><b>(2)</b>
        };
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Controller <em>i2c@7000d000</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The controller is disabled</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we take a look at a board file which includes the <em>.dtsi</em> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
        i2c<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">7000</span>d000 {
                status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">okay</span><span style="color:#710">&quot;</span></span>;        <i class="conum" data-value="1"></i><b>(1)</b>
                clock-frequency = &lt;<span style="color:#00D">100000</span>&gt;;        <i class="conum" data-value="2"></i><b>(2)</b>

                <span style="color:#970;font-weight:bold">rt5640:</span> rt5640 {
                        compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">realtek,rt5640</span><span style="color:#710">&quot;</span></span>;
                        reg = &lt;<span style="color:#02b">0x1c</span>&gt;;        <i class="conum" data-value="3"></i><b>(3)</b>
                        interrupt-parent = &lt;&amp;gpio&gt;;
                        interrupts = &lt;TEGRA_GPIO(X, <span style="color:#00D">3</span>) GPIO_ACTIVE_HIGH&gt;;
                        realtek,ldo1-en-gpios =
                                &lt;&amp;gpio TEGRA_GPIO(X, <span style="color:#00D">2</span>) GPIO_ACTIVE_HIGH&gt;;
                };

                tps62361 {
                        compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,tps62361</span><span style="color:#710">&quot;</span></span>;
                        reg = &lt;<span style="color:#02b">0x60</span>&gt;;        <i class="conum" data-value="4"></i><b>(4)</b>

                        regulator-name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">tps62361-vout</span><span style="color:#710">&quot;</span></span>;
                        regulator-min-microvolt = &lt;<span style="color:#00D">500000</span>&gt;;
                        regulator-max-microvolt = &lt;<span style="color:#00D">1500000</span>&gt;;
                        regulator-boot-on;
                        regulator-always-on;
                        ti,vsel0-state-high;
                        ti,vsel1-state-high;
                };
.
.
        };
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>status</em> is set to "okay"</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>clock-frequency</em> is set to 100KHz</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>rt5640</em> is an I2C device on the bus with address 0x1C</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><em>tps62361</em> is an I2C device on the bus with address 0x60</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="i2c-device-driver-un-registration"><a class="anchor" href="#i2c-device-driver-un-registration"></a>38.4. I2C Device Driver (Un)Registration</h3>
<div class="paragraph">
<p>From the above example of I2C device approach using a device tree we can
identify a device driver for the device using the <em>compatible</em> string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ grep -ri &quot;tps62361&quot; drivers/*        <i class="conum" data-value="1"></i><b>(1)</b>
drivers/regulator/tps62360-regulator.c: * Driver for processor core supply tps62360, tps62361B, tps62362 and tps62363.
drivers/regulator/tps62360-regulator.c:enum chips {TPS62360, TPS62361, TPS62362, TPS62363};
drivers/regulator/tps62360-regulator.c:#define TPS62361_BASE_VOLTAGE        500000
drivers/regulator/tps62360-regulator.c:#define TPS62361_N_VOLTAGES        128
drivers/regulator/tps62360-regulator.c:         { .compatible = &quot;ti,tps62361&quot;, .data = (void *)TPS62361},
drivers/regulator/tps62360-regulator.c:        case TPS62361:
drivers/regulator/tps62360-regulator.c:                tps-&gt;desc.min_uV = TPS62361_BASE_VOLTAGE;
drivers/regulator/tps62360-regulator.c:                tps-&gt;desc.n_voltages = TPS62361_N_VOLTAGES;
drivers/regulator/tps62360-regulator.c:        {.name = &quot;tps62361&quot;, .driver_data = TPS62361},</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Searching for the string "tps62361" we find it mentioned in the <em>tps62360-regulator.c</em> file</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we open up the <em>drivers/regulator/tps62360-regulator.c</em> file we can see the
<em>struct of_device_id</em> table <em>tps62360_of_match</em> defined.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#579">#if</span> defined(CONFIG_OF)
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> of_device_id tps62360_of_match[] = {
         { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,tps62360</span><span style="color:#710">&quot;</span></span>, .data = (<span style="color:#088;font-weight:bold">void</span> *)TPS62360},        <i class="conum" data-value="1"></i><b>(1)</b>
         { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,tps62361</span><span style="color:#710">&quot;</span></span>, .data = (<span style="color:#088;font-weight:bold">void</span> *)TPS62361},
         { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,tps62362</span><span style="color:#710">&quot;</span></span>, .data = (<span style="color:#088;font-weight:bold">void</span> *)TPS62362},
         { .compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,tps62363</span><span style="color:#710">&quot;</span></span>, .data = (<span style="color:#088;font-weight:bold">void</span> *)TPS62363},
        {},
};
MODULE_DEVICE_TABLE(of, tps62360_of_match);
<span style="color:#579">#endif</span>
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The string "ti,tps62360" as part of the <em>struct of_device_id</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>struct i2c_driver</em> is defined as <em>tps62360_i2c_driver</em>. The <em>tps62360_probe</em>
and <em>tps62360_shutdown</em> functions define the entry and exit points for the
driver.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> i2c_driver tps62360_i2c_driver = {
        .driver = {
                .name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">tps62360</span><span style="color:#710">&quot;</span></span>,
                .owner = THIS_MODULE,
                .of_match_table = of_match_ptr(tps62360_of_match),
        },
        .probe = tps62360_probe,
        .shutdown = tps62360_shutdown,
        .id_table = tps62360_id,
};

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init tps62360_init(<span style="color:#088;font-weight:bold">void</span>)
{
        <span style="color:#080;font-weight:bold">return</span> i2c_add_driver(&amp;tps62360_i2c_driver);
}
subsys_initcall(tps62360_init);

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit tps62360_cleanup(<span style="color:#088;font-weight:bold">void</span>)
{
        i2c_del_driver(&amp;tps62360_i2c_driver);
}
module_exit(tps62360_cleanup);
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <em>tps62360_probe</em> function initializes the device and registers it with
the appropriate kernel framework which happens to be the <em>regulator</em> framework.
It receives the <em>struct i2c_client</em> pointer which represents the I2C device.
This device inherits from <em>struct device</em>. The probe function also receives
the <em>struct i2c_device_id</em> pointer which points to the device ID entry
that matched the device.</p>
</div>
<div class="paragraph">
<p>The tps62360 driver does not have a <em>remove</em> function but if present it receives
the <em>struct i2c_client</em> pointer that was passed to it in the probe function.
The <em>remove</em> function should unregister the device from the kernel framework
and shut it down.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lab-5-linux-device-model-for-an-i2c-device"><a class="anchor" href="#lab-5-linux-device-model-for-an-i2c-device"></a>39. LAB 5 : Linux Device Model For An I2C Device</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">This is a hands on session taken from the Free Electrons labs with the following objectives</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add an I2C device to a device tree.</p>
</li>
<li>
<p>Develop a basic driver with a <em>probe</em>/<em>remove</em> function that gets invoked by the device model of the Linux kernel.</p>
</li>
<li>
<p>Explore <em>sysfs</em> for the I2C device and driver.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="creating-a-new-branch"><a class="anchor" href="#creating-a-new-branch"></a>39.1. Creating A New Branch</h3>
<div class="paragraph">
<p>We first check out the 3.13.y branch which will be the base source code used
for our lab5 experiments. We then checkout a new branch called <em>nunchuck</em>
which will hold our changes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git branch
  3.13.y
  fix_unioxx5
* hello_version
  master
  tutorialv2
  tutorialv3
  tutorialv4
  tutorialv5
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git checkout 3.13.y <i class="conum" data-value="1"></i><b>(1)</b>
Switched to branch '3.13.y'
Your branch is up-to-date with 'stable/linux-3.13.y'.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git checkout -b nunchuck <i class="conum" data-value="2"></i><b>(2)</b>
Switched to a new branch 'nunchuck'
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git branch
  3.13.y
  fix_unioxx5
  hello_version
  master
* nunchuck
  tutorialv2
  tutorialv3
  tutorialv4
  tutorialv5

conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Checkout branch <em>3.13.y</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Checkout new branch <em>nunchuck</em></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="about-the-nunchuck"><a class="anchor" href="#about-the-nunchuck"></a>39.2. About The Nunchuck</h3>
<div class="paragraph">
<p>We&#8217;re going to connect a Nunchuck device to our Beagle Bone Black board.
The Wii Nunchuck is an attachment for Nintendo&#8217;s Wii Remote. It comes with
an analog stick, trigger buttons and an inbuilt accelerometer for motion-sensing
and tilting.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="nintendo-wii-remote-nunchuck" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/nintendo-wii-remote-nunchuck.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/nintendo-wii-remote-nunchuck.jpg" alt="nintendo wii remote nunchuck" width="640" height="480"></a>
</div>
<div class="title">The Nintendo Wii Remote Nunchuck</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The device can be purchased online. I personally got mine from PayTM using Google
to search for the cheapest available option.</p>
</div>
<div class="paragraph">
<p>Apart from the nunchuck we will also need some sort of breakout board to expose
the connetions on the nunchuck so that we can interface it to our <em>i2c1</em> bus on
our board. For this I&#8217;m using an arduino type of breakout board for the
Wii Nunchuck as shown below.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="nunchuck-breakout-board" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/nunchuck-breakout-board.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/nunchuck-breakout-board.jpg" alt="nunchuck breakout board" width="640" height="480"></a>
</div>
<div class="title">The Nunchuck Breakout Board</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The breakout board has three contacts on one side and two contacts on the other.
If we look at the Nunchuck connector it becomes clear as to how to pair the two.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="nunchuck-breakout-board-pairing" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/nunchuck-breakout-board-pairing.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/nunchuck-breakout-board-pairing.jpg" alt="nunchuck breakout board pairing" width="640" height="480"></a>
</div>
<div class="title">The Nunchuck and Breakout Board Pairing</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Finally we connect the breakout board to a breadboard to make it easier to
make the connections to our Beagle Bone Black board.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="nunchuck-breakout-breadboard-connection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/nunchuck-breakout-breadboard-connection.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/nunchuck-breakout-breadboard-connection.jpg" alt="nunchuck breakout breadboard connection" width="640" height="480"></a>
</div>
<div class="title">The Nunchuck, Breakout Board And Breadboard Connections</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="update-the-board-device-tree"><a class="anchor" href="#update-the-board-device-tree"></a>39.3. Update The Board Device Tree</h3>
<div class="paragraph">
<p>We will need to specify the device as part of the platform. We do this using the
device tree approach and modify the board device tree. We will have to define
a second I2C bus <em>i2c1</em> and then add a child node to this bus which will correspond
to the Nunchuck device.</p>
</div>
<div class="sect3">
<h4 id="declaring-a-second-i2c-bus"><a class="anchor" href="#declaring-a-second-i2c-bus"></a>39.3.1. Declaring A Second I2C Bus</h4>
<div class="paragraph">
<p>First we try to locate the DTS file with the first I2C bus <em>i2c0</em> is defined. Using
fubd we can search in the <em>arch/arm/boot/dts/</em> directory for files which have
references to "bone".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ find arch/arm/boot/dts/ -name '*bone*.dts'
arch/arm/boot/dts/am335x-boneblack.dts
arch/arm/boot/dts/am335x-bone.dts</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we open the file we can see that it includes two files which may have the
<em>i2c0</em> bus definition.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="dts">.
.
#include &quot;am33xx.dtsi&quot;        <i class="conum" data-value="1"></i><b>(1)</b>
#include &quot;am335x-bone-common.dtsi&quot;        <i class="conum" data-value="2"></i><b>(2)</b>

&amp;ldo3_reg {
        regulator-min-microvolt = &lt;1800000&gt;;
        regulator-max-microvolt = &lt;1800000&gt;;
        regulator-always-on;
};

.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Include of <em>am33xx.dtsi</em> which is the SOC base file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Include of <em>am335x-bone-common.dtsi</em> which is the bone platform base file</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We take a look at the <em>am33xx.dtsi</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
                i2c0: i2c<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">4</span><span style="color:#60E">4</span>e0b000 {
                        compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,omap4-i2c</span><span style="color:#710">&quot;</span></span>;
                        <span style="color:#579">#address</span>-cells = &lt;<span style="color:#00D">1</span>&gt;;
                        <span style="color:#579">#size</span>-cells = &lt;<span style="color:#00D">0</span>&gt;;
                        ti,hwmods = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">i2c1</span><span style="color:#710">&quot;</span></span>;
                        reg = &lt;<span style="color:#02b">0x44e0b000</span> <span style="color:#02b">0x1000</span>&gt;;        <i class="conum" data-value="1"></i><b>(1)</b>
                        interrupts = &lt;<span style="color:#00D">70</span>&gt;;
                        status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">disabled</span><span style="color:#710">&quot;</span></span>;        <i class="conum" data-value="2"></i><b>(2)</b>
                };

                <span style="color:#970;font-weight:bold">i2c1:</span> i2c<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">4802</span>a000 {
                        compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,omap4-i2c</span><span style="color:#710">&quot;</span></span>;
                        <span style="color:#579">#address</span>-cells = &lt;<span style="color:#00D">1</span>&gt;;
                        <span style="color:#579">#size</span>-cells = &lt;<span style="color:#00D">0</span>&gt;;
                        ti,hwmods = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">i2c2</span><span style="color:#710">&quot;</span></span>;
                        reg = &lt;<span style="color:#02b">0x4802a000</span> <span style="color:#02b">0x1000</span>&gt;;
                        interrupts = &lt;<span style="color:#00D">71</span>&gt;;
                        status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">disabled</span><span style="color:#710">&quot;</span></span>;
                };

                <span style="color:#970;font-weight:bold">i2c2:</span> i2c<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">4819</span>c000 {
                        compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,omap4-i2c</span><span style="color:#710">&quot;</span></span>;
                        <span style="color:#579">#address</span>-cells = &lt;<span style="color:#00D">1</span>&gt;;
                        <span style="color:#579">#size</span>-cells = &lt;<span style="color:#00D">0</span>&gt;;
                        ti,hwmods = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">i2c3</span><span style="color:#710">&quot;</span></span>;
                        reg = &lt;<span style="color:#02b">0x4819c000</span> <span style="color:#02b">0x1000</span>&gt;;
                        interrupts = &lt;<span style="color:#00D">30</span>&gt;;
                        status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">disabled</span><span style="color:#710">&quot;</span></span>;
                };
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The base address of the registers for <em>i2c0</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The status of the bus is disabled</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We take a look at the <em>am335x-bone-common.dtsi</em> file and search for the <em>i2c0</em>
bus. A node is defined but it is not complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
&amp;i2c0 {        <i class="conum" data-value="1"></i><b>(1)</b>
        pinctrl-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">default</span><span style="color:#710">&quot;</span></span>;
        pinctrl-<span style="color:#00D">0</span> = &lt;&amp;i2c0_pins&gt;;

        status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">okay</span><span style="color:#710">&quot;</span></span>;
        clock-frequency = &lt;<span style="color:#00D">400000</span>&gt;;

        <span style="color:#970;font-weight:bold">tps:</span> tps<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">24</span> {        <i class="conum" data-value="2"></i><b>(2)</b>
                reg = &lt;<span style="color:#02b">0x24</span>&gt;;
        };

};
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <em>i2c0</em> bus is defined in the <em>am335x-bone-common.dtsi</em> file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>There is one device defined as part of the <em>i2c0</em> bus i.e. <em>tps</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We locate the address of the <em>i2c1</em> bus i.e. 0x4802a000 in the processor
<a href="../docs/spruh73i.pdf" target="_blank">data sheet</a>. To search for
the address we have to search for the string as 4802_a000. It is located
in the Table 2-3. L4_PER Peripheral Memory Map.</p>
</div>
<div class="paragraph">
<p>We simply copy the <em>i2c0</em> node defined in the <em>am335x-bone-common.dtsi</em> file
and modify the <em>am335x-boneblack.dts</em> file to enable the <em>i2c1</em> bus.
The pinctrl- properties are left out for now and the frequency is set to 100KHz.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
/ {
        hdmi {
                compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ti,tilcdc,slave</span><span style="color:#710">&quot;</span></span>;
                i2c = &lt;&amp;i2c0&gt;;
                pinctrl-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">default</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">off</span><span style="color:#710">&quot;</span></span>;
                pinctrl-<span style="color:#00D">0</span> = &lt;&amp;nxp_hdmi_bonelt_pins&gt;;
                pinctrl-<span style="color:#00D">1</span> = &lt;&amp;nxp_hdmi_bonelt_off_pins&gt;;
                status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">okay</span><span style="color:#710">&quot;</span></span>;
        };
};

&amp;i2c1 {        <i class="conum" data-value="1"></i><b>(1)</b>
        status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">okay</span><span style="color:#710">&quot;</span></span>;
        clock-frequency = &lt;<span style="color:#00D">100000</span>&gt;;

};
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>i2c1</em> bus is defined</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="declaring-the-nunchuck-device"><a class="anchor" href="#declaring-the-nunchuck-device"></a>39.3.2. Declaring The Nunchuck Device</h4>
<div class="paragraph">
<p>If we go through the nunchuck <a href="../free_electrons_linux_kernel/nunchuck.pdf" target="_blank">pdf</a> we see that the I2C address
of the nunchuck is 0x52. We add this device to the <em>i2c1</em> bus in the device tree.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
&amp;i2c1 {
        status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">okay</span><span style="color:#710">&quot;</span></span>;
        clock-frequency = &lt;<span style="color:#00D">100000</span>&gt;;

        <span style="color:#970;font-weight:bold">nunchuck:</span> { <i class="conum" data-value="1"></i><b>(1)</b>
                compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nintendo,nunchuck</span><span style="color:#710">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
                reg = &lt;<span style="color:#02b">0x52</span>&gt; <i class="conum" data-value="3"></i><b>(3)</b>
        };

};
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>New nunchuck device added to <em>i2c1</em> bus</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The driver compatible with this device</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The address of the I2C device is 0x52</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After making the modifications we recompile the device tree blob and copy it
to <em>/var/lib/tftpboot/</em> in order to download it to the Beagle Bone Black board
during boot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ make dtbs
  DTC     arch/arm/boot/dts/am335x-boneblack.dtb
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ cp -a arch/arm/boot/dts/am335x-boneblack.dtb /var/lib/tftpboot/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the kernel and device tree blob is loaded on the board we can inspect
the <em>/proc/device-tree</em> folder to see if our changes are present</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># find /proc/device-tree/ -name &quot;*nunchuck*&quot;        <i class="conum" data-value="1"></i><b>(1)</b>
/proc/device-tree/ocp/i2c@4802a000/nunchuck@52
#
# ls /proc/device-tree/ocp/i2c@4802a000/nunchuck@52/
compatible  name        reg
# cat /proc/device-tree/ocp/i2c@4802a000/nunchuck@52/compatible
nintendo,nunchuck<i class="conum" data-value="2"></i><b>(2)</b>
#
#
# cat /proc/device-tree/ocp/i2c@4802a000/nunchuck@52/name
nunchuck<i class="conum" data-value="3"></i><b>(3)</b>
#
#
#
# cat /proc/device-tree/ocp/i2c@4802a000/nunchuck@52/reg
R <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Search for any file with <em>nunchuck</em> in its name</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Display the value of the <em>compatible</em> property</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Display the value of the <em>name</em> property</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Display the value of the <em>reg</em> property</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see the device tree blob we use the <em>dtc</em> utility.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># dtc -I fs /proc/device-tree/
/dts-v1/;

/ {
        model = &quot;TI AM335x BeagleBone&quot;;
        interrupt-parent = &lt;0x1&gt;;
        compatible = &quot;ti,am335x-bone&quot;, &quot;ti,am33xx&quot;;
        #size-cells = &lt;0x1&gt;;
        #address-cells = &lt;0x1&gt;;

        hdmi {
                status = &quot;okay&quot;;
                pinctrl-1 = &lt;0x18&gt;;
                pinctrl-0 = &lt;0x17&gt;;
                pinctrl-names = &quot;default&quot;, &quot;off&quot;;
                i2c = &lt;0x16&gt;;
                compatible = &quot;ti,tilcdc,slave&quot;;
        };

        fixedregulator@0 {
                phandle = &lt;0x9&gt;;
                linux,phandle = &lt;0x9&gt;;
                regulator-max-microvolt = &lt;0x325aa0&gt;;
                regulator-min-microvolt = &lt;0x325aa0&gt;;
                regulator-name = &quot;vmmcsd_fixed&quot;;
                compatible = &quot;regulator-fixed&quot;;
        };
.
.
.

                i2c@4802a000 { <i class="conum" data-value="1"></i><b>(1)</b>
                        clock-frequency = &lt;0x186a0&gt;;
                        status = &quot;okay&quot;;
                        interrupts = &lt;0x47&gt;;
                        reg = &lt;0x4802a000 0x1000&gt;;
                        ti,hwmods = &quot;i2c2&quot;;
                        #size-cells = &lt;0x0&gt;;
                        #address-cells = &lt;0x1&gt;;
                        compatible = &quot;ti,omap4-i2c&quot;;

                        nunchuck@52 { &lt;r21&gt;
                                reg = &lt;0x52&gt;;
                                compatible = &quot;nintendo,nunchuck&quot;;
                        };
                };
.
.
.
        aliases {
                ethernet1 = &quot;/ocp/ethernet@4a100000/slave@4a100300&quot;;
                ethernet0 = &quot;/ocp/ethernet@4a100000/slave@4a100200&quot;;
                phy1 = &quot;/ocp/usb@47400000/usb-phy@47401b00&quot;;
                phy0 = &quot;/ocp/usb@47400000/usb-phy@47401300&quot;;
                usb1 = &quot;/ocp/usb@47400000/usb@47401800&quot;;
                usb0 = &quot;/ocp/usb@47400000/usb@47401000&quot;;
                d_can1 = &quot;/ocp/d_can@481d0000&quot;;
                d_can0 = &quot;/ocp/d_can@481cc000&quot;;
                serial5 = &quot;/ocp/serial@481aa000&quot;;
                serial4 = &quot;/ocp/serial@481a8000&quot;;
                serial3 = &quot;/ocp/serial@481a6000&quot;;
                serial2 = &quot;/ocp/serial@48024000&quot;;
                serial1 = &quot;/ocp/serial@48022000&quot;;
                serial0 = &quot;/ocp/serial@44e09000&quot;;
                i2c2 = &quot;/ocp/i2c@4819c000&quot;;
                i2c1 = &quot;/ocp/i2c@4802a000&quot;;
                i2c0 = &quot;/ocp/i2c@44e0b000&quot;;
        };

        chosen {
                bootargs = &quot;root=/dev/nfs rw ip=192.168.0.100 console=ttyO0 nfsroot=192.168.0.1:/home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot&quot;;
        };
};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The I2C1 device</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The nunchuck devuce in the device tree blob</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="implement-a-basic-i2c-driver-for-the-nunchuck"><a class="anchor" href="#implement-a-basic-i2c-driver-for-the-nunchuck"></a>39.4. Implement A Basic I2C Driver For The Nunchuck</h3>
<div class="paragraph">
<p>We now take the basic <em>nunchuck.c</em> file present in the
~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk/_
directory and modify it to implement our basic I2C driver. The
file present in the Free Electrons lab data NFS root folder looks
like this before modification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/i2c.h&gt;</span>

<span style="color:#777">/* Add your code here */</span>

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>We make the following changes to the driver code:
. Instantiate an object of type <em>struct i2c_device_id</em>
. Instantiate an object of type <em>struct of_device_id</em>
. Define the probe and remove functions
. Instantiate an object of type <em>struct i2c_driver</em>
. Instantiate the I2C driver using <em>module_i2c_driver</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/i2c.h&gt;</span>

<span style="color:#777">/* Add your code here */</span>
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> i2c_device_id nunchuck_id[] = {        <i class="conum" data-value="1"></i><b>(1)</b>
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nunchuck</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">0</span> },
        { }
};
MODULE_DEVICE_TABLE(i2c, nunchuck_id);

<span style="color:#579">#ifdef</span> CONFIG_OF
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> of_device_id nunchuck_dt_ids[] = {        <i class="conum" data-value="2"></i><b>(2)</b>
        {.compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nintendo,nunchuck</span><span style="color:#710">&quot;</span></span>,},
        { }
};
MODULE_DEVICE_TABLE(of, nunchuck_dt_ids);
<span style="color:#579">#endif</span>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> nunchuck_probe(<span style="color:#080;font-weight:bold">struct</span> i2c_client *client,
                        <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> i2c_device_id *id)        <i class="conum" data-value="3"></i><b>(3)</b>
{
        <span style="color:#777">/* initialize device */</span>
        <span style="color:#777">/* register to a kernel framework */</span>

        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> nunchuck_remove(<span style="color:#080;font-weight:bold">struct</span> i2c_client *client)        <i class="conum" data-value="4"></i><b>(4)</b>
{
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> i2c_driver nunchuck_driver = {        <i class="conum" data-value="5"></i><b>(5)</b>
        .probe = nunchuck_probe,
        .remove = nunchuck_remove,
        .id_table = nunchuck_id,
        .driver = {
                .name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nunchuck</span><span style="color:#710">&quot;</span></span>,
                .owner = THIS_MODULE,
                .of_match_table = of_match_ptr(nunchuck_dt_ids),
        },
};

module_i2c_driver(nunchuck_driver);        <i class="conum" data-value="6"></i><b>(6)</b>

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Instantiate an object of type <em>struct i2c_device_id</em> nunchuck_id</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Instantiate an object of type <em>struct of_device_id</em> nunchuck_dt_ids</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The probe function</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The remove function</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Instantiate an object of type <em>struct i2c_driver</em></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Instantiate the I2C driver using <em>module_i2c_driver</em></td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="compiling-the-em-nunchuck-em-driver"><a class="anchor" href="#compiling-the-em-nunchuck-em-driver"></a>39.4.1. Compiling The <em>nunchuck</em> Driver</h4>
<div class="paragraph">
<p>We&#8217;ve gone through the compilation of a kernel module in the previous lab session.
So passing the <em>ARCH</em>, <em>CROSS_COMPILE</em> and <em>KDIR</em> we are able to build the kernel
module driver <em>nunchuck.ko</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- KDIR=/home/conrad/Git/linux/
make -C /home/conrad/Git/linux/ M=$PWD
make[1]: Entering directory `/home/conrad/Git/linux'
  CC [M]  /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk/nunchuk.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk/nunchuk.mod.o
  LD [M]  /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk/nunchuk.ko
make[1]: Leaving directory `/home/conrad/Git/linux'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="testing-the-em-nunchuck-em-driver"><a class="anchor" href="#testing-the-em-nunchuck-em-driver"></a>39.4.2. Testing The <em>nunchuck</em> Driver</h4>
<div class="paragraph">
<p>So now that we have our kernel driver <em>nunchuck.ko</em> we can easily load it on
the board as we&#8217;re using a <em>NFS</em> root filesystem.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># cd /root/nunchuk/        <i class="conum" data-value="1"></i><b>(1)</b>
# ls
Makefile        built-in.o      modules.order   nunchuk.ko      nunchuk.mod.o
Module.symvers  dtc.txt         nunchuk.c       nunchuk.mod.c   nunchuk.o
# insmod nunchuk.ko         <i class="conum" data-value="2"></i><b>(2)</b>
#
#
#
# lsmod        <i class="conum" data-value="3"></i><b>(3)</b>
Module                  Size  Used by    Tainted: G
nunchuk                 1569  0
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Change the directory to <em>/root/nunchuck/</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Insert the <em>nunchuck.ko</em> kernel module driver</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>List the loaded kernel modules</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We explore the <em>sysfs</em> and see what files get created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># find /sys/ -name '*nunchuck*'        <i class="conum" data-value="1"></i><b>(1)</b>
/sys/bus/i2c/drivers/nunchuck
/sys/module/nunchuk/drivers/i2c:nunchuck
#
# ls -l /sys/bus/i2c/drivers/nunchuck/        <i class="conum" data-value="2"></i><b>(2)</b>
total 0
lrwxrwxrwx    1 root     root             0 Jan  1 00:05 1-0052 -&gt; ../../../../devices/ocp.3/4802a000.i2c/i2c-1/1-0052
--w-------    1 root     root          4096 Jan  1 00:05 bind
lrwxrwxrwx    1 root     root             0 Jan  1 00:05 module -&gt; ../../../../module/nunchuk
--w-------    1 root     root          4096 Jan  1 00:05 uevent
--w-------    1 root     root          4096 Jan  1 00:05 unbind
# cat /sys/bus/i2c/drivers/nunchuck/1-0052/name <i class="conum" data-value="3"></i><b>(3)</b>
nunchuck
# ls -l /sys/module/nunchuk/drivers/i2c\:nunchuck/ <i class="conum" data-value="4"></i><b>(4)</b>
total 0
lrwxrwxrwx    1 root     root             0 Jan  1 00:05 1-0052 -&gt; ../../../../devices/ocp.3/4802a000.i2c/i2c-1/1-0052
--w-------    1 root     root          4096 Jan  1 00:05 bind
lrwxrwxrwx    1 root     root             0 Jan  1 00:05 module -&gt; ../../../../module/nunchuk
--w-------    1 root     root          4096 Jan  1 00:05 uevent
--w-------    1 root     root          4096 Jan  1 00:05 unbind
# cat /sys/module/nunchuk/drivers/i2c:nunchuck/1-0052/name <i class="conum" data-value="5"></i><b>(5)</b>
nunchuck
# cat /sys/module/nunchuk/drivers/i2c:nunchuck/1-0052/modalias <i class="conum" data-value="6"></i><b>(6)</b>
i2c:nunchuck</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Search for files with name <em>nunchuck</em> in <em>sysfs</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>List contents of <em>/sys/bus/i2c/drivers/nunchuck/</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Display contents in <em>/sys/bus/i2c/drivers/nunchuck/1-0052/name</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>List contents of <em>/sys/module/nunchuk/drivers/i2c:nunchuck/</em></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Display contents in <em>/sys/module/nunchuk/drivers/i2c:nunchuck/1-0052/name</em></td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Display contents in <em>/sys/module/nunchuk/drivers/i2c:nunchuck/1-0052/modalias</em></td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="communicating-with-the-i2c-device"><a class="anchor" href="#communicating-with-the-i2c-device"></a>40. Communicating With The I2C Device</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are several ways present through which we can communicate with
the I2C device. We&#8217;ll go through each of the methods available.</p>
</div>
<div class="sect2">
<h3 id="raw-api"><a class="anchor" href="#raw-api"></a>40.1. Raw API</h3>
<div class="paragraph">
<p>We have the basic API available which allow us
to either send or receive data from the I2C device. These are defined
in the <em>drivers/i2c/i2c-core.c</em>. The APIs are <em>i2c_master_send</em> to send
data to the client and <em>i2c_master_recv</em> to receive data from the client.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#777">/**
 * i2c_master_send - issue a single I2C message in master transmit mode
 * @client: Handle to slave device
 * @buf: Data that will be written to the slave
 * @count: How many bytes to write, must be less than 64k since msg.len is u16
 *
 * Returns negative errno, or else the number of bytes written.
 */</span>
<span style="color:#0a8;font-weight:bold">int</span> i2c_master_send(<span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> i2c_client *client, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *buf, <span style="color:#0a8;font-weight:bold">int</span> count) <i class="conum" data-value="1"></i><b>(1)</b>
{
        <span style="color:#0a8;font-weight:bold">int</span> ret;
        <span style="color:#080;font-weight:bold">struct</span> i2c_adapter *adap = client-&gt;adapter;
        <span style="color:#080;font-weight:bold">struct</span> i2c_msg msg;

        msg.addr = client-&gt;addr;
        msg.flags = client-&gt;flags &amp; I2C_M_TEN;
        msg.len = count;
        msg.buf = (<span style="color:#0a8;font-weight:bold">char</span> *)buf;

        ret = i2c_transfer(adap, &amp;msg, <span style="color:#00D">1</span>);

        <span style="color:#777">/*
         * If everything went ok (i.e. 1 msg transmitted), return #bytes
         * transmitted, else error code.
         */</span>
        <span style="color:#080;font-weight:bold">return</span> (ret == <span style="color:#00D">1</span>) ? count : ret;
}
EXPORT_SYMBOL(i2c_master_send);

<span style="color:#777">/**
 * i2c_master_recv - issue a single I2C message in master receive mode
 * @client: Handle to slave device
 * @buf: Where to store data read from slave
 * @count: How many bytes to read, must be less than 64k since msg.len is u16
 *
 * Returns negative errno, or else the number of bytes read.
 */</span>
<span style="color:#0a8;font-weight:bold">int</span> i2c_master_recv(<span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> i2c_client *client, <span style="color:#0a8;font-weight:bold">char</span> *buf, <span style="color:#0a8;font-weight:bold">int</span> count) <i class="conum" data-value="2"></i><b>(2)</b>
{
        <span style="color:#080;font-weight:bold">struct</span> i2c_adapter *adap = client-&gt;adapter;
        <span style="color:#080;font-weight:bold">struct</span> i2c_msg msg;
        <span style="color:#0a8;font-weight:bold">int</span> ret;

        msg.addr = client-&gt;addr;
        msg.flags = client-&gt;flags &amp; I2C_M_TEN;
        msg.flags |= I2C_M_RD;
        msg.len = count;
        msg.buf = buf;

        ret = i2c_transfer(adap, &amp;msg, <span style="color:#00D">1</span>);

        <span style="color:#777">/*
         * If everything went ok (i.e. 1 msg received), return #bytes received,
         * else error code.
         */</span>
        <span style="color:#080;font-weight:bold">return</span> (ret == <span style="color:#00D">1</span>) ? count : ret;
}
EXPORT_SYMBOL(i2c_master_recv);
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Sends the content of <em>buf</em> and of size <em>count</em> to the <em>client</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Receives <em>count</em> bytes in <em>buf</em> from the <em>client</em></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="message-transfer-api"><a class="anchor" href="#message-transfer-api"></a>40.2. Message Transfer API</h3>
<div class="paragraph">
<p>The raw api make use of another API which is used to describe a transfer
of several messages. A collection of messages can be sent at one time
using the <em>i2c_transfer</em> API which is also defined in the <em>drivers/i2c/i2c-core.c</em>
file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#777">/**
 * i2c_transfer - execute a single or combined I2C message
 * @adap: Handle to I2C bus
 * @msgs: One or more messages to execute before STOP is issued to
 *      terminate the operation; each message begins with a START.
 * @num: Number of messages to be executed.
 *
 * Returns negative errno, else the number of messages executed.
 *
 * Note that there is no requirement that each message be sent to
 * the same slave address, although that is the most common model.
 */</span>
<span style="color:#0a8;font-weight:bold">int</span> i2c_transfer(<span style="color:#080;font-weight:bold">struct</span> i2c_adapter *adap, <span style="color:#080;font-weight:bold">struct</span> i2c_msg *msgs, <span style="color:#0a8;font-weight:bold">int</span> num)
{
.
.
.
}
EXPORT_SYMBOL(i2c_transfer);
.
.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="smbus-calls"><a class="anchor" href="#smbus-calls"></a>40.3. SMBus Calls</h3>
<div class="paragraph">
<p>The SMBus is a subset of the I2C protocol. SMBus defines a standard set
of transactions for example to read or write a register of a device. If
possible the SMBus API should be used instead of the raw API to simplify
the implementation with standard transaction APIs. One such API is
<em>i2c_smbus_read_byte_data()</em> function which allows a read of one byte
of data from a device register.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The following sequence of operations are carried out:
_S Addr Wr [A] Comm [A] S Addr Rd [A] [Data] NA P)</p>
</li>
<li>
<p>The above sequence means write one byte data command i.e. <em>Comm</em>
and then read back the data i.e. <em>[Data]</em></p>
</li>
<li>
<p>Further details are elaborated in <em>Documentation/i2c/smbus-protocol</em></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="list-of-smbus-api"><a class="anchor" href="#list-of-smbus-api"></a>40.3.1. List Of SMBus API</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read/write one byte</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>s32 i2c_smbus_read_byte(const struct i2c_client *client);</p>
</li>
<li>
<p>s32 i2c_smbus_write_byte(const struct i2c_client *client, u8 value);</p>
</li>
</ol>
</div>
</li>
<li>
<p>Write a command byte, and read or write one byte</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>s32 i2c_smbus_read_byte_data(const struct i2c_client *client, u8 command);</p>
</li>
<li>
<p>s32 i2c_smbus_write_byte_data(const struct i2c_client *client, u8 command, u8
value);</p>
</li>
</ol>
</div>
</li>
<li>
<p>Write a command byte, and read or write one word</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>s32 i2c_smbus_read_word_data(const struct i2c_client *client, u8 command);</p>
</li>
<li>
<p>s32 i2c_smbus_write_word_data(const struct i2c_client *client, u8 command, u16
value);</p>
</li>
</ol>
</div>
</li>
<li>
<p>Write a command byte, and read or write a block of data
(max 32 bytes)</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>s32 i2c_smbus_read_block_data(const struct i2c_client *client, u8 command, u8
*values);</p>
</li>
<li>
<p>s32 i2c_smbus_write_block_data(const struct i2c_client *client, u8 command, u8
length, const u8 *values);</p>
</li>
</ol>
</div>
</li>
<li>
<p>Write a command byte, and read or write a block of data (no
limit)</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>s32 i2c_smbus_read_i2c_block_data(const struct i2c_client *client, u8 command, u8
length, u8 *values);</p>
</li>
<li>
<p>s32 i2c_smbus_write_i2c_block_data(const struct i2c_client *client, u8 command, u8
length, const u8 *values);</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect2">
<h3 id="i2c-functionality"><a class="anchor" href="#i2c-functionality"></a>40.4. I2C Functionality</h3>
<div class="paragraph">
<p>I2C controllers may not support all functionalities. A device driver
must check to see which functionalities are supported by the controller. The
controller tells the core which functionalities it supports. The API
<em>i2c_check_functionality()</em> is to be used to find out the functionalities.
For example <em>I2C_FUNC_I2C</em> is required in order to use the raw API functions
discussed above whereas <em>I2C_FUNC_SMBUS_BYTE_DATA</em> is required for SMBus commands.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Additional details can be seen in <em>include/uapi/linux/i2c.h</em></p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
.
<span style="color:#579">#define</span> I2C_FUNC_I2C                    <span style="color:#02b">0x00000001</span>
<span style="color:#579">#define</span> I2C_FUNC_10BIT_ADDR             <span style="color:#02b">0x00000002</span>
<span style="color:#579">#define</span> I2C_FUNC_PROTOCOL_MANGLING      <span style="color:#02b">0x00000004</span> <span style="color:#777">/* I2C_M_IGNORE_NAK etc. */</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_PEC              <span style="color:#02b">0x00000008</span>
<span style="color:#579">#define</span> I2C_FUNC_NOSTART                <span style="color:#02b">0x00000010</span> <span style="color:#777">/* I2C_M_NOSTART */</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_BLOCK_PROC_CALL  <span style="color:#02b">0x00008000</span> <span style="color:#777">/* SMBus 2.0 */</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_QUICK            <span style="color:#02b">0x00010000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_READ_BYTE        <span style="color:#02b">0x00020000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_WRITE_BYTE       <span style="color:#02b">0x00040000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_READ_BYTE_DATA   <span style="color:#02b">0x00080000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_WRITE_BYTE_DATA  <span style="color:#02b">0x00100000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_READ_WORD_DATA   <span style="color:#02b">0x00200000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_WRITE_WORD_DATA  <span style="color:#02b">0x00400000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_PROC_CALL        <span style="color:#02b">0x00800000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_READ_BLOCK_DATA  <span style="color:#02b">0x01000000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_WRITE_BLOCK_DATA <span style="color:#02b">0x02000000</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_READ_I2C_BLOCK   <span style="color:#02b">0x04000000</span> <span style="color:#777">/* I2C-like block xfer  */</span>
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_WRITE_I2C_BLOCK  <span style="color:#02b">0x08000000</span> <span style="color:#777">/* w/ 1-byte reg. addr. */</span>

<span style="color:#579">#define</span> I2C_FUNC_SMBUS_BYTE             (I2C_FUNC_SMBUS_READ_BYTE | \
                                         I2C_FUNC_SMBUS_WRITE_BYTE)
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_BYTE_DATA        (I2C_FUNC_SMBUS_READ_BYTE_DATA | \
                                         I2C_FUNC_SMBUS_WRITE_BYTE_DATA)
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_WORD_DATA        (I2C_FUNC_SMBUS_READ_WORD_DATA | \
                                         I2C_FUNC_SMBUS_WRITE_WORD_DATA)
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_BLOCK_DATA       (I2C_FUNC_SMBUS_READ_BLOCK_DATA | \
                                         I2C_FUNC_SMBUS_WRITE_BLOCK_DATA)
<span style="color:#579">#define</span> I2C_FUNC_SMBUS_I2C_BLOCK        (I2C_FUNC_SMBUS_READ_I2C_BLOCK | \
                                         I2C_FUNC_SMBUS_WRITE_I2C_BLOCK)

<span style="color:#579">#define</span> I2C_FUNC_SMBUS_EMUL             (I2C_FUNC_SMBUS_QUICK | \
                                         I2C_FUNC_SMBUS_BYTE | \
                                         I2C_FUNC_SMBUS_BYTE_DATA | \
                                         I2C_FUNC_SMBUS_WORD_DATA | \
                                         I2C_FUNC_SMBUS_PROC_CALL | \
                                         I2C_FUNC_SMBUS_WRITE_BLOCK_DATA | \
                                         I2C_FUNC_SMBUS_I2C_BLOCK | \
                                         I2C_FUNC_SMBUS_PEC)
.
.
.</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pin-muxing"><a class="anchor" href="#pin-muxing"></a>41. Pin Muxing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Modern SOCs include a large number of hardware blocks but only a certain
combination of blocks can be enabled at any point in time as there are
a limited number of pins present on the SOC. In order to fascilitate the
access of hardware blocks on the SOC there needs to be some sort of
mechanism by which the system designer can select which blocks have to be
activated for the application. This is done through a software mechanism
known as <em>pin muxing</em>.</p>
</div>
<div class="paragraph">
<p>Since version 3.2 of the Linux kernel there has been a new subsystem
called <em>pinctrl</em> which is added to handle the pinmuxing. This is
present in the <em>drivers/pinctrl</em> section of the source code. This subsystem
provides:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A pin muxing consumer interface for device drivers</p>
</li>
<li>
<p>A pin muxing driver interface to implement the system on chip specific drivers
that configure the muxing.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Most <em>pinctrl</em> drivers provide a Device Tree binding which must be described
in the Device Tree. The binding will differ from driver to driver but it
should be documented in <em>Documentation/devicetree/bindings/pinctrl</em>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="pinctrl-subsystem-diagram" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/pinctrl-subsystem-diagram.png"><img src="http://zeuzoix.github.io/techeuphoria/images/pinctrl-subsystem-diagram.png" alt="pinctrl subsystem diagram" width="640" height="480"></a>
</div>
<div class="title">Pinctrl Subsystem Diagram</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="device-tree-binding-for-consumer-devices"><a class="anchor" href="#device-tree-binding-for-consumer-devices"></a>41.1. Device Tree Binding For Consumer Devices</h3>
<div class="paragraph">
<p>The devices that require certains pins to be muxed will use the <em>pinctrl-&lt;x&gt;</em> and
<em>pinctrl-names</em> Device Tree properties. The <em>pinctrl-0</em>, <em>pinctrl-1</em>, pinctrl-&lt;x&gt;_
properties link to a pin configuration for a given state of the device.</p>
</div>
<div class="sect3">
<h4 id="pinctrl-client-devices"><a class="anchor" href="#pinctrl-client-devices"></a>41.1.1. Pinctrl Client Devices</h4>
<div class="paragraph">
<p>Out of the following only the first is required whereas the remaining are optional:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">pinctrl-0</dt>
<dd>
<p>List of phandles, each pointing at a pin configuration
node. These referenced pin configuration nodes must be child
nodes of the pin controller that they configure. Multiple
entries may exist in this list so that multiple pin
controllers may be configured, or so that a state may be built
from multiple nodes for a single pin controller, each
contributing part of the overall configuration. See the next
section of this document for details of the format of these
pin configuration nodes.</p>
</dd>
<dt class="hdlist1">pinctrl-1</dt>
<dd>
<p>List of phandles, each pointing at a pin configuration
node within a pin controller.</p>
</dd>
<dt class="hdlist1">pinctrl-n</dt>
<dd>
<p>List of phandles, each pointing at a pin configuration
node within a pin controller.</p>
</dd>
<dt class="hdlist1">pinctrl-names</dt>
<dd>
<p>The list of names to assign states. List entry 0 defines the
name for integer state ID 0, list entry 1 for state ID 1, and
so on.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Taking the example given in <em>Documentation/devicetree/bindings/pinctrl/pinctrl-bindings.txt</em>
under the section "Pinctrl client devices".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">        <span style="color:#777">/* For a client device requiring named states */</span>
        device {
                pinctrl-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">active</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">idle</span><span style="color:#710">&quot;</span></span>;
                pinctrl-<span style="color:#00D">0</span> = &lt;&amp;state_0_node_a&gt;;
                pinctrl-<span style="color:#00D">1</span> = &lt;&amp;state_1_node_a &amp;state_1_node_b&gt;;
        };

        <span style="color:#777">/* For the same device if using state IDs */</span>
        device {
                pinctrl-<span style="color:#00D">0</span> = &lt;&amp;state_0_node_a&gt;;
                pinctrl-<span style="color:#00D">1</span> = &lt;&amp;state_1_node_a &amp;state_1_node_b&gt;;
        };

        <span style="color:#777">/*
         * For an IP block whose binding supports pin configuration,
         * but in use on an SoC that doesn't have any pin control hardware
         */</span>
        device {
                pinctrl-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">active</span><span style="color:#710">&quot;</span></span>, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">idle</span><span style="color:#710">&quot;</span></span>;
                pinctrl-<span style="color:#00D">0</span> = &lt;&gt;;
                pinctrl-<span style="color:#00D">1</span> = &lt;&gt;;
        };</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="pin-controller-devices"><a class="anchor" href="#pin-controller-devices"></a>41.1.2. Pin Controller Devices</h4>
<div class="paragraph">
<p>Pin controller devices should contain the pin configuration nodes that client
devices reference.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">For example:

        pincontroller {
                ... <span style="color:#777">/* Standard DT properties for the device itself elided */</span>

                state_0_node_a {
                        ...
                };
                state_1_node_a {
                        ...
                };
                state_1_node_b {
                        ...
                };
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The contents of each of those pin configuration child nodes is defined
entirely by the binding for the individual pin controller device. There
exists no common standard for this content.</p>
</div>
<div class="paragraph">
<p>The pin configuration nodes need not be direct children of the pin controller
device; they may be grandchildren, for example. Whether this is legal, and
whether there is any interaction between the child and intermediate parent
nodes, is again defined entirely by the binding for the individual pin
controller device.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="example-on-omap-am33xx"><a class="anchor" href="#example-on-omap-am33xx"></a>41.2. Example On OMAP / AM33xx</h3>
<div class="paragraph">
<p>The base <em>dtsi</em> file for our Beagle Bone Black is in the <em>arch/arm/boot/dts/am33xx.dtsi</em>
file. If we look at <em>pinctrl</em> device we see that it is compatible with the <em>pinctrl-single</em>
driver. This is common between related SOCs and allows to configure pins by
writing a value to a register.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
        am33xx_pinmux: pinmux<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">4</span><span style="color:#60E">4</span>e10800 {
                compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pinctrl-single</span><span style="color:#710">&quot;</span></span>;         <i class="conum" data-value="1"></i><b>(1)</b>
                reg = &lt;<span style="color:#02b">0x44e10800</span> <span style="color:#02b">0x0238</span>&gt;;
                <span style="color:#579">#address</span>-cells = &lt;<span style="color:#00D">1</span>&gt;;
                <span style="color:#579">#size</span>-cells = &lt;<span style="color:#00D">0</span>&gt;;
                pinctrl-single,<span style="color:#088;font-weight:bold">register</span>-width = &lt;<span style="color:#00D">32</span>&gt;;
                pinctrl-single,function-mask = &lt;<span style="color:#02b">0x7f</span>&gt;;
        };
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The compatible <em>pinctrl-single</em> driver</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The base <em>dtsi</em> doesn&#8217;t mention any <em>pinctrl</em> configurations. We can find these <em>pinctrl configurations</em>
defined as child nodes of the main <em>pinctrl</em> device in the board specific <em>dts</em> file. If we search
for board files that include the base <em>dtsi</em> file we get the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ egrep -ri &quot;am33xx.dtsi&quot; arch/arm/boot/dts/*
arch/arm/boot/dts/am335x-boneblack.dts:#include &quot;am33xx.dtsi&quot;
arch/arm/boot/dts/am335x-bone.dts:#include &quot;am33xx.dtsi&quot;
arch/arm/boot/dts/am335x-evm.dts:#include &quot;am33xx.dtsi&quot;
arch/arm/boot/dts/am335x-evmsk.dts:#include &quot;am33xx.dtsi&quot;
arch/arm/boot/dts/am335x-igep0033.dtsi:#include &quot;am33xx.dtsi&quot;
arch/arm/boot/dts/am335x-nano.dts:#include &quot;am33xx.dtsi&quot;
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Opening <em>arch/arm/boot/dts/am335x-evmsk.dts</em> we see several configurations defined:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">&amp;am33xx_pinmux {
        pinctrl-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">default</span><span style="color:#710">&quot;</span></span>;
        pinctrl-<span style="color:#00D">0</span> = &lt;&amp;gpio_keys_s0 &amp;clkout2_pin&gt;;

        <span style="color:#970;font-weight:bold">user_leds_s0:</span> user_leds_s0 {
                pinctrl-single,pins = &lt;
                        <span style="color:#02b">0x10</span> (PIN_OUTPUT_PULLDOWN | MUX_MODE7)  <span style="color:#777">/* gpmc_ad4.gpio1_4 */</span>
                        <span style="color:#02b">0x14</span> (PIN_OUTPUT_PULLDOWN | MUX_MODE7)  <span style="color:#777">/* gpmc_ad5.gpio1_5 */</span>
                        <span style="color:#02b">0x18</span> (PIN_OUTPUT_PULLDOWN | MUX_MODE7)  <span style="color:#777">/* gpmc_ad6.gpio1_6 */</span>
                        <span style="color:#02b">0x1c</span> (PIN_OUTPUT_PULLDOWN | MUX_MODE7)  <span style="color:#777">/* gpmc_ad7.gpio1_7 */</span>
                &gt;;
        };

        <span style="color:#970;font-weight:bold">gpio_keys_s0:</span> gpio_keys_s0 {
                pinctrl-single,pins = &lt;
                        <span style="color:#02b">0x94</span> (PIN_INPUT_PULLDOWN | MUX_MODE7)   <span style="color:#777">/* gpmc_oen_ren.gpio2_3 */</span>
                        <span style="color:#02b">0x90</span> (PIN_INPUT_PULLDOWN | MUX_MODE7)   <span style="color:#777">/* gpmc_advn_ale.gpio2_2 */</span>
                        <span style="color:#02b">0x70</span> (PIN_INPUT_PULLDOWN | MUX_MODE7)   <span style="color:#777">/* gpmc_wait0.gpio0_30 */</span>
                        <span style="color:#02b">0x9c</span> (PIN_INPUT_PULLDOWN | MUX_MODE7)   <span style="color:#777">/* gpmc_ben0_cle.gpio2_5 */</span>
                &gt;;
        };

        <span style="color:#970;font-weight:bold">i2c0_pins:</span> pinmux_i2c0_pins { <i class="conum" data-value="1"></i><b>(1)</b>
                pinctrl-single,pins = &lt;
                        <span style="color:#02b">0x188</span> (PIN_INPUT_PULLUP | MUX_MODE0)    <span style="color:#777">/* i2c0_sda.i2c0_sda */</span>
                        <span style="color:#02b">0x18c</span> (PIN_INPUT_PULLUP | MUX_MODE0)    <span style="color:#777">/* i2c0_scl.i2c0_scl */</span>
                &gt;;
        };
.
.
.
};

.
.
.
&amp;i2c0 {
        pinctrl-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">default</span><span style="color:#710">&quot;</span></span>;
        pinctrl-<span style="color:#00D">0</span> = &lt;&amp;i2c0_pins&gt;; <i class="conum" data-value="2"></i><b>(2)</b>
.
.

};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>i2c0_pins</em> defined pinctrl configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>pinctrl-0 references <em>i2c0_pins</em></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lab-6-communicating-with-the-nunchuck"><a class="anchor" href="#lab-6-communicating-with-the-nunchuck"></a>42. LAB 6 : Communicating With The Nunchuck</h2>
<div class="sectionbody">
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">This is a hands on session taken from the Free Electrons labs with the following objectives</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Hooking up the nunchuck to the board.</p>
</li>
<li>
<p>Configuring the pinmuxing for the I2C bus used.</p>
</li>
<li>
<p>Validate I2C communication works with user space tools.</p>
</li>
<li>
<p>Extend the I2C driver from the previous lab to communicate with the Nunchuck.</p>
</li>
</ol>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="connecting-the-nunchuck"><a class="anchor" href="#connecting-the-nunchuck"></a>42.1. Connecting The Nunchuck</h3>
<div class="paragraph">
<p>We will now hook up the nunchuck to the Beagle Bone Black board. The diagram below
gives the names of the different pins on the connector.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="nunchuck-connector-pins" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/nunchuck-connector-pins.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/nunchuck-connector-pins.jpg" alt="nunchuck connector pins" width="640" height="480"></a>
</div>
<div class="title">The Nunchuck Connector Pins</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now we open up the <a href="../docs/BBB_SRM.pdf" target="_blank">BBB system reference manual</a> and
search for "connector P9". Under this section we see the "Expansion Header P9 Pinout"
table which describes the signals for the different peripherals on the SOC. So we
need to make sure our connections from the Nunchuck are:
. The GND pin to P9 pins 1 or 2 (GND)
. The PWR pin to P9 pins 3 or 4 (DC_3.3V)
. The CLK pin to P9 pin 17 (I2C1_SCL)
. The DATA pin to P9 pin 18 (I2C1_SDA)</p>
</div>
<div class="paragraph">
<p>On hooking up the breakout board we need to understand which pins correspond to
which signals. The + &amp; - signs correspond to VCC(3.3V) and GND. The P &amp; C
correspond to SDA and SCL of I2C. We make the connections on the P9 connector
using a breadboard and some wiring. Our hooked up connection is shown below.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="nunchuck-bbb-hook-up" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/nunchuck-bbb-hook-up.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/nunchuck-bbb-hook-up.jpg" alt="nunchuck bbb hook up" width="640" height="480"></a>
</div>
<div class="title">The Hook Up Of The Nunchuck To The BBB</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-pin-muxing-configuration-for-i2c1"><a class="anchor" href="#configuring-pin-muxing-configuration-for-i2c1"></a>42.2. Configuring Pin Muxing Configuration For I2C1</h3>
<div class="paragraph">
<p>Configuring the pin mux settings for our I2C1 bus on the SOC
is going to involve going through several documents. If we go through the
"Expansion Header P9 Pinout" table in the
<a href="../docs/BBB_SRM.pdf" target="_blank">BBB system reference manual</a> we can also
see the pins of the AM335 SOC
associated with the signals <em>I2C1_SCL</em> and <em>I2C1_SDA</em> which happen to be
A16 and B16 respectively. We also see the different "MODES" that these
pins can be muxed as and for I2C1 we need them to be in <em>MODE2</em>.</p>
</div>
<div class="paragraph">
<p>Our next step is to inspect the CPU <a href="../docs/am3359.pdf" target="_blank">datasheet</a>.
We go through the Pin Assignment section. You will find that the processor is
available through two types of packages: ZCE and ZCZ. Our CPU has ZCZ written
on its lower right corner. In the ZCZ pin assignment section we can see
hyperlinks associated with each pin of the SOC. If we click on the A16 pin which
is named as <em>SPI_CS0</em> we see that to set it as <em>I2C1_SCL</em> we need to use <em>MODE2</em>.
The pin is named as <em>SPI_CS0</em> because that is the function of the pin in MODE0.
We also see that B16 is named <em>SPI0_D1</em> because of its association in <em>MODE0</em>
and to get it to <em>I2C1_SDA</em> we need to set it to <em>MODE2</em>. The default names
of the pins will be useful going forward.</p>
</div>
<div class="paragraph">
<p>Finally we need to change the pin mux settings somehow. We open the
<a href="../docs/spruh73i.pdf" target="_blank">AM3358 technical reference document</a>
and look for registers that can help us do this. Specifically look for the
"Control Module" section.</p>
</div>
<div class="paragraph">
<p>The control module includes status and control logic not addressed within the
peripherals or the rest of the device infrastructure. This module provides
interface to control the following areas of the device:
. Functional I/O multiplexing
. Emulation controls
. Device control and status
. DDR PHY control and IO control registers
. EDMA event multiplexing control registers</p>
</div>
<div class="paragraph">
<p>We search for the "Control Module Registers" and find its address in the <em>L4 WKUP Peripheral Memory Map</em>
table with start address 0x44E1_0000 and end address 0x44E1_1FFF. If we click on the Control Module
hyperlink in the <em>L4 WKUP Peripheral Memory Map</em> table we can see the offsets of the registers
controlling the <em>SPI0_CS0</em> and <em>SPI0_D1</em> pins as <em>conf_spi0_d1</em> (0x958) and <em>conf_spi0_cs0</em> (0x95C).
Clicking on the hyperlinks associated with the offsets takes us to the register descriptions.</p>
</div>
</div>
<div class="sect2">
<h3 id="add-em-pinctrl-em-properties-to-the-device-tree"><a class="anchor" href="#add-em-pinctrl-em-properties-to-the-device-tree"></a>42.3. Add <em>pinctrl</em> Properties To The Device Tree</h3>
<div class="paragraph">
<p>Armed with the knowledge of register settings we shall try to add the pinctrl configuration
for the I2C1 bus on the SOC. We can refer to another platforms file to get a sense
of how to use the register. For this we take a look at the <em>arch/arm/boot/dts/am335x-evm.dts</em>
file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.

        i2c1_pins: pinmux_i2c1_pins {
                pinctrl-single,pins = &lt;
                        <span style="color:#02b">0x158</span> (PIN_INPUT_PULLUP | MUX_MODE2)    <span style="color:#777">/* spi0_d1.i2c1_sda */</span>        <i class="conum" data-value="1"></i><b>(1)</b>
                        <span style="color:#02b">0x15c</span> (PIN_INPUT_PULLUP | MUX_MODE2)    <span style="color:#777">/* spi0_cs0.i2c1_scl */</span>        <i class="conum" data-value="2"></i><b>(2)</b>
                &gt;;
        };

.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configuring the <em>conf_spi0_d1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configuring the <em>conf_spi0_cs0</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have 0x158 instead of 0x958 and 0x15C instead of 0x95C. The difference
is because of the offset present in the way the base address for the control module register
is defined in the base <em>dtsi</em> file. Let&#8217;s take a look:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
        am33xx_pinmux: pinmux<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">4</span><span style="color:#60E">4</span>e10800 {
                compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">pinctrl-single</span><span style="color:#710">&quot;</span></span>;
                reg = &lt;<span style="color:#02b">0x44e10800</span> <span style="color:#02b">0x0238</span>&gt;; <i class="conum" data-value="1"></i><b>(1)</b>
                <span style="color:#579">#address</span>-cells = &lt;<span style="color:#00D">1</span>&gt;;
                <span style="color:#579">#size</span>-cells = &lt;<span style="color:#00D">0</span>&gt;;
                pinctrl-single,<span style="color:#088;font-weight:bold">register</span>-width = &lt;<span style="color:#00D">32</span>&gt;;
                pinctrl-single,function-mask = &lt;<span style="color:#02b">0x7f</span>&gt;;
        };
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The base address is set as 0x44e10800 instead of 0x44e10000</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The base address is set to 0x44e10800 because the registers below
the 0x800 offset are not related to the pinctrl functionality.
Therefore, starting at offset 0x800 is probably a way to make
sure that using the pinctrl-single driver, users can only access
real pin muxing registers and do not mess with lower registers by mistake.</p>
</div>
<div class="paragraph">
<p>The values of the configuration registers are set to:
. <em>MUX_MODE2</em> corresponding to muxing mode 2, as explained in the datasheet
. <em>PIN_INPUT_PULLUP</em> puts the pin in the pull up mode. This is for I2C bus signalling.</p>
</div>
<div class="paragraph">
<p>We make modifications to <em>arch/arm/boot/dts/am335x-boneblack.dts</em> and add
the pinctrl configuration for I2C1. Additionally we need to define the pinctrl
settings in our i2c1 node from the previous lab.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">&amp;am33xx_pinmux {
.
.
.
        nxp_hdmi_bonelt_off_pins: nxp_hdmi_bonelt_off_pins {
                pinctrl-single,pins = &lt;
                        <span style="color:#02b">0x1b0</span> <span style="color:#02b">0x03</span>      <span style="color:#777">/* xdma_event_intr0, OMAP_MUX_MODE3 | AM33XX_PIN_OUTPUT */</span>
                &gt;;
        };
        <span style="color:#970;font-weight:bold">i2c1_pins:</span> pinmux_i2c1_pins { <i class="conum" data-value="1"></i><b>(1)</b>
                pinctrl-single,pins = &lt;
                        <span style="color:#02b">0x158</span> (PIN_INPUT_PULLUP | MUX_MODE2)    <span style="color:#777">/* spi0_d1.i2c1_sda */</span>
                        <span style="color:#02b">0x15c</span> (PIN_INPUT_PULLUP | MUX_MODE2)    <span style="color:#777">/* spi0_cs0.i2c1_scl */</span>
                &gt;;
        };
};
.
.
.
i2c1 {
        pinctrl-names = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">default</span><span style="color:#710">&quot;</span></span>;
        pinctrl-<span style="color:#00D">0</span> = &lt;&amp;i2c1_pins&gt;; <i class="conum" data-value="2"></i><b>(2)</b>

        status = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">okay</span><span style="color:#710">&quot;</span></span>;
        clock-frequency = &lt;<span style="color:#00D">100000</span>&gt;;

        <span style="color:#970;font-weight:bold">nunchuck:</span> nunchuck<span style="color:#F00;background-color:#FAA">@</span><span style="color:#00D">52</span> {
                compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nintendo,nunchuck</span><span style="color:#710">&quot;</span></span>;
                reg = &lt;<span style="color:#02b">0x52</span>&gt;;
        };

};</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Defined the pinctrl configuration for <em>i2c1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Defined the named state for the <em>i2c1</em> bus</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We now rebuild the <em>DTB</em> and reboot the board.</p>
</div>
</div>
<div class="sect2">
<h3 id="i2c-bus-tests"><a class="anchor" href="#i2c-bus-tests"></a>42.4. I2C Bus Tests</h3>
<div class="paragraph">
<p>We can run the <a href="http://linux.die.net/man/8/i2cdetect" target="_blank"><em>i2cdetect</em></a> utility to check if we&#8217;ve configured the <em>i2c1</em> bus correctly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Welcome to Buildroot
buildroot login: root
# i2cdetect -l        <i class="conum" data-value="1"></i><b>(1)</b>
i2c-0        i2c               OMAP I2C adapter                        I2C adapter
i2c-1        i2c               OMAP I2C adapter                        I2C adapter
# i2cdetect -F 1 <i class="conum" data-value="2"></i><b>(2)</b>
Functionalities implemented by /dev/i2c-1:
I2C                              yes
SMBus Quick Command              no
SMBus Send Byte                  yes
SMBus Receive Byte               yes
SMBus Write Byte                 yes
SMBus Read Byte                  yes
SMBus Write Word                 yes
SMBus Read Word                  yes
SMBus Process Call               yes
SMBus Block Write                yes
SMBus Block Read                 no
SMBus Block Process Call         no
SMBus PEC                        yes
I2C Block Write                  yes
I2C Block Read                   yes
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List the I2C adapters available</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>List the functionalities associated with the <em>i2c1</em> bus</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To see if everything works fine we use the <em>i2cdetect -r 1</em> command.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Using <em>i2cdetect -r 1</em></div>
<div class="paragraph">
<p>According to the <a href="http://linux.die.net/man/8/i2cdetect" target="_blank">man page</a>, this command uses the
SMBus "read byte" commands for probing. It uses a command which will be
safest for each address. Since we&#8217;re following the Free Electrons lab
we use it but otherwise it&#8217;s better to read up before using it for an
unknown I2C device.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># i2cdetect -r 1
WARNING! This program can confuse your I2C bus, cause data loss and worse!
I will probe file /dev/i2c-1 using read byte commands.
I will probe address range 0x03-0x77.
Continue? [Y/n]
     0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f
00:          -- -- -- -- -- -- -- -- -- -- -- -- --
10: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
20: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
30: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
40: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
50: -- -- 52 -- -- -- -- -- -- -- -- -- -- -- -- --
60: -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- --
70: -- -- -- -- -- -- -- --
# [  445.878808] random: nonblocking pool is initialized</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we go ahead and commit our changes using git.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git status <i class="conum" data-value="1"></i><b>(1)</b>
On branch nunchuck
Changes not staged for commit:
  (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)
  (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)

        modified:   arch/arm/boot/dts/am335x-boneblack.dts

Untracked files:
  (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)

        defconfig
        drivers/Module.symvers
        drivers/misc/Module.symvers
        drivers/staging/Module.symvers
        drivers/staging/comedi/Module.symvers
        drivers/staging/comedi/drivers/Module.symvers

no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git diff arch/arm/boot/dts/am335x-boneblack.dts        <i class="conum" data-value="2"></i><b>(2)</b>
diff --git a/arch/arm/boot/dts/am335x-boneblack.dts b/arch/arm/boot/dts/am335x-boneblack.dts
index 049049a..fe7422d 100644
--- a/arch/arm/boot/dts/am335x-boneblack.dts
+++ b/arch/arm/boot/dts/am335x-boneblack.dts
@@ -60,6 +60,12 @@
                        0x1b0 0x03      /* xdma_event_intr0, OMAP_MUX_MODE3 | AM33XX_PIN_OUTPUT */
                &gt;;
        };
+       i2c1_pins: pinmux_i2c1_pins {
+               pinctrl-single,pins = &lt;
+                       0x158 (PIN_INPUT_PULLUP | MUX_MODE2)    /* spi0_d1.i2c1_sda */
+                       0x15c (PIN_INPUT_PULLUP | MUX_MODE2)    /* spi0_cs0.i2c1_scl */
+               &gt;;
+       };
 };

 &amp;lcdc {
@@ -78,6 +84,9 @@
 };

 &amp;i2c1 {
+       pinctrl-names = &quot;default&quot;;
+       pinctrl-0 = &lt;&amp;i2c1_pins&gt;;
+
        status = &quot;okay&quot;;
        clock-frequency = &lt;100000&gt;;

conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git add arch/arm/boot/dts/am335x-boneblack.dts <i class="conum" data-value="3"></i><b>(3)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$ git commit -s -m &quot;am335x-boneblack.dts: Enable pinmux settings for i2c1 bus&quot; <i class="conum" data-value="4"></i><b>(4)</b>
[nunchuck de7b0fb] am335x-boneblack.dts: Enable pinmux settings for i2c1 bus
 1 file changed, 9 insertions(+)
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/linux$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Check the status of the repository</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Check the differences in the <em>arch/arm/boot/dts/am335x-boneblack.dts</em> file</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add The file to the index</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Commit the change with an appropriate message using -m and signing off using -s</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="nunchuck-device-initialization"><a class="anchor" href="#nunchuck-device-initialization"></a>42.5. Nunchuck Device Initialization</h3>
<div class="paragraph">
<p>We will need to read the registers of the Nunchuck to find out whether the buttons
are pressed or not. But before that we will need to initiate the Nunchuck.
To communicate with the Nunchuck, we must send a handshake signal. If you are
using a black Wii Nunchuck, send 2 bytes 0xF0, 0x55 to initalize the first register
and 0xFB, 0x00 to initialize the second register of the Nunchuck. On a white send
0x40, 0x00 followed by 0x00. We get this information from the
<a href="../free_electrons_linux_kernel/nunchuck.pdf" target="_blank">nunchuck pdf</a>.</p>
</div>
<div class="paragraph">
<p>To initialize the device we will modify our probe routine in our platform driver
and use the I2C raw API. The modifications to our driver code are shown below.
We take extra care to check the return value of <em>i2c_master_send</em> to check
for communication issues.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/i2c.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/delay.h&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>

<span style="color:#777">/* Add your code here */</span>
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> i2c_device_id nunchuck_id[] = {
        { <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nunchuck</span><span style="color:#710">&quot;</span></span>, <span style="color:#00D">0</span> },
        { }
};
MODULE_DEVICE_TABLE(i2c, nunchuck_id);

<span style="color:#579">#ifdef</span> CONFIG_OF
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> of_device_id nunchuck_dt_ids[] = {
        {.compatible = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nintendo,nunchuck</span><span style="color:#710">&quot;</span></span>,},
        { }
};
MODULE_DEVICE_TABLE(of, nunchuck_dt_ids);
<span style="color:#579">#endif</span>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> nunchuck_probe(<span style="color:#080;font-weight:bold">struct</span> i2c_client *client,
                        <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> i2c_device_id *id)
{
        <span style="color:#0a8;font-weight:bold">char</span> init1[<span style="color:#00D">2</span>] = {<span style="color:#02b">0xF0</span>, <span style="color:#02b">0x55</span>};
        <span style="color:#0a8;font-weight:bold">char</span> init2[<span style="color:#00D">2</span>] = {<span style="color:#02b">0xFB</span>, <span style="color:#02b">0x00</span>};
        <span style="color:#0a8;font-weight:bold">int</span> count1 = <span style="color:#080;font-weight:bold">sizeof</span>(init1)/<span style="color:#080;font-weight:bold">sizeof</span>(init1[<span style="color:#00D">0</span>]);
        <span style="color:#0a8;font-weight:bold">int</span> count2 = <span style="color:#080;font-weight:bold">sizeof</span>(init2)/<span style="color:#080;font-weight:bold">sizeof</span>(init2[<span style="color:#00D">0</span>]);
        <span style="color:#0a8;font-weight:bold">int</span> ret;

        dev_info(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s invoked</span><span style="color:#710">&quot;</span></span>, __func__);

        <span style="color:#777">/* initialize device */</span>
        ret = i2c_master_send(client, init1, count1);        <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#080;font-weight:bold">if</span> (ret != count1) {
                dev_err(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: err=%d</span><span style="color:#710">&quot;</span></span>, __func__, ret);
                <span style="color:#080;font-weight:bold">return</span> -EIO;
        }

        udelay(<span style="color:#00D">1000</span>);        <i class="conum" data-value="3"></i><b>(3)</b>

        ret = i2c_master_send(client, init2, count2);        <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#080;font-weight:bold">if</span> (ret != count2) {
                dev_err(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: err=%d</span><span style="color:#710">&quot;</span></span>, __func__, ret);
                <span style="color:#080;font-weight:bold">return</span> -EIO;
        }
        <span style="color:#777">/* register to a kernel framework */</span>

        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> nunchuck_remove(<span style="color:#080;font-weight:bold">struct</span> i2c_client *client)
{
        dev_info(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s invoked</span><span style="color:#710">&quot;</span></span>, __func__);
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#080;font-weight:bold">struct</span> i2c_driver nunchuck_driver = {
        .probe = nunchuck_probe,
        .remove = nunchuck_remove,
        .id_table = nunchuck_id,
        .driver = {
                .name = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">nunchuck</span><span style="color:#710">&quot;</span></span>,
                .owner = THIS_MODULE,
                .of_match_table = of_match_ptr(nunchuck_dt_ids),
        },
};

module_i2c_driver(nunchuck_driver);

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We include the <em>linux/delay.h</em> file to use <em>udelay</em> in our code</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Using <em>i2c_master_send</em> we send the 0xF0 and 0x55 bytes to the client</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>A delay of 1ms is inserted between the two I2C transactions</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Using <em>i2c_master_send</em> we send the 0xFB and 0x00 bytes to the client</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Again we compile our kernel driver module with the new changes passing the
<em>ARCH</em>, <em>CROSS_COMPILE</em> and <em>KDIR</em> options as before.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk$ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- KDIR=/home/conrad/Git/linux/
make -C /home/conrad/Git/linux/ M=$PWD
make[1]: Entering directory `/home/conrad/Git/linux'
  CC [M]  /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk/nunchuk.o
  Building modules, stage 2.
  MODPOST 1 modules
  CC      /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk/nunchuk.mod.o
  LD [M]  /home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk/nunchuk.ko
make[1]: Leaving directory `/home/conrad/Git/linux'
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/root/nunchuk$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we test the kernel module to check if there are any communication
issues.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># lsmod        <i class="conum" data-value="1"></i><b>(1)</b>
Module                  Size  Used by    Tainted: G
#
#
#
# insmod nunchuk.ko <i class="conum" data-value="2"></i><b>(2)</b>
[  840.223615] nunchuck 1-0052: nunchuck_probe invoked
#
#
#
#
# rmmod nunchuk        <i class="conum" data-value="3"></i><b>(3)</b>
[  850.012196] nunchuck 1-0052: nunchuck_remove invoked
#
#
#
#
# dmesg |tail <i class="conum" data-value="4"></i><b>(4)</b>
[    5.107285]      device=eth0, hwaddr=90:59:af:49:c8:ef, ipaddr=192.168.0.100, mask=255.255.255.0, gw=255.255.255.255
[    5.118343]      host=192.168.0.100, domain=, nis-domain=(none)
[    5.124525]      bootserver=255.255.255.255, rootserver=192.168.0.1, rootpath=
[    5.772441] VFS: Mounted root (nfs filesystem) on device 0:13.
[    5.780080] devtmpfs: mounted
[    5.783776] Freeing unused kernel memory: 384K (c0771000 - c07d1000)
[    7.029211] random: dd urandom read with 56 bits of entropy available
[  303.383631] random: nonblocking pool is initialized
[  840.223615] nunchuck 1-0052: nunchuck_probe invoked
[  850.012196] nunchuck 1-0052: nunchuck_remove invoked
#
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using <em>lsmod</em> we see that there are not inserted kernel modules</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Insert our <em>nunchuck.ko</em> driver</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Remove our <em>nunchuck</em> driver</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Print the last kernel logs and inspect for any errors</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point we assume the device is initialized in the probe routine.</p>
</div>
</div>
<div class="sect2">
<h3 id="read-nunchuck-registers"><a class="anchor" href="#read-nunchuck-registers"></a>42.6. Read Nunchuck Registers</h3>
<div class="paragraph">
<p>The nunchuk has 6 registers with which it relays information as given in <a href="../free_electrons_linux_kernel/nunchuck.pdf" target="_blank">the pdf</a>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Byte 0x00</dt>
<dd>
<p>X-axis data of the joystick</p>
</dd>
<dt class="hdlist1">Byte 0x01</dt>
<dd>
<p>Y-axis data of the joystick</p>
</dd>
<dt class="hdlist1">Byte 0x02</dt>
<dd>
<p>X-axis data of the accellerometer sensor</p>
</dd>
<dt class="hdlist1">Byte 0x03</dt>
<dd>
<p>Y-axis data of the accellerometer sensor</p>
</dd>
<dt class="hdlist1">Byte 0x04</dt>
<dd>
<p>Z-axis data of the accellerometer sensor</p>
</dd>
<dt class="hdlist1">Byte 0x05</dt>
<dd>
<p><strong>bit 0</strong> as Z button status - 0 = pressed and 1 = release;
<strong>bit 1</strong> as C button status - 0 = pressed and 1 = release;
<strong>bit 2 and 3</strong> as 2 lower bit of X-axis data of the accellerometer sensor;
<strong>bit 4 and 5</strong> as 2 lower bit of Y-axis data of the accellerometer sensor;
<strong>bit 6 and 7</strong> as 2 lower bit of Z-axis data of the accellerometer sensor;</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The nunchuck updates the registers only once they have been read so we
have to read the registers twice. We create a function <em>nunchuck_read_registers</em>
to simplify the impelementation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> nunchuck_read_registers(<span style="color:#080;font-weight:bold">struct</span> i2c_client *client,
                        <span style="color:#0a8;font-weight:bold">char</span> *reg_data, <span style="color:#0a8;font-weight:bold">int</span> count)
{
        <span style="color:#0a8;font-weight:bold">char</span> addr = <span style="color:#02b">0x00</span>;
        <span style="color:#0a8;font-weight:bold">int</span> ret = -<span style="color:#00D">1</span>;

        <span style="color:#080;font-weight:bold">if</span> ((<span style="color:#069">NULL</span> == client) || (<span style="color:#069">NULL</span>== reg_data) || (<span style="color:#00D">0</span> == count))
                <span style="color:#080;font-weight:bold">return</span> -EFAULT;

        dev_info(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s invoked</span><span style="color:#710">&quot;</span></span>, __func__);

        <span style="color:#777">/* Add 10ms delay before next read of registers */</span>
        mdelay(<span style="color:#00D">10</span>);        <i class="conum" data-value="1"></i><b>(1)</b>

        <span style="color:#777">/* Write 0x00 to nunchuck which is the base address for registers */</span>
        ret = i2c_master_send(client, &amp;addr, <span style="color:#080;font-weight:bold">sizeof</span>(addr));        <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#080;font-weight:bold">if</span> (ret != <span style="color:#080;font-weight:bold">sizeof</span>(addr)) {
                dev_err(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: err=%d</span><span style="color:#710">&quot;</span></span>, __func__, ret);
                ret = -EIO;
                <span style="color:#080;font-weight:bold">goto</span> END;
        }

        <span style="color:#777">/* Add 10ms delay before i2c_master_read */</span>
        mdelay(<span style="color:#00D">10</span>);        <i class="conum" data-value="3"></i><b>(3)</b>

        ret = i2c_master_recv(client, reg_data, count);        <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#080;font-weight:bold">if</span> (ret != count) {
                dev_err(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: err=%d</span><span style="color:#710">&quot;</span></span>, __func__, ret);
                ret = -EIO;
                <span style="color:#080;font-weight:bold">goto</span> END;
        }

        ret = <span style="color:#00D">0</span>;

<span style="color:#970;font-weight:bold">END:</span>
        <span style="color:#080;font-weight:bold">return</span> ret;
}
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Start by putting a 10 ms delay by calling the mdelay() routine. Thats needed to add
time between the previous i2c operation and the next one.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Write 0x00 to the bus. That will allow us to read the device registers.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Add another 10 ms delay.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Read 6 bytes from the device, still using the I2C raw API. Check the return value as usua</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We use the <em>nunchuck_read_registers</em> function in our probe routine invoking it twice.
The first read value is discarded and the latest value is used in order to determine the status
of the Z and C buttons. Our implementation looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> nunchuck_probe(<span style="color:#080;font-weight:bold">struct</span> i2c_client *client,
                        <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> i2c_device_id *id)
{
        <span style="color:#0a8;font-weight:bold">char</span> init1[<span style="color:#00D">2</span>] = {<span style="color:#02b">0xF0</span>, <span style="color:#02b">0x55</span>};
        <span style="color:#0a8;font-weight:bold">char</span> init2[<span style="color:#00D">2</span>] = {<span style="color:#02b">0xFB</span>, <span style="color:#02b">0x00</span>};
        <span style="color:#0a8;font-weight:bold">char</span> data[<span style="color:#00D">6</span>] = {<span style="color:#00D">0</span>};        <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#0a8;font-weight:bold">int</span> count1 = <span style="color:#080;font-weight:bold">sizeof</span>(init1)/<span style="color:#080;font-weight:bold">sizeof</span>(init1[<span style="color:#00D">0</span>]);
        <span style="color:#0a8;font-weight:bold">int</span> count2 = <span style="color:#080;font-weight:bold">sizeof</span>(init2)/<span style="color:#080;font-weight:bold">sizeof</span>(init2[<span style="color:#00D">0</span>]);
        <span style="color:#0a8;font-weight:bold">int</span> ret;
        <span style="color:#0a8;font-weight:bold">int</span> zpressed = <span style="color:#00D">0</span>;        <i class="conum" data-value="2"></i><b>(2)</b>
        <span style="color:#0a8;font-weight:bold">int</span> cpressed = <span style="color:#00D">0</span>;

        dev_info(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s invoked</span><span style="color:#710">&quot;</span></span>, __func__);

        <span style="color:#777">/* initialize device */</span>
        ret = i2c_master_send(client, init1, count1);
        <span style="color:#080;font-weight:bold">if</span> (ret != count1) {
                dev_err(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: err=%d</span><span style="color:#710">&quot;</span></span>, __func__, ret);
                <span style="color:#080;font-weight:bold">return</span> -EIO;
        }

        udelay(<span style="color:#00D">1000</span>);

        ret = i2c_master_send(client, init2, count2);
        <span style="color:#080;font-weight:bold">if</span> (ret != count2) {
                dev_err(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: err=%d</span><span style="color:#710">&quot;</span></span>, __func__, ret);
                <span style="color:#080;font-weight:bold">return</span> -EIO;
        }
        <span style="color:#777">/* register to a kernel framework */</span>

        <span style="color:#777">/* read nunchuck registers */</span>
        ret = nunchuck_read_registers(client, data, <span style="color:#080;font-weight:bold">sizeof</span>(data));        <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="color:#080;font-weight:bold">if</span> (ret) {
                dev_err(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: err=%d</span><span style="color:#710">&quot;</span></span>, __func__, ret);
                <span style="color:#080;font-weight:bold">return</span> -EIO;
        }

        <span style="color:#777">/* read nunchuck registers */</span>
        ret = nunchuck_read_registers(client, data, <span style="color:#080;font-weight:bold">sizeof</span>(data));        <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#080;font-weight:bold">if</span> (ret) {
                dev_err(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s: err=%d</span><span style="color:#710">&quot;</span></span>, __func__, ret);
                <span style="color:#080;font-weight:bold">return</span> -EIO;
        }

        <span style="color:#777">/* Bit 0 indicates if Z button is pressed */</span>
        zpressed = (data[<span style="color:#00D">5</span>] &amp; BIT(<span style="color:#00D">0</span>)? <span style="color:#00D">0</span> : <span style="color:#00D">1</span>);                <i class="conum" data-value="5"></i><b>(5)</b>
        <span style="color:#777">/* Bit 1 indicates if Z button is pressed */</span>
        cpressed = (data[<span style="color:#00D">5</span>] &amp; BIT(<span style="color:#00D">1</span>)? <span style="color:#00D">0</span> : <span style="color:#00D">1</span>);

        dev_info(&amp;client-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">%s:zpressed : %d cpressed : %d</span><span style="color:#710">&quot;</span></span>,
                        __func__, zpressed, cpressed);

        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}
.
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Data array to read the 6 registers</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>zpressed, cpressed variables to store the status of the Z and C buttons</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>First read of the nunchuck registers</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Second read of the nunchuck registers</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We use <em>BIT</em> macro to extract the bit status of the 6th element(index 5)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After cross-compiling the kernel module driver again we test it out with the nunchuck.
Each time we load the module using <em>insmod</em> and unload it using <em>rmmod</em>. We see
that we&#8217;re successfully able to read the status of the buttons through I2C.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">#
#
# insmod nunchuk.ko
[  791.810820] nunchuck 1-0052: nunchuck_probe invoked
[  791.817778] nunchuck 1-0052: nunchuck_read_registers invoked
[  791.846620] nunchuck 1-0052: nunchuck_read_registers invoked
[  791.873956] nunchuck 1-0052: nunchuck_probe:zpressed : 0 cpressed : 0        <i class="conum" data-value="1"></i><b>(1)</b>
# rmmod nunchuk
#
#
[  796.906688] nunchuck 1-0052: nunchuck_remove invoked
# insmod nunchuk.ko
[  801.625983] nunchuck 1-0052: nunchuck_probe invoked
[  801.633607] nunchuck 1-0052: nunchuck_read_registers invoked
[  801.660876] nunchuck 1-0052: nunchuck_read_registers invoked
[  801.687922] nunchuck 1-0052: nunchuck_probe:zpressed : 0 cpressed : 1        <i class="conum" data-value="2"></i><b>(2)</b>
# rmmod nunchuk
#
#
[  804.590286] nunchuck 1-0052: nunchuck_remove invoked
# insmod nunchuk.ko
[  807.392982] nunchuck 1-0052: nunchuck_probe invoked
[  807.400573] nunchuck 1-0052: nunchuck_read_registers invoked
[  807.427810] nunchuck 1-0052: nunchuck_read_registers invoked
[  807.454934] nunchuck 1-0052: nunchuck_probe:zpressed : 0 cpressed : 0        <i class="conum" data-value="3"></i><b>(3)</b>
# rmmod nunchuk
#
#
[  809.332638] nunchuck 1-0052: nunchuck_remove invoked
# insmod nunchuk.ko
[  812.202315] nunchuck 1-0052: nunchuck_probe invoked
[  812.209840] nunchuck 1-0052: nunchuck_read_registers invoked
[  812.237097] nunchuck 1-0052: nunchuck_read_registers invoked
[  812.264222] nunchuck 1-0052: nunchuck_probe:zpressed : 1 cpressed : 0        <i class="conum" data-value="4"></i><b>(4)</b>
# rmmod nunchuk
#
#
[  815.116691] nunchuck 1-0052: nunchuck_remove invoked
# insmod nunchuk.ko
[  819.487739] nunchuck 1-0052: nunchuck_probe invoked
[  819.495379] nunchuck 1-0052: nunchuck_read_registers invoked
[  819.522628] nunchuck 1-0052: nunchuck_read_registers invoked
[  819.549747] nunchuck 1-0052: nunchuck_probe:zpressed : 0 cpressed : 0        <i class="conum" data-value="5"></i><b>(5)</b>
#
#
# rmmod nunchuk
[ 1746.370837] nunchuck 1-0052: nunchuck_remove invoked
# insmod nunchuk.ko
[ 1751.173512] nunchuck 1-0052: nunchuck_probe invoked
[ 1751.181127] nunchuck 1-0052: nunchuck_read_registers invoked
[ 1751.208413] nunchuck 1-0052: nunchuck_read_registers invoked
[ 1751.235496] nunchuck 1-0052: nunchuck_probe:zpressed : 1 cpressed : 1        <i class="conum" data-value="6"></i><b>(6)</b>
#
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>No buttons pressed</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>C button is pressed</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>No buttons pressed</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Z button is pressed</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>No buttons pressed</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Both C and Z are pressed</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this lab we were able to successfully communicate with the Wii Nintendo nunchuck
over the I2C bus. This is a basic platform driver which gives us an understanding
of how to initialise the device and access its registers. To be really useful
we&#8217;ll have to plug it into some sort of framework such as <em>input</em> so as to make
it available to the user.</p>
</div>
</div>
</div>
</div>
<h1 id="kernel-frameworks" class="sect0"><a class="anchor" href="#kernel-frameworks"></a>Kernel Frameworks</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>The Linux kernel is designed so that a kernel driver can interface with a framework
which exposes services to the userspace. The driver interfaces with the bus infrastructure
of the device depending on how it is connected in the platform and also interfaces
with a specific framework which classifies the functionality of the device. This
allows different devices to support the same userspace interface.
This section will focus on the kernel frameworks.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="user-space-inteface-to-devices"><a class="anchor" href="#user-space-inteface-to-devices"></a>43. User Space Inteface To Devices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Linux, there are three types of devices:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Network devices</dt>
<dd>
<p>They are the network interfaces which are visible using
tools like ifconfig for ethernet interfaces, iwconfig for wlan interfaces, etc&#8230;&#8203;</p>
</dd>
<dt class="hdlist1">Block devices</dt>
<dd>
<p>They are the devices which represent physical storage in the
system. The easiest example is the hard disk drive. Access to such type of
devices is through blocks of data. They are visible through files present in
<em>/dev</em>.</p>
</dd>
<dt class="hdlist1">Character devices</dt>
<dd>
<p>All other types of devices are represented as character
devices. They include devices such as input devices like the mouse, keyboard
to devices such as the graphics card and sound card. They are also visible
through files present in <em>/dev</em>. Bulk of the devices that are present
are represented as character devices.</p>
</dd>
</dl>
</div>
<div class="sect2">
<h3 id="major-minor-numbers"><a class="anchor" href="#major-minor-numbers"></a>43.1. Major &amp; Minor Numbers</h3>
<div class="paragraph">
<p>The kernel denotes devices with a major and minor number where the major
number represents the class that the device falls into and the minor
number is just an identifier for the device in that class.</p>
</div>
<div class="paragraph">
<p>Userspace applications need to access devices across different platforms
and for this reason the major and minor numbers are statically allocated
and identical across different systems. Checkout <em>Documentation/devices.txt</em></p>
</div>
</div>
<div class="sect2">
<h3 id="devices-are-files"><a class="anchor" href="#devices-are-files"></a>43.2. Devices Are Files</h3>
<div class="paragraph">
<p>One of the highlights of Unix design is that devices are also treated
as files. In this way a userspace application can manipulate all
devices in the same way it accesses a file on the system using the API
<em>open</em>, <em>close</em>, <em>write</em>, <em>read</em>, etc..</p>
</div>
<div class="paragraph">
<p>This is possible because of a special type of file called the device file.
This file associates the type, major and minor of a device with a specific
file name. Typically all device files are stored in <em>/dev</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># ls -l /dev/
total 0
crw-------    1 root     root        5,   1 Jan  1  1970 console
crw-------    1 root     root       10,  63 Jan  1  1970 cpu_dma_latency
crw-rw-rw-    1 root     root        1,   7 Jan  1  1970 full
crw-------    1 root     root       10, 183 Jan  1  1970 hwrng
crw-------    1 root     root       89,   0 Jan  1  1970 i2c-0
crw-------    1 root     root       89,   1 Jan  1  1970 i2c-1
drwxr-xr-x    2 root     root            60 Jan  1  1970 input
.
.
.
crw-------    1 root     root        7, 129 Jan  1  1970 vcsa1
crw-------    1 root     root       10, 130 Jan  1  1970 watchdog
crw-------    1 root     root      253,   0 Jan  1  1970 watchdog0
crw-rw-rw-    1 root     root        1,   5 Jan  1  1970 zero
#
#</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-device-files"><a class="anchor" href="#creating-device-files"></a>43.3. Creating Device Files</h3>
<div class="paragraph">
<p>Since device files are special they have to be created using a special
command <em>mknod</em>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>mknod /dev/&lt;device_file_name&gt; [c/b] major minor</em></p>
</li>
<li>
<p><em>mknod</em> requires special root access</p>
</li>
<li>
<p>The association between type, major and minor of the file and the device
needs to be respected in the system and is the responsibility of the system designer.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Some systems automate the creation of these device files by the use
of daemons which run and monitor the <em>/sys/</em> filesystem.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>devtmpfs</em> virtual filesystem</p>
</li>
<li>
<p><em>udev</em> daemon popular on desktops and server systems</p>
</li>
<li>
<p><em>mdev</em> lightweight solution popular on embedded devices</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="character-drivers"><a class="anchor" href="#character-drivers"></a>44. Character Drivers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As mentioned in the previous section character devices are treated
as files so the device driver for character devices must implement
the routines <em>open, close, read, write, etc</em>.</p>
</div>
<div class="paragraph">
<p>The character driver does this through the callback functions
defined in the <em>struct file_operations</em> structure.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="user-kernel-interface-char-devices" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/user-kernel-interface-char-devices.png"><img src="http://zeuzoix.github.io/techeuphoria/images/user-kernel-interface-char-devices.png" alt="user kernel interface char devices" width="640" height="480"></a>
</div>
<div class="title">USB Kernel Interface Character Devices</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="file-operations"><a class="anchor" href="#file-operations"></a>44.1. File Operations</h3>
<div class="paragraph">
<p>We will take a look at the file operations for a character driver. It is not necessary
to implement either of them. These are found in <em>include/linux/fs.h</em>. The structure
below shows all operations for a file but we&#8217;ve enumerated the ones which are relevant
to character drivers.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#080;font-weight:bold">struct</span> file_operations {
        <span style="color:#080;font-weight:bold">struct</span> module *owner;
        loff_t (*llseek) (<span style="color:#080;font-weight:bold">struct</span> file *, loff_t, <span style="color:#0a8;font-weight:bold">int</span>);
        ssize_t (*read) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#0a8;font-weight:bold">char</span> __user *, size_t, loff_t *);        <i class="conum" data-value="1"></i><b>(1)</b>
        ssize_t (*write) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> __user *, size_t, loff_t *);        <i class="conum" data-value="2"></i><b>(2)</b>
        ssize_t (*aio_read) (<span style="color:#080;font-weight:bold">struct</span> kiocb *, <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> iovec *, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>, loff_t);
        ssize_t (*aio_write) (<span style="color:#080;font-weight:bold">struct</span> kiocb *, <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> iovec *, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>, loff_t);
        <span style="color:#0a8;font-weight:bold">int</span> (*iterate) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#080;font-weight:bold">struct</span> dir_context *);
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> (*poll) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#080;font-weight:bold">struct</span> poll_table_struct *);
        <span style="color:#0a8;font-weight:bold">long</span> (*unlocked_ioctl) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>);        <i class="conum" data-value="3"></i><b>(3)</b>
        <span style="color:#0a8;font-weight:bold">long</span> (*compat_ioctl) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>);
        <span style="color:#0a8;font-weight:bold">int</span> (*mmap) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#080;font-weight:bold">struct</span> vm_area_struct *);        <i class="conum" data-value="4"></i><b>(4)</b>
        <span style="color:#0a8;font-weight:bold">int</span> (*open) (<span style="color:#080;font-weight:bold">struct</span> inode *, <span style="color:#080;font-weight:bold">struct</span> file *);        <i class="conum" data-value="5"></i><b>(5)</b>
        <span style="color:#0a8;font-weight:bold">int</span> (*flush) (<span style="color:#080;font-weight:bold">struct</span> file *, fl_owner_t id);
        <span style="color:#0a8;font-weight:bold">int</span> (*release) (<span style="color:#080;font-weight:bold">struct</span> inode *, <span style="color:#080;font-weight:bold">struct</span> file *);        <i class="conum" data-value="6"></i><b>(6)</b>
        <span style="color:#0a8;font-weight:bold">int</span> (*fsync) (<span style="color:#080;font-weight:bold">struct</span> file *, loff_t, loff_t, <span style="color:#0a8;font-weight:bold">int</span> datasync);
        <span style="color:#0a8;font-weight:bold">int</span> (*aio_fsync) (<span style="color:#080;font-weight:bold">struct</span> kiocb *, <span style="color:#0a8;font-weight:bold">int</span> datasync);
        <span style="color:#0a8;font-weight:bold">int</span> (*fasync) (<span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#0a8;font-weight:bold">int</span>);
        <span style="color:#0a8;font-weight:bold">int</span> (*lock) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#080;font-weight:bold">struct</span> file_lock *);
        ssize_t (*sendpage) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#080;font-weight:bold">struct</span> page *, <span style="color:#0a8;font-weight:bold">int</span>, size_t, loff_t *, <span style="color:#0a8;font-weight:bold">int</span>);
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> (*get_unmapped_area)(<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span>);
        <span style="color:#0a8;font-weight:bold">int</span> (*check_flags)(<span style="color:#0a8;font-weight:bold">int</span>);
        <span style="color:#0a8;font-weight:bold">int</span> (*flock) (<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#0a8;font-weight:bold">int</span>, <span style="color:#080;font-weight:bold">struct</span> file_lock *);
        ssize_t (*splice_write)(<span style="color:#080;font-weight:bold">struct</span> pipe_inode_info *, <span style="color:#080;font-weight:bold">struct</span> file *, loff_t *, size_t, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span>);
        ssize_t (*splice_read)(<span style="color:#080;font-weight:bold">struct</span> file *, loff_t *, <span style="color:#080;font-weight:bold">struct</span> pipe_inode_info *, size_t, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span>);
        <span style="color:#0a8;font-weight:bold">int</span> (*setlease)(<span style="color:#080;font-weight:bold">struct</span> file *, <span style="color:#0a8;font-weight:bold">long</span>, <span style="color:#080;font-weight:bold">struct</span> file_lock **);
        <span style="color:#0a8;font-weight:bold">long</span> (*fallocate)(<span style="color:#080;font-weight:bold">struct</span> file *file, <span style="color:#0a8;font-weight:bold">int</span> mode, loff_t offset,
                          loff_t len);
        <span style="color:#0a8;font-weight:bold">int</span> (*show_fdinfo)(<span style="color:#080;font-weight:bold">struct</span> seq_file *m, <span style="color:#080;font-weight:bold">struct</span> file *f);
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>Therefore in a character driver named <em>foo</em> we would have the following operations
defined.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">int foo_open(struct inode *i, struct file *f)</dt>
<dd>
<p>The <em>open</em> operation is defined so that when user space opens the device file
it gets access to the character driver. Here <em>struct inode</em> pointer is a structure
that uniquely represents a file in the Linux system (be it a regular file,
a directory, a symbolic link, a character or block device). And <em>struct file</em>
is a structure created every time a file is opened. Going forward we see that
the <em>struct file</em> object is used in the other operations. As the same file
can be accessed by multiple applications there needs to be a way of differentiating
each process&#8217;s access. Several file structures can point to the same inode structure.
The object contains information like the current position, the opening mode, etc.
which is relevant to a particular process. The <em>struct file</em> object also has a
<em>void *private_data</em> pointer that one can freely use.</p>
</dd>
<dt class="hdlist1">int foo_release(struct inode *i, struct file *f)</dt>
<dd>
<p>The <em>release</em> operation is called when user space closes the file.</p>
</dd>
<dt class="hdlist1">ssize_t foo_read(struct file *f, char __user *buf, size_t sz, loff_t *off)</dt>
<dd>
<p>The <em>read</em> operation is defined to allow the user space application to
read the device. So the driver has to read data from the device, write in the user
space buffer pointed <em>buf</em> argument, and update the current position in <em>off</em>.
The pointer to the same file structure that was used in the <em>open</em> call is used.
The amount of data should be capped to that of <em>sz</em>. The number of bytes
actually read is returned. On UNIX systems the <em>read</em> operation blocks
if there is not enough data to read.</p>
</dd>
<dt class="hdlist1">ssize_t foo_write(struct file *f, const char __user *buf, size_t sz, loff_t *off)</dt>
<dd>
<p>Called when user space uses the <em>write()</em> system call on the device
The opposite of read, must read at most <em>sz</em> bytes from buf, write it to the device,
update <em>off</em> and return the number of bytes written.</p>
</dd>
<dt class="hdlist1">long foo_unlocked_ioctl(struct file *f, unsigned int cmd, unsigned long arg)</dt>
<dd>
<p>Associated to the ioctl() system call. Called unlocked because it didnt hold the Big Kernel Lock
(gone now). Allows to extend the driver capabilities beyond the limited
read/write API. For example: changing the speed of a serial port, setting video
output format, querying a device serial number. In this <em>cmd</em> is a number
identifying the operation to perform <em>arg</em> is the optional argument passed as
third argument of the <em>ioctl()</em> system call. Can be an integer, an address, etc.
The semantic of cmd and arg is driver-specific</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exchanging-data-with-user-space"><a class="anchor" href="#exchanging-data-with-user-space"></a>45. Exchanging Data With User Space</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since user space memory is different from kernel space memory we can&#8217;t use
a simple <em>memcpy</em> to copy data from user space to kernel space. Additionally
dereferencing a user space pointer in kernel space will not work on all platforms.
Moreover if the pointer being dereferenced is invalid it will lead to a segfault
in the application.</p>
</div>
<div class="paragraph">
<p>Linux defines a set of functions to keep the kernel code portable when it comes
to copying data from user space to kernel space and vice versa. The first two
functions copy single values and the last two copy buffers:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">get_user(v, p);</dt>
<dd>
<p>The kernel variable <em>v</em> gets the value pointed by the user space pointer <em>p</em></p>
</dd>
<dt class="hdlist1">put_user(v, p);</dt>
<dd>
<p>The value of the variable refered by the pointer <em>p</em> is set to the value
of the kernel variable <em>v</em></p>
</dd>
<dt class="hdlist1">unsigned long copy_to_user(void __user *to, const void *from, unsigned long n);</dt>
<dd>
<p>Copy the contents of the kernel buffer <em>from</em> to the user space buffer <em>to</em> upto
<em>n</em> bytes. Return 0 on success and -EFAULT on failure.</p>
</dd>
<dt class="hdlist1">unsigned long copy_from_user(void *to, const void __user *from, unsigned long n);</dt>
<dd>
<p>Copy the contents of the user space buffer <em>from</em> to the kernel buffer <em>to</em> upto
<em>n</em> bytes. Return 0 on success and -EFAULT on failure.</p>
</dd>
</dl>
</div>
<div class="exampleblock">
<div class="content">
<div id="user-kernel-data-exchange" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/user-kernel-data-exchange.png"><img src="http://zeuzoix.github.io/techeuphoria/images/user-kernel-data-exchange.png" alt="user kernel data exchange" width="640" height="480"></a>
</div>
<div class="title">User Kernel Data Exchange</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="zero-copy-access-to-user-space"><a class="anchor" href="#zero-copy-access-to-user-space"></a>45.1. Zero Copy Access To User Space</h3>
<div class="paragraph">
<p>We looked at the functions that allow us to copy data between user space and kernel
space. If the amount of data we&#8217;re dealing with is huge we need a more efficient
mechanism. We&#8217;d like to keep our system as efficient as possible and free up
our processor to do other activities besides copying.</p>
</div>
<div class="paragraph">
<p>The Linux kernel offers <em>zero copy</em> options:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">mmap</dt>
<dd>
<p>This system call allows user space to directly access memory mapped I/O space.</p>
</dd>
<dt class="hdlist1">get_user_pages_fast</dt>
<dd>
<p>This allows a kernel module to get access to user pages without copying them.
The API is more complex to use though.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="input-subsystem-a-framework-example"><a class="anchor" href="#input-subsystem-a-framework-example"></a>46. Input Subsystem, A Framework Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The input subsystem takes care of all the input events coming
from the user. It was initially written to support the USB HID (Human
Interface Device) devices, it expanded to handle all types of input
devices irrespective of the interface. Some examples of input devices
supported are: keyboards, mice, joysticks, touchscreens, etc..</p>
</div>
<div class="paragraph">
<p>The input subsystem is split into two parts:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Device drivers</dt>
<dd>
<p>This part communicates with the hardware of the input
device through the interface bus e.g. USB and provides events such as
keystrokes, mouse movements, touchscreen coordinates, etc.. to the input
core.</p>
</dd>
<dt class="hdlist1">Event handlers</dt>
<dd>
<p>This part gets the events from the drivers and passes
them where needed mostly through interfaces such as <em>evdev</em>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In user space we have different graphic stacks which will use the events
such as X.Org, Wayland or Android&#8217;s InputManager.</p>
</div>
<div class="sect2">
<h3 id="input-subsystem-overview"><a class="anchor" href="#input-subsystem-overview"></a>46.1. Input Subsystem Overview</h3>
<div class="paragraph">
<p>In order to configure the kernel with the input subsystem enabled
we have to enable the configuration option <em>CONFIG_INPUT</em>. We see
information in <em>menuconfig INPUT</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p>tristate "Generic input layer (needed for keyboard, mouse, &#8230;&#8203;)"</p>
</li>
</ul>
</div>
<div class="exampleblock">
<div class="content">
<div id="menuconfig-input" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../images/menuconfig-input.png"><img src="http://zeuzoix.github.io/techeuphoria/images/menuconfig-input.png" alt="menuconfig input" width="640" height="480"></a>
</div>
<div class="title">menuconfig INPUT</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The framework is implemented in <em>drivers/input/</em></p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>input.c</em></p>
</li>
<li>
<p><em>input-polldev.c</em></p>
</li>
<li>
<p><em>evbug.c</em></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The input subsystem implements a single character driver and defines
the user/kernel API in <em>include/uapi/linux/input.h</em>. The set of operations
that a input driver must implement and the helper functions for the driver
are alse defined by the input subsystem. The important structures are defined in
<em>include/linux/input.h</em></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>struct input_dev</em> for the device driver part</p>
</li>
<li>
<p><em>struct input_handler</em> for the event handler part</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="input-subsystem-api-for-allocation-and-deallocation"><a class="anchor" href="#input-subsystem-api-for-allocation-and-deallocation"></a>46.1.1. Input Subsystem API For Allocation And Deallocation</h4>
<div class="paragraph">
<p>The <em>input device</em> is described by a very long <em>struct input_dev</em> structure. Along
with the definition we have the prototype of the functions used to allocate and free
an object of the structure type i.e</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>struct input_dev *input_allocate_device(void);</em></p>
</li>
<li>
<p><em>void input_free_device(struct input_dev *dev);</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#080;font-weight:bold">struct</span> input_dev {        <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *name;
        <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *phys;
        <span style="color:#088;font-weight:bold">const</span> <span style="color:#0a8;font-weight:bold">char</span> *uniq;
        <span style="color:#080;font-weight:bold">struct</span> input_id id;

        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> propbit[BITS_TO_LONGS(INPUT_PROP_CNT)];

        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> evbit[BITS_TO_LONGS(EV_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> keybit[BITS_TO_LONGS(KEY_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> relbit[BITS_TO_LONGS(REL_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> absbit[BITS_TO_LONGS(ABS_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> mscbit[BITS_TO_LONGS(MSC_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> ledbit[BITS_TO_LONGS(LED_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> sndbit[BITS_TO_LONGS(SND_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> ffbit[BITS_TO_LONGS(FF_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> swbit[BITS_TO_LONGS(SW_CNT)];

        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> hint_events_per_packet;

        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> keycodemax;
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> keycodesize;
        <span style="color:#088;font-weight:bold">void</span> *keycode;

        <span style="color:#0a8;font-weight:bold">int</span> (*setkeycode)(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev,
                          <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> input_keymap_entry *ke,
                          <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> *old_keycode);
        <span style="color:#0a8;font-weight:bold">int</span> (*getkeycode)(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev,
                          <span style="color:#080;font-weight:bold">struct</span> input_keymap_entry *ke);

        <span style="color:#080;font-weight:bold">struct</span> ff_device *ff;

        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> repeat_key;
        <span style="color:#080;font-weight:bold">struct</span> timer_list timer;

        <span style="color:#0a8;font-weight:bold">int</span> rep[REP_CNT];

        <span style="color:#080;font-weight:bold">struct</span> input_mt *mt;

        <span style="color:#080;font-weight:bold">struct</span> input_absinfo *absinfo;

        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> key[BITS_TO_LONGS(KEY_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> led[BITS_TO_LONGS(LED_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> snd[BITS_TO_LONGS(SND_CNT)];
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> sw[BITS_TO_LONGS(SW_CNT)];

        <span style="color:#0a8;font-weight:bold">int</span> (*open)(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev);
        <span style="color:#088;font-weight:bold">void</span> (*close)(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev);
        <span style="color:#0a8;font-weight:bold">int</span> (*flush)(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev, <span style="color:#080;font-weight:bold">struct</span> file *file);
        <span style="color:#0a8;font-weight:bold">int</span> (*event)(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> type, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> code, <span style="color:#0a8;font-weight:bold">int</span> value);

        <span style="color:#080;font-weight:bold">struct</span> input_handle __rcu *grab;

        spinlock_t event_lock;
        <span style="color:#080;font-weight:bold">struct</span> mutex mutex;

        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> users;
        <span style="color:#0a8;font-weight:bold">bool</span> going_away;

        <span style="color:#080;font-weight:bold">struct</span> device dev;

        <span style="color:#080;font-weight:bold">struct</span> list_head        h_list;
        <span style="color:#080;font-weight:bold">struct</span> list_head        node;

        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> num_vals;
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> max_vals;
        <span style="color:#080;font-weight:bold">struct</span> input_value *vals;

        <span style="color:#0a8;font-weight:bold">bool</span> devres_managed;
};
.
.
.
<span style="color:#080;font-weight:bold">struct</span> input_dev __must_check *input_allocate_device(<span style="color:#088;font-weight:bold">void</span>);        <i class="conum" data-value="2"></i><b>(2)</b>
<span style="color:#080;font-weight:bold">struct</span> input_dev __must_check *devm_input_allocate_device(<span style="color:#080;font-weight:bold">struct</span> device *);
<span style="color:#088;font-weight:bold">void</span> input_free_device(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev);        <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>struct input_dev</em> is defined</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>input_allocate_device</em> is used to allocate the structure</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><em>input_free_device</em> is used to free the structure</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="input-subsystem-api-for-registration-and-deregistration"><a class="anchor" href="#input-subsystem-api-for-registration-and-deregistration"></a>46.1.2. Input Subsystem API For Registration And Deregistration</h4>
<div class="paragraph">
<p>Depending on the type of event that will be generated, the input bit fields evbit and keybit
of the <em>struct input_dev</em> must be configured. Let&#8217;s take a look at the input driver for the
Apple USB touchpad. This is located at <em>drivers/input/mouse/appletouch.c</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> atp_probe(<span style="color:#080;font-weight:bold">struct</span> usb_interface *iface,
                     <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> usb_device_id *id)
{
        <span style="color:#080;font-weight:bold">struct</span> atp *dev;
        <span style="color:#080;font-weight:bold">struct</span> input_dev *input_dev;

.
.
        set_bit(EV_KEY, input_dev-&gt;evbit);        <i class="conum" data-value="1"></i><b>(1)</b>
        set_bit(BTN_TOUCH, input_dev-&gt;keybit);        <i class="conum" data-value="2"></i><b>(2)</b>
        set_bit(BTN_TOOL_FINGER, input_dev-&gt;keybit);
        set_bit(BTN_TOOL_DOUBLETAP, input_dev-&gt;keybit);
        set_bit(BTN_TOOL_TRIPLETAP, input_dev-&gt;keybit);
        set_bit(BTN_LEFT, input_dev-&gt;keybit);
.
.
.
        <span style="color:#080;font-weight:bold">return</span> error;
}
.
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>EV_KEY</em> type of events are generated by this input device</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>BTN_TOUCH</em> events code are generated</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the example above <em>set_bit()</em> is an atomic operation allowing to set a particular
bit to 1. Once the input device is allocated and filled, we have to register
the allocated <em>struct input_dev</em> object with the input subsystem. This is done
with the <em>input_register_device</em> function. In the same example we see the registration
process just after initialising the allocated device structure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> atp_probe(<span style="color:#080;font-weight:bold">struct</span> usb_interface *iface,
                     <span style="color:#088;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">struct</span> usb_device_id *id)
{
        <span style="color:#080;font-weight:bold">struct</span> atp *dev;
        <span style="color:#080;font-weight:bold">struct</span> input_dev *input_dev;

.
.
        set_bit(EV_KEY, input_dev-&gt;evbit);
        set_bit(BTN_TOUCH, input_dev-&gt;keybit);
        set_bit(BTN_TOOL_FINGER, input_dev-&gt;keybit);
        set_bit(BTN_TOOL_DOUBLETAP, input_dev-&gt;keybit);
        set_bit(BTN_TOOL_TRIPLETAP, input_dev-&gt;keybit);
        set_bit(BTN_LEFT, input_dev-&gt;keybit);

        error = input_register_device(dev-&gt;input);        <i class="conum" data-value="1"></i><b>(1)</b>
        <span style="color:#080;font-weight:bold">if</span> (error)
                <span style="color:#080;font-weight:bold">goto</span> err_free_buffer;
.
.
.

        <span style="color:#080;font-weight:bold">return</span> error;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>input_register_device</em> is used to register the input device object</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the driver is unloaded, the input device will be unregistered using
<em>input_unregister_device</em>. We see this being called in the driver code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> atp_disconnect(<span style="color:#080;font-weight:bold">struct</span> usb_interface *iface)
{
        <span style="color:#080;font-weight:bold">struct</span> atp *dev = usb_get_intfdata(iface);

        usb_set_intfdata(iface, <span style="color:#069">NULL</span>);
        <span style="color:#080;font-weight:bold">if</span> (dev) {
                usb_kill_urb(dev-&gt;urb);
                input_unregister_device(dev-&gt;input);         <i class="conum" data-value="1"></i><b>(1)</b>
                usb_free_coherent(dev-&gt;udev, dev-&gt;info-&gt;datalen,
                                  dev-&gt;data, dev-&gt;urb-&gt;transfer_dma);
                usb_free_urb(dev-&gt;urb);
                kfree(dev);
        }
        dev_info(&amp;iface-&gt;dev, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">input: appletouch disconnected</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
}
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>input_unregister_device</em> is used to unregister the input device object</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="input-subsystem-api-for-injecting-events"><a class="anchor" href="#input-subsystem-api-for-injecting-events"></a>46.1.3. Input Subsystem API For Injecting Events</h4>
<div class="paragraph">
<p>The input driver now has the task of sending events to the event handler based
on the status of the input device. The events are sent by the driver to the event
handler using <em>input_event</em>. This function is defined in <em>drivers/input/input.c</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#777">/**
 * input_event() - report new input event
 * @dev: device that generated the event
 * @type: type of the event
 * @code: event code
 * @value: value of the event
 *
 * This function should be used by drivers implementing various input
 * devices to report input events. See also input_inject_event().
 *
 * NOTE: input_event() may be safely used right after input device was
 * allocated with input_allocate_device(), even before it is registered
 * with input_register_device(), but the event will not reach any of the
 * input handlers. Such early invocation of input_event() may be used
 * to 'seed' initial state of a switch or initial position of absolute
 * axis, etc.
 */</span>
<span style="color:#088;font-weight:bold">void</span> input_event(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev,
                 <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> type, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> code, <span style="color:#0a8;font-weight:bold">int</span> value)
{
        <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">long</span> flags;

        <span style="color:#080;font-weight:bold">if</span> (is_event_supported(type, dev-&gt;evbit, EV_MAX)) {

                spin_lock_irqsave(&amp;dev-&gt;event_lock, flags);
                input_handle_event(dev, type, code, value);
                spin_unlock_irqrestore(&amp;dev-&gt;event_lock, flags);
        }
}
EXPORT_SYMBOL(input_event);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The event types are documented in <em>Documentation/input/event-codes.txt</em>.
An event is composed by one or several input data changes (packet of input data changes)
such as the button state, the relative or absolute position along an axis, etc..
After submitting potentially multiple events, the input core must be notified by calling
<em>input_sync</em> whic is defined in <em>include/linux/input.h</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">inline</span> <span style="color:#088;font-weight:bold">void</span> input_sync(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev)
{
        input_event(dev, EV_SYN, SYN_REPORT, <span style="color:#00D">0</span>);
}
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The input subsystem provides other wrappers such as
input_report_key(), input_report_abs(), input_report_rel(), etc.. which are also defined
in <em>include/linux/input.h</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">.
.
tatic <span style="color:#088;font-weight:bold">inline</span> <span style="color:#088;font-weight:bold">void</span> input_report_key(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> code, <span style="color:#0a8;font-weight:bold">int</span> value)
{
        input_event(dev, EV_KEY, code, !!value);
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">inline</span> <span style="color:#088;font-weight:bold">void</span> input_report_rel(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> code, <span style="color:#0a8;font-weight:bold">int</span> value)
{
        input_event(dev, EV_REL, code, value);
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">inline</span> <span style="color:#088;font-weight:bold">void</span> input_report_abs(<span style="color:#080;font-weight:bold">struct</span> input_dev *dev, <span style="color:#0a8;font-weight:bold">unsigned</span> <span style="color:#0a8;font-weight:bold">int</span> code, <span style="color:#0a8;font-weight:bold">int</span> value)
{
        input_event(dev, EV_ABS, code, value);
}
.
.</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer class="row" style="max-width: 100%">
<hr>
<div class="large-6 columns">
<p style="margin-bottom: .75em">
&copy; conrad.s.j.gomes@gmail.com 2016
<br>
Built on Foundation. Baked by Awestruct. Composed with Asciidoc
</p>
</div>
<div class="large-6 columns">
<ul class="inline-list right">
<li>
<a href="http://zeuzoix.github.io/techeuphoria/">Home</a>
</li>
</ul>
</div>
</footer>
<script>
document.write('<script src=' + ('__proto__' in {} ? 'http://zeuzoix.github.io/techeuphoria/javascripts/vendor/zepto' : 'http://zeuzoix.github.io/techeuphoria/javascripts/vendor/jquery') + '.js><\/script>')
</script>
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/foundation/foundation.js"></script>
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/foundation/foundation.topbar.js"></script>
<script>
$(document).foundation()
</script>
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-61553633-1']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</body>
</html>
