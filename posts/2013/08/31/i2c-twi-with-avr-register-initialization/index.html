<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title>A Technical Odyssey</title>
<link href="http://zeuzoix.github.io/techeuphoria/stylesheets/app.css" rel="stylesheet">
<link href="/techeuphoria/feed.xml" rel="alternate" type="application/atom+xml">
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/vendor/custom.modernizr.js"></script>
<link href="http://zeuzoix.github.io/techeuphoria/humans.txt" rel="author" type="text/plain">
</head>
<body class="antialiased">
<div class="fixed-width">
<nav class="top-bar">
<ul class="title-area">
<li class="name">
<h1>
<a href="/techeuphoria/">
TechEuphoria
</a>
</h1>
</li>
<li class="toggle-topbar menu-icon">
<a href="#"><span></span></a>
</li>
</ul>
<section class="top-bar-section">
<ul class="left">
<li class="divider">
<li>
<a href="/techeuphoria/quests/index.html">/quests</a>
</li>
</li>
<li class="divider"></li>
</ul>
</section>
</nav>
</div>
<div class="row">
<div class="large-12 columns">
<h1></h1>
</div>
</div>
<div class="row" id="content">
<div class="large-12 columns">
<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2013/08/31/i2c-twi-with-avr-register-initialization/">I2C/TWI with AVR Register Initialization</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2013-08-31T00:00:00+00:00">
August 31, 2013
</time>
</h4>
</header>
<div class="post-body">
<div class="paragraph">
<p>We learned about the different registers available in the Atmel AVR microcontroller to program the TWI interface. In this section we&#8217;ll go through the twi_init API and the initialization of the TWI interface.</p>
</div>
<div class="paragraph">
<p>The initialization code in the <a href="https://github.com/zeuzoix/sardine/blob/master/testbench.c">testbench.c</a> initializes the
TWI/I2C library as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c">x_twi_init_params.e_mode = eTWI_INIT_MODE_16_0000M_100K_1;
x_twi_init_params.pfn_debug = testbench_debug;
e_twi_ret = twi_init(&amp;x_twi_init_params);
<span style="color:#080;font-weight:bold">if</span>(eTWI_SUCCESS != e_twi_ret)
{
   i_ret = -<span style="color:#00D">1</span>;
   <span style="color:#080;font-weight:bold">goto</span> LBL_INIT_IO_RET;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The API <em>twi_init</em> takes a structure variable x_twi_init_params of the type
shown below.  The definition is in <a href="https://github.com/zeuzoix/sardine/blob/master/twi.h">twi.h</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#080;font-weight:bold">typedef</span> <span style="color:#080;font-weight:bold">struct</span> _TWI_INIT_PARAMS_X
{
   TWI_INIT_MODE_E e_mode;
   TWI_DEBUG_PFN pfn_debug;

}TWI_INIT_PARAMS_X;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The TWI interface can be initialized based on several modes each of which
is given an identifier which signifies the CPU clock frequency, SCL clock
speed and the pre-scaler value. For instance in the enumeration definition
below <em>eTWI_INIT_MODE_16_0000M_100K_1</em> is the mode for a 16.0000MHz
micro-controller, with the desired SCL clock frequency set at 100KHz and
the pre-scaler set to 1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#080;font-weight:bold">typedef</span> <span style="color:#080;font-weight:bold">enum</span> _TWI_INIT_MODE_E
{
   eTWI_INIT_MODE_16_0000M_100K_1 = <span style="color:#00D">0</span>,
   eTWI_INIT_MODE_16_0000M_400K_1,
   eTWI_INIT_MODE_16_0000M_100K_4,
   eTWI_INIT_MODE_16_0000M_400K_4,
   eTWI_INIT_MODE_INVALID

}TWI_INIT_MODE_E;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Internally if we take a look at the twi_init function defined in
<a href="https://github.com/zeuzoix/sardine/blob/master/twi.c">twi.c</a> we see a look up table is employed to initialize the
5 registers TWBR, TWCR, TWSR, TWDR, TWAR. The look up table has the
following structure for each row:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#080;font-weight:bold">typedef</span> <span style="color:#080;font-weight:bold">struct</span> _TWI_INIT_REG_X
{
   TWI_INIT_MODE_E e_mode;
   uint8_t uc_twbr;
   uint8_t uc_twcr;
   uint8_t uc_twsr;
   uint8_t uc_twdr;
   uint8_t uc_twar;

}TWI_INIT_REG_X;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The lookup table is a global array gxa_init_reg and is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#088;font-weight:bold">static</span> TWI_INIT_REG_X gxa_init_reg[] =
{
   {
      eTWI_INIT_MODE_16_0000M_100K_1,
      <span style="color:#02b">0x48</span>,                               <span style="color:#777">//0b01001000</span>
      <span style="color:#02b">0x80</span>,                               <span style="color:#777">//0b10000000</span>
      <span style="color:#02b">0x00</span>,                               <span style="color:#777">//0b00000000</span>
      <span style="color:#02b">0x00</span>,                               <span style="color:#777">//0b00000000</span>
      <span style="color:#02b">0x00</span>                                <span style="color:#777">//0b00000000</span>
   }
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code in twi_init cycles through the array gxa_init_reg until it finds
the correct mode and then initializes the 5 registers with the values associated
with the mode.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#080;font-weight:bold">for</span>(uc_i = <span style="color:#00D">0</span> ; uc_i &lt; uc_size_arr ; uc_i++)
{
   <span style="color:#080;font-weight:bold">if</span>(px_init_params-&gt;e_mode == gxa_init_reg[uc_i].e_mode)
   {
      px_init_reg = &amp;gxa_init_reg[uc_i];
      <span style="color:#080;font-weight:bold">break</span>;
   }
}

<span style="color:#080;font-weight:bold">if</span>(<span style="color:#069">NULL</span> == px_init_reg)
{
   <span style="color:#080;font-weight:bold">if</span>(<span style="color:#069">NULL</span> != px_init_params-&gt;pfn_debug)
   {
      px_init_params-&gt;pfn_debug(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Can't find correct mode</span><span style="color:#710">&quot;</span></span>);
   }

   e_ret = eTWI_FAILURE;
   <span style="color:#080;font-weight:bold">goto</span> LBL_TWI_INIT_RET;
}

TWBR = px_init_reg-&gt;uc_twbr;
TWCR = px_init_reg-&gt;uc_twcr;
TWSR = px_init_reg-&gt;uc_twsr;
TWDR = px_init_reg-&gt;uc_twdr;
TWAR = px_init_reg-&gt;uc_twar;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the <a href="http://zeuzoix.github.io/techeuphoria/posts/2013/09/07/i2c-twi-with-avr-data-transfer/">next</a> section we&#8217;ll check out transmit
and receive functionality on the TWI/I2C bus with I2C/TWI with AVR Data Transfer.</p>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/electronics/">electronics</a>
, <a href="/techeuphoria/posts/tag/protocols/">protocols</a>
, <a href="/techeuphoria/posts/tag/i2c/">i2c</a>
, <a href="/techeuphoria/posts/tag/twi/">twi</a>
, <a href="/techeuphoria/posts/tag/bus/">bus</a></div>
</footer>
<hr>
<div id="comments">

            <div id="disqus_thread"></div>
            <script type="text/javascript">
            var disqus_shortname = 'zeuzoix-techblog';
            var disqus_url = "http://zeuzoix.github.io/techeuphoria/posts/2013/08/31/i2c-twi-with-avr-register-initialization/";
            var disqus_developer = null;
            var disqus_identifier = "352de9285ed265d1e0b312d1878f2f735bd62126";
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=zeuzoix-techblog">comments powered by Disqus.</a></noscript>
          
</div>
<hr>
</article>


</div>
</div>
<footer class="row" style="max-width: 100%">
<hr>
<div class="large-6 columns">
<p style="margin-bottom: .75em">
&copy; conrad.s.j.gomes@gmail.com 2016
<br>
Built on Foundation. Baked by Awestruct. Composed with Asciidoc
</p>
</div>
<div class="large-6 columns">
<ul class="inline-list right">
<li>
<a href="http://zeuzoix.github.io/techeuphoria/">Home</a>
</li>
</ul>
</div>
</footer>
<script>
document.write('<script src=' + ('__proto__' in {} ? 'http://zeuzoix.github.io/techeuphoria/javascripts/vendor/zepto' : 'http://zeuzoix.github.io/techeuphoria/javascripts/vendor/jquery') + '.js><\/script>')
</script>
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/foundation/foundation.js"></script>
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/foundation/foundation.topbar.js"></script>
<script>
$(document).foundation()
</script>
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-61553633-1']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</body>
</html>
