<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title>A Technical Odyssey</title>
<link href="http://zeuzoix.github.io/techeuphoria/stylesheets/app.css" rel="stylesheet">
<link href="/techeuphoria/feed.xml" rel="alternate" type="application/atom+xml">
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/vendor/custom.modernizr.js"></script>
<link href="http://zeuzoix.github.io/techeuphoria/humans.txt" rel="author" type="text/plain">
</head>
<body class="antialiased">
<div class="fixed-width">
<nav class="top-bar">
<ul class="title-area">
<li class="name">
<h1>
<a href="/techeuphoria/">
TechEuphoria
</a>
</h1>
</li>
<li class="toggle-topbar menu-icon">
<a href="#"><span></span></a>
</li>
</ul>
<section class="top-bar-section">
<ul class="left">
<li class="divider">
<li>
<a href="/techeuphoria/quests/index.html">/quests</a>
</li>
</li>
<li class="divider"></li>
</ul>
</section>
</nav>
</div>
<div class="row">
<div class="large-12 columns">
<h1></h1>
</div>
</div>
<div class="row" id="content">
<div class="large-12 columns">
<div class="row">
<div class="large-12 columns posts">
<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2015/04/21/benchmarking-rt-preempt-kernel-on-beaglebone-black/">Benchmarking RT Preempt Kernel 3.18 On BeagleBone Black</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2015-04-21T00:00:00+00:00">
April 21, 2015
</time>
</h4>
</header>
<div class="post-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this post we will run the cyclictest utility and benchmark the RT Preempt Kernel on BeagleBone Black We need to check the realtime performance of the RT Preempt kernel against
the vanilla kernel. To do this we will run the <a href="https://rt.wiki.kernel.org/index.php/Cyclictest" target="_blank">cyclictest</a> utility and measure the
performance.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="clone-the-em-rt-tests-em-sources"><a class="anchor" href="#clone-the-em-rt-tests-em-sources"></a>Clone The <em>rt-tests</em> Sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First clone the source code</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git$ git clone git://git.kernel.org/pub/scm/linux/kernel/git/clrkwllms/rt-tests.git
Cloning into 'rt-tests'...
remote: Counting objects: 2830, done.
remote: Total 2830 (delta 0), reused 0 (delta 0)
Receiving objects: 100% (2830/2830), 512.57 KiB | 164.00 KiB/s, done.
Resolving deltas: 100% (1692/1692), done.
Checking connectivity... done.
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git$</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cross-compiling-the-em-rt-tests-em-sources"><a class="anchor" href="#cross-compiling-the-em-rt-tests-em-sources"></a>Cross-Compiling The <em>rt-tests</em> Sources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cross-compile the rt-tests by passing the CC as arm-linux-gnueabi-gcc.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Do not use CROSS_COMPILE</div>
<div class="paragraph">
<p>The cyclictest wiki states that CROSS_COMPILE is to be used in order to
cross-compile the sources. However this is not honored by the Makefile
and will lead to a build of x86 binaries instead of ARM binaries. Use
CC instead and it should work.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/rt-tests$ make CC=arm-linux-gnueabi-gcc clean                <i class="conum" data-value="1"></i><b>(1)</b>
for F in cyclictest pi_stress pip_stress pmqtest rt-migrate-test signaltest ptsematest sigwaittest svsematest sendme hackbench *.o .depend *.*~ *.orig *.rej rt-tests.spec *.d *.a  ChangeLog; do find -type f -name $F | xargs rm -f; done
rm -f hwlatdetect
rm -f tags
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/rt-tests$
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/rt-tests$ make CC=arm-linux-gnueabi-gcc all                <i class="conum" data-value="2"></i><b>(2)</b>
arm-linux-gnueabi-gcc -D VERSION_STRING=0.91 -c src/cyclictest/cyclictest.c -Wall -Wno-nonnull -O2 -D_GNU_SOURCE -Isrc/include
In file included from src/cyclictest/cyclictest.c:39:0:
src/cyclictest/rt_numa.h: In function ‘numa_on_and_available’:
src/cyclictest/rt_numa.h:259:2: warning: implicit declaration of function ‘numa_available’ [-Wimplicit-function-declaration]
src/cyclictest/cyclictest.c: In function ‘tracemark’:
src/cyclictest/cyclictest.c:433:7: warning: ignoring return value of ‘write’, declared with attribute warn_unused_result [-Wunused-result]
src/cyclictest/cyclictest.c: In function ‘tracing’:
src/cyclictest/cyclictest.c:446:9: warning: ignoring return value of ‘write’, declared with attribute warn_unused_result [-Wunused-result]
src/cyclictest/cyclictest.c:456:9: warning: ignoring return value of ‘write’, declared with attribute warn_unused_result [-Wunused-result]
arm-linux-gnueabi-gcc -D VERSION_STRING=0.91 -c src/lib/rt-utils.c -Wall -Wno-nonnull -O2 -D_GNU_SOURCE -Isrc/include
arm-linux-gnueabi-gcc -D VERSION_STRING=0.91 -c src/lib/error.c -Wall -Wno-nonnull -O2 -D_GNU_SOURCE -Isrc/include
arm-linux-gnueabi-gcc -D VERSION_STRING=0.91 -c src/lib/rt-get_cpu.c -Wall -Wno-nonnull -O2 -D_GNU_SOURCE -Isrc/include
arm-linux-gnueabi-gcc -D VERSION_STRING=0.91 -c src/lib/rt-sched.c -Wall -Wno-nonnull -O2 -D_GNU_SOURCE -Isrc/include
ar rcs librttest.a rt-utils.o error.o rt-get_cpu.o rt-sched.o
arm-linux-gnueabi-gcc -Wall -Wno-nonnull -O2  -o cyclictest cyclictest.o librttest.a -lrt -lpthread -lrttest -L.
.
.
.
ln -s src/hwlatdetect/hwlatdetect.py hwlatdetect
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/rt-tests$
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/rt-tests$ file cyclictest                                                                <i class="conum" data-value="3"></i><b>(3)</b>
cyclictest: ELF 32-bit LSB  executable, ARM, EABI5 version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.32, BuildID[sha1]=f849bb56948e70e80282318453629a15d4eb4844, not stripped
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/rt-tests$
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/rt-tests$ cp cyclictest ~/fe-kernel-training/linux-kernel-labs/modules/nfsroot/bin/.        <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cleaning the source code</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Cross-compiling all</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <em>file</em> command shows it has been cross-compiled</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Copy the cyclictest to the NFS root filesystem folder</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally we boot up the board and test if we&#8217;re able to print the version of
<em>cyclictest</em> with the "-h" option.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># cyclictest --help
cyclictest V 0.91        <i class="conum" data-value="1"></i><b>(1)</b>
Usage:
cyclictest &lt;options&gt;
.
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Version is 0.91</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="different-configurations-of-the-kernel"><a class="anchor" href="#different-configurations-of-the-kernel"></a>Different Configurations Of The Kernel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will be evaluating for different versions of the RT Preempt 3.18 kernel
for BeagleBone Black. The instructions to port RT Preempt to the BeagleBone
Black kernel are given in the following posts:<br></p>
</div>
<div class="paragraph">
<div class="title">http://zeuzoix.github.io/techeuphoria/posts/2015/04/16/port-rt-preempt-to-kernel-3point18-for-beaglebone-black-part2/[http://zeuzoix.github.io/techeuphoria/posts/2015/04/16/port-rt-preempt-to-kernel-3point18-for-beaglebone-black-part2/^]</div>
<p>We create four different builds with different preemption configuraitons
to compare the real-time behavior of the kernels. To change the configuration
we go to Kernel Features --&#8594; Preemption Model and select the type of
preemption required.</p>
</div>
<div class="sect2">
<h3 id="no-forced-preemption"><a class="anchor" href="#no-forced-preemption"></a>No Forced Preemption</h3>
<div class="exampleblock">
<div class="content">
<div id="benchmark-rt-no-forced-preemption" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/benchmark-rt-no-forced-preemption.png"><img src="http://zeuzoix.github.io/techeuphoria/images/benchmark-rt-no-forced-preemption.png" alt="benchmark rt no forced preemption" width="640" height="480"></a>
</div>
<div class="title">Figure 1. Preemption model for no forced preemption</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preemptible-kernel-low-latency-desktop"><a class="anchor" href="#preemptible-kernel-low-latency-desktop"></a>Preemptible Kernel (Low-Latency Desktop)</h3>
<div class="exampleblock">
<div class="content">
<div id="benchmark-rt-preemptible-kernel-low-latency" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/benchmark-rt-preemptible-kernel-low-latency.png"><img src="http://zeuzoix.github.io/techeuphoria/images/benchmark-rt-preemptible-kernel-low-latency.png" alt="benchmark rt preemptible kernel low latency" width="640" height="480"></a>
</div>
<div class="title">Figure 2. Preemption model for preemptible kernel (low latency desktop)</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preemptible-kernel-basic-rt"><a class="anchor" href="#preemptible-kernel-basic-rt"></a>Preemptible Kernel (Basic RT)</h3>
<div class="exampleblock">
<div class="content">
<div id="benchmark-rt-preemptible-kernel-basic-rt" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/benchmark-rt-preemptible-kernel-basic-rt.png"><img src="http://zeuzoix.github.io/techeuphoria/images/benchmark-rt-preemptible-kernel-basic-rt.png" alt="benchmark rt preemptible kernel basic rt" width="640" height="480"></a>
</div>
<div class="title">Figure 3. Preemption model for basic rt preemptible kernel</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fully-preemptible-kernel"><a class="anchor" href="#fully-preemptible-kernel"></a>Fully Preemptible Kernel</h3>
<div class="exampleblock">
<div class="content">
<div id="benchmark-rt-fully-preemptible-kernel" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/benchmark-rt-fully-preemptible-kernel.png"><img src="http://zeuzoix.github.io/techeuphoria/images/benchmark-rt-fully-preemptible-kernel.png" alt="benchmark rt fully preemptible kernel" width="640" height="480"></a>
</div>
<div class="title">Figure 4. Preemption model for fully preemptible kernel</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="torturing-the-kernel"><a class="anchor" href="#torturing-the-kernel"></a>Torturing The Kernel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll follow the steps given in the following link to benchmark the various kernels:<br>
<a href="http://erlerobotics.gitbooks.io/erle-robotics-erle-brain-a-linux-brain-for-drones/content/en/software/kernel.html" target="_blank">http://erlerobotics.gitbooks.io/erle-robotics-erle-brain-a-linux-brain-for-drones/content/en/software/kernel.html</a></p>
</div>
<div class="paragraph">
<p>First we run <em>stress</em> in the background to spawn 64 CPU intensive tasks,
64 input/ouput tasks and 2 tasks spinning on malloc/free.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># stress --cpu 64 --io 64 --vm 2 --vm-bytes 128M &amp;
# stress: info: [220] dispatching hogs: 64 cpu, 64 io, 2 vm, 0 hdd        <i class="conum" data-value="1"></i><b>(1)</b>

#
# ps
PID   USER     COMMAND
    1 root     init
    2 root     [kthreadd]
    3 root     [ksoftirqd/0]
.
.
.
  220 root     stress --cpu 64 --io 64 --vm 2 --vm-bytes 128M                <i class="conum" data-value="2"></i><b>(2)</b>
  221 root     stress --cpu 64 --io 64 --vm 2 --vm-bytes 128M
.
.
.
  351 root     ps
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Running <em>stress</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The tasks spawned by <em>stress</em> are listed using the <em>ps</em> command</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The load gradually increases and we wait until it is greater than
100 as shown below. We use <em>uptime</em> to measure the load on the system. It gives
the system load averages for the past 1, 5 and 15 minutes.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>System load averages is the average number of processes that are either in a
runnable or uninterruptable state. A process in a runnable state is either
using the CPU or waiting to use the CPU. A process in uninterruptable state
is waiting for some I/O access, eg waiting for disk.</p>
</div>
</blockquote>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># uptime
 00:52:19 up 45 min,  load average: 28.94, 6.42, 2.44
# uptime
 00:52:24 up 45 min,  load average: 37.03, 8.47, 3.12
# uptime
 00:52:26 up 45 min,  load average: 37.03, 8.47, 3.12
# uptime
 00:52:28 up 45 min,  load average: 44.55, 10.51, 3.81
# uptime
 00:52:30 up 45 min,  load average: 44.55, 10.51, 3.81
# uptime
 00:52:41 up 46 min,  load average: 57.69, 14.44, 5.16
#
# uptime
 00:56:54 up 50 min,  load average: 128.98, 80.81, 35.15        <i class="conum" data-value="1"></i><b>(1)</b>
# uptime
 01:03:24 up 56 min,  load average: 130.07, 116.68, 67.69        <i class="conum" data-value="2"></i><b>(2)</b>
#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The load crosses 128 which indicates that on average the 130(64 + 64 + 2) tasks are created</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The load after 3 minutes has increased to ~130 and the 5 minute load has also increased to 67.69</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="running-em-cyclictest-em"><a class="anchor" href="#running-em-cyclictest-em"></a>Running <em>cyclictest</em></h2>
<div class="sectionbody">
<div class="paragraph">
<p>After the system has been "stressed" out we can run the <em>cyclictest</em> to measure
the latencies(us). This will give us the realtime performance of the kernels.
We will now compare the results of the different kernels.</p>
</div>
<div class="sect2">
<h3 id="no-forced-preemption-2"><a class="anchor" href="#no-forced-preemption-2"></a>No Forced Preemption</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Min</dt>
<dd>
<p>15 us</p>
</dd>
<dt class="hdlist1">Avg</dt>
<dd>
<p>36 us</p>
</dd>
<dt class="hdlist1">Max</dt>
<dd>
<p>2235 us</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># cyclictest -t1 -p 80 -n -i 10000 -l 10000
# /dev/cpu_dma_latency set to 0us
policy: fifo: loadavg: 130.62 100.00 48.77 131/180 279

T: 0 (  283) P:80 I:10000 C:  10000 Min:     15 Act:   31 Avg:   36 Max:    2235
#</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preemptible-low-latency-kernel"><a class="anchor" href="#preemptible-low-latency-kernel"></a>Preemptible Low Latency Kernel</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Min</dt>
<dd>
<p>19 us</p>
</dd>
<dt class="hdlist1">Avg</dt>
<dd>
<p>32 us</p>
</dd>
<dt class="hdlist1">Max</dt>
<dd>
<p>233 us</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># cyclictest -t1 -p 80 -n -i 10000 -l 10000
# /dev/cpu_dma_latency set to 0us
policy: fifo: loadavg: 130.61 95.66 45.16 131/186 248

T: 0 (  247) P:80 I:10000 C:  10000 Min:     19 Act:   32 Avg:   32 Max:     233
#</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="preemptible-basic-rt-kernel"><a class="anchor" href="#preemptible-basic-rt-kernel"></a>Preemptible Basic RT Kernel</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Min</dt>
<dd>
<p>19 us</p>
</dd>
<dt class="hdlist1">Avg</dt>
<dd>
<p>34 us</p>
</dd>
<dt class="hdlist1">Max</dt>
<dd>
<p>183 us</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># cyclictest -t1 -p 80 -n -i 10000 -l 10000
# /dev/cpu_dma_latency set to 0us
policy: fifo: loadavg: 130.78 98.49 47.44 132/202 260

T: 0 (  260) P:80 I:10000 C:  10000 Min:     19 Act:   36 Avg:   34 Max:     183
#</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="fully-preemptible-rt-kernel"><a class="anchor" href="#fully-preemptible-rt-kernel"></a>Fully Preemptible RT Kernel</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Min</dt>
<dd>
<p>14 us</p>
</dd>
<dt class="hdlist1">Avg</dt>
<dd>
<p>26 us</p>
</dd>
<dt class="hdlist1">Max</dt>
<dd>
<p>43 us</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash"># cyclictest -t1 -p 80 -n -i 10000 -l 10000
# /dev/cpu_dma_latency set to 0us
policy: fifo: loadavg: 130.74 111.39 60.19 68/205 269

T: 0 (  268) P:80 I:10000 C:  10000 Min:     14 Act:   26 Avg:   26 Max:      43
#</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary-of-tests"><a class="anchor" href="#summary-of-tests"></a>Summary Of Tests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We see that the minimum, average and maximum latencies are lowest for the
fully preemptible RT Kernel.</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Kernel Type</th>
<th class="tableblock halign-left valign-top">Min (us)</th>
<th class="tableblock halign-left valign-top">Avg (us)</th>
<th class="tableblock halign-left valign-top">Max(us)</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">No Forced Preemption</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">15</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">36</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">2235</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preemptible Low Latency Kernel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">32</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">233</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Preemptible Basic RT Kernel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">19</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">34</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">183</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fully Preemptible RT Kernel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">14</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">26</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">43</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The compiled kernels, configuration files, generated device tree binaries, modules
and firmware are available <a href="https://github.com/zeuzoix/compiled-binaries/tree/master/benchmark-rt-kernels" target="_blank">here</a>.</p>
</div>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/kernel/">kernel</a>
, <a href="/techeuphoria/posts/tag/beagleboneblack/">beagleboneblack</a>
, <a href="/techeuphoria/posts/tag/rtlinux/">rtlinux</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2015/04/16/port-rt-preempt-to-kernel-3point18-for-beaglebone-black-part2/">Porting RT Preempt To Kernel 3.18 For BeagleBone Black - Part 2</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2015-04-16T00:00:00+00:00">
April 16, 2015
</time>
</h4>
</header>
<div class="post-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In the second part we will take a look and see how to apply the RT-Preempt patches to the 3.18 kernel for BeagleBone Black. This is a continuation of a previous <a href="http://zeuzoix.github.io/techeuphoria/posts/2015/04/13/port-rt-preempt-to-kernel-3point18-for-beaglebone-black-part1/" target="_blank">post</a> where we built
the 3.18 version and tested it on the BeagleBone Black.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rt-preempt-information"><a class="anchor" href="#rt-preempt-information"></a>RT Preempt Information</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The instructions to apply the patches are given in the
<a href="https://rt.wiki.kernel.org" target="_blank">Real-Time Linux Wiki</a>. It would be advisable to first go
through the <a href="https://rt.wiki.kernel.org/index.php/Frequently_Asked_Questions" target="_blank">FAQs</a> section and get a general understanding
on RT Linux.</p>
</div>
<div class="paragraph">
<p>To apply the patches we go through the <a href="https://rt.wiki.kernel.org/index.php/RT_PREEMPT_HOWTO" target="_blank">RT Preempt Howto</a>
which describes the general procedure. In the document the patches are applied
on top of the vanilla kernel sources taken from
<a href="http://kernel.org/" target="_blank">http://kernel.org/</a>. However we will have to apply the patches
on top of <a href="http://www.rcn-ee.com/" target="_blank">Robert Nelson&#8217;s</a> bb-kernel sources for
version 3.18 which we used in the <a href="http://zeuzoix.github.io/techeuphoria/posts/2015/04/13/port-rt-preempt-to-kernel-3point18-for-beaglebone-black-part1/" target="_blank">previous post</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="locating-the-correct-patches"><a class="anchor" href="#locating-the-correct-patches"></a>Locating The Correct Patches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>After going through the <a href="https://rt.wiki.kernel.org/index.php/RT_PREEMPT_HOWTO" target="_blank">RT Preempt Howto</a>, it becomes clear
that there are different patches for different versions of the kernel source at:<br></p>
</div>
<div class="paragraph">
<p><a href="https://www.kernel.org/pub/linux/kernel/projects/rt/" target="_blank">https://www.kernel.org/pub/linux/kernel/projects/rt/</a></p>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-patches" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-patches.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-patches.png" alt="rt preempt patches" width="640" height="480"></a>
</div>
<div class="title">Figure 1. The patches for each kernel version</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We cannot randomly apply any of the patches to our kernel source tree. We have
to find the RT-Preempt patch version which fits the kernel verison we are using.</p>
</div>
<div class="paragraph">
<p>The exact version of our kernel can be determined from the Makefile in the kernel
tree. As shown below our version is <strong>3.18.5</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/KERNEL$ head Makefile
VERSION = 3
PATCHLEVEL = 18
SUBLEVEL = 5
EXTRAVERSION =
NAME = Diseased Newt

# *DOCUMENTATION*
# To see a list of typical targets execute &quot;make help&quot;
# More info can be located in ./README
# Comments in this file are targeted only to the developer, do not
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/KERNEL$</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we check the patches available in the <em>3.18</em> folder of the
rt-preempt patches location we see the latest version is at <strong>3.18.11</strong>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-patches-3point18" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-patches-3point18.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-patches-3point18.png" alt="rt preempt patches 3point18" width="640" height="480"></a>
</div>
<div class="title">Figure 2. The latest patches for 3.18 kernel</div>
</div>
</div>
</div>
<div class="paragraph">
<p>There is a mismatch, we cannot use the 3.18.11 patches as our source
code is of version 3.18.5. We take a look at the older patches in the
<em>older</em> directory. The oldest version available is <strong>3.18.7</strong>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-patches-3point18-older" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-patches-3point18-older.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-patches-3point18-older.png" alt="rt preempt patches 3point18 older" width="640" height="480"></a>
</div>
<div class="title">Figure 3. The latest patches for 3.18 kernel</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="searching-for-a-solution"><a class="anchor" href="#searching-for-a-solution"></a>Searching For A Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this point we have to search for a solution as it looks like the rt-preempt
patches are not compatible with the 3.18.5 kernel. After a bit of online browsing
an answer was found on the <a href="https://eewiki.net/dashboard.action" target="_blank">wiki</a> maintained by the
aplication engineers at <a href="http://www.digikey.com" target="_blank">Digi-Key Corporation</a> in the comments
page for BeagleBone Black:</p>
</div>
<div class="paragraph">
<p><a href="https://eewiki.net/display/linuxonarm/BeagleBone+Black+Comments" target="_blank">https://eewiki.net/display/linuxonarm/BeagleBone+Black+Comments</a></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I got the 3.18.5-bone1 kernel working with hard real time! I simply applied the
nearest available RT patch (patch-3.18.7-rt1.patch.xz), and by golly the patch
had no rejects and only 4 "offset x lines" messages! And the updated kernel
compiled cleanly and working right away! I really really didn&#8217;t expect that.</p>
</div>
<div class="paragraph">
<p>I didn&#8217;t bother to investigate the "offset" cases, since 3 of them were for
other architectures, and the other was for raid5.c, which is a module that
I don&#8217;t need.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; John S. Rhoades
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="downloading-and-applying-the-patches"><a class="anchor" href="#downloading-and-applying-the-patches"></a>Downloading And Applying The Patches</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will not download the patch used by John i.e. patch-3.18.7-rt1.patch.xz
instead we will download the latest real-time patch for 3.18.7 i.e.
<em>patch-3.18.7-rt2.patch.gz</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Wget$ wget https://www.kernel.org/pub/linux/kernel/projects/rt/3.18/older/patch-3.18.7-rt2.patch.gz                <i class="conum" data-value="1"></i><b>(1)</b>
--2015-04-15 12:52:34--  https://www.kernel.org/pub/linux/kernel/projects/rt/3.18/older/patch-3.18.7-rt2.patch.gz
Resolving www.kernel.org (www.kernel.org)... 149.20.4.69, 198.145.20.140, 199.204.44.194, ...
Connecting to www.kernel.org (www.kernel.org)|149.20.4.69|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 183993 (180K) [application/x-gzip]
Saving to: ‘patch-3.18.7-rt2.patch.gz’

100%[=============================================================================================================================================================================================================================&gt;] 183,993     88.2KB/s   in 2.0s

2015-04-15 12:52:37 (88.2 KB/s) - ‘patch-3.18.7-rt2.patch.gz’ saved [183993/183993]</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Downloading the patch with <em>wget</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we will apply the patch on top of our <em>KERNEL</em> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Wget$ cd ~/Git/bb-kernel/KERNEL/                <i class="conum" data-value="1"></i><b>(1)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/KERNEL$ zcat ~/Wget/patch-3.18.7-rt2.patch.gz | patch -p1        <i class="conum" data-value="2"></i><b>(2)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/KERNEL$ zcat ~/Wget/patch-3.18.7-rt2.patch.gz | patch -p1
patching file Documentation/hwlat_detector.txt
patching file Documentation/sysrq.txt
.
.
patching file arch/s390/mm/fault.c
Hunk #1 succeeded at 429 (offset -6 lines).        <i class="conum" data-value="3"></i><b>(3)</b>
.
.
patching file arch/sh/mm/fault.c
Hunk #1 succeeded at 438 (offset -2 lines).        <i class="conum" data-value="4"></i><b>(4)</b>
.
.
patching file arch/x86/mm/fault.c
Hunk #1 succeeded at 1133 (offset 5 lines).        <i class="conum" data-value="5"></i><b>(5)</b>
.
.
patching file drivers/md/raid5.c
Hunk #3 succeeded at 5704 (offset -5 lines).        <i class="conum" data-value="6"></i><b>(6)</b>
.
.
patching file net/sched/sch_generic.c
patching file scripts/mkcompile_h
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/KERNEL$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Change to the 3.18 kernel tree which we built in the previous part</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Apply the patch without uncompressing before applying it</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ignoring as for s390</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Ignoring as for sh</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Ignoring as for x86</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Raid not required</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="rebuilding-after-patching"><a class="anchor" href="#rebuilding-after-patching"></a>Rebuilding After Patching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So now that the patches have been applied we will see if it has broken
our build by rebuilding the kernel as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ ./tools/rebuild.sh
+ Detected build host [Ubuntu 14.04.2 LTS]
+ host: [i686]
+ git HEAD commit: [496f173e9148f4662257a6023435b429cfa5e69e]
-----------------------------
scripts/gcc: Using: arm-linux-gnueabi-gcc (Ubuntu/Linaro 4.7.3-12ubuntu1) 4.7.3
Copyright (C) 2012 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
-----------------------------
CROSS_COMPILE=/usr/bin/arm-linux-gnueabi-
scripts/kconfig/mconf Kconfig
.
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Again we&#8217;re shown the <em>menuconfig</em> screen. Just exit and save the configuration
and let the build proceed. The build completes successfully outputing the built
binaries and archives on the console as was seen in the previous part when we
built the vanilla kernel.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
.
‘arch/arm/boot/zImage’ -&gt; ‘/home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1.zImage’        <i class="conum" data-value="1"></i><b>(1)</b>
‘.config’ -&gt; ‘/home/conrad/Git/bb-kernel/deploy/config-3.18.5-rt2-bone1’
-rwxrwxr-x 1 conrad conrad 6.5M Apr 15 18:33 /home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1.zImage
-----------------------------
Building modules archive...
Compressing 3.18.5-rt2-bone1-modules.tar.gz...
-rw-rw-r-- 1 conrad conrad 18M Apr 15 18:33 /home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1-modules.tar.gz
-----------------------------
Building firmware archive...
Compressing 3.18.5-rt2-bone1-firmware.tar.gz...
-rw-rw-r-- 1 conrad conrad 1.2M Apr 15 18:33 /home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1-firmware.tar.gz
-----------------------------
Building dtbs archive...
Compressing 3.18.5-rt2-bone1-dtbs.tar.gz...
-rw-rw-r-- 1 conrad conrad 952K Apr 15 18:33 /home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1-dtbs.tar.gz        <i class="conum" data-value="2"></i><b>(2)</b>
-----------------------------
Script Complete
eewiki.net: [user@localhost:~$ export kernel_version=3.18.5-rt2-bone1]        <i class="conum" data-value="3"></i><b>(3)</b>
-----------------------------
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The zImage built</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The device tree binaries archive</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Version of the kernel that was built which is <em>3.18.5-rt2-bone1</em></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="testing-the-patched-kernel"><a class="anchor" href="#testing-the-patched-kernel"></a>Testing The Patched Kernel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will follow the same steps as the part 1 section, "Testing The Kernel"
and copy the <em>3.18.5-rt2-bone1.zImage</em> binary and the device tree binary to
the TFTP server folder to be downloaded and booted through U-Boot.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ sudo cp 3.18.5-rt2-bone1.zImage /var/lib/tftpboot/
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ mkdir temp        <i class="conum" data-value="1"></i><b>(1)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ cd temp/
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy/temp$ tar xvzf ../3.18.5-rt2-bone1-dtbs.tar.gz         <i class="conum" data-value="2"></i><b>(2)</b>
am335x-base0033.dtb
am335x-bone-4dcape-43.dtb
.
.
omap3-zoom3.dtb
omap3430-sdp.dtb
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy/temp$
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy/temp$ sudo cp -a am335x-boneblack.dtb /var/lib/tftpboot/am335x-boneblack.3.18.5-rt2-bone1.dtb        <i class="conum" data-value="3"></i><b>(3)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy/temp$ cd ..
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ rm -Rf temp/                <i class="conum" data-value="4"></i><b>(4)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Make a temporary directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extract the archive file in the temporary directory</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Copy the <em>am335x-boneblack.dtb</em> device tree binary to the TFTP download
folder as <em>am335x-boneblack.3.18.5-rt2-bone1.dtb</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Remove the temporary directory</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="booting-the-patched-kernel"><a class="anchor" href="#booting-the-patched-kernel"></a>Booting The Patched Kernel</h3>
<div class="paragraph">
<p>We now boot the kernel <em>3.18.5-rt2-bone1.zImage</em> along with the device
tree binary to see if it loads properly. We also print the version information
to make sure it gives the right string.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
U-Boot# tftpboot 0x81000000 3.18.5-rt2-bone1.zImage                        <i class="conum" data-value="1"></i><b>(1)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename '3.18.5-rt2-bone1.zImage'.
Load address: 0x81000000
Loading: #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         ########
         1.3 MiB/s
done
Bytes transferred = 6783096 (678078 hex)
U-Boot# tftpboot 0x82000000 am335x-boneblack.3.18.5-rt2-bone1.dtb        <i class="conum" data-value="2"></i><b>(2)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename 'am335x-boneblack.3.18.5-rt2-bone1.dtb'.
Load address: 0x82000000
Loading: #####
         1.2 MiB/s
done
Bytes transferred = 65155 (fe83 hex)
U-Boot# bootz 0x81000000 - 0x82000000                                        <i class="conum" data-value="3"></i><b>(3)</b>
Kernel image @ 0x81000000 [ 0x000000 - 0x678078 ]
## Flattened Device Tree blob at 82000000
   Booting using the fdt blob at 0x82000000
   Using Device Tree in place at 82000000, end 82012e82

Starting kernel ...

[    0.000000] Booting Linux on physical CPU 0x0
[    0.000000] Initializing cgroup subsys cpuset
.
.
Welcome to Buildroot
buildroot login: root
#
#
# uname -a
Linux buildroot 3.18.5-rt2-bone1 #2 Wed Apr 15 18:30:15 IST 2015 armv7l GNU/Linux        <i class="conum" data-value="4"></i><b>(4)</b>
# [   36.134860] random: nonblocking pool is initialized
# halt 1                                <i class="conum" data-value="5"></i><b>(5)</b>
The system is going down NOW!
Sent SIGTERM to all processes
Sent SIGKILL to all processes
Requesting system halt
[  773.768416] musb-hdrc musb-hdrc.1.auto: remove, state 4
[  773.773932] usb usb1: USB disconnect, device number 1
[  773.779789] musb-hdrc musb-hdrc.1.auto: USB bus 1 deregistered
[  773.786629] reboot: System halted</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Downloading <em>3.18.5-rt2-bone1.zImage</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Downloading <em>am335x-boneblack.3.18.5-rt2-bone1.dtb</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Booting the zImage</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The string <em>3.18.5-rt2-bone1</em> indicates the kernel version</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Properly halting the system</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The patched kernel boots well so now we have the confidence to enable
full real-time support.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-full-real-time-support"><a class="anchor" href="#configuring-full-real-time-support"></a>Configuring Full Real-Time Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will have to run the <em>./tools/rebuild.sh</em> script again to allow us
to configure the full real-time support for the kernel. There are two
options we will have to enable. We refer to the section,
<a href="https://rt.wiki.kernel.org/index.php/Frequently_Asked_Questions#Configuring.2Fcompiling_CONFIG_PREEMPT_RT" target="_blank">Configuring/compiling CONFIG_PREEMPT_RT</a>
and enable <em>CONFIG_PREEMPT_RT_FULL (=y)</em> and <em>CONFIG_HIGH_RES_TIMERS (=y)</em>.</p>
</div>
<div class="paragraph">
<p>On executing the <em>./tools/rebuild.sh</em> script we will again get the
<em>menuconfig</em> screen. This time we have to enable the above values.
First we search for <em>CONFIG_PREEMPT_RT_FULL</em> (Hit the '/' key on the
menuconfig screen).</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-menuconfig-search-config-preempt-rt-full" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-menuconfig-search-config-preempt-rt-full.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-menuconfig-search-config-preempt-rt-full.png" alt="rt preempt menuconfig search config preempt rt full" width="640" height="480"></a>
</div>
<div class="title">Figure 4. Searching for <em>CONFIG_PREEMPT_RT_FULL</em></div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-menuconfig-search-config-preempt-rt-full-1" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-menuconfig-search-config-preempt-rt-full-1.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-menuconfig-search-config-preempt-rt-full-1.png" alt="rt preempt menuconfig search config preempt rt full 1" width="640" height="480"></a>
</div>
<div class="title">Figure 5. Search results for <em>CONFIG_PREEMPT_RT_FULL</em>. It is located at &#8594; Kernel Features &#8594; Preemptible Kernel</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-menuconfig-search-config-preempt-rt-full-4" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-menuconfig-search-config-preempt-rt-full-4.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-menuconfig-search-config-preempt-rt-full-4.png" alt="rt preempt menuconfig search config preempt rt full 4" width="640" height="480"></a>
</div>
<div class="title">Figure 6. Enabling Fully Preemptible Kernel(RT)</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Secondly we search for <em>CONFIG_HIGH_RES_TIMERS</em>.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-menuconfig-search-config-high-res-timers" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-menuconfig-search-config-high-res-timers.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-menuconfig-search-config-high-res-timers.png" alt="rt preempt menuconfig search config high res timers" width="640" height="480"></a>
</div>
<div class="title">Figure 7. Searching for <em>CONFIG_HIGH_RES_TIMERS</em></div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-menuconfig-search-config-high-res-timers-1" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-menuconfig-search-config-high-res-timers-1.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-menuconfig-search-config-high-res-timers-1.png" alt="rt preempt menuconfig search config high res timers 1" width="640" height="480"></a>
</div>
<div class="title">Figure 8. Search results for <em>CONFIG_HIGH_RES_TIMERS</em>. It is located at &#8594; General setup &#8594; Timers subsystem</div>
</div>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-menuconfig-search-config-high-res-timers-4" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-menuconfig-search-config-high-res-timers-4.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-menuconfig-search-config-high-res-timers-4.png" alt="rt preempt menuconfig search config high res timers 4" width="640" height="480"></a>
</div>
<div class="title">Figure 9. The CONFIG_HIGH_RES_TIMERS is enabled</div>
</div>
</div>
</div>
<div class="paragraph">
<p>After saving and exiting the <em>menuconfig</em> screen the build will proceed.
The build is successful and we get similar results as the previous build
in terms of output logs from the build script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
.
  LD [M]  sound/usb/misc/snd-ua101.ko
  LD [M]  sound/usb/snd-usb-audio.ko
  LD [M]  sound/usb/snd-usbmidi-lib.ko
-----------------------------
make -j2 ARCH=arm LOCALVERSION=-bone1 CROSS_COMPILE=/usr/bin/arm-linux-gnueabi- dtbs
-----------------------------
  CHK     include/config/kernel.release
  CHK     include/generated/uapi/linux/version.h
  CHK     include/generated/utsrelease.h
make[1]: `include/generated/mach-types.h' is up to date.
  CALL    scripts/checksyscalls.sh
‘arch/arm/boot/zImage’ -&gt; ‘/home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1.zImage’
‘.config’ -&gt; ‘/home/conrad/Git/bb-kernel/deploy/config-3.18.5-rt2-bone1’
-rwxrwxr-x 1 conrad conrad 6.7M Apr 15 21:57 /home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1.zImage        <i class="conum" data-value="1"></i><b>(1)</b>
-----------------------------
Building modules archive...
Compressing 3.18.5-rt2-bone1-modules.tar.gz...
-rw-rw-r-- 1 conrad conrad 18M Apr 15 21:58 /home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1-modules.tar.gz
-----------------------------
Building firmware archive...
Compressing 3.18.5-rt2-bone1-firmware.tar.gz...
-rw-rw-r-- 1 conrad conrad 1.2M Apr 15 21:58 /home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1-firmware.tar.gz
-----------------------------
Building dtbs archive...
Compressing 3.18.5-rt2-bone1-dtbs.tar.gz...
-rw-rw-r-- 1 conrad conrad 952K Apr 15 21:58 /home/conrad/Git/bb-kernel/deploy/3.18.5-rt2-bone1-dtbs.tar.gz        <i class="conum" data-value="2"></i><b>(2)</b>
-----------------------------
Script Complete
eewiki.net: [user@localhost:~$ export kernel_version=3.18.5-rt2-bone1]                <i class="conum" data-value="3"></i><b>(3)</b>
-----------------------------</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The full real-time zImage is built</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The device tree binaries archive. This should ideally be the same everytime
unless we modify the device tree source files.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Version of the kernel that was built which is <em>3.18.5-rt2-bone1</em></td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="booting-the-rt-preempt-kernel"><a class="anchor" href="#booting-the-rt-preempt-kernel"></a>Booting The RT-Preempt Kernel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To test the kernel we copy the <em>3.18.5-rt2-bone1.zImage</em> to the TFTP server
folder with a slightly different name i.e. 3.18.5-rt2-bone1.rt.zImage in
order to differentiate it from our previous image built without RT-Preempt
support. The rest of the steps are similar to our previous kernel load.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
.

U-Boot# tftpboot 0x81000000 3.18.5-rt2-bone1.rt.zImage                        <i class="conum" data-value="1"></i><b>(1)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename '3.18.5-rt2-bone1.rt.zImage'.
Load address: 0x81000000
Loading: #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         ######################
         1.3 MiB/s
done
Bytes transferred = 6991248 (6aad90 hex)
U-Boot# tftpboot 0x82000000 am335x-boneblack.3.18.5-rt2-bone1.dtb        <i class="conum" data-value="2"></i><b>(2)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename 'am335x-boneblack.3.18.5-rt2-bone1.dtb'.
Load address: 0x82000000
Loading: #####
         1.1 MiB/s
done
Bytes transferred = 65155 (fe83 hex)
U-Boot# bootz 0x81000000 - 0x82000000                                        <i class="conum" data-value="3"></i><b>(3)</b>
Kernel image @ 0x81000000 [ 0x000000 - 0x6aad90 ]
## Flattened Device Tree blob at 82000000
   Booting using the fdt blob at 0x82000000
   Using Device Tree in place at 82000000, end 82012e82

Starting kernel ...

[    0.000000] Booting Linux on physical CPU 0x0
[    0.000000] Initializing cgroup subsys cpuset
[    0.000000] Initializing cgroup subsys cpu
[    0.000000] Initializing cgroup subsys cpuacct
[    0.000000] Linux version 3.18.5-rt2-bone1 (conrad@conrad-HP-Pavilion-dm3-Notebook-PC) (gcc version 4.7.3 (Ubuntu/Linaro 4.7.3-12ubuntu1) ) #3 PREEMPT RT Wed Apr 15 21:54:59 IST 2015
[    0.000000] CPU: ARMv7 Processor [413fc082] revision 2 (ARMv7), cr=50c5387d
.
.
.
[    7.370106] Freeing unused kernel memory: 452K (c0977000 - c09e8000)
Starting logging: OK
Initializing random number generator... [    7.890589] random: dd urandom read with 67 bits of entropy available
done.
Starting network...
ip: RTNETLINK answers: File exists
Starting dropbear sshd: OK

Welcome to Buildroot
buildroot login: root
#
# [  206.655634] random: nonblocking pool is initialized
# dmesg | grep -ri &quot;preempt&quot;
[    0.000000] Linux version 3.18.5-rt2-bone1 (conrad@conrad-HP-Pavilion-dm3-Notebook-PC) (gcc version 4.7.3 (Ubuntu/Linaro 4.7.3-12ubuntu1) ) #3 PREEMPT RT Wed Apr 15 21:54:59 IST 2015
[    0.000000] Preemptible hierarchical RCU implementation.
# uname -a
Linux buildroot 3.18.5-rt2-bone1 #3 PREEMPT RT Wed Apr 15 21:54:59 IST 2015 armv7l GNU/Linux        <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Downloading <em>3.18.5-rt2-bone1.rt.zImage</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Downloading <em>am335x-boneblack.3.18.5-rt2-bone1.dtb</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Booting the zImage</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The PREEMPT RT differentiates this kernel string version from the previous one.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We were successfully able to port RT-Preempt to the 3.18 kernel from Robert Nelson&#8217;s
bb-kernel branch and boot the fully real-time kernel. We can now carry out tests with
this kernel and benchmark its performance.</p>
</div>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/kernel/">kernel</a>
, <a href="/techeuphoria/posts/tag/beagleboneblack/">beagleboneblack</a>
, <a href="/techeuphoria/posts/tag/rtlinux/">rtlinux</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2015/04/14/port-rt-preempt-to-kernel-3point18-for-beaglebone-black-part1/">Porting RT Preempt To Kernel 3.18 For BeagleBone Black - Part 1</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2015-04-14T00:00:00+00:00">
April 14, 2015
</time>
</h4>
</header>
<div class="post-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The RT-Preempt patch converts Linux into a fully preemptible kernel. In the first part we&#8217;ll build the 3.18 version of the kernel for the BeagleBone Black using Robert Nelson&#8217;s bb-kernel tree. It is important to make sure that the kernel source code on which we
will be applying our patches does not have any problems before we go on to
build and test the realtime preemptible kernel.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="cloning-the-beaglebone-black-kernel"><a class="anchor" href="#cloning-the-beaglebone-black-kernel"></a>Cloning The BeagleBone Black Kernel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We will need to clone the kernel repository from
<a href="http://www.rcn-ee.com/" target="_blank">Robert Nelson&#8217;s</a> github account. The repository
is located at <a href="https://github.com/zeuzoix/bb-kernel.git" target="_blank">https://github.com/zeuzoix/bb-kernel.git</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git$ git clone https://github.com/zeuzoix/bb-kernel.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will then checkout the branch we&#8217;re interested in and name the branch am33x-v3.18-vanila.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ git checkout -b am33x-v3.18-vanila remotes/origin/am33x-v3.18</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="understanding-the-build-process"><a class="anchor" href="#understanding-the-build-process"></a>Understanding The Build Process</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The repository contains a set of scripts to build a known working kernel for
ARM devices. The directory structure of the am33x-v3.18 branch is shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git$ cd bb-kernel/
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ ls -l
total 100
drwxrwxr-x 3 conrad conrad  4096 Apr 13 12:35 3rdparty
-rwxrwxr-x 1 conrad conrad  5932 Apr 13 12:35 build_deb.sh
-rwxrwxr-x 1 conrad conrad  8028 Apr 13 12:35 build_kernel.sh
-rw-rw-r-- 1 conrad conrad  1111 Apr 13 12:35 LICENSE
drwxrwxr-x 8 conrad conrad  4096 Apr 13 12:35 patches
-rw-rw-r-- 1 conrad conrad 20860 Apr 13 12:35 patch.sh
-rw-rw-r-- 1 conrad conrad  1006 Apr 13 12:35 README                        <i class="conum" data-value="1"></i><b>(1)</b>
drwxrwxr-x 2 conrad conrad  4096 Apr 13 12:35 repo_maintenance
drwxrwxr-x 2 conrad conrad  4096 Apr 13 15:12 scripts
-rwxrwxr-x 1 conrad conrad  9584 Apr 13 12:35 sgx_build_modules.sh
-rwxrwxr-x 1 conrad conrad  9586 Apr 13 12:35 sgx_create_package.sh
-rw-rw-r-- 1 conrad conrad  1454 Apr 13 12:35 system.sh.sample
drwxrwxr-x 2 conrad conrad  4096 Apr 14 10:29 tools
-rw-rw-r-- 1 conrad conrad   724 Apr 13 12:35 version.sh
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Readme with instructions on how to run the build</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To understand the build process we have to go through the <em>README</em> file.
We also skim through the <em>build_kernel.sh</em> script to get an idea of what
will happen when we run it.</p>
</div>
<div class="sect2">
<h3 id="setting-em-linux_git-em"><a class="anchor" href="#setting-em-linux_git-em"></a>Setting <em>LINUX_GIT</em></h3>
<div class="paragraph">
<p>We will set the <em>LINUX_GIT</em> variable in <em>system.sh</em> based on the following
instructions from the <em>README</em>.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>If you&#8217;ve already cloned torvalds tree and would like to save some hard drive
space, just modify the LINUX_GIT variable in system.sh to point to your current
git clone directory.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>We will first copy the <em>system.sh.sample</em> file as <em>system.sh</em> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ cp -v system.sh.sample system.sh
‘system.sh.sample’ -&gt; ‘system.sh’</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then open <em>system.sh</em> and uncomment the <em>LINUX_GIT</em> variable and replace the value with
the full path of the locally cloned tree.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ cat system.sh
#!/bin/sh
#copy as &quot;system.sh&quot; and tweak for your system

ARCH=$(uname -m)
.
.
.
###OPTIONAL: LINUX_GIT: specify location of locally cloned git tree.
#
LINUX_GIT=/home/conrad/Git/linux                        <i class="conum" data-value="1"></i><b>(1)</b>
.
.
.
###ADVANCED: AUTO_BUILD: Easier integration with Jenkins/Buildbot/etc..
#
#AUTO_BUILD=1</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We&#8217;ve uncommented <em>LINUX_GIT</em> and subsituted with our cloned path i.e.
/home/conrad/Git/linux</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="setting-em-cc-em"><a class="anchor" href="#setting-em-cc-em"></a>Setting <em>CC</em></h3>
<div class="paragraph">
<p>To prevent a download of a gcc cross compiler from Linaro we subsitute the
value of the <em>CC</em> variable in <em>system.sh</em> with our installed cross-compiler
which was installed using the APT utility. If it is not installed there&#8217;s
no need to set <em>CC</em> as the script will do it for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ dpkg -L gcc-arm-linux-gnueabi
/.
/usr
/usr/bin
/usr/share
/usr/share/doc
/usr/share/man
/usr/share/man/man1
/usr/bin/arm-linux-gnueabi-gcc                        <i class="conum" data-value="1"></i><b>(1)</b>
/usr/bin/arm-linux-gnueabi-gcov
/usr/share/doc/gcc-arm-linux-gnueabi
/usr/share/man/man1/arm-linux-gnueabi-gcov.1.gz
/usr/share/man/man1/arm-linux-gnueabi-gcc.1.gz</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This path is required for <em>CC</em></td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ cat system.sh
.
.
###REQUIRED:

#ARM GCC CROSS Compiler:
#if CC is not set, a known working linaro based gcc compiler will be downloaded and utilized.
CC=/usr/bin/arm-linux-gnueabi-                        <i class="conum" data-value="1"></i><b>(1)</b>
#CC=&lt;enter full path&gt;/bin/arm-none-eabi-
#CC=&lt;enter full path&gt;/bin/arm-linux-gnueabi-
#CC=&lt;enter full path&gt;/bin/arm-linux-gnueabihf-
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Our subsitutuion of <em>CC</em> with <em>/usr/bin/arm-linux-gnueabi-</em></td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="missing-dependencies"><a class="anchor" href="#missing-dependencies"></a>Missing Dependencies</h3>
<div class="paragraph">
<p>Once the <em>system.sh</em> is configured its time to give the <em>build_kernel.sh</em>
a whirl and see what happens. The script initially checks to see if everything
it needs in the system are in order. It looks like the script has found
something with my system.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ ./build_kernel.sh
+ Detected build host [Ubuntu 14.04.2 LTS]
+ host: [i686]
+ git HEAD commit: [496f173e9148f4662257a6023435b429cfa5e69e]
Debian/Ubuntu/Mint: missing dependencies, please install:
-----------------------------
sudo apt-get update
sudo apt-get install device-tree-compiler lzma lzop                         <i class="conum" data-value="1"></i><b>(1)</b>
-----------------------------
* Failed dependency check
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Dependencies that could be mssing</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The instructions to fix the dependencies are given so we follow it through.
First with the the system update.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ sudo apt-get update                <i class="conum" data-value="1"></i><b>(1)</b>
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
Ign http://dl.google.com stable InRelease
Get:1 http://dl.google.com stable Release.gpg [198 B]
Get:2 http://dl.google.com stable Release [1,347 B]
Get:3 http://dl.google.com stable/main i386 Packages [724 B]
.
.
.
Ign http://lk.archive.ubuntu.com trusty/restricted Translation-en_US
Ign http://lk.archive.ubuntu.com trusty/universe Translation-en_US
Fetched 2,392 kB in 30s (78.5 kB/s)
Reading package lists... Done</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Doing a system update</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second step is to install the missing dependencies i.e.
<em>device-tree-compiler</em>, <em>lzma</em> and <em>lzop</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ sudo apt-get install device-tree-compiler lzma lzop        <i class="conum" data-value="1"></i><b>(1)</b>
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following packages were automatically installed and are no longer required:
  linux-headers-3.13.0-36 linux-headers-3.13.0-36-generic
  linux-image-3.13.0-36-generic linux-image-extra-3.13.0-36-generic
Use 'apt-get autoremove' to remove them.
The following NEW packages will be installed:
  device-tree-compiler lzma lzop
0 upgraded, 3 newly installed, 0 to remove and 257 not upgraded.
Need to get 454 kB of archives.
After this operation, 797 kB of additional disk space will be used.
Get:1 http://lk.archive.ubuntu.com/ubuntu/ trusty/main lzma i386 9.22-2ubuntu2 [53.6 kB]
Get:2 http://lk.archive.ubuntu.com/ubuntu/ trusty/universe lzop i386 1.03-3 [43.6 kB]
Get:3 http://lk.archive.ubuntu.com/ubuntu/ trusty/main device-tree-compiler i386 1.4.0+dfsg-1 [357 kB]
Fetched 454 kB in 6s (70.3 kB/s)
Selecting previously unselected package lzma.
(Reading database ... 532551 files and directories currently installed.)
Preparing to unpack .../lzma_9.22-2ubuntu2_i386.deb ...
Unpacking lzma (9.22-2ubuntu2) ...
Selecting previously unselected package lzop.
Preparing to unpack .../archives/lzop_1.03-3_i386.deb ...
Unpacking lzop (1.03-3) ...
Selecting previously unselected package device-tree-compiler.
Preparing to unpack .../device-tree-compiler_1.4.0+dfsg-1_i386.deb ...
Unpacking device-tree-compiler (1.4.0+dfsg-1) ...
Processing triggers for man-db (2.6.7.1-1ubuntu1) ...
Processing triggers for doc-base (0.10.5) ...
Processing 2 added doc-base files...
Setting up lzma (9.22-2ubuntu2) ...                <i class="conum" data-value="2"></i><b>(2)</b>
update-alternatives: using /usr/bin/lzmp to provide /usr/bin/lzma (lzma) in auto mode
Setting up lzop (1.03-3) ...                                <i class="conum" data-value="3"></i><b>(3)</b>
Setting up device-tree-compiler (1.4.0+dfsg-1) ...        <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to install the dependencies</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setting up <em>lzma</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Setting up <em>lsop</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Setting up device-tree-compiler</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="building-the-kernel"><a class="anchor" href="#building-the-kernel"></a>Building The Kernel</h3>
<div class="paragraph">
<p>After the missing dependencies are fixed we re-run the <em>build_kernel.sh</em> script.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$ ./build_kernel.sh
+ Detected build host [Ubuntu 14.04.2 LTS]                                        <i class="conum" data-value="1"></i><b>(1)</b>
+ host: [i686]
+ git HEAD commit: [496f173e9148f4662257a6023435b429cfa5e69e]
-----------------------------
scripts/gcc: Using: arm-linux-gnueabi-gcc (Ubuntu/Linaro 4.7.3-12ubuntu1) 4.7.3
Copyright (C) 2012 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
-----------------------------
CROSS_COMPILE=/usr/bin/arm-linux-gnueabi-                                        <i class="conum" data-value="2"></i><b>(2)</b>
-----------------------------
scripts/git: Debug: LINUX_GIT is setup as: [/home/conrad/Git/linux].
scripts/git: [url=git://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git
url=git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git]
.
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Host detected correctly by the <em>build_kernel.sh</em> script</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set the <em>CROSS_COMPILE</em> as per our <em>CC</em> variable modifications in <em>system.sh</em></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Withing a few minutes the kernel configuration <em>menuconfig</em> screen is pulled up.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="rt-preempt-vanilla-linux-kernel-menuconfig" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/rt-preempt-vanilla-linux-kernel-menuconfig.png"><img src="http://zeuzoix.github.io/techeuphoria/images/rt-preempt-vanilla-linux-kernel-menuconfig.png" alt="rt preempt vanilla linux kernel menuconfig" width="640" height="480"></a>
</div>
<div class="title">Figure 1. The <em>menuconfig</em> configuration screen for the 3.18 vanilla kernel</div>
</div>
</div>
</div>
<div class="paragraph">
<p>For now we exit the configuration without any modifications to check and see if
the kernel builds correctly. The execution of the script will take time based
on the number of cores present on the workstation. The following shows the build
successfully completed after saving the configuration in the previous step.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
.
‘arch/arm/boot/zImage’ -&gt; ‘/home/conrad/Git/bb-kernel/deploy/3.18.5-bone1.zImage’
‘.config’ -&gt; ‘/home/conrad/Git/bb-kernel/deploy/config-3.18.5-bone1’
-rwxrwxr-x 1 conrad conrad 6.5M Apr 14 12:33 /home/conrad/Git/bb-kernel/deploy/3.18.5-bone1.zImage        <i class="conum" data-value="1"></i><b>(1)</b>
-----------------------------
Building modules archive...
Compressing 3.18.5-bone1-modules.tar.gz...
-rw-rw-r-- 1 conrad conrad 18M Apr 14 12:33 /home/conrad/Git/bb-kernel/deploy/3.18.5-bone1-modules.tar.gz
-----------------------------
Building firmware archive...
Compressing 3.18.5-bone1-firmware.tar.gz...
-rw-rw-r-- 1 conrad conrad 1.2M Apr 14 12:33 /home/conrad/Git/bb-kernel/deploy/3.18.5-bone1-firmware.tar.gz
-----------------------------
Building dtbs archive...
Compressing 3.18.5-bone1-dtbs.tar.gz...
-rw-rw-r-- 1 conrad conrad 952K Apr 14 12:34 /home/conrad/Git/bb-kernel/deploy/3.18.5-bone1-dtbs.tar.gz        <i class="conum" data-value="2"></i><b>(2)</b>
-----------------------------
Script Complete
eewiki.net: [user@localhost:~$ export kernel_version=3.18.5-bone1]        <i class="conum" data-value="3"></i><b>(3)</b>
-----------------------------
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The zImage built</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The device tree binaries archive</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Version of the kernel that was built</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="testing-the-kernel"><a class="anchor" href="#testing-the-kernel"></a>Testing The Kernel</h3>
<div class="paragraph">
<p>The setup being used is similar to the Lab instructions at the links
below.<br></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://zeuzoix.github.io/techeuphoria/quests/beagleboneblacktux/#lab-2-setting-up-the-beaglebone-black-board" target="_blank">LAB 2 : Setting Up The Beaglebone Black Board</a></p>
</li>
<li>
<p><a href="http://zeuzoix.github.io/techeuphoria/quests/beagleboneblacktux/#lab-3-cross-compiling-the-kernel-and-booting-it-from-the-workstation" target="_blank">LAB 3 : Cross Compiling The Kernel And Booting It From The Workstation</a></p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="open-serial-port-with-em-picocom-em"><a class="anchor" href="#open-serial-port-with-em-picocom-em"></a>Open Serial Port With <em>picocom</em></h4>
<div class="paragraph">
<p>Now we connect the serial USB-FTDI cable and start <em>picocom</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ picocom -b 115200 /dev/ttyUSB0
picocom v1.7

port is        : /dev/ttyUSB0
flowcontrol    : none
baudrate is    : 115200
parity is      : none
databits are   : 8
escape is      : C-a
local echo is  : no
noinit is      : no
noreset is     : no
nolock is      : no
send_cmd is    : sz -vv
receive_cmd is : rz -vv
imap is        :
omap is        :
emap is        : crcrlf,delbs,

Terminal ready</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="power-up-and-interrupt-u-boot"><a class="anchor" href="#power-up-and-interrupt-u-boot"></a>Power Up And Interrupt U-Boot</h4>
<div class="paragraph">
<p>Let&#8217;s connect the power cable and interrupt the boot loader.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot SPL 2013.10 (Nov 28 2013 - 06:36:11)
reading args
spl: error reading image args, err - -1
reading u-boot.img
reading u-boot.img


U-Boot 2013.10 (Nov 28 2013 - 06:36:11)

I2C:   ready
DRAM:  512 MiB
WARNING: Caches not enabled
MMC:   OMAP SD/MMC: 0, OMAP SD/MMC: 1
Net:   cpsw, usb_ether
Hit any key to stop autoboot:  0
U-Boot#
U-Boot# version

U-Boot 2013.10 (Nov 28 2013 - 06:36:11)                <i class="conum" data-value="1"></i><b>(1)</b>
arm-linux-gnueabi-gcc (Ubuntu/Linaro 4.7.3-1ubuntu1) 4.7.3
GNU ld (GNU Binutils for Ubuntu) 2.23.52.20130913
U-Boot# help bootz
bootz - boot Linux zImage image from memory        <i class="conum" data-value="2"></i><b>(2)</b>

Usage:
bootz [addr [initrd[:size]] [fdt]]
    - boot Linux zImage stored in memory
        The argument 'initrd' is optional and specifies the address
        of the initrd in memory. The optional argument ':size' allows
        specifying the size of RAW initrd.
        When booting a Linux kernel which requires a flat device-tree
        a third argument is required which is the address of the
        device-tree blob. To boot that kernel without an initrd image,
        use a '-' for the second argument. If you do not pass a third
        a bd_info struct will be passed instead

U-Boot#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We check the version used is 2013.10</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Our U-Boot version supports <em>bootz</em> so we should be able to boot the
zImage</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="download-the-zimage"><a class="anchor" href="#download-the-zimage"></a>Download The zImage</h4>
<div class="paragraph">
<p>To test the kernel we will place the built zImage in the tftpboot folder:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ sudo cp -a 3.18.5-bone1.zImage /var/lib/tftpboot/
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$</code></pre>
</div>
</div>
<div class="paragraph">
<p>First make sure the TFTP service is restarted</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ sudo service tftpd-hpa restart
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
tftpd-hpa stop/waiting
tftpd-hpa start/running, process 5082
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then download the zImage using tftpboot to address 0x81000000</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# printenv ipaddr
ipaddr=192.168.0.100                <i class="conum" data-value="1"></i><b>(1)</b>
U-Boot# printenv serverip
serverip=192.168.0.1                <i class="conum" data-value="2"></i><b>(2)</b>
U-Boot#
U-Boot# tftp 0x81000000 3.18.5-bone1.zImage        <i class="conum" data-value="3"></i><b>(3)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename '3.18.5-bone1.zImage'.
Load address: 0x81000000
Loading: #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #################################################################
         #######
         1.3 MiB/s
done
Bytes transferred = 6779136 (677100 hex)        <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The board&#8217;s IP is set to <em>192.168.0.100</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The server i.e. our workstation IP is set to <em>192.168.0.1</em></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We issue the <em>tftpboot</em> command</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <em>3.18.5-bone1.zImage</em> has been downloaded successfully</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="download-the-device-tree-binary"><a class="anchor" href="#download-the-device-tree-binary"></a>Download The Device Tree Binary</h4>
<div class="paragraph">
<p>Additionally we need to download a device tree binary for the BeagleBone
Black. The possible device tree binaries were built and stored in the
archive in the deploy folder. We extract the archive and save the
<em>am335x-boneblack.dtb</em> file to the TFTP server folder</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ mkdir temp                <i class="conum" data-value="1"></i><b>(1)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ cd temp/
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy/temp$ ls
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy/temp$ tar xvzf ../3.18.5-bone1-dtbs.tar.gz         <i class="conum" data-value="2"></i><b>(2)</b>
am335x-base0033.dtb
am335x-bone-4dcape-43.dtb
am335x-bone-4dcape-43t.dtb
am335x-bone-4dcape-70.dtb
am335x-bone-4dcape-70t.dtb
am335x-bone-audio-reva.dtb
.
.
.

map3-thunder.dtb
omap3-zoom3.dtb
omap3430-sdp.dtb
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy/temp$ sudo cp -a am335x-boneblack.dtb /var/lib/tftpboot/am335x-boneblack.3.18.5-bone1.dtb        <i class="conum" data-value="3"></i><b>(3)</b>
[sudo] password for conrad:
no talloc stackframe at ../source3/param/loadparm.c:4864, leaking memory
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ rm -Rf temp/        <i class="conum" data-value="4"></i><b>(4)</b>
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Make a temporary directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extract the archive file in the temporary directory</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Copy the <em>am335x-boneblack.dtb</em> device tree binary to the TFTP download
folder as <em>am335x-boneblack.3.18.5-bone1.dtb</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Remove the temporary directory</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now download the device tree binary to the board using tftpboot to address
0x82000000.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# tftp 0x82000000 am335x-boneblack.3.18.5-bone1.dtb        <i class="conum" data-value="1"></i><b>(1)</b>
link up on port 0, speed 100, full duplex
Using cpsw device
TFTP from server 192.168.0.1; our IP address is 192.168.0.100
Filename 'am335x-boneblack.3.18.5-bone1.dtb'.
Load address: 0x82000000
Loading: #####
         1.2 MiB/s
done
Bytes transferred = 65155 (fe83 hex)        <i class="conum" data-value="2"></i><b>(2)</b>
U-Boot#</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Downloading <em>am335x-boneblack.3.18.5-bone1.dtb</em> to 0x82000000</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The device tree binary has been downloaded</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="booting-the-kernel"><a class="anchor" href="#booting-the-kernel"></a>Booting The Kernel</h4>
<div class="paragraph">
<p>Our U-Boot environment has been configured with the following bootargs for
the kernel:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# printenv bootargs
bootargs=root=/dev/nfs rw ip=192.168.0.100 console=ttyO0 nfsroot=192.168.0.1:/home/conrad/fe-kernel-training/linux-kernel-labs/modules/nfsroot
U-Boot#</code></pre>
</div>
</div>
<div class="paragraph">
<p>We check to see if our kernel has been configured with NFS root filesystem
settings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$ grep -ri &quot;_NFS&quot; config-3.18.5-bone1
CONFIG_NFS_FS=y                                                <i class="conum" data-value="1"></i><b>(1)</b>
CONFIG_NFS_V2=y
CONFIG_NFS_V3=y
CONFIG_NFS_V3_ACL=y
CONFIG_NFS_V4=y
CONFIG_NFS_SWAP=y
CONFIG_NFS_V4_1=y
CONFIG_NFS_V4_2=y
CONFIG_NFS_V4_1_IMPLEMENTATION_ID_DOMAIN=&quot;kernel.org&quot;
# CONFIG_NFS_V4_1_MIGRATION is not set
CONFIG_NFS_V4_SECURITY_LABEL=y
CONFIG_ROOT_NFS=y                                        <i class="conum" data-value="2"></i><b>(2)</b>
# CONFIG_NFS_USE_LEGACY_DNS is not set
CONFIG_NFS_USE_KERNEL_DNS=y
CONFIG_NFS_DEBUG=y
CONFIG_NFSD=m
CONFIG_NFSD_V2_ACL=y
CONFIG_NFSD_V3=y
CONFIG_NFSD_V3_ACL=y
CONFIG_NFSD_V4=y
# CONFIG_NFSD_V4_SECURITY_LABEL is not set
# CONFIG_NFSD_FAULT_INJECTION is not set
CONFIG_NFS_ACL_SUPPORT=y
CONFIG_NFS_COMMON=y
CONFIG_NCPFS_NFS_NS=y
conrad@conrad-HP-Pavilion-dm3-Notebook-PC:~/Git/bb-kernel/deploy$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>NFS filesystem support is present</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>NFS Root filesystem  is present</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now issue the boot command with <em>bootz</em> specifying the kernel address
and the device tree binary address which were downloaded with <em>tftpboot</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">U-Boot# bootz 0x81000000 - 0x82000000                        <i class="conum" data-value="1"></i><b>(1)</b>
Kernel image @ 0x81000000 [ 0x000000 - 0x677100 ]
## Flattened Device Tree blob at 82000000
   Booting using the fdt blob at 0x82000000
   Using Device Tree in place at 82000000, end 82012e82

Starting kernel ...

[    0.000000] Booting Linux on physical CPU 0x0
[    0.000000] Initializing cgroup subsys cpuset
[    0.000000] Initializing cgroup subsys cpu
[    0.000000] Initializing cgroup subsys cpuacct
[    0.000000] Linux version 3.18.5-bone1 (conrad@conrad-HP-Pavilion-dm3-Notebook-PC) (gcc version 4.7.3 (Ubuntu/Linaro 4.7.3-12ubuntu1) ) #1 Tue Apr 14 12:30:08 IST 2015
[    0.000000] CPU: ARMv7 Processor [413fc082] revision 2 (ARMv7), cr=50c5387d
.
.
.
[    7.045937] VFS: Mounted root (nfs filesystem) on device 0:14.
[    7.052337] devtmpfs: mounted
[    7.055911] Freeing unused kernel memory: 448K (c092c000 - c099c000)
Starting logging: OK
Initializing random number generator... [    7.397510] random: dd urandom read with 77 bits of entropy available
done.
Starting network...
ip: RTNETLINK answers: File exists
Starting dropbear sshd: OK

Welcome to Buildroot                <i class="conum" data-value="2"></i><b>(2)</b>
buildroot login: root
# uname -a
Linux buildroot 3.18.5-bone1 #1 Tue Apr 14 12:30:08 IST 2015 armv7l GNU/Linux        <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We issue the <em>bootz</em> command specifying addresses of the kernel and device
tree binary</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The NFS root filesystem is successfully booted</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We confirm the version of the kernel as 3.18.5-bone1</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We were able to successfully build and test the 3.18 kernel from Robert Nelson&#8217;s
bb-kernel branch. This is important as it gives us the confidence to proceed with
applying the rt-preempt patches.</p>
</div>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/kernel/">kernel</a>
, <a href="/techeuphoria/posts/tag/beagleboneblack/">beagleboneblack</a>
, <a href="/techeuphoria/posts/tag/rtlinux/">rtlinux</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2015/02/06/imx28-ltib-bsp-build-part2/">Building The i.MX28 Board Support Package (BSP) With LTIB - Part 2</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2015-02-06T00:00:00+00:00">
February  6, 2015
</time>
</h4>
</header>
<div class="post-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In the first part we worked on getting LTIB configured for our machine. We ran into alot of problems but fixed each problem after a bit of online reading. In this part we attempt to actually build the bootloaders, kernel and applications with LTIB which will comprise the BSP</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-ltib-for-i-mx28"><a class="anchor" href="#configuring-ltib-for-i-mx28"></a>Configuring LTIB for i.MX28</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LTIB Offers a lot of flexibility in choosing the type of embedded system that
is required for the platform. Depending on the use case different aspects can
be configured using <em>ltib</em>.</p>
</div>
<div class="sect2">
<h3 id="selecting-the-platform"><a class="anchor" href="#selecting-the-platform"></a>Selecting The Platform</h3>
<div class="paragraph">
<p>On running <em>ltib</em> it will display the ncurses dialog which is used to select
the desired platform. In our case it is Freescale iMX reference boards as shown
below:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-ncurses-platform-selection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-ncurses-platform-selection.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-ncurses-platform-selection.png" alt="imx28 ltib bsp build freescale ncurses platform selection" width="640" height="480"></a>
</div>
<div class="title">Figure 1. Ncurses screen with platform selection</div>
</div>
</div>
</div>
<div class="paragraph">
<p>On exiting it will ask you if you want to save the configuration. Make sure
"yes" is selected and then exit:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-ncurses-save-new-configuration" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-ncurses-save-new-configuration.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-ncurses-save-new-configuration.png" alt="imx28 ltib bsp build freescale ncurses save new configuration" width="640" height="480"></a>
</div>
<div class="title">Figure 2. Saving the new configuration</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="selecting-the-freescale-platform-type-and-profile"><a class="anchor" href="#selecting-the-freescale-platform-type-and-profile"></a>Selecting The Freescale Platform Type And Profile</h3>
<div class="paragraph">
<p>It will then ask you to select the type of Freescale as i.MX28 development platform</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-ncurses-select-mx28-platform-chose-platform" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-ncurses-select-mx28-platform-chose-platform.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-ncurses-select-mx28-platform-chose-platform.png" alt="imx28 ltib bsp build freescale ncurses select mx28 platform chose platform" width="640" height="480"></a>
</div>
<div class="title">Figure 3. Selecting the type of development platform as imx28</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Also select the package profile. We select the "(Min profile)"</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-ncurses-select-mx28-platform-type-preconfig-min-profile" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-ncurses-select-mx28-platform-type-preconfig-min-profile.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-ncurses-select-mx28-platform-type-preconfig-min-profile.png" alt="imx28 ltib bsp build freescale ncurses select mx28 platform type preconfig min profile" width="640" height="480"></a>
</div>
<div class="title">Figure 4. Selecting the type of profile as "Min profile"</div>
</div>
</div>
</div>
<div class="paragraph">
<p>On exiting it will ask you if you want to save the configuration. Make sure
"yes" is selected and then exit:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-ncurses-platform-selection-save-new-configuration" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-ncurses-platform-selection-save-new-configuration.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-ncurses-platform-selection-save-new-configuration.png" alt="imx28 ltib bsp build freescale ncurses platform selection save new configuration" width="640" height="480"></a>
</div>
<div class="title">Figure 5. Saving the new configuration of development platform</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="configuring-the-freescale-i-mx28-board-package"><a class="anchor" href="#configuring-the-freescale-i-mx28-board-package"></a>Configuring The Freescale i.MX28 Board Package</h3>
<div class="paragraph">
<p>We see the ncurses configuration page for the i.MX28 board. From here the various
features of the board can be configured.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-ncurses-mx28-board-configuration" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-ncurses-mx28-board-configuration.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-ncurses-mx28-board-configuration.png" alt="imx28 ltib bsp build freescale ncurses mx28 board configuration" width="640" height="480"></a>
</div>
<div class="title">Figure 6. Saving and exiting without modifying the default configuration</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="default-build"><a class="anchor" href="#default-build"></a>Default Build</h3>
<div class="paragraph">
<p>The configuration loaded can be built without modifying it. We can take a look
and see what&#8217;s happening just by hitting exit and running the <em>LTIB</em> build. The
steps are hit <em>exit</em>. Then save the configuration when prompted on the ncurses
screen. We see is a failure to build of the kind:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Installing: gcc-4.6.2-glibc-2.13-linaro-multilib-2011.12-1.i386.rpm
Try gcc-4.6.2-glibc-2.13-linaro-multilib-2011.12-1.i386.rpm.md5 from the PPP  <i class="conum" data-value="1"></i><b>(1)</b>
Try gcc-4.6.2-glibc-2.13-linaro-multilib-2011.12-1.i386.rpm.md5 from the GPP
http://bitshrine.org/gpp/gcc-4.6.2-glibc-2.13-linaro-multilib-2011.12-1.i386.rpm.md5:
22:44:07 ERROR 404: Not Found.
Try gcc-4.6.2-glibc-2.13-linaro-multilib-2011.12-1.i386.rpm from the PPP
Try gcc-4.6.2-glibc-2.13-linaro-multilib-2011.12-1.i386.rpm from the GPP
http://bitshrine.org/gpp/gcc-4.6.2-glibc-2.13-linaro-multilib-2011.12-1.i386.rpm:
22:44:08 ERROR 404: Not Found.
Can't get: gcc-4.6.2-glibc-2.13-linaro-multilib-2011.12-1.i386.rpm at ./ltib line 2560.   <i class="conum" data-value="2"></i><b>(2)</b>
Died at ./ltib line 2560.
traceback:
 main::check_toolchain_setup:2560
  main::pre_build_checks:1465
   main:569


Started: Tue Feb 10 22:25:52 2015
Ended:   Tue Feb 10 22:44:08 2015
Elapsed: 1096 seconds


Build Failed

Exiting on error or interrupt</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>It looks like the toolchain is not found in the PPP and GPP after trying to install it from the local cache</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <em>LTIB</em> build fails</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For further information about PPP and GPP please check out the following link:<br>
<a href="http://www.bitshrine.org/autodocs/LtibFaq.html#ref_95" target="_blank">Where do the sources get downloaded from</a></p>
</div>
</div>
<div class="sect2">
<h3 id="selecting-the-right-toolchain"><a class="anchor" href="#selecting-the-right-toolchain"></a>Selecting The Right Toolchain</h3>
<div class="paragraph">
<p>The toolchain is the set of tools including the cross-compiler which is required
to build the BSP for development on the desired target. By default the toolchain
selected is <em>ARM, gcc-4.6.2, multilib, neon optimized, gnueabi/eglibc2.13</em>. We
have to change this to <em>ARM, gcc-4.4.4, multilib, neon optimized</em> which is the
correct one available in the <em>LTIB</em> system. Run the following to bring up the
ncurses configuration page:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ./ltib --configure</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that go to the "Toolchain selection" section and hit <em>Enter</em> on the default
option which is <em>Toolchain (ARM, gcc-4.6.2, multilib, neon optimized, gnueabi/eglibc2.13)</em>
We see a pop up with a list of toolchains. Select the <em>ARM, gcc-4.4.4, multilib, neon optimized</em>
option.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-ncurses-mx28-toolchain-selection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-ncurses-mx28-toolchain-selection.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-ncurses-mx28-toolchain-selection.png" alt="imx28 ltib bsp build freescale ncurses mx28 toolchain selection" width="640" height="480"></a>
</div>
<div class="title">Figure 7. Selecting the appropriate toolchain</div>
</div>
</div>
</div>
<div class="paragraph">
<p>On exiting we see the BSP being built which takes some time to complete. This is
a test and development profile BSP which is built so it may not be exactly what
is required for your target.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">sudo /opt/freescale/ltib/usr/bin/rpm --root /home/ubuntu/beta/projectX/ltib/rootfs --dbpath /var/lib/rpm -e --allmatches --nodeps --define '_tmppath /tmp/ltib' modeps 2&gt;/dev/null
sudo /opt/freescale/ltib/usr/bin/rpm --root /home/ubuntu/beta/projectX/ltib/rootfs --dbpath /var/lib/rpm --prefix / --ignorearch -ivh --force --excludedocs --define '_tmppath /tmp/ltib' /home/ubuntu/beta/projectX/ltib/rpm/RPMS/arm/modeps-1.0-1.arm.rpm
error: failed to stat /run/user/110/gvfs: Permission denied
Preparing...                ########################################### [100%]
   1:modeps                 ########################################### [100%]

Processing deployment operations
==================================
making filesystem image file
staging directory is /home/ubuntu/beta/projectX/ltib/rootfs.tmp
removing the boot directory and files
removing man files and directories
removing info files
removing /usr/share/locale directory
removing static libraries
removing target rpm database
stripping binaries and libraries

Filesystem stats, including padding:

    Total size            = 15040k
    Total number of files = 1293


Started: Wed Feb 11 04:30:28 2015
Ended:   Wed Feb 11 04:45:46 2015
Elapsed: 918 seconds

Build Succeeded</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="exploring-the-built-bsp"><a class="anchor" href="#exploring-the-built-bsp"></a>Exploring The Built BSP</h3>
<div class="paragraph">
<p>After building, <em>LTIB</em> will generate the following in the <em>rootfs/boot/</em>
directory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ls -l rootfs/boot/
total 19784
lrwxrwxrwx 1 root root       6 Feb 11 04:42 bootable_kernel -&gt; uImage
-rwxr-xr-x 1 root root   50960 Feb 11 04:45 boot_prep
-rwxr-xr-x 1 root root     803 Feb 11 04:45 create_updater.sh
-rw-r--r-- 1 root root 2586880 Feb 11 04:45 imx28_ivt_linux.sb       <i class="conum" data-value="1"></i><b>(1)</b>
-rw-r--r-- 1 root root  141184 Feb 11 04:45 imx28_ivt_uboot.sb       <i class="conum" data-value="2"></i><b>(2)</b>
-rw-r--r-- 1 root root 2586688 Feb 11 04:45 imx28_linux.sb           <i class="conum" data-value="3"></i><b>(3)</b>
-rw-r--r-- 1 root root  141040 Feb 11 04:45 imx28_uboot.sb           <i class="conum" data-value="4"></i><b>(4)</b>
-rw-r--r-- 1 root root   52953 Feb 11 04:42 linux.config
-rwxr-xr-x 1 root root   14855 Feb 11 04:45 linux_prep
-rwxr-xr-x 1 root root   57469 Feb 11 04:45 power_prep
-rw-r--r-- 1 root root 1224927 Feb 11 04:42 System.map
-rwxr-xr-x 1 root root  518068 Feb 11 04:33 u-boot
-rwxr-xr-x 1 root root  123572 Feb 11 04:33 u-boot.bin
-rw-r--r-- 1 root root 2566320 Feb 11 04:42 uImage                   <i class="conum" data-value="5"></i><b>(5)</b>
-rw-r--r-- 1 root root    1236 Feb 11 04:45 updater.bd
-rw-r--r-- 1 root root    1421 Feb 11 04:45 updater_ivt.bd
-rwxr-xr-x 1 root root 7523413 Feb 11 04:42 vmlinux                  <i class="conum" data-value="6"></i><b>(6)</b>
-rwxr-xr-x 1 root root 2566256 Feb 11 04:42 zImage                   <i class="conum" data-value="7"></i><b>(7)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The HAB enabled bootstream of bootlets and kernel image</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The HAB enabled bootstream of bootloet and uboot image</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The HAB disabled bootstream of bootlets and kernel image</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The HAB disabled bootstream of bootloet and uboot image</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The uboot compatible kernel image</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The ELF format kernel image</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The compressed self extracting image of the kernel</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The application rootfs is generated in the top directory of <em>ltib</em>
as a JFFS2 filesystem image which can be flashed onto a NAND partition.
The filesystem format can be changed to EXT2/EXT3/etc.. by changing the
configuration of the <em>LTIB</em> build.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ls -l
total 5308
drwxrwxrwx  2 ubuntu ubuntu    4096 Feb 11 03:49 bin
drwxrwxrwx  6 ubuntu ubuntu    4096 Feb 11 04:30 config
-rwxrwxrwx  1 ubuntu ubuntu   17989 Jan  8  2013 COPYING
drwxrwxrwx  3 ubuntu ubuntu    4096 Jan  8  2013 dist
drwxrwxrwx  2 ubuntu ubuntu    4096 Jan  8  2013 doc
-rwxrwxrwx  1 ubuntu ubuntu      41 Jan 30  2013 hash
-rw-rw-r--  1 ubuntu ubuntu    1366 Feb 11 04:30 host_config.log
-rwxrwxrwx  1 ubuntu ubuntu  106077 Jan  8  2013 ltib
-rwxrwxrwx  1 ubuntu ubuntu     952 Jan  8  2013 README
-rw-rw-r--  1 ubuntu ubuntu     227 Feb 11 04:45 RELEASE_INFO
drwxrwxr-x 17 ubuntu ubuntu    4096 Feb 11 04:42 rootfs
lrwxrwxrwx  1 ubuntu ubuntu      14 Feb 11 04:45 rootfs_image -&gt; ./rootfs.jffs2
-rw-r--r--  1 ubuntu ubuntu 5242880 Feb 11 04:45 rootfs.jffs2        <i class="conum" data-value="1"></i><b>(1)</b>
drwxrwxr-x  7 ubuntu ubuntu    4096 Feb 11 04:32 rpm
drwxrwxr-x  2 ubuntu ubuntu    4096 Feb 11 04:45 tmp
drwxrwxr-x  2 ubuntu ubuntu    4096 Feb  4 04:38 ubuntu-ltib-patch</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>JFFS2 image of rootfs</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With that we have completed building our first BSP with <em>LTIB</em></p>
</div>
</div>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/i.mx28/">i.mx28</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2015/01/28/imx28-ltib-bsp-build-part1/">Building The i.MX28 Board Support Package (BSP) With LTIB - Part 1</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2015-01-28T00:00:00+00:00">
January 28, 2015
</time>
</h4>
</header>
<div class="post-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>My first attempt at building the BSP for i.MX28 evaluation board. Freescale provides the source code required to build the BSP for its i.MX28 evaluation board. We take a look at the tool LTIB which is used to build its BSP.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registering-with-freescale"><a class="anchor" href="#registering-with-freescale"></a>Registering With Freescale</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we proceed with the download of the source code and tools we need to
register with the <a href="http://www.freescale.com" target="_blank">Freescale</a> website. After registering
with the website log on to the website with the credentials used at the time
of registeration:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-signin" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-signin.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-signin.png" alt="imx28 ltib bsp build freescale signin" width="640" height="480"></a>
</div>
<div class="title">Figure 1. Signing into the Freescale website</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="i-mx28-software-and-development-tool-resources"><a class="anchor" href="#i-mx28-software-and-development-tool-resources"></a>i.MX28 Software and Development Tool Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The development software and tools are available in the Linux section of the
i.MX28 current software releases. When writing this article the page that
was available to me had the link <a href="http://www.freescale.com/webapp/sps/site/prod_summary.jsp?code=IMX28_SW" target="_blank">imx28-sw-link</a>.</p>
</div>
<div class="paragraph">
<p>On clicking the "Linux source files" link we&#8217;re taken to a license agreement.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-eula" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-eula.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-eula.png" alt="imx28 ltib bsp build freescale eula" width="640" height="480"></a>
</div>
<div class="title">Figure 2. The Freescale Semiconductor Software License Agreement</div>
</div>
</div>
</div>
<div class="paragraph">
<p>If all goes according to plan then you should see a download of the package
{L2.6.35_1.1.0_130130_source.tar.gz-link}[L2.6.35_1.1.0_130130_source.tar.gz^]
which you can save to your linux development environment. In my case it is an
Ubuntu virtual machine running on my Windows laptop. The package download will
take some time based on your network bandwidth and speed. The size of the
package is roughly about 710MB.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-eula" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-download-package.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-download-package.png" alt="imx28 ltib bsp build freescale download package" width="640" height="480"></a>
</div>
<div class="title">Figure 3. Download The L2.6.35_1.1.0_130130_source.tar.gz Package</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="unpacking-the-imx28_sw-package"><a class="anchor" href="#unpacking-the-imx28_sw-package"></a>Unpacking The IMX28_SW Package</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Move the package to a suitable folder and make sure there is sufficient space
on the drive before unpacking the gunzipped tarball.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX$ ls
L2.6.35_1.1.0_130130_source.tar.gz
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ tar xvzf L2.6.35_1.1.0_130130_source.tar.gz <i class="conum" data-value="1"></i><b>(1)</b>
L2.6.35_1.1.0_130130_source/
L2.6.35_1.1.0_130130_source/pkgs/
L2.6.35_1.1.0_130130_source/pkgs/16colors.txt
.<i class="conum" data-value="2"></i><b>(2)</b>
.
.
L2.6.35_1.1.0_130130_source/EULA
L2.6.35_1.1.0_130130_source/package_manifest.txt
L2.6.35_1.1.0_130130_source/redboot_201003.zip
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ ls -l
total 727632
drwxrwxr-x 3 ubuntu ubuntu      4096 Jan 30  2013 L2.6.35_1.1.0_130130_source <i class="conum" data-value="3"></i><b>(3)</b>
-rwxrwx--- 1 ubuntu vboxsf 744357641 Jan 20 22:55 L2.6.35_1.1.0_130130_source.tar.gz
ubuntu@ubuntu-VirtualBox:~/beta/projectX$</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Gunzip the tarball in one step</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Lot of files being unpacked</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The folder with unpacked contents is L2.6.35_1.1.0_130130_source</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="exploring-and-installing-the-imx28_sw-package"><a class="anchor" href="#exploring-and-installing-the-imx28_sw-package"></a>Exploring And Installing The IMX28_SW Package</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The directory L2.6.35_1.1.0_130130_source contains an install script which we run.
Before proceeding with the installation it presents the EULA which must be accepted
before installation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/L2.6.35_1.1.0_130130_source$ ls
EULA  install  ltib.tar.gz  package_manifest.txt  pkgs  redboot_201003.zip  tftp.zip
ubuntu@ubuntu-VirtualBox:~/beta/projectX/L2.6.35_1.1.0_130130_source$ ./install

You are about to install the LTIB (GNU/Linux Target Image Builder)

Before installing LTIB, you must read and accept the EULA
(End User License Agreement) which will be presented next.

Do you want to continue ? Y|n
Y     <i class="conum" data-value="1"></i><b>(1)</b>

Hit enter to continue:
IMPORTANT. Read the following Freescale Software License Agreement
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Hit 'Y' to read the EULA</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point we have to scroll and read the EULA before it prompts us with a
declaration stating that we have read and accept the EULA, to which we reply
"yes".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
I have read and accept the EULA (yes|no):
yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next we&#8217;re asked about the installation path. We can hit "Enter" to use the default
which is <em>/home/ubuntu/beta/projectX/L2.6.35_1.1.0_130130_source</em>. However it doesn&#8217;t
allow us to install it there so we supply a level above the current directory i.e.
<em>/home/ubuntu/beta/projectX/</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
Copying packages to /home/ubuntu/beta/projectX//ltib/pkgs

Installation complete, your ltib installation has been placed in
/home/ubuntu/beta/projectX//ltib, to complete the installation:

cd /home/ubuntu/beta/projectX//ltib
./ltib</code></pre>
</div>
</div>
<div class="paragraph">
<p>The installation is completed along with a hint of the next step which is running
the Linux Target Image Builder (LTIB) tool.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-is-ltib"><a class="anchor" href="#what-is-ltib"></a>What Is LTIB?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Well LTIB is a tool which is used by Freescale to develop, build and deploy the
software i.e. bootloaders, linux kernel, applications, daemons, etc.. required to
support the board which in this case happens to be an i.MX28 board. It is uses the
RPM way to manage software which has to be built for the target board.</p>
</div>
<div class="paragraph">
<p>It is advisable to read the Introduction and FAQ section present on the LTIB website at the following
links:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://ltib.org/home-intro" target="_blank">Introduction</a></p>
</li>
<li>
<p><a href="http://ltib.org/documentation-LtibFaq" target="_blank">FAQs</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-ltib"><a class="anchor" href="#building-ltib"></a>Building LTIB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The hint given above is to configure and build LTIB. Within the configuration
various settings such as toolchain path, platform details, C library to be
used, etc can be configured.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/L2.6.35_1.1.0_130130_source$ cd /home/ubuntu/beta/projectX//ltib
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ls -l
total 184
drwxrwxrwx 2 ubuntu ubuntu   4096 Jan  8  2013 bin
drwxrwxrwx 6 ubuntu ubuntu   4096 Jan  8  2013 config
-rwxrwxrwx 1 ubuntu ubuntu  17989 Jan  8  2013 COPYING
drwxrwxrwx 3 ubuntu ubuntu   4096 Jan  8  2013 dist
drwxrwxrwx 2 ubuntu ubuntu   4096 Jan  8  2013 doc
-rwxrwxrwx 1 ubuntu ubuntu     41 Jan 30  2013 hash
-rwxrwxrwx 1 ubuntu ubuntu 106077 Jan  8  2013 ltib
drwxr-xr-x 2 ubuntu ubuntu  32768 Jan 28 06:49 pkgs
-rwxrwxrwx 1 ubuntu ubuntu    952 Jan  8  2013 README
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="problems-running-ltib"><a class="anchor" href="#problems-running-ltib"></a>Problems Running LTIB</h3>
<div class="paragraph">
<p>Okay there were several issues seen while trying to install <em>LTIB</em> on my Ubuntu
system. We&#8217;ll take a look at each one as they occurred in sequence and my steps
taken to fix all of them.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
This part will vary from system to system. It depends on your system
configuration so you may face issues different to those listed here.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="fixing-dependency-issues"><a class="anchor" href="#fixing-dependency-issues"></a>Fixing Dependency Issues</h4>
<div class="paragraph">
<p>LTIB failed and cribbed on my system complaninig about missing packages as shown
below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ./ltib
Don't have HTTP::Request::Common
Don't have LWP::UserAgent
Cannot test proxies, or remote file availability without both
HTTP::Request::Common and LWP::UserAgent
defined(@array) is deprecated at /home/ubuntu/beta/projectX/ltib/bin/Ltibutils.pm line 362.
        (Maybe you should just omit the defined()?)

ltib cannot be run because one or more of the host packages needed to run it
are either missing or out of date or not in ltib's standard path.  Please
install/upgrade these packages on your host.  If you have your own utilities
in non-standard paths, please add an entry into the .ltibrc file for example:

%path_std
/usr/local/bin:/usr/bin:/bin:/usr/bin/X11:/usr/X11R6/bin:/my/own/exes

Package                Minimum ver   Installed info
-------                -----------   ---------------
zlib                   0             not installed
rpm                    0             not installed
rpm-build              0             not installed
ncurses-devel          0             not installed
m4                     0             not installed
bison                  0             not installed

Died at ./ltib line 1409.
traceback:
 main::host_checks:1409
  main:554


Started: Fri Jan 30 00:53:17 2015
Ended:   Fri Jan 30 00:53:17 2015
Elapsed: 0 seconds


Build Failed

Exiting on error or interrupt</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the Advanced Packaging Tool (APT) utility we are able to fix the missing
package issues. The stratedgy involves trying to identify the package
equivalent for Ubuntu using the command below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-cache search m4    <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Example of searching packages related to m4 using the APT utility</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>And then installing the package</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-get install m4    <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Example of installing m4 using the APT utility</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <em>ltib</em> utility can be executed again to see if the package errors reduce
with each successful installation. Documentation of installation of the missing
packages proceeds in the subsections below. They can be avoided if the same
problems do not exist.</p>
</div>
<div class="sect4">
<h5 id="installing-em-m4-em"><a class="anchor" href="#installing-em-m4-em"></a>Installing <em>m4</em></h5>
<div class="paragraph">
<p>Installation of <em>m4</em> proceeded with no problems</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-get install m4     <i class="conum" data-value="1"></i><b>(1)</b>
Reading package lists... Done
Building dependency tree
Reading state information... Done
.
.
.
Need to get 206 kB of archives.
After this operation, 390 kB of additional disk space will be used.
Do you want to continue? [Y/n] Y    <i class="conum" data-value="2"></i><b>(2)</b>
.
.
.
Processing triggers for libc-bin (2.19-0ubuntu6.5) ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to install m4</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>User input confirming installation</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="installing-em-rpm-em"><a class="anchor" href="#installing-em-rpm-em"></a>Installing <em>rpm</em></h5>
<div class="paragraph">
<p>Installation of <em>rpm</em> proceeded with no problems</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-get install rpm    <i class="conum" data-value="1"></i><b>(1)</b>
[sudo] password for ubuntu:
Reading package lists... Done
Building dependency tree
Reading state information... Done
.
.
.
Do you want to continue? [Y/n] Y    <i class="conum" data-value="2"></i><b>(2)</b>
.
.
.
Processing triggers for libc-bin (2.19-0ubuntu6.5) ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to install rpm</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>User input confirming installation</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="installing-em-bison-em"><a class="anchor" href="#installing-em-bison-em"></a>Installing <em>bison</em></h5>
<div class="paragraph">
<p>Installation of <em>bison</em> proceeded with no problems</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-get install bison     <i class="conum" data-value="1"></i><b>(1)</b>
Reading package lists... Done
Building dependency tree
Reading state information... Done
.
.
.
Do you want to continue? [Y/n] Y          <i class="conum" data-value="2"></i><b>(2)</b>
Get:1 http://us.archive.ubuntu.com/ubuntu/ trusty/main libbison-dev i386 2:3.0.2.dfsg-2 [338 kB]
.
.
.
update-alternatives: using /usr/bin/bison.yacc to provide /usr/bin/yacc (yacc) in auto mode</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to install bison</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>User input confirming installation</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="installing-em-ncurses-devel-em"><a class="anchor" href="#installing-em-ncurses-devel-em"></a>Installing <em>ncurses-devel</em></h5>
<div class="paragraph">
<p>Installation of <em>ncurses-devel</em> proceeded with no problems after locating the
correct package name as <em>libncurses5-dev</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-get install libncurses5-dev    <i class="conum" data-value="1"></i><b>(1)</b>
Reading package lists... Done
Building dependency tree
Reading state information... Done
.
.
.
Do you want to continue? [Y/n] Y    <i class="conum" data-value="2"></i><b>(2)</b>
.
.
.
Setting up libncurses5-dev:i386 (5.9+20140118-1ubuntu1) ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Command to install bison</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>User input confirming installation</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="installing-em-zlib-em"><a class="anchor" href="#installing-em-zlib-em"></a>Installing <em>zlib</em></h5>
<div class="paragraph">
<p>Installation of <em>zlib</em> was not straightforward after several attempts to install
packages like <em>zlibc</em> &amp; <em>zlib-bin</em> LTIB was still failing and cribbing saying
the package was missing from the system.</p>
</div>
<div class="paragraph">
<p>Aparently all the dependencies are stored in the file <em>./bin/Ltibutils.pm</em>. So
on greping the file for zlib we get the paths which are searched for in order to
look for the zlib package.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ grep -A 4 -B 2 zlib ./bin/Ltibutils.pm     <i class="conum" data-value="1"></i><b>(1)</b>
                        `makeinfo --version 2&gt;/dev/null`;
                    },
    zlib         =&gt; sub { my @f = (glob('/usr/lib/libz.so*'),
                                   glob('/lib/libz.so*'),
                                   glob('/lib64/libz.so*'),
                                   glob('/usr/lib/i386-linux-gnu/libz.so*'),
                                   glob('/usr/lib32/libz.so*'),
                                   glob('/usr/lib/x86_64-linux-gnu/libz.so*') ); @f &gt; 1 ? 1 : 0 },
    'zlib-devel' =&gt; sub { -f '/usr/include/zlib.h' },
};

sub get_ver
{</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Greping 4 lines after(-A 4) and 2 lines before(-B 2) for zlib in the file Ltibutils.pm</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After doing going through some basic perl sites it was decided to print the
value of array <em>@f</em> which was being used in the <em>get_ver</em> function exposed
by Ltibutils.pm. The following was the change done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ grep -A 4 -B 2 zlib ./bin/Ltibutils.pm        <i class="conum" data-value="1"></i><b>(1)</b>
                        `makeinfo --version 2&gt;/dev/null`;
                    },
    zlib         =&gt; sub { my @f = (glob('/usr/lib/libz.so*'),
                                   glob('/lib/libz.so*'),
                                   glob('/lib64/libz.so*'),
                                   glob('/usr/lib/i386-linux-gnu/libz.so*'),
                                   glob('/usr/lib32/libz.so*'),
                                   glob('/usr/lib/x86_64-linux-gnu/libz.so*') );print &quot;Value of list = @f\n&quot;; @f &gt; 1 ? 1 : 0 },  <i class="conum" data-value="2"></i><b>(2)</b>
    'zlib-devel' =&gt; sub { -f '/usr/include/zlib.h' },
};

sub get_ver
{</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Greping 4 lines after(-A 4) and 2 lines before(-B 2) for zlib in the file Ltibutils.pm</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><em>print "Value of list = @f\n";</em> is added</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Additionally we run <em>ltib</em> with verbose option <em>--verbose</em> to see if we can
get any more details that can help us debug the dependency issue. This time after
we execute the <em>ltib</em> script we get the details below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ./ltib --verbose
Don't have HTTP::Request::Common
Don't have LWP::UserAgent
.
.
.
pkg=gcc-c++, min=2.96, got: 4.8.2,
ref=4, min=2
pkg=sudo, min=0, got: 1.8.9,
ref=1, min=0
Value of list = /usr/lib/i386-linux-gnu/libz.so    <i class="conum" data-value="1"></i><b>(1)</b>
pkg=zlib, min=0, got: -1, not installed            <i class="conum" data-value="2"></i><b>(2)</b>
pkg=zlib-devel, min=0, got: 0,
ref=0, min=0
pkg=rpm, min=0, got: 4.0.4,
ref=4, min=0
.
.
.
pkg=rpm-build, min=0, got: 4.0.4,
ref=4, min=0
.
.
.
Build Failed

Exiting on error or interrupt
ubuntu@ubuntu-VirtualBox:~/beta/project</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the value of <em>@f</em> which implies that our zlib library is /usr/lib/i386-linux-gnu/libz.so</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This print indicates that the version obtained is -1 and hence it is forced to mark <em>zlib</em> as not installed</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The flow of calls is:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><em>check_basic_deps</em> in <em>ltib</em> iterates through <em>$pkg</em> to find each version with <em>get_ver</em></p>
</li>
<li>
<p><em>get_ver</em> is defined in <em>bin/Ltibutils.pm</em> and has a series of checks for the version</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>If the $pkg is not defined in the predefined <em>app_checks</em> it issues a
'$pkg --version 2&gt;/dev/null' to get the package version information</p>
</li>
<li>
<p>If the $pkg is defined as 'CODE' it executes the pkg as a function call</p>
</li>
<li>
<p>Lastly it executes the value of <code>$app_checks&#8594;{$pkg}</code></p>
</li>
<li>
<p>If <em>$_</em> is not set to anything then -1 is returned as the version</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Finally after understanding the mapping of <em>app_checks</em> for zlib it looked as
though the expression <em>@f &gt; 1 ? 1 : 0 _ was evaluating to 1 instead of 2. And
this was because only one path was valid from the list of paths i.e.
_/usr/lib/i386-linux-gnu/libz.so</em>. This is a softlink to the path
<em>/lib/i386-linux-gnu/libz.so.1.2.8</em> so we add that to the list of options
available. This change is similar to  With this change the zlib dependency is
detected and the file now looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">buntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ grep -A 4 -B 2 zlib ./bin/Ltibutils.pm
                        `makeinfo --version 2&gt;/dev/null`;
                    },
    zlib         =&gt; sub { my @f = (glob('/usr/lib/libz.so*'),
                                   glob('/lib/libz.so*'),
                                   glob('/lib64/libz.so*'),
                                   glob('/lib/i386-linux-gnu/libz.so*'),   <i class="conum" data-value="1"></i><b>(1)</b>
                                   glob('/usr/lib/i386-linux-gnu/libz.so*'),  <i class="conum" data-value="2"></i><b>(2)</b>
                                   glob('/usr/lib32/libz.so*'),
                                   glob('/usr/lib/x86_64-linux-gnu/libz.so*') );print &quot;Value of list = @f\n&quot;; @f &gt; 1 ? 1 : 0 },
    'zlib-devel' =&gt; sub { -f '/usr/include/zlib.h' },
};

sub get_ver
{</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is the new path added in <em>bin/Ltibutils.pm</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This is the original path which is detected in the system. The above path is the actual file to this soft link.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We revert all changes except the fix to the original script files i.e.
<em>print "Value of list = @f\n";</em> which was added for debugging and is not
required now.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setting-em-sudo-em-permissions-for-em-rpm-em"><a class="anchor" href="#setting-em-sudo-em-permissions-for-em-rpm-em"></a>Setting <em>sudo</em> Permissions For <em>rpm</em></h4>
<div class="paragraph">
<p>The next issue was because of a test done by <em>ltib</em> to check if there are
<em>sudo</em> permissions for <em>rpm</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ./ltib
Don't have HTTP::Request::Common
.
.
.
Don't have LWP::UserAgent

I ran the command: sudo -S -l which returned:      <i class="conum" data-value="1"></i><b>(1)</b>

[sudo] password for ubuntu: Sorry, try again.
[sudo] password for ubuntu: Sorry, try again.
[sudo] password for ubuntu: Sorry, try again.
sudo: 3 incorrect password attempts

This means you don't have sudo permission to execute rpm commands as root           <i class="conum" data-value="2"></i><b>(2)</b>
without a password.  This is needed for this build script to operate correctly.

To configure this, as root using the command &quot;/usr/sbin/visudo&quot;,     <i class="conum" data-value="3"></i><b>(3)</b>
and add the following line in the User privilege section:

ubuntu ALL = NOPASSWD: /usr/bin/rpm, /opt/freescale/ltib/usr/bin/rpm
.
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>ltib</em> explaining what is run to test for <em>sudo</em> priviledges</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Explaning what is wrong in the system</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Potential fix</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can execute "/usr/sbin/visudo" as indicated or "sudo vim /etc/sudoers" is also
fine.</p>
</div>
</div>
<div class="sect3">
<h4 id="installing-the-host-support-packages"><a class="anchor" href="#installing-the-host-support-packages"></a>Installing The Host Support Packages</h4>
<div class="paragraph">
<p>After fixing the sudo issue we run <em>ltib</em> yet again to find a new problem as
shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ./ltib
Don't have HTTP::Request::Common
Don't have LWP::UserAgent
Cannot test proxies, or remote file availability without both
HTTP::Request::Common and LWP::UserAgent
defined(@array) is deprecated at /home/ubuntu/beta/projectX/ltib/bin/Ltibutils.pm line 362.
        (Maybe you should just omit the defined()?)

Installing host support packages.

This only needs to be done once per host, but may take up to
an hour to complete ...

If an error occurs, a log file with the full output may be found in:
/home/ubuntu/beta/projectX/ltib/host_config.log

Exiting on error or interrupt                                                    <i class="conum" data-value="1"></i><b>(1)</b>
Please see &gt;&gt; /home/ubuntu/beta/projectX/ltib/host_config.log for details</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Exited on error</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Opening the <em>/home/ubuntu/beta/projectX/ltib/host_config.log</em> file we see that there
is some trouble building the <em>lkc</em> packge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ tail /home/ubuntu/beta/projectX/ltib/host_config.log

Started: Tue Feb  3 04:13:25 2015
Ended:   Tue Feb  3 04:13:29 2015
Elapsed: 4 seconds

These packages failed to build:
lkc

Build Failed</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="searching-for-a-simpler-installation"><a class="anchor" href="#searching-for-a-simpler-installation"></a>Searching For A Simpler Installation</h4>
<div class="paragraph">
<p>Aparently most of the problems seen are due to the newer version of Ubuntu of
my system. When going through the Freescale forums for similar problems a
solution was provided in the form of a patch at
<a href="https://community.freescale.com/docs/DOC-93454" target="_blank">https://community.freescale.com/docs/DOC-93454</a>.</p>
</div>
<div class="paragraph">
<p>The temporary fix to find zlib as a dependency was removed and the patch was
installed using the steps highlighted in the forum.</p>
</div>
<div class="sect4">
<h5 id="unpacking-the-patch"><a class="anchor" href="#unpacking-the-patch"></a>Unpacking The Patch</h5>
<div class="paragraph">
<p>The patch file has to be copied to the ltib directory and untarred there.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ls
bin  config  COPYING  dist  doc  hash  host_config.log  ltib  README  tmp  ubuntu-ltib-patch.tgz      <i class="conum" data-value="1"></i><b>(1)</b>
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ tar xvzf ubuntu-ltib-patch.tgz       <i class="conum" data-value="2"></i><b>(2)</b>
ubuntu-ltib-patch/
ubuntu-ltib-patch/zlib.patch
ubuntu-ltib-patch/sparse-0.4-fixlabel.patch
ubuntu-ltib-patch/lkc-1.4-lib.patch
ubuntu-ltib-patch/mux_server.spec
ubuntu-ltib-patch/sparse-0.4-fixlabel.patch.md5
ubuntu-ltib-patch/install-patches.sh
ubuntu-ltib-patch/lkc.spec
ubuntu-ltib-patch/sparse.spec
ubuntu-ltib-patch/lkc-1.4-lib.patch.md5</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>List of files in the <em>ltib</em> directory. <em>ubuntu-ltib-patch.tgz</em> is the new addition.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Untarring the package.</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="install-the-patches"><a class="anchor" href="#install-the-patches"></a>Install The Patches</h5>
<div class="paragraph">
<p>Go to the extracted directory and run <em>install-patches.sh</em> with the full path
of the <em>ltib</em> directory to install the patches.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ cd ubuntu-ltib-patch/
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib/ubuntu-ltib-patch$ ./install-patches.sh /home/ubuntu/beta/projectX/ltib/
cp lkc-1.4-lib.patch /opt/freescale/pkgs
cp lkc-1.4-lib.patch.md5 /opt/freescale/pkgs
cp sparse-0.4-fixlabel.patch /opt/freescale/pkgs
cp sparse-0.4-fixlabel.patch.md5 /opt/freescale/pkgs
Patching Spec Files
Done
patching file bin/Ltibutils.pm</code></pre>
</div>
</div>
<div class="paragraph">
<p>After running the <em>ltib</em> script we were able to see the path added to the <em>bin/Ltibutils.pm</em>
file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ grep -A 4 -B 2 zlib ./bin/Ltibutils.pm
                        `makeinfo --version 2&gt;/dev/null`;
                    },
    zlib         =&gt; sub { my @f = (glob('/usr/lib/libz.so*'),
                                   glob('/lib/libz.so*'),
                                   glob('/lib/i386-linux-gnu/libz.so*'),
                                   glob('/lib64/libz.so*'),
                                   glob('/usr/lib/i386-linux-gnu/libz.so*'),
                                   glob('/usr/lib32/libz.so*'),
                                   glob('/usr/lib/x86_64-linux-gnu/libz.so*') ); @f &gt; 1 ? 1 : 0 },
    'zlib-devel' =&gt; sub { -f '/usr/include/zlib.h' },
};

sub get_ver
{</code></pre>
</div>
</div>
<div class="paragraph">
<p>We see a new set of <em>wget</em> errors this time and after searching the forums
we get help in this post about dead links in  LTIB installation.
<a href="https://community.freescale.com/thread/308278" target="_blank">https://community.freescale.com/thread/308278</a>.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trying-by-patching-earlier-on"><a class="anchor" href="#trying-by-patching-earlier-on"></a>Trying By Patching Earlier On</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LTIB doesn&#8217;t work without the patch from Freescale especially if you are using
a newer Ubuntu system which is greater than Ubuntu 9.0. Not sure about the next
steps we put this attempt to rest and retry with another attempt by applying
the patch earlier on rather than later as a logical progression of the installation.</p>
</div>
<div class="paragraph">
<p>Sometimes it&#8217;s good to erase the board and start with a fresh perspective.</p>
</div>
<div class="sect2">
<h3 id="cleaning-up-the-old-installation"><a class="anchor" href="#cleaning-up-the-old-installation"></a>Cleaning Up The Old Installation</h3>
<div class="paragraph">
<p>We clean up the folders created when we install and configure the LTIB package:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX$ rm -Rf ltib/
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ sudo rm -Rf /opt/freescale</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repeat-the-installaion"><a class="anchor" href="#repeat-the-installaion"></a>Repeat The Installaion</h3>
<div class="paragraph">
<p>As mentioned in section <a href="#exploring-and-installing-the-imx28_sw-package">Exploring And Installing The IMX28_SW Package</a>
repeat all the installation steps outlined in that session until you get
the fresh ltib folder created at <em>/home/ubuntu/beta/projectX/ltib</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/L2.6.35_1.1.0_130130_source$ ls
EULA  install  ltib.tar.gz  package_manifest.txt  pkgs  redboot_201003.zip  tftp.zip
ubuntu@ubuntu-VirtualBox:~/beta/projectX/L2.6.35_1.1.0_130130_source$ ./install
.
.</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="apply-the-ubuntu-patch"><a class="anchor" href="#apply-the-ubuntu-patch"></a>Apply The Ubuntu Patch</h3>
<div class="paragraph">
<p>As mentioned in the <a href="#unpacking-the-patch">Unpacking The Patch</a> and <a href="#install-the-patches">Install The Patches</a> sections
patch the fresh ltib folder again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ tar xvzf ubuntu-ltib-patch.tgz
ubuntu-ltib-patch/
ubuntu-ltib-patch/zlib.patch
ubuntu-ltib-patch/sparse-0.4-fixlabel.patch
ubuntu-ltib-patch/lkc-1.4-lib.patch
ubuntu-ltib-patch/mux_server.spec
ubuntu-ltib-patch/sparse-0.4-fixlabel.patch.md5
ubuntu-ltib-patch/install-patches.sh
ubuntu-ltib-patch/lkc.spec
ubuntu-ltib-patch/sparse.spec
ubuntu-ltib-patch/lkc-1.4-lib.patch.md5
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ cd ubuntu-ltib-patch/
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib/ubuntu-ltib-patch$ ./install-patches.sh /home/ubuntu/beta/projectX/ltib/
cp lkc-1.4-lib.patch /opt/freescale/pkgs
cp lkc-1.4-lib.patch.md5 /opt/freescale/pkgs
cp sparse-0.4-fixlabel.patch /opt/freescale/pkgs
cp sparse-0.4-fixlabel.patch.md5 /opt/freescale/pkgs
Patching Spec Files
Done
patching file bin/Ltibutils.pm</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="repeat-the-build"><a class="anchor" href="#repeat-the-build"></a>Repeat The Build</h3>
<div class="paragraph">
<p>Again we try to configure and build <em>LTIB</em> with the same command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ./ltib          <i class="conum" data-value="1"></i><b>(1)</b>
Don't have HTTP::Request::Common
Don't have LWP::UserAgent
Cannot test proxies, or remote file availability without both
HTTP::Request::Common and LWP::UserAgent
defined(@array) is deprecated at /home/ubuntu/beta/projectX/ltib/bin/Ltibutils.pm line 362.
        (Maybe you should just omit the defined()?)

Installing host support packages.

This only needs to be done once per host, but may take up to
an hour to complete ...

If an error occurs, a log file with the full output may be found in:
/home/ubuntu/beta/projectX/ltib/host_config.log

[sudo] password for ubuntu:                  <i class="conum" data-value="2"></i><b>(2)</b>
Exiting on error or interrupt
Please see &gt;&gt; /home/ubuntu/beta/projectX/ltib/host_config.log for details</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Execute the <em>ltib</em> command to being the configuration and build</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Enter the login password for sudo</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="missing-em-lzo-lzo1x-h-em"><a class="anchor" href="#missing-em-lzo-lzo1x-h-em"></a>Missing <em>lzo/lzo1x.h</em></h4>
<div class="paragraph">
<p>Ok after a while it looks like there&#8217;s a different type of error that is thrown.
After opening the <em>host_config.log</em> we see the following type of error related
to missing <em>lzo/lzo1x.h</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ tail -n 30 /home/ubuntu/beta/projectX/ltib/host_config.log
  CC      compr_lzo.o
compr_lzo.c:31:23: fatal error: lzo/lzo1x.h: No such file or directory
 #include &lt;lzo/lzo1x.h&gt;
                       ^
compilation terminated.
make: *** [/opt/freescale/ltib/usr/src/rpm/BUILD/mtd-utils/compr_lzo.o] Error 1
error: Bad exit status from /home/ubuntu/beta/projectX/ltib/tmp/rpm-tmp.80059 (%build)


RPM build errors:
    Bad exit status from /home/ubuntu/beta/projectX/ltib/tmp/rpm-tmp.80059 (%build)
Build time for mtd-utils: 6 seconds

Failed building mtd-utils
Died at ./ltib line 1392.
traceback:
 main::build_host_rpms:1392
  main::host_checks:1447
   main:554


Started: Thu Feb  5 05:36:42 2015
Ended:   Thu Feb  5 05:46:54 2015
Elapsed: 612 seconds

These packages failed to build:
mtd-utils

Build Failed</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok so we&#8217;re missing some package in our system. Let&#8217;s try using APT again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-cache search &quot;lzo&quot;    <i class="conum" data-value="1"></i><b>(1)</b>
file-roller - archive manager for GNOME
liblzo2-2 - data compression library
liblzo2-dev - data compression library (development files)        <i class="conum" data-value="2"></i><b>(2)</b>
lrzip - compression program with a very high compression ratio
lzop - fast compression program
patool - command line archive file manager
python-lzo - Python bindings for the LZO data compression library
zope-debhelper - debhelper script for zope packaging
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-cache search &quot;liblzo2-dev&quot;
liblzo2-dev - data compression library (development files)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Example of searching packages related to lzo using the APT utility</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Looks like a good candidate since header file is missing and it is a development package</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Installing the package liblzo2-dev</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-get install liblzo2-dev  <i class="conum" data-value="1"></i><b>(1)</b>
Reading package lists... Done
Building dependency tree
Reading state information... Done
.
.
.
Unpacking liblzo2-dev:i386 (2.06-1.2ubuntu1.1) ...
Setting up liblzo2-dev:i386 (2.06-1.2ubuntu1.1) ...</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Installation of liblzo2-dev</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Running <em>ltib</em> again we get an error almost immediately. Again we open the
<em>/home/ubuntu/beta/projectX/ltib/host_config.log</em> file and see that the build stopped
with a message as shown below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">Processing: u-boot-tools
==========================

Processing: mtd-utils
=======================
Build path taken because: directory build, no prebuilt rpm,

Cowardly refusing to clobber existing directory:            <i class="conum" data-value="1"></i><b>(1)</b>
 /opt/freescale/ltib/usr/src/rpm/BUILD/mtd-utils
Remove this by hand if you really want to rebuild this package from scratch

Died at ./ltib line 1392.
traceback:
 main::build_host_rpms:1392
  main::host_checks:1447
   main:554</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Reason why <em>ltib</em> fails</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s do as it says and try again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo rm -Rf /opt/freescale/ltib/usr/src/rpm/BUILD/mtd-utils
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ./ltib</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="missing-em-uuid-uuid-h-em"><a class="anchor" href="#missing-em-uuid-uuid-h-em"></a>Missing <em>uuid/uuid.h</em></h4>
<div class="paragraph">
<p>It fails again. After opening the <em>host_config.log</em> we see the following type of error related
to missing <em>uuid/uuid.h</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
  LD      jffs2reader
  CC      mkfs.ubifs/mkfs.ubifs.o
In file included from mkfs.ubifs/mkfs.ubifs.c:25:0:
mkfs.ubifs/mkfs.ubifs.h:48:23: fatal error: uuid/uuid.h: No such file or directory
 #include &lt;uuid/uuid.h&gt;
                       ^
.
.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok so we&#8217;re missing another package in our system. Let&#8217;s try using APT again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-cache search uuid   <i class="conum" data-value="1"></i><b>(1)</b>
.
.
libuuid1 - Universally Unique ID library
postgresql-contrib-9.3 - additional facilities for PostgreSQL
uuid-dev - universally unique id library - headers and static libraries    <i class="conum" data-value="1"></i><b>(1)</b>
uuid-runtime - runtime components for the Universally Unique ID library
uuidcdef - Universally Unique Identifier (UUID) generator
.
.
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo apt-get install uuid-dev     <i class="conum" data-value="2"></i><b>(2)</b>
Reading package lists... Done
Building dependency tree
Reading state information... Done
The following NEW packages will be installed:
  uuid-dev
.
.
Setting up uuid-dev (2.20.1-5.1ubuntu20.3) ...
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ sudo rm -Rf /opt/freescale/ltib/usr/src/rpm/BUILD/mtd-utils        <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Looks like a good candidate as header files are missing</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Installing the package</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Removing mtd-utils as it won&#8217;t build because of the previous error</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="missing-em-usr-include-sys-types-h-em"><a class="anchor" href="#missing-em-usr-include-sys-types-h-em"></a>Missing <em>/usr/include/sys/types.h</em></h4>
<div class="paragraph">
<p>It fails again. After opening the <em>host_config.log</em> we see the following type of error related
to missing <em>/usr/include/sys/types.h</em>. This is different from the previous errors. It looks
like some system header file is not in place where it should be. After searching a bit on Google
this blog entry gives us clues as to how to fix these errors
<a href="https://importgeek.wordpress.com/2014/08/21/imx-ltib-common-errors/" target="_blank">https://importgeek.wordpress.com/2014/08/21/imx-ltib-common-errors/</a></p>
</div>
<div class="paragraph">
<p>It looks like the <em>types.h</em> file is in <em>/usr/incude/i386-linux-gnu/sys</em> so we create a softlink as
shown below to solve this issue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ vim /home/ubuntu/beta/projectX/ltib/host_config.log
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ cd /usr/include/
ubuntu@ubuntu-VirtualBox:/usr/include$ sudo ln -s i386-linux-gnu/sys sys
ubuntu@ubuntu-VirtualBox:/usr/include$ cd -
/home/ubuntu/beta/projectX/ltib
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="loader-error-missing-maths-library"><a class="anchor" href="#loader-error-missing-maths-library"></a>Loader Error Missing Maths Library</h4>
<div class="paragraph">
<p>It fails again. Opening up the <em>host_config.log</em> file we see the error as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">.
.
gcc AESKey.o Blob.o crc.o DataSource.o DataTarget.o ELFSourceFile.o EncoreBootImage.o EvalContext.o GHSSecInfo.o GlobMatcher.o HexValues.o Logging.o Operation.o OptionDictionary.o options.o OutputSection.o Random.o RijndaelCBCMAC.o rijndael.o SHA1.o SourceFile.o SRecordSourceFile.o stdafx.o StELFFile.o StExecutableImage.o StSRecordFile.o Value.o Version.o format_string.o ExcludesListMatcher.o SearchPath.o DataSourceImager.o IVTDataSource.o BootImageGenerator.o ConversionController.o ElftosbAST.o elftosb.o elftosb_lexer.o ElftosbLexer.o elftosb_parser.tab.o EncoreBootImageGenerator.o -lstdc++ -o elftosb
/usr/bin/ld: ElftosbAST.o: undefined reference to symbol 'powf@@GLIBC_2.0'       <i class="conum" data-value="1"></i><b>(1)</b>
//lib/i386-linux-gnu/libm.so.6: error adding symbols: DSO missing from command line
collect2: error: ld returned 1 exit status
make[1]: *** [elftosb] Error 1
make[1]: Leaving directory `/opt/freescale/ltib/usr/src/rpm/BUILD/elftosb-2.6.35.3-1.1.0/bld/linux'
make: *** [all] Error 2
error: Bad exit status from /home/ubuntu/beta/projectX/ltib/tmp/rpm-tmp.5414 (%build)
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Exact error is an unknown reference to symbol 'powf@@GLIBC_2.0'</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This error is covered in the same blog link given above so we follow the instructions</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ cp /opt/freescale/pkgs/elftosb-2.6.35.3-1.1.0.tar.gz ~/beta/projectX/.      <i class="conum" data-value="1"></i><b>(1)</b>
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ cd ~/beta/projectX/
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ ls
elftosb-2.6.35.3-1.1.0.tar.gz  L2.6.35_1.1.0_130130_source  L2.6.35_1.1.0_130130_source.tar.gz  ltib
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ tar xvzf elftosb-2.6.35.3-1.1.0.tar.gz       <i class="conum" data-value="2"></i><b>(2)</b>
elftosb-2.6.35.3-1.1.0/
elftosb-2.6.35.3-1.1.0/COPYING
elftosb-2.6.35.3-1.1.0/ReadMe.txt
elftosb-2.6.35.3-1.1.0/bdfiles/
elftosb-2.6.35.3-1.1.0/bdfiles/basic_test_cmd.e
.
.
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ cd elftosb-2.6.35.3-1.1.0/
ubuntu@ubuntu-VirtualBox:~/beta/projectX/elftosb-2.6.35.3-1.1.0$ ls     <i class="conum" data-value="3"></i><b>(3)</b>
bdfiles  COPYING   elftosb.ccscc  elftosb.sln  elftosb.xcodeproj  keygen    makefile.rules  sbtool    test_elftosb.bat  test_files
common   elftosb2  elftosb.ncb    elftosb.suo  encryptgpk         makefile  ReadMe.txt      stdafx.h  test_elftosb.sh   winsupport
ubuntu@ubuntu-VirtualBox:~/beta/projectX/elftosb-2.6.35.3-1.1.0$
ubuntu@ubuntu-VirtualBox:~/beta/projectX/elftosb-2.6.35.3-1.1.0$ vim makefile.rules       <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Copy elftosb-2.6.35.3-1.1.0.tar.gz from the pkgs directory to a temporary location</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Unpack the compressed tarball</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>List the contents in elftosb-2.6.35.3-1.1.0 after unpacking</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Edit the makefile.rules</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The makefile requires adding the maths library to the LIBS path</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="makefile">.
.
.
OBJ_FILES_KEYGEN =         \
   ${OBJ_FILES_COMMON} \
   keygen.o


LIBS =     -lstdc++ -lm       <i class="conum" data-value="1"></i><b>(1)</b>


ifeq (&quot;${UNAMES}&quot;, &quot;Linux&quot;)
EXEC_FILE_ELFTOSB2 = elftosb
EXEC_FILE_SBTOOL = sbtool
.
.
.</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>-lm is added to LIBS</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now repack the tarball, overwrite the orignal tarball, remove the build folder and run <em>ltib</em> again</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/elftosb-2.6.35.3-1.1.0$ cd ..
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ tar cvzf elftosb-2.6.35.3-1.1.0.tar.gz elftosb-2.6.35.3-1.1.0/       <i class="conum" data-value="1"></i><b>(1)</b>
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ cp elftosb-2.6.35.3-1.1.0.tar.gz /opt/freescale/pkgs/elftosb-2.6.35.3-1.1.0.tar.gz        <i class="conum" data-value="2"></i><b>(2)</b>
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ sudo rm -Rf /opt/freescale/ltib/usr/src/rpm/BUILD/elftosb-2.6.35.3-1.1.0      <i class="conum" data-value="3"></i><b>(3)</b>
ubuntu@ubuntu-VirtualBox:~/beta/projectX$ cd ltib
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ ./ltib    <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Repacking elftosb-2.6.35.3-1.1.0/ into elftosb-2.6.35.3-1.1.0.tar.gz</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Overwriting the original /opt/freescale/pkgs/elftosb-2.6.35.3-1.1.0.tar.gz package</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Removing the previous /opt/freescale/ltib/usr/src/rpm/BUILD/elftosb-2.6.35.3-1.1.0 build directory</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Trying to build again</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="ncurses-at-last"><a class="anchor" href="#ncurses-at-last"></a>Ncurses At Last!</h4>
<div class="exampleblock">
<div class="content">
<div id="imx28-ltib-bsp-build-freescale-ncurses-platform-selection" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/imx28-ltib-bsp-build-freescale-ncurses-platform-selection.png"><img src="http://zeuzoix.github.io/techeuphoria/images/imx28-ltib-bsp-build-freescale-ncurses-platform-selection.png" alt="imx28 ltib bsp build freescale ncurses platform selection" width="640" height="480"></a>
</div>
<div class="title">Figure 4. Ncurses screen with platform selection</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Phew that took some fair amount of tinkering. We finally are able to move to the
next step which is configuration of the BSP.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="conclusion"><a class="anchor" href="#conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Well after a lot of probing we were finally able to build LTIB for our Ubuntu 14.04.1 LTS system. Since this post has been insanely long I&#8217;ve decided to split it into two parts.</p>
</div>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/i.mx28/">i.mx28</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2015/01/20/imx28-sdimage-tool-code-walkthrough/">Understanding The i.MX28 sdimage Utility Code</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2015-01-20T00:00:00+00:00">
January 20, 2015
</time>
</h4>
</header>
<div class="post-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The i.MX28 development environment provides a utility like sdimage which is used to flash the bootstream files to the Freescale firmware partitions. In this post we walk through the code of sdimage to understand its implementation</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mmc-boot"><a class="anchor" href="#mmc-boot"></a>MMC Boot</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The instructions to prepare a MMC device for boot are given in the i.MX28
EVK Linux User.s Guide. At the time of writing this post the guide
available from the Freescale website was used and its revision is
Rev. L2.6.35_1.1.0. The document can be obtained from
<a href="https://www.freescale.com/webapp/Download?colCode=L2.6.35_1.1.0_LINUX_DOCS&amp;location=null&amp;fasp=1&amp;WT_TYPE=Supporting%20Information&amp;WT_VENDOR=FREESCALE&amp;WT_FILE_FORMAT=gz&amp;WT_ASSET=Documentation&amp;fileExt=.gz&amp;Parent_nodeId=1285002710766722211624&amp;Parent_pageType=product&amp;Parent_nodeId=1285002710766722211624&amp;Parent_pageType=product" target="_blank">L2.6.35_1.1.0_LINUX_DOCS</a>.</p>
</div>
<div class="paragraph">
<p>The steps for MMC boot in section 5.1.3.1 include using sdimage which is
a part of the Linux Target Image Builder (<a href="http://ltib.org/" target="_blank">LTIB</a>) development
environment to flash the bootstream images onto the MMC device.</p>
</div>
<div class="paragraph">
<p>This post walks through the steps to extract sdimage from the LTIB,
build it and then goes through the source code for sdimage to understand
what it is doing as it is not very clear.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="getting-the-sdimage-utility-from-ltib"><a class="anchor" href="#getting-the-sdimage-utility-from-ltib"></a>Getting the sdimage utility from LTIB</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To inspect the source code for sdimage we first extract it from the rpm sources
in the LTIB</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$./ltib -p uuc.spec -m prep
on't have HTTP::Request::Common
Don't have LWP::UserAgent
Cannot test proxies, or remote file availability without both
HTTP::Request::Common and LWP::UserAgent

Processing: uuc
=================
Build path taken because: build key set, no prebuilt rpm,

rpmbuild --dbpath /home/ubuntu/beta/projectX/ltib/rootfs//var/lib/rpm --target arm --define '_unpackaged_files_terminate_build 0' --define '_target_cpu arm' --define '__strip strip' --define '_topdir /home/ubuntu/beta/projectX/ltib/rpm' --define '_prefix /usr' --define '_tmppath /home/ubuntu/beta/projectX/ltib/tmp' --define '_rpmdir /home/ubuntu/beta/projectX/ltib/rpm/RPMS'  --define '_mandir /usr/share/man' --define '_sysconfdir /etc' --define '_localstatedir /var' -bp  /home/ubuntu/beta/projectX/ltib/dist/lfs-5.1/uuc/uuc.spec
Building target platforms: arm
Building for target arm
Executing(%prep): /bin/sh -e /home/ubuntu/beta/projectX/ltib/tmp/rpm-tmp.79873
+ umask 022
+ cd /home/ubuntu/beta/projectX/ltib/rpm/BUILD
+ cd /home/ubuntu/beta/projectX/ltib/rpm/BUILD
+ rm -rf uuc-10.12.01
+ tar -xvvf -
+ /bin/gzip -dc /home/ubuntu/beta/projectX/ltib/rpm/SOURCES/uuc-10.12.01.tar.gz
drwxrwxr-x root/root         0 2010-09-29 06:35 uuc-10.12.01/
-rw-rw-r-- root/root       338 2010-09-29 06:35 uuc-10.12.01/Makefile
-rwxrwxr-x root/root       337 2010-09-29 06:35 uuc-10.12.01/linuxrc
-rw-rw-r-- root/root      4754 2010-09-29 06:35 uuc-10.12.01/sdimage.c
-rw-rw-r-- root/root     16753 2010-09-29 06:35 uuc-10.12.01/uu.c
+ STATUS=0
+ [ 0 -ne 0 ]
+ cd uuc-10.12.01
+ exit 0
Build time for uuc: 0 seconds

ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="building-the-code"><a class="anchor" href="#building-the-code"></a>Building the code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To build the code for sdimage we go to the rpm directory with the uuc source
code and run <em>gcc</em> on the <em>sdimage.c</em> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib$ cd rpm/BUILD/uuc-10.12.01/
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib/rpm/BUILD/uuc-10.12.01$ gcc sdimage.c -o sdimage
sdimage.c: In function âinâsdimage.c:134:2: warning: incompatible implicit declaration of built-in function âmsetâenabled by default]
.
.
ubuntu@ubuntu-VirtualBox:~/beta/projectX/ltib/rpm/BUILD/uuc-10.12.01$</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="code-walk-through"><a class="anchor" href="#code-walk-through"></a>Code Walk Through</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Read arguments passed.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Filter -f and set the firmware file name to g_firmware.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>e.g imx28_linux.sb</p>
</li>
</ol>
</div>
</li>
<li>
<p>Filter -d and set the device file name to g_filedev.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>e.g /dev/sde, /dev/mmcblk</p>
</li>
</ol>
</div>
</li>
<li>
<p>Crib and return if either of the arguments are not passed</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the device file and save the handle.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Assign device file handle to devhandle.</p>
</li>
<li>
<p>Crib and return if error in opening the device file.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Open the firmware file and save the handle.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Assign firmware file handle to firmwarehandle.</p>
</li>
<li>
<p>Crib and return if error in opening the firmware file.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Get filestat of firmware file</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Crib and return if error in filestat.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Read the Master Boot Record (MBR) from device handle devhandle into object variable mbr with a structure which matches the MBR structure</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Crib and return if number of bytes read is less than the size of the MBR structure.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Check the signature of the MBR, it should be 0xAA55</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>mbr.sign holds the signature</p>
</li>
<li>
<p>Crib and return if signature does not match</p>
</li>
</ol>
</div>
</li>
<li>
<p>Iterate through the 4 physical partitions and search for a partition type OnTrack DM6 Aux3. (This is the Freescale firmware partition type as given in section 12.11 SD/MMC Boot Mode of i.MX28 Applications Processor Reference Manual, Rev. 2, 08/2013)</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>mbr.part[i].filesystem holds the filesystem type</p>
</li>
<li>
<p>Filesystem type is 'S' in ASCII. Hex code 53. Decimal value 83.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>To figure out the various filesystem types run fdisk utility. At the command prompt enter 'l' to list partition types.</p>
</li>
<li>
<p>'S' is hex code 53 which represents Linux partition type which is created when formatting the MMC device with fdisk.</p>
</li>
<li>
<p>If "OnTrack DM6 Aux3" type of partition is not found then crib and return.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Check if the size of the partition is greater than one byte plus two times the firmware file size obtained in step 4</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Crib and return if less as the partition size is too small.</p>
</li>
<li>
<p>Partition size has to be slightly greater than twice the firmware file size</p>
</li>
</ol>
</div>
</li>
<li>
<p>Intialize the ConfigBlock structure variable bcb</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>The config block holds the information about the boot information for the driver. (Further information about its structure is given in section 12.11.1 Boot Control Block (BCB) Data Structure of i.MX28 Applications Processor Reference Manual, Rev. 2, 08/2013)</p>
</li>
<li>
<p>This structure holds the information about the primary and secondary boot tags.</p>
</li>
<li>
<p>The bcb structure is initialized with appropriate signature0x00112233.</p>
</li>
<li>
<p>The primary boot firmware is given a tag of 1</p>
</li>
<li>
<p>The start of the primary boot firmware is initialized to the next sector after the start of the partition. The bcb structure is stored in the first sector.</p>
</li>
<li>
<p>The secondary boot firmware is given a tag of 2</p>
</li>
<li>
<p>The start of the secondary boot firmware is initialized to the next sector after the start of the partition. The bcb structure is stored in the first sector.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Write the bcb data</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Seek to the first sector of the Freescale firmware partition.</p>
</li>
<li>
<p>Write the bcb data</p>
</li>
<li>
<p>Crib and exit if bytes written does not match with the size of the bcb.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Write the primary and secondary firmware partitions</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allocate memory of size equal to the firmware file</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Crib and exit if there is a memory allocation error.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Read the firmware file from the firmwarehandle to a buffer buff.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Crib and exit if there is a read error</p>
</li>
</ol>
</div>
</li>
<li>
<p>Seek to the second sector of the Freescale firmware partition.</p>
</li>
<li>
<p>Write the firmware buffer buff to the address seeked above.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Crib and exit if there is a write error</p>
</li>
</ol>
</div>
</li>
<li>
<p>Seek to the sector after the last sector containing the primary firmware.</p>
</li>
<li>
<p>Write the firmware buffer buff to the address seeked above.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Crib and exit if there is a write error</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Free the buffer allocated</p>
</li>
<li>
<p>Close the device handle devhandle.</p>
</li>
<li>
<p>Close the firmware file handle firmwarehandle.</p>
</li>
<li>
<p>Exit.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/sdcard/">sdcard</a>
, <a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/i.mx28/">i.mx28</a>
, <a href="/techeuphoria/posts/tag/mmc/">mmc</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2014/12/09/sdcard-access-on-ubuntu-guest-on-a-windows-host-with-virtualbox/">SD Card Access on an Ubuntu virtual machine running on a Windows host through VirtualBox</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2014-12-09T00:00:00+00:00">
December  9, 2014
</time>
</h4>
</header>
<div class="post-body">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>We will take a look at how to access an SD Card on a Windows Laptop through an Ubuntu VirtualBox virtual machine.</p>
</div>
<div class="paragraph">
<p>Some of the embedded linux platforms like the
<a href="http://www.freescale.com/webapp/sps/site/prod_summary.jsp?code=MCIMX28EVKJ" target="_blank">i.MX28 evaluation kit</a> from <a href="http://www.freescale.com">Freescale</a> have SD
card interfaces with which a firmware image can be flashed and booted up on
the platform.</p>
</div>
<div class="paragraph">
<p>If you work in an environment where you use Microsoft Windows as your primary
OS you might end up using a Linux environment as a virtual machine on Windows.
For all work involving embedded development for your target board you will
mostly use linux based tools to build code, remote debugging or even flashing
your firmware on some sort of flash based device.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="our-embedded-development-environment"><a class="anchor" href="#our-embedded-development-environment"></a>Our Embedded Development Environment</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We have a i.mx28 Evaluation Kit with a SD card interface. The platform supports
booting from firmware flashed on the SD card. In order to access the SD card we
use a linux based tool for the embedded platform. Unfortunately our linux
development machine is a virtual machine of Ubuntu running on
<a href="https://www.virtualbox.org/" target="_blank">Oracle&#8217;s VirtualBox</a>.</p>
</div>
<div class="paragraph">
<p>The challenge here is to allow the virtual machine running the guest Ubuntu OS to
recognize the SD card interface on the laptop running Windows OS as the host OS.</p>
</div>
<div class="paragraph">
<p>Specifications of the environment:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Host OS</strong> : Windows 7 Professional</p>
</li>
<li>
<p><strong>VirtualBox</strong> : Version 4.3.8</p>
</li>
<li>
<p><strong>Guest OS</strong> : Ubuntu 13.04 (GNU/Linux 3.8.0-19-generic i686)</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step-1-accessing-the-command-prompt-on-windows-7"><a class="anchor" href="#step-1-accessing-the-command-prompt-on-windows-7"></a>Step 1: Accessing the command prompt on Windows 7</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll need to access the command prompt to run VirtualBox&#8217;s <em>VBoxManage</em> utility.
In order to do so we go to <em>Start</em> then open <em>Run</em> and enter <em>cmd</em> in the text
box provided.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-open-command-prompt" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-open-command-prompt.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-open-command-prompt.png" alt="sdcard open command prompt" width="640" height="480"></a>
</div>
<div class="title">Figure 1. Opening the command prompt on Windows 7</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step-2-determine-the-physical-drive-number-allocated-to-the-sd-card"><a class="anchor" href="#step-2-determine-the-physical-drive-number-allocated-to-the-sd-card"></a>Step 2: Determine the physical drive number allocated to the SD Card</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In our case we work with a micro SD card and have to use an adapter as shown
in the diagram below:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-microsd-adaptor-sd" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-microsd-adaptor-sd.jpg"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-microsd-adaptor-sd.jpg" alt="sdcard microsd adaptor sd" width="640" height="480"></a>
</div>
<div class="title">Figure 2. Micro SD card adapter</div>
</div>
</div>
</div>
<div class="paragraph">
<p>After we have plugged in our SD card we need to know what physical drive number
is allocated to it by the Windows 7 system. This will be used as a parameter to
<em>VBoxManage</em> when we&#8217;re configuring VirtualBox to use the SD card. We will use
the Windows Management Instrumentation command-line (<a href="http://technet.microsoft.com/en-us/library/bb742610.aspx" target="_blank">WMIC</a>) tool to determine the
physical drive.</p>
</div>
<div class="paragraph">
<p>The command might require administrator priviledges. After execution we
get to know that our SD card has been allocated a physical drive number of 1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\Users\Conrad.Gomes&gt;wmic diskdrive list brief /format:list</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-list-diskdrives-using-command-prompt" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-list-diskdrives-using-command-prompt.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-list-diskdrives-using-command-prompt.png" alt="sdcard list diskdrives using command prompt" width="640" height="480"></a>
</div>
<div class="title">Figure 3. Using wmic to get the physical drive number</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step-3-creating-and-mapping-a-disk-file-to-the-sd-card"><a class="anchor" href="#step-3-creating-and-mapping-a-disk-file-to-the-sd-card"></a>Step 3: Creating and mapping a disk file to the SD Card</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The SD card is treated as a physical disk in the system. We need to create an
image that will represent the entire "raw disk" represented by the SD card.
To do so we will use the <em>VBoxManage</em> utility available with the VirtualBox
installation. We first change the directory to the VirtualBox installation
path where the <em>VBoxManage</em> utility exists. Since VirtualBox is now owned by
Oracle it will be installed in the "Oracle" directory in "Program Files".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\Users\Conrad.Gomes&gt;cd &quot;C:\Program Files\Oracle\VirtualBox&quot;

C:\Program Files\Oracle\VirtualBox&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The capture below highlights the result of the above step</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-changedirectory-to-virtualbox" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-changedirectory-to-virtualbox.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-changedirectory-to-virtualbox.png" alt="sdcard changedirectory to virtualbox" width="640" height="480"></a>
</div>
<div class="title">Figure 4. Changing to the Oracle VirtualBox directory</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We should now be able to create the vmdk image mapped to the SD card using
the command below. Two arguments need to be supplied, the absolute path of
the file on the host OS i.e. the Windows7 machine which will map to the SD
card and the raw disk which is expressed as "\\.\PhysicalDriveX" where "X"
is the physical drive number of the SD card that we obtained using <em>wmic</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">C:\Program Files\Oracle\VirtualBox&gt;VBoxManage.exe internalcommands createrawvmdk -filename &quot;D:\Work\SD-Card.vmdk&quot; -rawdisk &quot;\\.\PhysicalDrive1&quot;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If it succeeds you should see a success message as shown in the screen
capture:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-vboxmanage-create-rawdisk" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-vboxmanage-create-rawdisk.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-vboxmanage-create-rawdisk.png" alt="sdcard vboxmanage create rawdisk" width="640" height="480"></a>
</div>
<div class="title">Figure 5. Creating VMDK image with VBoxManage and mapping it to the SD card</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step-4-allowing-the-guest-os-to-access-the-sd-card"><a class="anchor" href="#step-4-allowing-the-guest-os-to-access-the-sd-card"></a>Step 4: Allowing the guest OS to access the SD card</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure the guest OS virtual machine is "Powered Off" before changing
its settings. To modify the settings of the virtual machine we have to
power it off. If not powered off the system will not allow us to add the
hard disk mapped SD-Card.vmdk file.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-open-virtualbox-settings-when-powered-off" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-open-virtualbox-settings-when-powered-off.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-open-virtualbox-settings-when-powered-off.png" alt="sdcard open virtualbox settings when powered off" width="640" height="480"></a>
</div>
<div class="title">Figure 6. Open VirtualBox settings when VM is powered off</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once powered off go to the settings of the virtual machine
and under the "Controller: SATA" settings click on "Add Hard Disk" button
as shown below:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-storage-settings-add-harddisk" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-storage-settings-add-harddisk.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-storage-settings-add-harddisk.png" alt="sdcard storage settings add harddisk" width="640" height="480"></a>
</div>
<div class="title">Figure 7. Modify storage settings and add hard disk under Controller: SATA settings</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Locate the VMDK file created in the previous step and open it to add it as a
hard disk.</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-storage-settings-choose-sd-cardvmdk" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-storage-settings-choose-sd-cardvmdk.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-storage-settings-choose-sd-cardvmdk.png" alt="sdcard storage settings choose sd cardvmdk" width="640" height="480"></a>
</div>
<div class="title">Figure 8. Select the VMDK file and open it as a hard disk</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once successfully opened we should be able to see the file listed as a hard
disk under "Controller: SATA" as shown below:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-storage-sd-card-vmdk-added" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-storage-sd-card-vmdk-added.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-storage-sd-card-vmdk-added.png" alt="sdcard storage sd card vmdk added" width="640" height="480"></a>
</div>
<div class="title">Figure 9. SD-Card.vmdk is listed as a hard disk under Controller:Sata settings</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="step-5-accessing-the-sd-card-on-the-guest-os"><a class="anchor" href="#step-5-accessing-the-sd-card-on-the-guest-os"></a>Step 5: Accessing The SD Card On The Guest OS</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next step is to power on the virtual machine and see the SD card added as a
hard disk in the system. We use <em>fdisk</em> to check and see if the SD card is
listed in the system. Use of <em>fdisk</em> may require <em>sudo</em> privileges.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">ubuntu@ubuntu-VirtualBox:~$ sudo fdisk -l
[sudo] password for ubuntu:</code></pre>
</div>
</div>
<div class="paragraph">
<p>The SD card is visible as <em>/dev/sde</em> device in the system. Further more we can
see the various partitions and their file formats. It is the last device listed
by <em>fdisk</em>. For comparison sake <em>fdisk</em> can be run before adding the SD card
as explained here and then compared to see the new hard disk device:</p>
</div>
<div class="exampleblock">
<div class="content">
<div id="sdcard-guest-os-fdisk-list" class="imageblock" style="text-align: center">
<div class="content">
<a class="image" href="../../../../../images/sdcard-guest-os-fdisk-list.png"><img src="http://zeuzoix.github.io/techeuphoria/images/sdcard-guest-os-fdisk-list.png" alt="sdcard guest os fdisk list" width="640" height="480"></a>
</div>
<div class="title">Figure 10. Listing the newly added SD card using fdisk</div>
</div>
</div>
</div>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/virtualbox/">virtualbox</a>
, <a href="/techeuphoria/posts/tag/sdcard/">sdcard</a>
, <a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/ubuntu/">ubuntu</a>
, <a href="/techeuphoria/posts/tag/virtualization/">virtualization</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2014/11/05/apt-cache-show/">Getting information about packages using APT</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2014-11-05T00:00:00+00:00">
November  5, 2014
</time>
</h4>
</header>
<div class="post-body">
<div class="paragraph">
<p>Understanding information about packages before using apt-get</p>
</div>
<div class="paragraph">
<p>The APT( Advanced Packaging Tool) handles software packages on a debian system.
Typically when you go through any tutorial on installing any package or
application you may encounter instructions to install packages with <em>apt_get</em>.
This step is typically a trivial step that is executed without understanding
the nature and purpose of the packages being installed. The power and simplicity
of APT resolves all the dependencies of the packages.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">user@ubuntu-VirtualBox:~/mysite/techeuphoria$ sudo apt-get install build-essential
[sudo] password for user:</code></pre>
</div>
</div>
<div class="paragraph">
<p>However if you want to dig deeper and understand the nature of the packages
getting installed you can use the <em>apt-cache show</em> command as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">user@ubuntu-VirtualBox:~/mysite/techeuphoria$ sudo apt-cache show build-essential
Package: build-essential
Priority: optional
Section: devel
Installed-Size: 37
Maintainer: Ubuntu Developers &lt;ubuntu-devel-discuss@lists.ubuntu.com&gt;
Original-Maintainer: Matthias Klose &lt;doko@debian.org&gt;
Architecture: i386
Version: 11.6ubuntu4
Depends: libc6-dev | libc-dev, gcc (&gt;= 4:4.4.3), g++ (&gt;= 4:4.4.3), make, dpkg-dev (&gt;= 1.13.5)
Filename: pool/main/b/build-essential/build-essential_11.6ubuntu4_i386.deb
Size: 5654
MD5sum: d8bd2f0becd7b941d8e10c75f3e73120
SHA1: 55488e1349c1f49656260dfa8d46dea4f353b3a1
SHA256: 5594116e639130239f849088321f5ff3cc75cd3a688d1d3504786da1195e4d4d
Description-en: Informational list of build-essential packages
 If you do not plan to build Debian packages, you don't need this
 package.  Starting with dpkg (&gt;= 1.14.18) this package is required
 for building Debian packages.
 .
 This package contains an informational list of packages which are
 considered essential for building Debian packages.  This package also
 depends on the packages on that list, to make it easy to have the
 build-essential packages installed.
 .
 If you have this package installed, you only need to install whatever
 a package specifies as its build-time dependencies to build the
 package.  Conversely, if you are determining what your package needs
 to build-depend on, you can always leave out the packages this
 package depends on.
 .
 This package is NOT the definition of what packages are
 build-essential; the real definition is in the Debian Policy Manual.
 This package contains merely an informational list, which is all
 most people need.   However, if this package and the manual disagree,
 the manual is correct.
Description-md5: 90ef0ef86cafda0bd16f746eb621d9da
Bugs: https://bugs.launchpad.net/ubuntu/+filebug
Build-Essential: yes
Origin: Ubuntu
Supported: 9m</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above command gives you insight into the details of the package along
with dependencies and a description. We check the information for
<em>build-essential</em> which is not a single package but a list of packages
which are tagged as <em>"Build-Essential: yes"</em>. The same command can be applied
to any package name listed in your <em>apt-get install</em> command.</p>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/packages/">packages</a>
, <a href="/techeuphoria/posts/tag/apt/">apt</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2014/06/30/a-new-website/">A New Beginning</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2014-06-30T00:00:00+00:00">
June 30, 2014
</time>
</h4>
</header>
<div class="post-body">
<div class="sect1">
<h2 id="epoch"><a class="anchor" href="#epoch"></a>Epoch</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TechEuphoria was developed during the second quarter of 2014 with the
help of a wonderful <a href="http://mojavelinux.github.io/decks/docs-workshop/oscon2013/index.html">slide deck</a> from an open source
advocate Dan Allen(<a href="http://www.mojavelinux.com">mojavelinux</a>).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="objectives"><a class="anchor" href="#objectives"></a>Objectives</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I had an overall understanding of what I wanted to achieve. It is to build a lean
and clean website, have the ability to be agile and publish with ease and at will.
My objectives took form over the course of my search for a solution as I
became familiar with the different concepts and paradigms of web design and
development. My objectives can now be summarized as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use a decentrallized tool with which TechEuphoria can be built locally before
publishing it to the world wide web.</p>
</li>
<li>
<p>The tools chosen should have a mechanism with which the presentation of the
website could be separated from the content.</p>
</li>
<li>
<p>Use responsive website design(<a href="http://en.wikipedia.org/wiki/Responsive_web_design">RWD</a>) to
allow users with devices of different displays to consume the content.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="a-journey-of-errors"><a class="anchor" href="#a-journey-of-errors"></a>A Journey of Errors</h2>
<div class="sectionbody">
<div class="paragraph">
<p>My objectives were more or less clear. I needed a way to work on my website,
whenever and wherever I wanted to. I knew Git was a good way to achieve
it but I did not know about <a href="https://pages.github.com">Github Pages</a> and started
off with the first choice that came to mind and that was <a href="http://wordpress.com">Wordpress</a>.</p>
</div>
<div class="paragraph">
<p>So begain my pursuit to build TechEuphoria with the objectives given. I initially
figured a way to deploy and manage this website with the help of the following
links:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="http://davidwinter.me/articles/2012/04/09/install-and-manage-wordpress-with-git/">Install and manage Wordpress with Git</a></p>
</li>
<li>
<p><a href="http://culttt.com/2013/04/08/how-to-deploy-wordpress-themes-with-git">How to deploy WordPress themes with Git</a></p>
</li>
<li>
<p><a href="http://mattbanks.me/wordpress-deployments-with-git">Managing WordPress Deployments With Git</a></p>
</li>
<li>
<p><a href="http://blog.g-design.net/post/60019471157/managing-and-deploying-wordpress-with-git">Managing and deploying WordPress with Git</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After days of playing around and understanding the details of Wordpress I
realized that it was still difficult to publish and the fact of dumping the
SQL database to a file to sync different copies of the website was a hack
rather than a solution. Despite getting the solution working I abandoned
it completely on the 30th of May. My exploits are stored in the logs of
the following repositories:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://github.com/zeuzoix/techeuphoria_wordpress">GitHub repository</a></p>
</li>
<li>
<p><a href="https://bitbucket.org/zeuzoix/techeuphoria_wordpress">Bitbucket repository</a></p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tools"><a class="anchor" href="#tools"></a>Tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following represents the tools that I use to compile and publish this website:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>TechEuphoria content is written in <a href="http://asciidoc.org">AsciiDoc</a>.</p>
</li>
<li>
<p>It is transformed by <a href="http://awestruct.org">Awestruct</a> and
<a href="http://asciidoctor.org">Asciidoctor</a> into a static website.</p>
</li>
<li>
<p>It uses <a href="https://pages.github.com">Github Pages</a> as its publishing engine.</p>
</li>
<li>
<p>I use <a href="http://www.vim.org">Vim</a> as my text editor to edit everything.</p>
</li>
<li>
<p>My development machine is an <a href="http://www.ubuntu.com">Ubuntu</a> guest on an
<a href="https://www.virtualbox.org">Oracle Virtual Box</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Happy Blogging!</p>
</div>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/github pages/">github pages</a>
, <a href="/techeuphoria/posts/tag/asciidoctor/">asciidoctor</a>
, <a href="/techeuphoria/posts/tag/asciidoc/">asciidoc</a>
, <a href="/techeuphoria/posts/tag/awestruct/">awestruct</a>
, <a href="/techeuphoria/posts/tag/blog/">blog</a>
, <a href="/techeuphoria/posts/tag/website/">website</a>
, <a href="/techeuphoria/posts/tag/www/">www</a></div>
</footer>
<hr>
</article>

<article class="post">
<header class="post-head">
<h1 class="title">
<a href="/techeuphoria/posts/2014/01/29/printing-linux-kernel-version/">Printing the Linux kernel version</a>
</h1>
<h4>
<em>by</em>
<a class="author" href="http://in.linkedin.com/in/conradsjgomes">
Conrad Gomes
</a>
on
<time class="pubdate" datetime="2014-01-29T00:00:00+00:00">
January 29, 2014
</time>
</h4>
</header>
<div class="post-body">
<div class="paragraph">
<p>The kernel version that a kernel module is built with can differ from the kernel version it is running on. The version of the kernel that the module is running on is shown
in the first log and the version of the kernel is compiled with is shown
in the second log in the version_init function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="c"><span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/init.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/module.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/kernel.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;linux/utsname.h&gt;</span>
<span style="color:#579">#include</span> <span style="color:#B44;font-weight:bold">&lt;generated/utsrelease.h&gt;</span>

<span style="color:#088;font-weight:bold">static</span> <span style="color:#0a8;font-weight:bold">int</span> __init version_init(<span style="color:#088;font-weight:bold">void</span>)
{
        <span style="color:#0a8;font-weight:bold">int</span> i = <span style="color:#00D">0</span>;

        pr_alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Kernel module running of version %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, utsname()-&gt;release);
        pr_alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Kernel module compiled with version %s</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>, UTS_RELEASE);
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#00D">0</span>;
}

<span style="color:#088;font-weight:bold">static</span> <span style="color:#088;font-weight:bold">void</span> __exit version_exit(<span style="color:#088;font-weight:bold">void</span>)
{
        pr_alert(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Over and out!</span><span style="color:#b0b">\n</span><span style="color:#710">&quot;</span></span>);
}

module_init(version_init);
module_exit(version_exit);

MODULE_LICENSE(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">GPL</span><span style="color:#710">&quot;</span></span>);
MODULE_AUTHOR(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">zeuzoix</span><span style="color:#710">&quot;</span></span>);
MODULE_DESCRIPTION(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">Kernel Module Version Example Module</span><span style="color:#710">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<footer class="post-footer">
<div class="tags"><i class="label icon-tags"></i>
<a href="/techeuphoria/posts/tag/linux/">linux</a>
, <a href="/techeuphoria/posts/tag/kernel/">kernel</a>
, <a href="/techeuphoria/posts/tag/programming/">programming</a>
, <a href="/techeuphoria/posts/tag/c/">c</a></div>
</footer>
<hr>
</article>

<div class="pagination-centered">
<ul class="pagination">
<li class="arrow unavailable">
<a href="#">
<i class="icon-step-backward"></i>
</a>
</li>
<li>1 of 3</li>
<li class="arrow">
<a href="/techeuphoria/posts/page/2/">
<i class="icon-step-forward"></i>
</a>
</li>
</ul>
</div>

</div>
</div>

</div>
</div>
<footer class="row" style="max-width: 100%">
<hr>
<div class="large-6 columns">
<p style="margin-bottom: .75em">
&copy; conrad.s.j.gomes@gmail.com 2015
<br>
Built on Foundation. Baked by Awestruct. Composed with Asciidoc
</p>
</div>
<div class="large-6 columns">
<ul class="inline-list right">
<li>
<a href="http://zeuzoix.github.io/techeuphoria/">Home</a>
</li>
</ul>
</div>
</footer>
<script>
document.write('<script src=' + ('__proto__' in {} ? 'http://zeuzoix.github.io/techeuphoria/javascripts/vendor/zepto' : 'http://zeuzoix.github.io/techeuphoria/javascripts/vendor/jquery') + '.js><\/script>')
</script>
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/foundation/foundation.js"></script>
<script src="http://zeuzoix.github.io/techeuphoria/javascripts/foundation/foundation.topbar.js"></script>
<script>
$(document).foundation()
</script>
<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount','UA-61553633-1']);
_gaq.push(['_trackPageview']);
(function() {
 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</body>
</html>
